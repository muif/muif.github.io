<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ISP Manager Pro</title>
    <!-- استيراد المكتبات الأساسية لضمان عمل كافة الوظائف المحاسبية والتقنية -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800;900&display=swap" rel="stylesheet">
    
    <style>
        /* تعريف الهوية البصرية (Theme) لنظام إدارة الشبكات والمشتركين */
        :root {
            --primary-blue: #4f46e5;
            --indigo-accent: #6366f1;
            --success-green: #10b981;
            --error-red: #ef4444;
            --bg-slate: #f1f5f9;
            --glass-white: rgba(255, 255, 255, 0.98);
        }

        body { 
            font-family: 'Tajawal', sans-serif; 
            background: var(--bg-slate); 
            padding-bottom: 115px; 
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
            user-select: none; 
        }

        /* تصميم الكروت بنمط Glassmorphism المتقدم لسهولة القراءة والجمالية */
        .glass-card { 
            background: var(--glass-white); 
            backdrop-filter: blur(15px); 
            border: 1px solid rgba(226, 232, 240, 0.8); 
            border-radius: 1.75rem; 
            box-shadow: 0 10px 30px -5px rgba(0,0,0,0.04);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* تنسيق شريط التنقل السفلي الاحترافي */
        .bottom-nav { 
            position: fixed; 
            bottom: 0; 
            left: 0; 
            right: 0; 
            height: 85px; 
            background: rgba(255,255,255,0.95); 
            backdrop-filter: blur(25px); 
            border-top: 1px solid #e2e8f0; 
            display: flex; 
            justify-content: space-around; 
            align-items: center; 
            z-index: 50; 
            padding-bottom: env(safe-area-inset-bottom);
            box-shadow: 0 -5px 25px rgba(0,0,0,0.06);
        }

        .nav-item { 
            color: #94a3b8; 
            font-size: 0.65rem; 
            font-weight: 800; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            gap: 7px; 
            cursor: pointer; 
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            width: 20%;
        }

        .nav-item.active { 
            color: var(--primary-blue); 
            transform: translateY(-6px); 
        }

        .nav-item.active i { 
            stroke-width: 3.5px; 
            filter: drop-shadow(0 0 8px rgba(79, 70, 229, 0.4)); 
        }
        
        /* تصميم النوافذ المنبثقة التفاعلية */
        .modal { 
            display: none; 
            position: fixed; 
            inset: 0; 
            background: rgba(15, 23, 42, 0.78); 
            backdrop-filter: blur(12px); 
            z-index: 100; 
            align-items: center; 
            justify-content: center; 
            padding: 1rem; 
        }
        
        .modal.active { 
            display: flex; 
            animation: slideUpFade 0.5s cubic-bezier(0.16, 1, 0.3, 1); 
        }
        
        .modal-content { 
            background: white; 
            width: 100%; 
            max-width: 540px; 
            border-radius: 2.5rem; 
            padding: 2.2rem; 
            max-height: 92vh; 
            overflow-y: auto; 
            box-shadow: 0 35px 70px -15px rgba(0, 0, 0, 0.45);
            position: relative;
        }
        
        /* حقول الإدخال العصرية */
        .modern-input { 
            width: 100%; 
            padding: 1.1rem 1.3rem; 
            border-radius: 1.3rem; 
            border: 1.5px solid #e2e8f0; 
            margin-top: 0.6rem; 
            font-size: 0.98rem; 
            transition: all 0.35s ease; 
            background: #f8fafc;
            color: #0f172a;
        }

        .modern-input:focus { 
            border-color: var(--primary-blue); 
            background: white; 
            box-shadow: 0 0 0 6px rgba(79, 70, 229, 0.12);
            outline: none; 
        }
        
        /* الأزرار الاحترافية */
        .btn-primary { 
            background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
            color: white; 
            padding: 1.25rem; 
            border-radius: 1.5rem; 
            font-weight: 900; 
            width: 100%; 
            transition: all 0.4s; 
            box-shadow: 0 15px 25px -5px rgba(79, 70, 229, 0.4);
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        .btn-primary:active { transform: scale(0.94); box-shadow: 0 5px 10px rgba(79, 70, 229, 0.2); }
        .btn-primary:disabled { background: #cbd5e1; box-shadow: none; opacity: 0.7; transform: none; cursor: not-allowed; }

        @keyframes slideUpFade { 
            from { opacity: 0; transform: translateY(50px) scale(0.92); } 
            to { opacity: 1; transform: translateY(0) scale(1); } 
        }
        
        .sync-loading { animation: spin 0.8s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        /* تخصيص شريط التمرير */
        .modal-content::-webkit-scrollbar { width: 4px; }
        .modal-content::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }

        /* توست (Toast) بسيط */
        #toast {
            position: fixed; top: 100px; left: 50%; transform: translateX(-50%);
            background: #1e293b; color: white; padding: 10px 20px; border-radius: 12px;
            font-size: 12px; font-weight: bold; z-index: 200; display: none;
            animation: fadeInOut 2s forwards;
        }
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translate(-50%, 20px); }
            15% { opacity: 1; transform: translate(-50%, 0); }
            85% { opacity: 1; transform: translate(-50%, 0); }
            100% { opacity: 0; transform: translate(-50%, -20px); }
        }
    </style>
</head>
<body>

    <div id="toast">تم النسخ بنجاح</div>

    <!-- Header -->
    <header class="bg-white/80 backdrop-blur-xl sticky top-0 z-40 border-b border-slate-100 p-4 flex justify-between items-center shadow-sm">
        <div class="flex items-center gap-4">
            <div class="w-12 h-12 bg-gradient-to-br from-indigo-500 to-indigo-700 rounded-2xl flex items-center justify-center text-white shadow-xl shadow-indigo-200 ring-2 ring-white">
                <i data-lucide="wifi"></i>
            </div>
            <div>
                <h1 class="font-black text-slate-800 tracking-tight text-xl leading-none">إدارة ISP برو</h1>
                <p class="text-[10px] text-slate-400 font-black uppercase tracking-widest mt-1.5 flex items-center gap-1">
                    <span class="w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse"></span> نظام إدارة الشبكات v5.5
                </p>
            </div>
        </div>
        <div id="sync-status" class="flex items-center gap-2 text-[10px] font-black px-4 py-2.5 rounded-full bg-slate-50 text-slate-500 border border-slate-200">
            <i id="sync-icon" data-lucide="refresh-cw" class="w-3.5 h-3.5"></i> <span id="sync-text">مستقر</span>
        </div>
    </header>

    <!-- Main Content -->
    <main id="content" class="p-4 space-y-6">
        <!-- يتم ملؤه عبر JavaScript -->
    </main>

    <!-- Bottom Nav -->
    <nav class="bottom-nav">
        <div onclick="router('home')" class="nav-item active" id="nav-home"><i data-lucide="layout-grid"></i><span>الرئيسية</span></div>
        <div onclick="router('subs')" class="nav-item" id="nav-subs"><i data-lucide="users"></i><span>المشتركين</span></div>
        <div onclick="router('init_codes')" class="nav-item" id="nav-init_codes"><i data-lucide="zap"></i><span>كودات التفعيل</span></div>
        <div onclick="router('codes')" class="nav-item" id="nav-codes"><i data-lucide="ticket"></i><span>كودات التجديد</span></div>
        <div onclick="router('settings')" class="nav-item" id="nav-settings"><i data-lucide="settings"></i><span>الإعدادات</span></div>
    </nav>

    <button id="fab" onclick="openAddSubModal()" class="fixed bottom-28 left-6 w-16 h-16 bg-indigo-600 text-white rounded-3xl shadow-2xl hidden items-center justify-center z-40 hover:bg-indigo-700 transition-all hover:-translate-y-2 active:scale-90 shadow-indigo-300">
        <i data-lucide="user-plus" class="w-8 h-8"></i>
    </button>

    <!-- Modal: Add Subscriber -->
    <div id="modal-sub" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-8 border-b pb-5">
                <div>
                    <h3 class="font-black text-2xl text-slate-800">إضافة مشترك</h3>
                    <p class="text-[11px] text-slate-400 font-bold mt-1.5 uppercase tracking-wide">تسجيل مشترك جديد مع تفعيل الكود</p>
                </div>
                <button onclick="closeModals()" class="text-slate-400 hover:text-slate-600 transition-all p-3 rounded-2xl hover:bg-slate-50 border border-slate-100"><i data-lucide="x"></i></button>
            </div>
            <div class="space-y-6">
                <div class="grid grid-cols-2 gap-5">
                    <div><label class="text-xs font-black text-slate-500 mr-1 uppercase">تاريخ البيع</label><input type="date" id="new-sale-date" class="modern-input"></div>
                    <div><label class="text-xs font-black text-slate-500 mr-1 uppercase">تاريخ التفعيل</label><input type="date" id="new-act-date" class="modern-input"></div>
                </div>
                <div><label class="text-xs font-black text-slate-500 mr-1 uppercase">اسم المشترك الكامل</label><input type="text" id="new-name" class="modern-input" placeholder="اكتب الاسم الكامل للمشترك..."></div>
                <div class="grid grid-cols-2 gap-5">
                    <div><label class="text-xs font-black text-slate-500 mr-1 uppercase">رقم الموبايل</label><input type="tel" id="new-phone" class="modern-input font-mono" placeholder="07xxxxxxxx"></div>
                    <div><label class="text-xs font-black text-slate-500 mr-1 uppercase">سيريال الجهاز</label><input type="text" id="new-serial" class="modern-input font-mono" placeholder="SN/000000"></div>
                </div>
                <div>
                    <label class="text-xs font-black text-slate-500 mr-1 uppercase text-indigo-600">كود تفعيل الشهر الأول (من المخزن)</label>
                    <select id="new-month1-code" class="modern-input font-black text-indigo-600 bg-indigo-50/30 border-indigo-100">
                        <option value="">-- اختر كود تفعيل متاح --</option>
                    </select>
                </div>
                <div><label class="text-xs font-black text-slate-500 mr-1 uppercase">العنوان السكني</label><input type="text" id="new-address" class="modern-input" placeholder="المنطقة - الحي"></div>
                <div><label class="text-xs font-black text-slate-500 mr-1 uppercase">مبلغ التسديد المبدئي</label><input type="number" id="new-payment" class="modern-input font-black text-emerald-600" value="0"></div>
                <div><label class="text-xs font-black text-slate-500 mr-1 uppercase">ملاحظات إضافية</label><textarea id="new-notes" class="modern-input leading-relaxed" rows="2"></textarea></div>
                <button id="btn-save-sub" onclick="saveNewSubscriber()" class="btn-primary mt-6">تأكيد البيانات وحفظ المشترك</button>
            </div>
        </div>
    </div>

    <!-- Modal: Financial Details -->
    <div id="modal-details" class="modal">
        <div class="modal-content !max-w-2xl !rounded-[3rem]">
            <div class="flex justify-between items-center mb-8 border-b pb-5">
                <h3 class="font-black text-2xl text-slate-800">سجل نشاط المشترك</h3>
                <button onclick="closeModals()" class="text-slate-400 p-3 rounded-2xl hover:bg-slate-50 transition-all"><i data-lucide="x"></i></button>
            </div>
            <div id="sub-details-content" class="space-y-8">
                <!-- Content will be injected -->
            </div>
        </div>
    </div>

    <!-- Modal: Renew Subscription -->
    <div id="modal-renew" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-8 border-b pb-5">
                <div>
                    <h3 class="font-black text-2xl text-slate-800">تجديد: <span id="renew-sub-name" class="text-indigo-600"></span></h3>
                    <p class="text-[11px] text-slate-400 font-bold mt-1 uppercase tracking-wider">إضافة فترة اشتراك جديدة</p>
                </div>
                <button onclick="closeModals()" class="text-slate-400 p-3 rounded-2xl hover:bg-slate-50"><i data-lucide="x"></i></button>
            </div>
            <div class="space-y-6">
                <div><label class="text-xs font-black text-slate-500 mr-1 uppercase">تاريخ التفعيل الجديد</label><input type="date" id="renew-date" class="modern-input"></div>
                <div><label class="text-xs font-black text-slate-500 mr-1 uppercase">الموظف المسؤول</label><input type="text" id="renew-emp" class="modern-input" placeholder="من قام بالتفعيل؟"></div>
                <div><label class="text-xs font-black text-slate-500 mr-1 uppercase">كود التجديد</label>
                    <select id="renew-code-select" class="modern-input font-bold text-indigo-700 bg-indigo-50/20"></select>
                </div>
                <div class="grid grid-cols-2 gap-5 items-end">
                    <div><label class="text-xs font-black text-slate-500 mr-1 uppercase">مدة الاشتراك</label>
                        <select id="renew-duration" class="modern-input font-black" onchange="calculatePrice()">
                            <option value="1">1 شهر</option>
                            <option value="3">3 شهر</option>
                            <option value="6">6 شهر</option>
                            <option value="12">1 سنة</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-xs font-black text-slate-500 mr-1 uppercase">السعر (قابل للتعديل)</label>
                        <input type="number" id="renew-price-input" class="modern-input font-black text-indigo-700 text-center !bg-indigo-50 border-indigo-200" value="0">
                    </div>
                </div>
                <div><label class="text-xs font-black text-slate-500 mr-1 uppercase">المبلغ المقبوض</label><input type="number" id="renew-paid" class="modern-input font-black text-emerald-600" placeholder="0"></div>
                <div><label class="text-xs font-black text-slate-500 mr-1 uppercase">ملاحظات التجديد</label><textarea id="renew-notes" class="modern-input" rows="2"></textarea></div>
                <button id="btn-save-renew" onclick="saveRenewal()" class="btn-primary mt-4">إتمام عملية التجديد</button>
            </div>
        </div>
    </div>

    <!-- Modal: Sell to Agent -->
    <div id="modal-agent-sale" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6 border-b pb-4">
                <div>
                    <h3 class="font-black text-xl text-slate-800">بيع كود لوكيل</h3>
                    <p class="text-[10px] text-slate-400 font-bold uppercase tracking-wider mt-1">تسجيل عملية بيع خارجية</p>
                </div>
                <button onclick="closeModals()" class="text-slate-400 p-2"><i data-lucide="x"></i></button>
            </div>
            <div class="space-y-5">
                <div class="bg-indigo-50 p-4 rounded-2xl border border-indigo-100">
                    <p class="text-[10px] font-black text-indigo-400 uppercase tracking-widest">الكود المختار</p>
                    <p id="agent-sale-code" class="text-xl font-black text-indigo-700 font-mono tracking-wider"></p>
                </div>
                <div>
                    <label class="text-xs font-black text-slate-500 mr-1 uppercase">المبلغ الواصل (د.ع)</label>
                    <input type="number" id="agent-sale-paid" class="modern-input font-black text-indigo-600" placeholder="0">
                </div>
                <div>
                    <label class="text-xs font-black text-slate-500 mr-1 uppercase">ملاحظات العملية (اسم الوكيل)</label>
                    <textarea id="agent-sale-notes" class="modern-input" rows="2" placeholder="اكتب اسم الوكيل أو ملاحظات..."></textarea>
                </div>
                <button onclick="saveAgentSale()" class="btn-primary mt-2">حفظ وتغيير حالة الكود</button>
            </div>
        </div>
    </div>

    <script>
        const db = new Dexie("ISP_DB");
        db.version(11).stores({
            subscribers: '++id, name, phone, serial',
            activations: '++id, subName, code, date',
            initialCodes: '++id, primary, status',
            renewalCodes: '++id, code, status',
            settings: '++id',
            syncQueue: '++id'
        });

        let isSyncing = false;
        let currentTab = 'home';
        let searchQuery = "";
        let showUsedCodes = false;
        let currentAgentCode = null;

        let APP_STATE = { 
            data: { subscribers: [], activations: [], initialCodes: [], renewalCodes: [], settings: {} },
            scriptURL: localStorage.getItem('gas_url') || ""
        };

        async function initDB() {
            try { 
                await db.open(); 
            } catch (err) { 
                console.error("Database mismatch. Resetting...");
                await db.delete(); 
                location.reload(); 
            }
        }

        const router = (tab) => {
            currentTab = tab;
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            const navBtn = document.getElementById(`nav-${tab}`);
            if (navBtn) navBtn.classList.add('active');
            const fab = document.getElementById('fab');
            if (fab) fab.style.display = (tab === 'subs') ? 'flex' : 'none';
            renderTab(tab);
        };

        function calculateDebt(sub) {
            if (!sub) return 0;
            let debt = 0;
            const settings = APP_STATE.data.settings || {};
            const firstMonthPrice = parseFloat(settings.firstMonthPrice || 0);
            const paidInitial = parseFloat(sub.payment || 0);
            if (isNaN(paidInitial) || paidInitial === 0) { debt += firstMonthPrice; }
            const activations = APP_STATE.data.activations || [];
            const subName = String(sub.name || "").trim();
            const subActivations = activations.filter(a => a && String(a.subName || "").trim() === subName);
            subActivations.forEach(act => {
                const price = parseFloat(act.price || 0);
                const paid = parseFloat(act.paid || 0);
                if (!isNaN(price) && !isNaN(paid)) { debt += (price - paid); }
            });
            return isNaN(debt) ? 0 : debt;
        }

        async function loadLocal() {
            try {
                if (!db.isOpen()) await initDB();
                APP_STATE.data.subscribers = await db.subscribers.toArray() || [];
                APP_STATE.data.activations = await db.activations.toArray() || [];
                APP_STATE.data.initialCodes = await db.initialCodes.toArray() || [];
                APP_STATE.data.renewalCodes = await db.renewalCodes.toArray() || [];
                const sett = await db.settings.toCollection().first();
                APP_STATE.data.settings = sett || {};
                renderTab(currentTab);
            } catch (err) { console.error("Load failure", err); }
        }

        async function fetchFromSheet() {
            if (!navigator.onLine || !APP_STATE.scriptURL) return;
            updateSyncUI("جاري الجلب...", "loading");
            try {
                const res = await fetch(APP_STATE.scriptURL, { method: 'GET', redirect: 'follow' });
                const json = await res.json();
                await db.subscribers.clear();
                if (json.subscribers && json.subscribers.length > 1) {
                    await db.subscribers.bulkAdd(json.subscribers.slice(1).map(r => ({
                        t: r[0], date: r[1], name: String(r[2] || "").trim(), phone: String(r[3] || "").trim(), serial: String(r[4] || "").trim(), 
                        m1: String(r[5] || ""), address: String(r[6] || "").trim(), payment: r[7], actDate: r[8], notes: String(r[9] || "")
                    })));
                }
                await db.activations.clear();
                if (json.activations && json.activations.length > 1) {
                    await db.activations.bulkAdd(json.activations.slice(1).map(r => ({
                        t: r[0], date: r[1], subName: String(r[2] || "").trim(), emp: String(r[3] || "").trim(), code: String(r[4] || "").trim(), duration: r[5], price: r[6], paid: r[7]
                    })));
                }
                await db.initialCodes.clear();
                if (json.initialCodes && json.initialCodes.length > 1) {
                    await db.initialCodes.bulkAdd(json.initialCodes.slice(1).map(r => ({
                        t: r[0], primary: String(r[1] || "").trim(), code: String(r[2] || "").trim(), nid: r[3], status: String(r[4] || "").trim(), usedBy: String(r[5] || "").trim()
                    })));
                }
                await db.renewalCodes.clear();
                if (json.renewalCodes && json.renewalCodes.length > 1) {
                    await db.renewalCodes.bulkAdd(json.renewalCodes.slice(1).map(r => ({
                        t: r[0], code: String(r[1] || "").trim(), status: String(r[4] || "").trim(), notes: String(r[5] || "").trim(), paidAmount: r[6]
                    })));
                }
                await db.settings.clear();
                await db.settings.add({ monthlyPrice: json.settings?.[1]?.[0] || 0, firstMonthPrice: json.settings?.[1]?.[1] || 0 });
                await loadLocal();
                updateSyncUI("محدث", "success");
            } catch (e) { updateSyncUI("خطأ اتصال", "error"); }
        }

        async function syncNow() {
            if (isSyncing) return;
            const queue = await db.syncQueue.toArray();
            if (queue.length === 0 || !navigator.onLine || !APP_STATE.scriptURL) return;
            isSyncing = true;
            updateSyncUI("جاري الرفع...", "loading");
            try {
                await fetch(APP_STATE.scriptURL, { 
                    method: 'POST', 
                    mode: 'no-cors', 
                    headers: {'Content-Type': 'text/plain'},
                    body: JSON.stringify({ updates: queue }) 
                });
                await db.syncQueue.clear();
                updateSyncUI("تم الرفع", "success");
                setTimeout(fetchFromSheet, 2500); 
            } catch (e) { updateSyncUI("فشل الرفع", "error"); }
            finally { isSyncing = false; }
        }

        function updateSyncUI(text, type) {
            const statusBox = document.getElementById("sync-status");
            const statusText = document.getElementById("sync-text");
            const statusIcon = document.getElementById("sync-icon");
            if (!statusBox || !statusText || !statusIcon) return;
            statusText.innerText = text;
            statusIcon.classList.remove('sync-loading', 'text-green-500', 'text-red-500', 'text-amber-500');
            if (type === "loading") statusIcon.classList.add('sync-loading', 'text-amber-500');
            else if (type === "success") statusIcon.classList.add('text-green-500');
            else if (type === "error") statusIcon.classList.add('text-red-500');
        }

        function renderTab(tab) {
            const c = document.getElementById('content');
            if (!c) return;
            c.innerHTML = '';
            if (tab === 'home') renderHomeView(c);
            else if (tab === 'subs') renderSubsView(c);
            else if (tab === 'init_codes') renderCodesView('initialCodes');
            else if (tab === 'codes') renderCodesView('renewalCodes');
            else if (tab === 'settings') renderSettingsView(c);
            lucide.createIcons();
        }

        function renderHomeView(c) {
            const subs = APP_STATE.data.subscribers || [];
            const unusedRenewal = (APP_STATE.data.renewalCodes || []).filter(c => c && c.status === "غير مستخدم").length;
            c.innerHTML = `
                <div class="grid grid-cols-2 gap-5 animate-in fade-in duration-500">
                    <div class="glass-card p-7 bg-indigo-600 text-white shadow-2xl shadow-indigo-100 ring-4 ring-indigo-50 border-none">
                        <h4 class="text-xs font-black opacity-80 tracking-widest uppercase">المشتركين</h4>
                        <h2 class="text-5xl font-black mt-2 leading-none">${subs.length}</h2>
                    </div>
                    <div class="glass-card p-7 bg-white shadow-sm border border-slate-100">
                        <h4 class="text-xs font-black text-slate-400 tracking-widest uppercase">كود تجديد متاح</h4>
                        <h2 class="text-4xl font-black text-indigo-600 mt-2 leading-none">${unusedRenewal}</h2>
                    </div>
                </div>
                <div class="glass-card p-6 bg-white border border-slate-100 mt-2 flex justify-between items-center shadow-lg shadow-slate-100 active:scale-95">
                    <div class="flex items-center gap-5">
                        <div class="w-14 h-14 bg-amber-50 text-amber-500 rounded-2xl flex items-center justify-center border border-amber-100"><i data-lucide="cloud-off" class="w-7 h-7"></i></div>
                        <div><p class="text-[11px] font-black text-slate-400 uppercase tracking-wider">عمليات معلقة</p><p class="text-2xl font-black text-slate-800 leading-none mt-1" id="queue-count">0</p></div>
                    </div>
                    <button onclick="syncNow()" class="px-8 py-4 bg-indigo-600 text-white rounded-2xl font-black text-xs hover:bg-indigo-700 transition-all shadow-lg shadow-indigo-200">مزامنة البيانات</button>
                </div>
            `;
            db.syncQueue.count().then(count => { if(document.getElementById('queue-count')) document.getElementById('queue-count').innerText = count; });
        }

        function renderSubsView(c) {
            c.innerHTML = `
                <div class="glass-card p-4 bg-white border border-slate-100 mb-6 flex items-center gap-4 shadow-sm focus-within:ring-4 focus-within:ring-indigo-100 transition-all border-b-4 border-b-indigo-500">
                    <i data-lucide="search" class="text-slate-400 w-6 h-6"></i>
                    <input type="text" id="search-sub" class="bg-transparent border-none outline-none w-full text-base font-bold placeholder:text-slate-300" 
                           placeholder="البحث بالاسم، الهاتف، أو السيريال..." value="${searchQuery}" oninput="searchSubs(this.value)">
                </div>
                <div id="subs-list-container" class="space-y-4 pb-10"></div>
            `;
            renderSubsList();
        }

        function renderSubsList() {
            const listContainer = document.getElementById('subs-list-container');
            if (!listContainer) return;
            const subs = APP_STATE.data.subscribers || [];
            const q = searchQuery.toLowerCase().trim();
            const filteredSubs = subs.filter(s => {
                if (!s) return false;
                return (s.name || "").toLowerCase().includes(q) || (s.phone || "").toLowerCase().includes(q) || (s.serial || "").toLowerCase().includes(q);
            });
            listContainer.innerHTML = filteredSubs.length === 0 ? '<div class="text-center py-20 opacity-20 font-black">لا توجد نتائج</div>' :
                filteredSubs.map(s => {
                    const debt = calculateDebt(s);
                    const safeName = String(s.name || "بدون اسم").replace(/'/g, "\\'");
                    return `<div class="glass-card p-5 space-y-3 relative border border-slate-100 shadow-md active:scale-95 transition-all cursor-pointer hover:bg-slate-50/50 shadow-slate-200/50" onclick="openSubDetails('${safeName}')">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <h3 class="font-black text-slate-800 text-lg leading-tight">${s.name || "بدون اسم"}</h3>
                                <div class="flex items-center gap-3 mt-2">
                                    <button onclick="event.stopPropagation(); copyTxt('${s.phone}')" class="text-xs text-slate-400 font-bold flex items-center gap-1 hover:text-indigo-600 transition-colors">
                                        <i data-lucide="smartphone" class="w-3 h-3"></i> ${s.phone || '-'} <i data-lucide="copy" class="w-2.5 h-2.5 ml-1 opacity-50"></i>
                                    </button>
                                    <span class="text-xs ${debt > 0 ? 'text-red-500 bg-red-50' : 'text-green-600 bg-green-50'} font-black px-3 py-1 rounded-full flex items-center gap-1">
                                        <i data-lucide="wallet" class="w-3 h-3"></i> الدين: ${debt.toLocaleString()} د.ع
                                    </span>
                                </div>
                            </div>
                            <button onclick="event.stopPropagation(); openRenewModal('${safeName}')" class="w-14 h-14 bg-indigo-600 text-white rounded-[1.25rem] flex items-center justify-center shadow-xl shadow-indigo-100 active:rotate-12 transition-all">
                                <i data-lucide="zap" class="w-7 h-7"></i>
                            </button>
                        </div>
                        <div class="text-[10px] grid grid-cols-2 gap-3 text-slate-400 border-t border-slate-50 pt-4 mt-2 font-bold uppercase tracking-widest">
                            <button onclick="event.stopPropagation(); copyTxt('${s.serial}')" class="flex items-center gap-2 bg-slate-50 p-1.5 rounded-lg hover:text-indigo-600">
                                <i data-lucide="cpu" class="w-3.5 h-3.5 text-indigo-400"></i> ${s.serial || '-'} <i data-lucide="copy" class="w-3 h-3 opacity-50"></i>
                            </button>
                            <span class="flex items-center gap-2 bg-slate-50 p-1.5 rounded-lg"><i data-lucide="map-pin" class="w-3.5 h-3.5 text-indigo-400"></i> ${s.address || '-'}</span>
                        </div>
                    </div>`;
                }).join('');
            lucide.createIcons();
        }

        function renderCodesView(type) {
            const list = APP_STATE.data[type] || [];
            const isInit = type === 'initialCodes';
            const unused = list.filter(c => c && c.status === "غير مستخدم");
            const used = list.filter(c => c && c.status === "مستخدم");
            const activeList = showUsedCodes ? used : unused;
            const c = document.getElementById('content');
            c.innerHTML = `
                <div class="glass-card p-6 bg-white border border-slate-100 mb-6 space-y-5 shadow-lg shadow-slate-100">
                    <h3 class="font-black text-base text-slate-800 flex items-center gap-3">
                        <i data-lucide="plus-circle" class="w-6 h-6 text-indigo-600"></i> إضافة مخزون كودات ${isInit ? 'تفعيل (أول شهر)' : 'تجديد'}
                    </h3>
                    <textarea id="multi-codes" class="modern-input h-32 leading-relaxed font-mono text-sm border-2 border-indigo-50" placeholder="ألصق مجموعة كودات هنا (كل كود في سطر)..."></textarea>
                    <button onclick="saveMultiCodes('${type}')" class="btn-primary">حفظ الكودات في المخزن</button>
                </div>
                <div class="flex gap-3 mb-5 p-2 bg-slate-200/50 rounded-2xl shadow-inner">
                    <button onclick="toggleCodes(false)" class="flex-1 py-3 text-xs font-black rounded-xl transition-all ${!showUsedCodes?'bg-white text-indigo-600 shadow-md':'text-slate-500'}">متاحة (${unused.length})</button>
                    <button onclick="toggleCodes(true)" class="flex-1 py-3 text-xs font-black rounded-xl transition-all ${showUsedCodes?'bg-white text-indigo-600 shadow-md':'text-slate-500'}">مستخدمة (${used.length})</button>
                </div>
                <div class="space-y-3">
                    ${activeList.map(i => {
                        const codeVal = isInit ? (i.primary || i.code) : i.code;
                        return `<div class="glass-card p-5 border border-slate-100 flex justify-between items-center text-sm bg-white hover:border-indigo-200 transition-colors shadow-sm">
                            <div class="flex-1">
                                <span class="font-mono font-black text-slate-700 text-base tracking-widest">${codeVal}</span>
                                ${isInit && i.usedBy ? `<div class="text-[10px] text-indigo-500 font-bold mt-2 uppercase flex items-center gap-1 font-black"><i data-lucide="user" class="w-3 h-3"></i> ${i.usedBy}</div>` : ''}
                                ${!isInit && i.notes ? `<div class="text-[9px] text-slate-400 mt-1 uppercase font-bold">${i.notes}</div>` : ''}
                            </div>
                            <div class="flex gap-2 items-center">
                                ${(!isInit && i.status === 'غير مستخدم') ? `
                                    <button onclick="openAgentSaleModal('${codeVal}')" class="w-9 h-9 bg-indigo-50 text-indigo-600 rounded-xl flex items-center justify-center hover:bg-indigo-600 hover:text-white transition-all">
                                        <i data-lucide="shopping-cart" class="w-4 h-4"></i>
                                    </button>
                                ` : ''}
                                <span class="text-[10px] font-black px-4 py-2 rounded-xl ${i.status==='مستخدم'?'bg-red-50 text-red-600 border border-red-100':'bg-green-50 text-green-600 border border-green-100'}">${i.status}</span>
                            </div>
                        </div>`;
                    }).join('')}
                </div>
            `;
            lucide.createIcons();
        }

        function renderSettingsView(c) {
            c.innerHTML = `
                <div class="glass-card p-8 bg-white border border-slate-100 space-y-6 shadow-2xl shadow-slate-100">
                    <div class="flex items-center gap-4 border-b border-slate-50 pb-6">
                        <div class="w-14 h-14 bg-indigo-50 text-indigo-600 rounded-3xl flex items-center justify-center shadow-inner"><i data-lucide="settings-2" class="w-7 h-7"></i></div>
                        <div>
                            <h3 class="font-black text-xl text-slate-800 leading-none">إعدادات النظام</h3>
                            <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest mt-2">تخصيص الربط وإدارة الكاش</p>
                        </div>
                    </div>
                    <div>
                        <label class="text-[11px] font-black text-slate-400 uppercase tracking-widest mr-2 mb-2 block">رابط محرك البيانات (GAS URL)</label>
                        <input type="text" id="gas-url" class="modern-input font-mono text-[11px] tracking-tighter shadow-sm" value="${APP_STATE.scriptURL}" placeholder="https://script.google.com/macros/s/...">
                    </div>
                    <button onclick="saveGasUrl()" class="btn-primary flex items-center justify-center gap-2 transition-transform active:scale-95"><i data-lucide="save" class="w-5 h-5"></i> حفظ إعدادات الاتصال</button>
                    <div class="pt-8 border-t border-slate-50 space-y-4">
                         <h4 class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2 flex items-center gap-2"><i data-lucide="database" class="w-4 h-4"></i> صيانة قاعدة البيانات</h4>
                         <button onclick="fetchFromSheet()" class="w-full bg-slate-50 text-slate-800 py-4 rounded-2xl font-black text-xs border border-slate-200 hover:bg-white hover:border-indigo-200 transition-all flex items-center justify-center gap-2"><i data-lucide="refresh-cw" class="w-5 h-5"></i> تحديث شامل وفوري من السحابة</button>
                         <button onclick="clearCache()" class="w-full text-red-500 py-3 text-[10px] font-black uppercase tracking-[0.2em] hover:bg-red-50 rounded-xl transition-all border border-transparent hover:border-red-100">حذف كافة البيانات المخزنة محلياً</button>
                    </div>
                </div>
            `;
            lucide.createIcons();
        }

        function searchSubs(q) { searchQuery = q; renderSubsList(); }
        function toggleCodes(v) { showUsedCodes = v; renderTab(currentTab); }

        async function openSubDetails(name) {
            const sub = APP_STATE.data.subscribers.find(s => s && String(s.name || "").trim() === String(name).trim());
            if(!sub) return;
            const acts = (APP_STATE.data.activations || []).filter(a => a && String(a.subName || "").trim() === String(name).trim());
            const firstPrice = parseFloat(APP_STATE.data.settings?.firstMonthPrice || 0);
            const content = document.getElementById('sub-details-content');
            content.innerHTML = `
                <div class="bg-indigo-600 p-8 rounded-[2.5rem] text-white shadow-2xl shadow-indigo-100 flex justify-between items-center overflow-hidden relative">
                    <div class="absolute -right-4 -top-4 w-28 h-28 bg-white/10 rounded-full blur-2xl"></div>
                    <div class="relative z-10">
                        <span class="text-[10px] font-black opacity-70 uppercase tracking-[0.2em]">صافي المبالغ المستحقة</span>
                        <h2 class="text-4xl font-black mt-2 leading-none">${calculateDebt(sub).toLocaleString()} <span class="text-sm font-bold opacity-80 uppercase tracking-tighter">IQD</span></h2>
                    </div>
                    <i data-lucide="file-text" class="w-14 h-14 opacity-20"></i>
                </div>
                <div class="space-y-5">
                    <h4 class="font-black text-xs text-slate-400 uppercase tracking-[0.2em] flex items-center gap-3"><span class="w-10 h-[2px] bg-indigo-200"></span> السجل التاريخي للعمليات</h4>
                    <div class="p-6 border border-slate-100 rounded-[2rem] flex justify-between items-center bg-white shadow-sm hover:shadow-md transition-all">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 bg-indigo-50 text-indigo-600 rounded-2xl flex items-center justify-center shadow-inner"><i data-lucide="award" class="w-6 h-6"></i></div>
                            <div><p class="font-black text-slate-800 text-base">عقد البيع الأول</p><p class="text-[10px] text-slate-400 font-black">${sub.date || '-'}</p></div>
                        </div>
                        <div class="text-right"><p class="text-base font-black text-slate-700">${firstPrice.toLocaleString()} د.ع</p><p class="text-[10px] ${parseFloat(sub.payment)>0?'text-green-500':'text-red-500'} font-black tracking-widest uppercase mt-1 inline-block">${parseFloat(sub.payment)>0?'واصل':'مطلوب'}</p></div>
                    </div>
                    ${acts.map(a => `<div class="p-6 border border-slate-100 rounded-[2rem] flex flex-col gap-4 bg-white shadow-sm hover:shadow-md transition-all">
                        <div class="flex justify-between items-center">
                            <div class="flex items-center gap-4">
                                <div class="w-12 h-12 bg-emerald-50 text-emerald-600 rounded-2xl flex items-center justify-center shadow-inner"><i data-lucide="repeat" class="w-6 h-6"></i></div>
                                <div>
                                    <p class="font-black text-slate-800 text-base">تجديد: ${a.duration}</p>
                                    <p class="text-[10px] text-slate-400 font-black">${a.date} | كود: ${a.code}</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="text-base font-black text-slate-700">${parseFloat(a.price || 0).toLocaleString()} د.ع</p>
                                <p class="text-[10px] ${parseFloat(a.paid)>=parseFloat(a.price)?'text-green-500':'text-amber-500'} font-black tracking-widest uppercase mt-1 border px-2 py-0.5 rounded-lg border-current inline-block">${parseFloat(a.paid)>=parseFloat(a.price)?'كامل التسديد':`واصل: ${parseFloat(a.paid).toLocaleString()}`}</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-2 text-[9px] font-black text-slate-400 uppercase tracking-wider border-t border-slate-50 pt-2">
                            <i data-lucide="user-check" class="w-3 h-3"></i> بواسطة الموظف: <span class="text-indigo-500">${a.emp || 'غير مسجل'}</span>
                        </div>
                    </div>`).join('')}
                </div>`;
            document.getElementById('modal-details').classList.add('active');
            lucide.createIcons();
        }

        function openAddSubModal() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('new-sale-date').value = today;
            document.getElementById('new-act-date').value = today;
            const codes = (APP_STATE.data.initialCodes || []).filter(c => c && c.status === "غير مستخدم");
            const select = document.getElementById('new-month1-code');
            if (select) select.innerHTML = `<option value="">-- اختر كود متاح --</option>` + codes.map(c => `<option value="${String(c.primary).trim()}">${String(c.primary).trim()}</option>`).join('');
            document.getElementById('modal-sub').classList.add('active');
            lucide.createIcons();
        }

        async function openRenewModal(name) {
            const nameEl = document.getElementById('renew-sub-name');
            const dateEl = document.getElementById('renew-date');
            if(nameEl) nameEl.innerText = name;
            if(dateEl) dateEl.value = new Date().toISOString().split('T')[0];
            const codes = (APP_STATE.data.renewalCodes || []).filter(c => c && c.status === "غير مستخدم");
            const select = document.getElementById('renew-code-select');
            if(select) select.innerHTML = codes.length > 0 ? codes.map(c => `<option value="${String(c.code).trim()}">${String(c.code).trim()}</option>`).join('') : '<option value="">لا يوجد كودات تجديد متوفرة</option>';
            calculatePrice();
            document.getElementById('modal-renew').classList.add('active');
            lucide.createIcons();
        }

        function openAgentSaleModal(code) {
            currentAgentCode = code;
            document.getElementById('agent-sale-code').innerText = code;
            document.getElementById('agent-sale-paid').value = "0";
            document.getElementById('agent-sale-notes').value = "";
            document.getElementById('modal-agent-sale').classList.add('active');
        }

        function calculatePrice() {
            const dur = parseInt(document.getElementById('renew-duration').value);
            const monthly = parseFloat(APP_STATE.data.settings?.monthlyPrice || 0);
            const input = document.getElementById('renew-price-input');
            if(input) input.value = dur * monthly;
        }

        async function saveNewSubscriber() {
            const btn = document.getElementById('btn-save-sub');
            const name = document.getElementById('new-name').value.trim();
            const initCodeRaw = document.getElementById('new-month1-code').value;
            const initCode = String(initCodeRaw).trim();
            if(!name) return alert("يرجى إدخال اسم المشترك الكامل");
            if(!initCode || initCode === "") return alert("يرجى اختيار كود تفعيل");
            btn.disabled = true;
            try {
                const subData = [Date.now(), document.getElementById('new-sale-date').value, name, document.getElementById('new-phone').value, document.getElementById('new-serial').value, "مفعل", document.getElementById('new-address').value, document.getElementById('new-payment').value, document.getElementById('new-act-date').value, document.getElementById('new-notes').value];
                await db.subscribers.add({ date: subData[1], name: subData[2], phone: subData[3], serial: subData[4], m1: subData[5], address: subData[6], payment: subData[7], actDate: subData[8], notes: subData[9] });
                await db.initialCodes.where('primary').equals(initCode).modify({ status: 'مستخدم', usedBy: name });
                await db.syncQueue.add({ sheetName: "جدول معلومات المشتركين", action: "add", data: subData });
                await db.syncQueue.add({ sheetName: "جدول كودات التفعيل", action: "update_initial_code", code: initCode, usedBy: name });
                closeModals();
                await loadLocal();
                syncNow();
            } catch(e) { console.error("Save failure", e); } 
            finally { btn.disabled = false; }
        }

        async function saveRenewal() {
            const btn = document.getElementById('btn-save-renew');
            const name = document.getElementById('renew-sub-name').innerText;
            const code = String(document.getElementById('renew-code-select').value).trim();
            if(!code || code === "") return alert("يرجى اختيار كود");
            btn.disabled = true;
            try {
                const dur = document.getElementById('renew-duration');
                const finalPrice = document.getElementById('renew-price-input').value;
                const data = [Date.now(), document.getElementById('renew-date').value, name, document.getElementById('renew-emp').value, code, dur.options[dur.selectedIndex].text, finalPrice, document.getElementById('renew-paid').value, new Date().toLocaleDateString()];
                await db.renewalCodes.where('code').equals(code).modify({ status: 'مستخدم' });
                await db.syncQueue.add({ sheetName: "جدول التفعيل", action: "add", data: data });
                await db.syncQueue.add({ sheetName: "جدول كودات التجديد", action: "update_code", code: code, notes: String(document.getElementById('renew-notes').value || "") });
                closeModals();
                await loadLocal();
                syncNow();
            } catch(e) { console.error(e); } finally { btn.disabled = false; }
        }

        async function saveAgentSale() {
            if(!currentAgentCode) return;
            const paid = document.getElementById('agent-sale-paid').value;
            const notes = document.getElementById('agent-sale-notes').value.trim();
            
            // تحديث محلي
            await db.renewalCodes.where('code').equals(currentAgentCode).modify({ 
                status: 'مستخدم', 
                notes: notes,
                paidAmount: paid 
            });

            // إضافة للمزامنة - إجراء خاص لتحديث الحالة والملاحظات والمبلغ
            await db.syncQueue.add({ 
                sheetName: "جدول كودات التجديد", 
                action: "update_agent_sale", 
                code: currentAgentCode, 
                notes: notes,
                paid: paid
            });

            closeModals();
            await loadLocal();
            syncNow();
        }

        async function saveMultiCodes(type) {
            const txtArea = document.getElementById('multi-codes');
            const codes = txtArea.value.trim().split(/[\n, ]+/).filter(c => c.length > 0);
            if(codes.length === 0) return;
            let ts = Date.now();
            const sheetName = type === 'initialCodes' ? "جدول كودات التفعيل" : "جدول كودات التجديد";
            for (const code of codes) {
                const cleanCode = String(code).trim();
                if (type === 'initialCodes') {
                    const data = [ts++, cleanCode, cleanCode, "1244", "غير مستخدم", ""];
                    await db.initialCodes.add({ primary: cleanCode, code: cleanCode, nid: "1244", status: "غير مستخدم", usedBy: "" });
                    await db.syncQueue.add({ sheetName, action: "add", data: data });
                } else {
                    const data = [ts++, cleanCode, "", "", "غير مستخدم", "", ""];
                    await db.renewalCodes.add({ code: cleanCode, status: "غير مستخدم", notes: "", paidAmount: 0 });
                    await db.syncQueue.add({ sheetName, action: "add", data: data });
                }
            }
            txtArea.value = "";
            alert("تم إيداع " + codes.length + " كود جديد وجدولة رفعها");
            await loadLocal();
            syncNow();
        }

        function copyTxt(t) { 
            if(!t || t === '-') return;
            navigator.clipboard.writeText(t).then(() => {
                const toast = document.getElementById('toast');
                toast.innerText = 'تم نسخ: ' + t;
                toast.style.display = 'block';
                setTimeout(() => toast.style.display = 'none', 2000);
            });
        }

        function closeModals() { document.querySelectorAll('.modal').forEach(m => m.classList.remove('active')); currentAgentCode = null; }
        function saveGasUrl() { localStorage.setItem('gas_url', document.getElementById('gas-url').value); APP_STATE.scriptURL = document.getElementById('gas-url').value; fetchFromSheet(); }
        async function clearCache() { if(confirm("تحذير: سيتم مسح كافة البيانات المحلية وإعادة تحميل التطبيق، هل تود الاستمرار؟")) { await db.delete(); location.reload(); } }

        window.onload = async () => {
            await initDB();
            await loadLocal();
            if (APP_STATE.scriptURL) fetchFromSheet();
            setInterval(syncNow, 60000);
        };
    </script>
</body>
</html>
