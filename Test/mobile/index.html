<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>نظام إدارة الاشتراكات</title>
    <meta name="theme-color" content="#4a90e2">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="images/icon-192x192.png">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Almarai:wght@400;700&family=Cairo:wght@400;700&family=El+Messiri:wght@400;700&family=Lalezar&family=Noto+Sans+Arabic:wght@400;700&family=Readex+Pro:wght@400;700&family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
    
    <style id="print-style-sheet"></style>
    <style>
        /* General Styles & Theming (Mobile-First) */
        :root {
            --primary-color: #4a90e2;
            --primary-color-dark: #357ABD;
            --primary-color-light: #EAF2FB;
            --text-color: #333;
            --text-color-light: #7f8c8d;
            --bg-color: #f4f7fa;
            --surface-color: #ffffff;
            --border-color: #e8eef3;
            --danger-color: #e74c3c;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
            --shadow: 0 4px 15px rgba(0, 0, 0, 0.07);
            --selected-row-bg: #dbeafe;
            --main-font: 'Cairo', sans-serif;
        }

        .dark-mode {
            --text-color: #e0e0e0;
            --text-color-light: #95a5a6;
            --bg-color: #121212;
            --surface-color: #1e1e1e;
            --border-color: #2d2d2d;
            --primary-color-light: rgba(74, 144, 226, 0.1);
            --selected-row-bg: rgba(74, 144, 226, 0.15);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }

        /* Professional Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background-color: var(--primary-color);
            border-radius: 6px;
        }
        
        html { scroll-behavior: smooth; }

        body {
            font-family: var(--main-font);
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
            font-size: 16px;
            line-height: 1.7;
            padding-bottom: 80px; /* Space for bottom nav */
            -webkit-user-select: none; /* Safari */
            -ms-user-select: none; /* IE 10+ */
            user-select: none; /* Standard syntax */
        }
        
        /* Allow text selection on inputs */
        input, textarea {
            -webkit-user-select: auto;
            -ms-user-select: auto;
            user-select: auto;
        }


        /* Layout */
        .page {
            display: none;
            padding: 15px;
            animation: fadeIn 0.4s ease-in-out;
        }
        .page.active {
            display: block;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .page-header h1 { 
            font-size: 1.8rem; 
            font-weight: 700; 
        }
        #profile-page .page-header h1 {
             font-size: 1.6rem; /* Specific smaller size for profile page */
        }
        .header-actions { display: flex; gap: 5px; }
        .header-actions .btn { padding: 8px 10px; font-size: 0.8rem; }

        /* Responsive Grid Container */
        .grid-container {
            display: grid;
            gap: 15px;
            margin-bottom: 15px;
        }
        .stats-grid {
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        }
        .charts-grid, .lists-grid {
            grid-template-columns: 1fr; /* Default for mobile */
        }
        .chart-container {
            position: relative;
            height: 250px;
            width: 100%;
        }

        /* Responsive adjustments for tablets and larger screens */
        @media (min-width: 640px) {
            .charts-grid, .lists-grid {
                grid-template-columns: 1fr 1fr;
            }
        }


        /* Bottom Navigation */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; right: 0; height: 70px;
            background-color: var(--surface-color); display: flex;
            justify-content: space-around; align-items: center;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.08); z-index: 1000;
            border-top: 1px solid var(--border-color);
        }
        .nav-btn {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: none; border: none; color: var(--text-color-light);
            font-family: var(--main-font); font-size: 0.75rem;
            flex-grow: 1; height: 100%; transition: color 0.2s, transform 0.2s;
        }
        .nav-btn i { font-size: 1.5rem; margin-bottom: 4px; }
        .nav-btn.active { color: var(--primary-color); transform: translateY(-2px); }
        
        /* Components */
        .card {
            background-color: var(--surface-color); border-radius: 16px;
            padding: 20px; box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            margin-bottom: 15px;
        }
        
        .stat-card { display: flex; align-items: center; gap: 15px; padding: 15px; }
        .stat-card .icon {
            font-size: 1.5rem; width: 45px; height: 45px; border-radius: 12px; color: #fff;
            display: flex; align-items: center; justify-content: center; flex-shrink: 0;
        }
        .stat-card .info { flex-grow: 1; }
        .stat-card .info h3 { font-size: 1.5rem; font-weight: 700; margin: 0; word-break: break-all; }
        .stat-card .info h3.small-font { font-size: 1.2rem; }
        .stat-card .info p { font-size: 0.9rem; color: var(--text-color-light); margin: 0; }

        .btn {
            padding: 12px 20px; border: none; border-radius: 12px; cursor: pointer;
            font-size: 1rem; font-weight: 600; transition: all 0.2s; text-decoration: none;
            display: inline-flex; align-items: center; justify-content: center; gap: 8px; font-family: inherit;
        }
        .btn-sm { padding: 8px 12px; font-size: 0.85rem; border-radius: 8px; }
        .btn-primary { background-color: var(--primary-color); color: #fff; }
        .btn-primary:active { background-color: var(--primary-color-dark); }
        .btn-secondary { background-color: var(--primary-color-light); color: var(--primary-color); }
        .btn-danger { background-color: var(--danger-color); color: #fff; }
        .btn-success { background-color: var(--success-color); color: #fff; }
        .btn-info { background-color: #3498db; color: #fff; }
        .btn-warning { background-color: var(--warning-color); color: #fff; }

        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 0.95rem; }
        .form-control {
            width: 100%; padding: 12px 15px; border-radius: 10px; border: 1px solid var(--border-color);
            background-color: var(--bg-color); color: var(--text-color); font-size: 1rem; font-family: inherit;
        }
        textarea.form-control { resize: vertical; }

        /* Toggle Switch */
        .switch { position: relative; display: inline-block; width: 50px; height: 25px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; }
        .slider:before {
            position: absolute; content: ""; height: 19px; width: 19px;
            left: 3px; bottom: 3px; background-color: white; transition: .4s;
        }
        input:checked + .slider { background-color: var(--success-color); }
        input:checked + .slider:before { transform: translateX(25px); }
        .slider.round { border-radius: 25px; }
        .slider.round:before { border-radius: 50%; }

        /* Modal Styles */
        .modal {
            display: none; position: fixed; z-index: 2000; left: 0; top: 0;
            width: 100%; height: 100%; overflow: hidden; background-color: rgba(0, 0, 0, 0.5);
            -webkit-backdrop-filter: blur(5px); backdrop-filter: blur(5px);
        }
        .modal.active { display: flex; flex-direction: column; justify-content: flex-end; }
        .modal-content {
            background-color: var(--surface-color); border-top-left-radius: 20px; border-top-right-radius: 20px;
            width: 100%; max-height: 90vh; display: flex; flex-direction: column;
            animation: slideUp 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
        }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .modal-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px 20px; border-bottom: 1px solid var(--border-color); flex-shrink: 0;
        }
        .modal-header h2 { font-size: 1.3rem; }
        .close-btn { font-size: 1.8rem; color: var(--text-color-light); cursor: pointer; }
        .modal-body { padding: 20px; overflow-y: auto; }
        .modal-tabs {
            display: flex; background-color: var(--primary-color-light); padding: 0 10px;
            flex-wrap: wrap; justify-content: center;
        }
        .tab-link {
            padding: 12px 10px; cursor: pointer; border-bottom: 3px solid transparent;
            transition: all 0.3s; font-weight: 500; font-size: 0.9rem;
        }
        .tab-link.active { color: var(--primary-color); border-bottom-color: var(--primary-color); }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.4s; }

        /* Table Styles (for modals and other pages) */
        .table-responsive { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; text-align: right; }
        th, td { padding: 10px; border-bottom: 1px solid var(--border-color); vertical-align: middle; font-size: 0.9rem; }
        tbody tr:hover { background-color: var(--primary-color-light); }
        
        /* Status Badge */
        .status-badge {
            padding: 4px 10px; border-radius: 20px; font-weight: bold;
            font-size: 0.75em; color: white; display: inline-block;
        }
        .status-badge.active { background-color: var(--success-color); }
        .status-badge.expired { background-color: var(--danger-color); }
        .status-badge.expiring_soon { background-color: var(--warning-color); }

        /* Filter Bar */
        .filter-bar {
            display: flex; gap: 10px; margin-bottom: 20px; overflow-x: auto;
            padding-bottom: 10px; scrollbar-width: none;
        }
        .filter-bar::-webkit-scrollbar { display: none; }
        .filter-btn {
            padding: 8px 15px; border-radius: 20px; border: 1px solid var(--border-color);
            background-color: var(--surface-color); color: var(--text-color); white-space: nowrap; font-size: 0.9rem;
        }
        .filter-btn.active { background-color: var(--primary-color); color: white; border-color: var(--primary-color); }

        /* Subscriber List Item (Card View) */
        .sub-list-item {
            background-color: var(--surface-color);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
        }
        .sub-list-item input[type="checkbox"] {
            flex-shrink: 0;
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        .sub-list-item .info {
            flex-grow: 1;
        }
        .sub-list-item .info h4 {
            font-weight: 600;
            margin: 0 0 4px 0;
            pointer-events: none;
        }
        .sub-list-item .info p {
            font-size: 0.85rem;
            color: var(--text-color-light);
            margin: 0;
            pointer-events: none;
        }
        .sub-list-item .actions {
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        /* Toast & Loader */
        #toast-container { position: fixed; top: 20px; left: 20px; right: 20px; z-index: 9999; }
        .toast {
            padding: 15px 20px; margin-bottom: 10px; border-radius: 12px; color: #fff;
            background-color: var(--primary-color); box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            opacity: 0; transform: translateY(-100%); transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .toast.show { opacity: 1; transform: translateY(0); }
        .toast.success { background-color: var(--success-color); }
        .toast.error { background-color: var(--danger-color); }

        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.5); z-index: 10000;
            display: none; justify-content: center; align-items: center;
        }
        .spinner {
            border: 5px solid var(--primary-color-light); border-top: 5px solid var(--primary-color);
            border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Floating Action Button */
        .fab-btn {
            position: fixed; bottom: 90px; left: 20px;
            width: 60px; height: 60px; border-radius: 50%;
            background-color: var(--primary-color); color: white;
            display: none; align-items: center; justify-content: center;
            font-size: 1.8rem; box-shadow: 0 6px 20px rgba(0,0,0,0.2);
            border: none; cursor: pointer; z-index: 999;
            transition: transform 0.3s, background-color 0.3s;
        }

        /* List Item for More page & Accordion */
        .list-item {
            background-color: var(--surface-color); border-radius: 12px; margin-bottom: 12px;
            display: flex; align-items: center; padding: 15px; box-shadow: var(--shadow); cursor: pointer;
        }
        .list-item:active { transform: scale(0.98); }
        .list-item-info { flex-grow: 1; }
        .list-item-info h4 { font-weight: 600; margin: 0; }
        
        /* More Page Profile Item */
        .profile-list-item {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .profile-list-item img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }

        .text-primary { color: var(--primary-color); }
        .empty-message { text-align: center; padding: 20px; color: var(--text-color-light); }
        
        .bg-primary { background-color: var(--primary-color); }
        .bg-success { background-color: var(--success-color); }
        .bg-warning { background-color: var(--warning-color); }
        .bg-danger { background-color: var(--danger-color); }
        
        .quick-list { list-style: none; padding: 0; }
        .quick-list li { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border-color); }
        .quick-list li:last-child { border-bottom: none; }

        /* Subscriber Modal Specifics */
        .sub-status-card {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-color-dark));
            color: white; border-radius: 10px; padding: 20px; margin-bottom: 20px;
        }
        .sub-status-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .sub-status-header h4 { margin: 0; font-size: 1.2rem; }
        .sub-status-body { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .sub-status-body p { margin: 0; font-size: 1rem; }
        .sub-status-body p strong { display: block; font-size: 1.3rem; margin-top: 4px; }
        .progress-bar { grid-column: 1 / -1; height: 8px; background-color: rgba(255,255,255,0.3); border-radius: 4px; overflow: hidden; margin-top: 10px; }
        .progress-bar-inner { height: 100%; background-color: var(--success-color); border-radius: 4px; transition: width 0.5s; }
        
        /* Profile Page Styles */
        #profile-details-card {
            text-align: center;
        }
        #profile-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            border: 4px solid var(--surface-color);
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
            margin: -60px auto 15px auto;
            display: block;
            background-color: #eee;
            cursor: pointer;
        }
        #profile-name {
            font-size: 1.5rem;
            font-weight: 700;
            margin: 0;
        }
        #profile-username {
            color: var(--text-color-light);
            font-size: 1rem;
        }
        .profile-info-list {
            list-style: none;
            text-align: right;
            padding: 0;
        }
        .profile-info-list li {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid var(--border-color);
        }
        .profile-info-list li:last-child {
            border-bottom: none;
        }
        .profile-info-list li strong {
            color: var(--text-color-light);
        }

    </style>
</head>
<body>
    <script>
        // --- Security Gate ---
        // This code runs first to ensure the user is logged in.
        // If not, it redirects to the login page.
        (function() {
            const userSession = localStorage.getItem('userSession');
            if (!userSession) {
                window.location.replace('login.html');
            }
        })();
    </script>

    <div id="loader">
        <div class="spinner"></div>
    </div>

    <div id="toast-container"></div>
    
    <div id="page-container">
        <!-- Page content will be injected here by the router -->
    </div>

    <nav class="bottom-nav" id="main-nav">
        <button class="nav-btn active" data-page="dashboard"><i class="fas fa-tachometer-alt"></i><span>الرئيسية</span></button>
        <button class="nav-btn" data-page="subscribers"><i class="fas fa-users"></i><span>المشتركين</span></button>
        <button class="nav-btn" data-page="packages"><i class="fas fa-box-open"></i><span>الباقات</span></button>
        <button class="nav-btn" data-page="expenses"><i class="fas fa-wallet"></i><span>المصاريف</span></button>
        <button class="nav-btn" data-page="more"><i class="fas fa-ellipsis-h"></i><span>المزيد</span></button>
    </nav>
    
    <button id="fab-add-btn" class="fab-btn">
        <i class="fas fa-plus"></i>
    </button>
    
    <button id="fab-upload-btn" class="fab-btn" style="display: none; left: auto; right: 20px; background-color: var(--success-color);" title="رفع البيانات إلى الشيت">
        <i class="fas fa-cloud-upload-alt"></i>
    </button>
    
    <script>
    // --- Service Worker Registration ---
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('sw.js')
                .then(registration => console.log('Service Worker registered successfully:', registration))
                .catch(err => console.error('Service Worker registration failed:', err));
        });
    }

    // --- Main Application Logic ---
    document.addEventListener('DOMContentLoaded', () => {
        const App = {
            db: null,
            charts: {},
            gSheetApiUrl: null,
            loginScriptUrl: 'https://script.google.com/macros/s/AKfycbyCQimNQovH8M_IhkmRZggjeCLE4WBi3wGg5qqL7oSWHM2U7wYdrivmCVm88sAjTvwH/exec', // استبدل هذا بالرابط الفعلي
            idleTimer: null,
            synth: null,

            state: {
                currentPage: 'dashboard',
                currentSubscriberId: null,
                currentReportData: null,
                packages: [],
                settings: {
                    companyProfile: { name: 'DashNET', logo: 'https://placehold.co/150x80/4a90e2/ffffff?text=DashNET', contact: '07xxxxxxxx', whatsappCode: '964' },
                    whatsappTemplates: {
                        activation: 'مرحباً {{اسم_المشترك}}،\nتم تفعيل اشتراكك ({{اسم_الباقة}}).\n\nالدين السابق: {{الدين_السابق}}\nسعر الباقة: {{سعر_الباقة}}\nالمبلغ الإجمالي: {{المبلغ_الإجمالي}}\nالمبلغ الواصل: {{المبلغ_الواصل}}\nالرصيد المتبقي: {{الرصيد_المتبقي}}\n\nيبدأ من: {{تاريخ_البدء}}\nينتهي في: {{تاريخ_الانتهاء}}\n\nشكراً لاختياركم خدماتنا.',
                        payment: 'مرحباً {{اسم_المشترك}}،\nتم استلام دفعة.\n\nالدين السابق: {{الدين_السابق}}\nالمبلغ الواصل: {{المبلغ_الواصل}}\nالرصيد المتبقي: {{الرصيد_المتبقي}}\n\nشكراً لتعاونكم.',
                        reminder: 'مرحباً {{اسم_المشترك}}،\nنود تذكيركم بأن اشتراككم سينتهي قريباً بتاريخ {{تاريخ_الانتهاء}}.\n\nالرجاء تجديد الاشتراك لضمان استمرارية الخدمة.\nشكراً لتعاونكم.'
                    },
                    automation: { sendOnActivation: true, sendOnPayment: true, whatsappMethod: 'api' },
                    appFont: "'Cairo', sans-serif",
                    primaryColor: '#4a90e2',
                    isps: [],
                    activeIspId: null,
                    printSettings: { showReceiptButtons: true, paperSize: '80mm', customPaperSize: 80 },
                    syncSettings: { showUploadFab: false, autoUploadOnIdle: false },
                    soundSettings: { touchSound: false }
                }
            },

            // --- Database Handler (IndexedDB) ---
            DB: {
                init() {
                    return new Promise((resolve, reject) => {
                        const request = indexedDB.open('ispManagerDB', 5);
                        request.onerror = (event) => reject("Database error");
                        request.onupgradeneeded = (event) => {
                            const db = event.target.result;
                            if (!db.objectStoreNames.contains('subscribers')) {
                                const subStore = db.createObjectStore('subscribers', { keyPath: 'id' });
                                subStore.createIndex('name', 'name', { unique: false });
                            }
                            if (!db.objectStoreNames.contains('packages')) db.createObjectStore('packages', { keyPath: 'id' });
                            if (!db.objectStoreNames.contains('movements')) {
                                const moveStore = db.createObjectStore('movements', { keyPath: 'id' });
                                moveStore.createIndex('subscriberId', 'subscriberId', { unique: false });
                            }
                            if (!db.objectStoreNames.contains('expenses')) db.createObjectStore('expenses', { keyPath: 'id' });
                            if (!db.objectStoreNames.contains('settings')) db.createObjectStore('settings', { keyPath: 'key' });
                            if (!db.objectStoreNames.contains('isps')) db.createObjectStore('isps', { keyPath: 'id' });
                        };
                        request.onsuccess = (event) => {
                            App.db = event.target.result;
                            resolve(App.db);
                        };
                    });
                },
                get: (storeName, key) => new Promise((resolve, reject) => { const req = App.db.transaction(storeName).objectStore(storeName).get(key); req.onsuccess = () => resolve(req.result); req.onerror = () => reject(req.error); }),
                getAll: (storeName, indexName, query) => new Promise((resolve, reject) => { const store = App.db.transaction(storeName).objectStore(storeName); const index = indexName ? store.index(indexName) : store; const req = index.getAll(query); req.onsuccess = () => resolve(req.result); req.onerror = () => reject(req.error); }),
                put: (storeName, data) => new Promise((resolve, reject) => { const req = App.db.transaction(storeName, 'readwrite').objectStore(storeName).put(data); req.onsuccess = () => resolve(req.result); req.onerror = () => reject(req.error); }),
                delete: (storeName, key) => new Promise((resolve, reject) => { const req = App.db.transaction(storeName, 'readwrite').objectStore(storeName).delete(key); req.onsuccess = () => resolve(); req.onerror = () => reject(req.error); })
            },
            
            // --- Google Sheet Database Handler ---
            GSheetDB: {
                async doFetch(body) {
                    if (!App.gSheetApiUrl) throw new Error("Google Sheet API URL is not set.");
                    const response = await fetch(App.gSheetApiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                        body: JSON.stringify(body),
                        mode: 'cors'
                    });
                    const result = await response.json();
                    if (result.status === 'error') {
                        console.error('Google Sheet API Error:', result.message);
                        throw new Error(result.message);
                    }
                    return result.data;
                },
                async getAllData() {
                    const url = `${App.gSheetApiUrl}?action=getAllData`;
                    const response = await fetch(url, { mode: 'cors' });
                    const result = await response.json();
                    if (result.status === 'error') {
                        console.error('Google Sheet API Error:', result.message);
                        throw new Error(result.message);
                    }
                    return {
                        subscribers: result.data.subscribers || [],
                        packages: result.data.packages || [],
                        movements: result.data.movements || [],
                        expenses: result.data.expenses || [],
                        isps: result.data.isps || [],
                        settings: result.data.settings || [],
                    };
                },
                async put(storeName, data) {
                    const action = storeName === 'settings' ? 'putSettings' : 'put';
                    return this.doFetch({ action, storeName, data });
                }
            },

            // --- Initialization ---
            async init() {
                this.UI.showLoader();
                try {
                    this.gSheetApiUrl = localStorage.getItem('gSheetApiUrl');
                    await this.DB.init();
                    await this.loadSettings();
                    
                    this.state.packages = await this.DB.getAll('packages');
                    this.state.settings.isps = await this.DB.getAll('isps');

                    this.UI.initTheme();
                    this.UI.updateUIFromSettings();
                    this.Router.init();
                    this.attachGlobalEventListeners();
                    
                    const initialPage = window.location.hash.substring(1) || 'dashboard';
                    await this.Router.navigateTo(initialPage);

                } catch (error) {
                    console.error("Initialization failed:", error);
                    this.UI.showToast("فشل تهيئة التطبيق", "error");
                } finally {
                    this.UI.hideLoader();
                }
            },

            // --- Settings Management ---
            async loadSettings() {
                const settingsToLoad = ['companyProfile', 'whatsappTemplates', 'automation', 'appFont', 'primaryColor', 'activeIspId', 'printSettings', 'syncSettings', 'soundSettings'];
                for (const key of settingsToLoad) {
                    const setting = await this.DB.get('settings', key);
                    if (setting && setting.value !== undefined) {
                        const defaultValue = this.state.settings[key];
                        const savedValue = setting.value;
                        if (typeof defaultValue === 'object' && !Array.isArray(defaultValue) && defaultValue !== null) {
                             this.state.settings[key] = { ...defaultValue, ...savedValue };
                        } else {
                            this.state.settings[key] = savedValue;
                        }
                    } else {
                        await this.DB.put('settings', { key, value: this.state.settings[key] });
                    }
                }
            },

            // --- Router ---
            Router: {
                init() {
                    document.getElementById('main-nav').addEventListener('click', (e) => {
                        const navBtn = e.target.closest('.nav-btn');
                        if (navBtn) window.location.hash = navBtn.dataset.page;
                    });
                    window.addEventListener('hashchange', () => this.navigateTo(window.location.hash.substring(1) || 'dashboard'));
                },
                async navigateTo(pageId) {
                    if (!pageId) pageId = 'dashboard';
                    App.state.currentPage = pageId;
                    
                    // Highlight correct nav button
                    document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
                    const mainPage = ['dashboard', 'subscribers', 'packages', 'expenses', 'more'].find(p => pageId.startsWith(p));
                    const activeBtn = document.querySelector(`.nav-btn[data-page="${mainPage}"]`);
                    if (activeBtn) activeBtn.classList.add('active');

                    // Render page content
                    const pageContainer = document.getElementById('page-container');
                    pageContainer.innerHTML = `<div id="${pageId}-page" class="page active">${App.UI.getPageHTML(pageId)}</div>`;
                    
                    App.UI.toggleFabVisibility(pageId);
                    
                    await App.loadPageData(pageId);
                }
            },
            
            // --- Data Loading ---
            async loadPageData(pageId) {
                this.UI.showLoader();
                try {
                    // Always refresh these states on page load
                    this.state.packages = await this.DB.getAll('packages');
                    this.state.settings.isps = await this.DB.getAll('isps');

                    switch (pageId) {
                        case 'dashboard': await this.Pages.Dashboard.render(); break;
                        case 'subscribers': await this.Pages.Subscribers.render(); break;
                        case 'movements': await this.Pages.Movements.render(); break;
                        case 'packages': await this.Pages.Packages.render(); break;
                        case 'expenses': await this.Pages.Expenses.render(); break;
                        case 'more': this.Pages.More.render(); break;
                        case 'profile': await this.Pages.Profile.render(); break;
                        case 'reports': await this.Pages.Reports.render(); break;
                        case 'settings': await this.Pages.Settings.render(); break;
                        case 'info': this.Pages.Info.render(); break;
                    }
                } catch (error) {
                    console.error(`Failed to load page ${pageId}:`, error);
                    this.UI.showToast(`خطأ في تحميل الصفحة`, 'error');
                } finally {
                    this.UI.hideLoader();
                }
            },

            // --- UI Handler & Helpers ---
            UI: {
                showLoader: () => { document.getElementById('loader').style.display = 'flex'; },
                hideLoader: () => { document.getElementById('loader').style.display = 'none'; },
                
                showToast(message, type = 'info') {
                    const container = document.getElementById('toast-container');
                    const toast = document.createElement('div');
                    toast.className = `toast ${type}`;
                    toast.textContent = message;
                    container.appendChild(toast);
                    setTimeout(() => toast.classList.add('show'), 10);
                    setTimeout(() => {
                        toast.classList.remove('show');
                        setTimeout(() => toast.remove(), 500);
                    }, 4000);
                },

                openModal(modalHTML, modalId) {
                    if (document.getElementById(modalId)) document.getElementById(modalId).remove();
                    const modalWrapper = document.createElement('div');
                    modalWrapper.innerHTML = modalHTML;
                    const modalElement = modalWrapper.firstElementChild;
                    modalElement.id = modalId;
                    document.body.appendChild(modalElement);
                    setTimeout(() => modalElement.classList.add('active'), 10);
                    const close = () => { modalElement.classList.remove('active'); setTimeout(() => modalElement.remove(), 400); };
                    modalElement.querySelector('.close-btn').addEventListener('click', close);
                    modalElement.addEventListener('click', (e) => { if (e.target === modalElement) close(); });
                    return modalElement;
                },

                showConfirmation(message, onConfirm) {
                    const modalId = 'confirmation-modal';
                    if (document.getElementById(modalId)) document.getElementById(modalId).remove();

                    const modalHTML = `
                    <div class="modal active" id="${modalId}" style="justify-content: center; align-items: center; background-color: rgba(0,0,0,0.6);">
                        <div class="modal-content" style="border-radius: 16px; width: auto; max-width: 320px; animation: none; transform: scale(0.9); opacity: 0; transition: all 0.3s ease; position:relative; top:auto; right:auto;">
                            <div class="modal-body" style="padding: 25px; text-align: center;">
                                <p style="font-size: 1.1rem; margin-bottom: 25px;">${message}</p>
                                <div style="display: flex; gap: 10px;">
                                    <button id="confirm-yes-btn" class="btn btn-primary" style="flex: 1;">نعم</button>
                                    <button id="confirm-no-btn" class="btn btn-secondary" style="flex: 1;">لا</button>
                                </div>
                            </div>
                        </div>
                    </div>`;
                    document.body.insertAdjacentHTML('beforeend', modalHTML);
                    const modalEl = document.getElementById(modalId);
                    const modalContent = modalEl.querySelector('.modal-content');

                    setTimeout(() => {
                        modalContent.style.transform = 'scale(1)';
                        modalContent.style.opacity = '1';
                    }, 10);

                    const close = () => {
                        modalContent.style.transform = 'scale(0.9)';
                        modalContent.style.opacity = '0';
                        setTimeout(() => modalEl.remove(), 300);
                    };

                    modalEl.querySelector('#confirm-yes-btn').addEventListener('click', () => {
                        if (onConfirm) onConfirm();
                        close();
                    });
                    modalEl.querySelector('#confirm-no-btn').addEventListener('click', close);
                },

                showWhatsappConfirmation(message, phone, whatsappMessage) {
                    const modalId = 'whatsapp-confirmation-modal';
                    if (document.getElementById(modalId)) document.getElementById(modalId).remove();

                    const cleanPhone = phone.toString().replace(/^0/, '');
                    const fullPhone = `${App.state.settings.companyProfile.whatsappCode}${cleanPhone}`;
                    const encodedMessage = encodeURIComponent(whatsappMessage);
                    let url;
                    if (App.state.settings.automation.whatsappMethod === 'web') {
                        url = `https://web.whatsapp.com/send?phone=${fullPhone}&text=${encodedMessage}`;
                    } else {
                        url = `https://wa.me/${fullPhone}?text=${encodedMessage}`;
                    }

                    const modalHTML = `
                    <div class="modal active" id="${modalId}" style="justify-content: center; align-items: center; background-color: rgba(0,0,0,0.6);">
                        <div class="modal-content" style="border-radius: 16px; width: auto; max-width: 320px; animation: none; transform: scale(0.9); opacity: 0; transition: all 0.3s ease; position:relative; top:auto; right:auto;">
                            <div class="modal-body" style="padding: 25px; text-align: center;">
                                <p style="font-size: 1.1rem; margin-bottom: 25px;">${message}</p>
                                <div style="display: flex; gap: 10px;">
                                    <a href="${url}" target="_blank" id="confirm-whatsapp-btn" class="btn btn-success" style="flex: 1; background-color: var(--success-color);"><i class="fab fa-whatsapp"></i> إرسال</a>
                                    <button id="confirm-no-btn" class="btn btn-secondary" style="flex: 1;">إغلاق</button>
                                </div>
                            </div>
                        </div>
                    </div>`;
                    document.body.insertAdjacentHTML('beforeend', modalHTML);
                    const modalEl = document.getElementById(modalId);
                    const modalContent = modalEl.querySelector('.modal-content');

                    setTimeout(() => {
                        modalContent.style.transform = 'scale(1)';
                        modalContent.style.opacity = '1';
                    }, 10);

                    const close = () => {
                        modalContent.style.transform = 'scale(0.9)';
                        modalContent.style.opacity = '0';
                        setTimeout(() => modalEl.remove(), 300);
                    };

                    modalEl.querySelector('#confirm-whatsapp-btn').addEventListener('click', () => {
                        setTimeout(close, 500);
                    });
                    modalEl.querySelector('#confirm-no-btn').addEventListener('click', close);
                },

                initTheme() {
                    if (localStorage.getItem('theme') === 'dark') document.body.classList.add('dark-mode');
                },
                toggleTheme() {
                    document.body.classList.toggle('dark-mode');
                    localStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
                },

                updateUIFromSettings() {
                    this.applyFont(App.state.settings.appFont);
                    this.applyColor(App.state.settings.primaryColor);
                    this.updatePrintStyles(App.state.settings.printSettings.paperSize, App.state.settings.printSettings.customPaperSize);
                    document.getElementById('fab-upload-btn').style.display = App.state.settings.syncSettings.showUploadFab ? 'flex' : 'none';
                    App.resetIdleTimer();
                },
                applyFont: (font) => { document.documentElement.style.setProperty('--main-font', font); },
                applyColor: (color) => { document.documentElement.style.setProperty('--primary-color', color); },
                updatePrintStyles(paperSize, customSize = 80) {
                    const styleSheet = document.getElementById('print-style-sheet');
                    let size = (paperSize === 'custom') ? `${customSize}mm` : paperSize;
                    styleSheet.innerHTML = (size === 'A4') ? `@media print { @page { size: A4; margin: 20mm; } body { font-size: 14pt; } }` : `@media print { @page { size: ${size} auto; margin: 3mm; } body { font-size: 12pt; } }`;
                },
                toggleFabVisibility(pageId) {
                    const fab = document.getElementById('fab-add-btn');
                    if(!fab) return;
                    
                    const pageActions = { 'subscribers': 'add-subscriber', 'packages': 'add-package', 'expenses': 'add-expense' };
                    if (pageActions[pageId]) {
                        fab.style.display = 'flex';
                        fab.dataset.action = pageActions[pageId];
                    } else {
                        fab.style.display = 'none';
                    }
                },
                
                // Formatters
                formatDate: (d) => d ? new Date(d).toLocaleDateString('ar-EG', { day: 'numeric', month: 'long', year: 'numeric' }) : 'N/A',
                formatDateTime: (d) => d ? new Date(d).toLocaleString('ar-EG', { day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' }) : 'N/A',
                formatNumericDateTime(date) {
                    if (!date) return 'N/A';
                    const d = new Date(date);
                    const pad = (num) => num.toString().padStart(2, '0');
                    const datePart = `${d.getFullYear()}/${pad(d.getMonth() + 1)}/${pad(d.getDate())}`;
                    const timePart = d.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
                    return `${datePart} ${timePart}`;
                },
                getISODate: (d) => d ? new Date(d.getTime() - (d.getTimezoneOffset() * 60000)).toISOString().split('T')[0] : '',
                getISO_DateTimeLocal(d) {
                    if (!d) return '';
                    const ten = (i) => (i < 10 ? '0' : '') + i;
                    const date = new Date(d);
                    return `${date.getFullYear()}-${ten(date.getMonth() + 1)}-${ten(date.getDate())}T${ten(date.getHours())}:${ten(date.getMinutes())}`;
                },
                parseTemplate: (template, data) => template.replace(/\{\{([^}]+)\}\}/g, (match, key) => data[key.trim()] !== undefined ? data[key.trim()] : match),

                // Page Templates
                getPageHTML(pageId) {
                    const pages = {
                        dashboard: `
                            <div class="page-header"><h1>لوحة التحكم</h1></div>
                            <div class="grid-container stats-grid" id="stats-grid-wrapper"></div>
                            <div class="grid-container charts-grid">
                                <div class="card">
                                    <h3>الاشتراكات الجديدة</h3>
                                    <div class="chart-container"><canvas id="newSubsChart"></canvas></div>
                                </div>
                                <div class="card">
                                    <h3>توزيع الباقات</h3>
                                    <div class="chart-container"><canvas id="packagesPieChart"></canvas></div>
                                </div>
                            </div>
                            <div class="card" style="margin-bottom: 20px;">
                                <h3>الإيرادات والمصاريف</h3>
                                <div class="chart-container"><canvas id="revenueExpenseChart"></canvas></div>
                            </div>
                            <div class="grid-container lists-grid">
                                <div class="card">
                                    <h3><i class="fas fa-hourglass-end text-warning"></i> تنتهي اليوم</h3>
                                    <ul id="expiring-today-list" class="quick-list"></ul>
                                </div>
                                <div class="card">
                                    <h3><i class="fas fa-history"></i> آخر الحركات</h3>
                                    <ul id="latest-movements-list" class="quick-list"></ul>
                                </div>
                            </div>`,
                        subscribers: `<div class="page-header"><h1>المشتركين</h1><div class="header-actions"><button id="export-subs-csv" class="btn btn-sm btn-secondary"><i class="fas fa-file-csv"></i></button><button id="export-subs-xlsx" class="btn btn-sm btn-success"><i class="fas fa-file-excel"></i></button></div></div><div class="card"><input type="search" id="subscriber-search" class="form-control" placeholder="بحث بالاسم أو الهاتف..." style="margin-bottom: 15px;"><div id="subscriber-filters" class="filter-bar"><button class="btn filter-btn active" data-filter="all">الكل</button><button class="btn filter-btn" data-filter="active">فعال</button><button class="btn filter-btn" data-filter="expiring_soon">سينتهي قريبا</button><button class="btn filter-btn" data-filter="expired">منتهي</button><button class="btn filter-btn" data-filter="has_debt">عليه دين</button></div><div id="subscriber-list"></div><p id="no-subs-message" class="empty-message" style="display: none;">لا يوجد مشتركين.</p></div><div class="bulk-actions" id="bulk-actions-bar" style="display: none; position: fixed; bottom: 70px; left: 0; right: 0; padding: 10px; background-color: var(--surface-color); border-top: 1px solid var(--border-color); gap: 10px; justify-content: center; align-items:center; z-index:1001;"><span id="bulk-actions-count"></span><button id="bulk-delete-btn" class="btn btn-sm btn-danger"><i class="fas fa-trash"></i> حذف</button><button id="bulk-whatsapp-btn" class="btn btn-sm btn-success"><i class="fab fa-whatsapp"></i> إرسال</button><button id="bulk-reminder-btn" class="btn btn-sm btn-warning" style="display: none;"><i class="fas fa-bell"></i> إرسال تذكير</button></div>`,
                        movements: `<div class="page-header"><h1>سجل الحركات</h1></div><div class="card"><div class="form-group"><input type="search" id="movements-search" class="form-control" placeholder="بحث باسم المشترك..."></div><div style="display:flex; gap:10px;"><div class="form-group" style="flex:1;"><input type="date" id="movements-start-date" class="form-control"></div><div class="form-group" style="flex:1;"><input type="date" id="movements-end-date" class="form-control"></div></div><div class="form-group"><select id="movements-type-filter" class="form-control"><option value="all">كل الحركات</option><option value="activation">تفعيل</option><option value="payment">تسديد</option></select></div></div><div class="table-responsive card"><table id="movements-table"><thead><tr><th>المشترك</th><th>النوع</th><th>التفاصيل</th><th>التاريخ</th></tr></thead><tbody></tbody></table><p id="no-movements-message" class="empty-message" style="display: none;">لا توجد حركات.</p></div>`,
                        packages: `<div class="page-header"><h1>الباقات</h1></div><div class="table-responsive card"><table id="packages-table"><thead><tr><th>اسم الباقة</th><th>السعر</th><th>المدة</th><th>إجراءات</th></tr></thead><tbody></tbody></table><p id="no-packages-message" class="empty-message" style="display:none;">لا توجد باقات.</p></div>`,
                        expenses: `<div class="page-header"><h1>المصاريف</h1></div><div class="table-responsive card"><table id="expenses-table"><thead><tr><th>الوصف</th><th>المبلغ</th><th>التاريخ</th><th>إجراءات</th></tr></thead><tbody></tbody></table><p id="no-expenses-message" class="empty-message" style="display:none;">لا توجد مصاريف.</p></div>`,
                        more: `<div class="page-header"><h1>المزيد</h1></div><div id="more-list-container"></div>`,
                        profile: `<div class="page-header"><h1>الملف الشخصي</h1></div>
                                  <div class="card" id="profile-details-card">
                                      <img id="profile-avatar" src="https://placehold.co/100x100/eaf2fb/7f8c8d?text=U" alt="الصورة الرمزية">
                                      <h2 id="profile-name"></h2>
                                      <p id="profile-username"></p>
                                  </div>
                                  <div class="card">
                                      <h3>تفاصيل الاشتراك</h3>
                                      <ul class="profile-info-list">
                                          <li><span>الخطة الحالية</span><strong id="profile-plan"></strong></li>
                                          <li><span>تاريخ الانتهاء</span><strong id="profile-end-date"></strong></li>
                                      </ul>
                                  </div>
                                  <div class="card">
                                      <h3>تعديل المعلومات</h3>
                                      <form id="update-profile-form">
                                          <div class="form-group"><label for="update-name">الاسم</label><input type="text" id="update-name" class="form-control" required></div>
                                          <div class="form-group"><label for="update-email">البريد الإلكتروني</label><input type="email" id="update-email" class="form-control" required></div>
                                          <button type="submit" class="btn btn-primary">حفظ التعديلات</button>
                                      </form>
                                  </div>
                                  <div class="card">
                                      <h3>تغيير كلمة المرور</h3>
                                      <form id="change-password-form">
                                          <div class="form-group"><label for="current-password">كلمة المرور الحالية</label><input type="password" id="current-password" class="form-control" required></div>
                                          <div class="form-group"><label for="new-password">كلمة المرور الجديدة</label><input type="password" id="new-password" class="form-control" required></div>
                                          <button type="submit" class="btn btn-secondary">تغيير كلمة المرور</button>
                                      </form>
                                  </div>`,
                        reports: `<div class="page-header"><h1>التقارير</h1><div class="header-actions"><button id="print-report-btn" class="btn btn-sm btn-primary"><i class="fas fa-print"></i></button></div></div><div class="card"><div class="form-group"><label>من:</label><input type="date" id="report-start-date" class="form-control"></div><div class="form-group"><label>إلى:</label><input type="date" id="report-end-date" class="form-control"></div><button id="generate-report-btn" class="btn btn-primary" style="width:100%;">عرض التقرير</button></div><div id="report-output" style="display: none;"></div>`,
                        settings: ``,
                        info: `<div class="page-header"><h1>حول التطبيق</h1></div><div class="card"><p>نظام إدارة اشتراكات الإنترنت، إصدار 2.1</p><p>تطبيق ويب تقدمي لإدارة شبكات ومكاتب الإنترنت بكفاءة.</p></div>`
                    };
                    return pages[pageId] || `<h1>صفحة غير موجودة</h1>`;
                }
            },
            
            // --- Page Renderers ---
            Pages: {
                Dashboard: {
                    async render() {
                        const subscribers = await App.DB.getAll('subscribers');
                        const movements = await App.DB.getAll('movements');
                        const expenses = await App.DB.getAll('expenses');

                        // Calculate Stats
                        let totalSubs = subscribers.length, activeSubs = 0, expiringSoonSubs = 0, expiredSubs = 0, totalDebt = 0;
                        subscribers.forEach(sub => {
                            totalDebt += Number(sub.debt) || 0;
                            const status = App.Pages.Subscribers.getSubscriberStatus(sub).key;
                            if (status === 'active') activeSubs++;
                            else if (status === 'expiring_soon') { activeSubs++; expiringSoonSubs++; }
                            else expiredSubs++;
                        });
                        const { netProfit } = this.calculateProfits(movements, expenses);

                        // Render Stat Cards
                        const debtString = totalDebt.toLocaleString();
                        const profitString = netProfit.toLocaleString();
                        const debtFontSizeClass = debtString.length > 6 ? 'small-font' : '';
                        const profitFontSizeClass = profitString.length > 6 ? 'small-font' : '';

                        document.getElementById('stats-grid-wrapper').innerHTML = `
                            <div class="card stat-card"><div class="icon bg-primary"><i class="fas fa-users"></i></div><div class="info"><p>الإجمالي</p><h3>${totalSubs}</h3></div></div>
                            <div class="card stat-card"><div class="icon bg-success"><i class="fas fa-user-check"></i></div><div class="info"><p>الفعالين</p><h3>${activeSubs}</h3></div></div>
                            <div class="card stat-card"><div class="icon bg-warning"><i class="fas fa-user-clock"></i></div><div class="info"><p>قرب الانتهاء</p><h3>${expiringSoonSubs}</h3></div></div>
                            <div class="card stat-card"><div class="icon bg-danger"><i class="fas fa-user-times"></i></div><div class="info"><p>منتهون</p><h3>${expiredSubs}</h3></div></div>
                            <div class="card stat-card"><div class="icon bg-danger"><i class="fas fa-file-invoice-dollar"></i></div><div class="info"><p>إجمالي الديون</p><h3 class="${debtFontSizeClass}">${debtString}</h3></div></div>
                            <div class="card stat-card"><div class="icon bg-success"><i class="fas fa-piggy-bank"></i></div><div class="info"><p>صافي الربح</p><h3 class="${profitFontSizeClass}">${profitString}</h3></div></div>
                        `;
                        
                        this.renderCharts(subscribers, movements, expenses);

                        // Render Quick Lists
                        const today = new Date();
                        const expiringTodayList = document.getElementById('expiring-today-list');
                        expiringTodayList.innerHTML = '';
                        subscribers.filter(sub => {
                            if (!sub.lastActivation_endDate) return false;
                            const endDate = new Date(sub.lastActivation_endDate);
                            return endDate.toDateString() === today.toDateString();
                        }).forEach(sub => {
                            expiringTodayList.innerHTML += `<li><span>${sub.name}</span><span class="text-danger">${sub.phone}</span></li>`;
                        });
                        if (expiringTodayList.innerHTML === '') expiringTodayList.innerHTML = '<li>لا يوجد.</li>';

                        const latestMovementsList = document.getElementById('latest-movements-list');
                        latestMovementsList.innerHTML = '';
                        movements.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp)).slice(0, 5).forEach(m => {
                            const sub = subscribers.find(s => s.id == m.subscriberId);
                            latestMovementsList.innerHTML += `<li><span>${sub?.name || 'محذوف'}</span><span class="${m.type === 'activation' ? 'text-success' : 'text-primary'}">${m.type === 'activation' ? 'تفعيل' : 'تسديد'}: ${Number(m.amount).toLocaleString()}</span></li>`;
                        });
                        if (latestMovementsList.innerHTML === '') latestMovementsList.innerHTML = '<li>لا توجد حركات.</li>';
                    },
                    calculateProfits(movements, expenses){
                        const today = new Date(), currentMonth = today.getMonth(), currentYear = today.getFullYear();
                        let monthlyRevenue = 0, monthlyCosts = 0;
                        movements.forEach(m => {
                            const moveDate = new Date(m.timestamp);
                            if (moveDate.getMonth() === currentMonth && moveDate.getFullYear() === currentYear) {
                                monthlyRevenue += Number(m.paidAmount) || 0;
                                if (m.type === 'activation') {
                                    const pkg = App.state.packages.find(p => p.name === m.packageName);
                                    if(pkg) monthlyCosts += Number(pkg.cost) || 0;
                                }
                            }
                        });
                        let monthlyExpenses = expenses.filter(e => { const d = new Date(e.date); return d.getMonth() === currentMonth && d.getFullYear() === currentYear; }).reduce((sum, e) => sum + Number(e.amount), 0);
                        return { netProfit: monthlyRevenue - monthlyCosts - monthlyExpenses };
                    },
                    renderCharts(subscribers, movements, expenses) {
                        Object.values(App.charts).forEach(chart => chart.destroy());
                        const chartOptions = { responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { font: { family: "'Cairo', sans-serif" } } } } };
                        
                        const renderChart = (ctxId, type, data) => {
                            const ctx = document.getElementById(ctxId)?.getContext('2d');
                            if(ctx) App.charts[ctxId] = new Chart(ctx, { type, data, options: chartOptions });
                        };

                        // Chart 1: New Subs
                        const newSubsData = { labels: [], datasets: [{ label: 'اشتراكات جديدة', data: [], backgroundColor: 'rgba(74, 144, 226, 0.7)' }] };
                        for(let i = 5; i >= 0; i--) {
                            const d = new Date(); d.setMonth(d.getMonth() - i);
                            newSubsData.labels.push(d.toLocaleDateString('ar-EG', { month: 'long' }));
                            newSubsData.datasets[0].data.push(movements.filter(m => { const md = new Date(m.timestamp); return m.type === 'activation' && md.getMonth() === d.getMonth() && md.getFullYear() === d.getFullYear(); }).length);
                        }
                        renderChart('newSubsChart', 'bar', newSubsData);
                        
                        // Chart 2: Package Dist
                        const activeSubs = subscribers.filter(sub => App.Pages.Subscribers.getSubscriberStatus(sub).key !== 'expired');
                        const packageDist = activeSubs.reduce((acc, sub) => { acc[sub.lastActivation_packageName || 'غير محدد'] = (acc[sub.lastActivation_packageName || 'غير محدد'] || 0) + 1; return acc; }, {});
                        renderChart('packagesPieChart', 'pie', { labels: Object.keys(packageDist), datasets: [{ data: Object.values(packageDist), backgroundColor: ['#4a90e2', '#2ecc71', '#f39c12', '#e74c3c', '#9b59b6'] }] });

                        // Chart 3: Revenue/Expense
                        const lineData = { labels: [], datasets: [ { label: 'الإيرادات', data: [], borderColor: 'rgba(46, 204, 113, 1)', tension: 0.1 }, { label: 'المصاريف', data: [], borderColor: 'rgba(231, 76, 60, 1)', tension: 0.1 } ] };
                        for(let i = 5; i >= 0; i--) {
                             const d = new Date(); d.setMonth(d.getMonth() - i);
                             lineData.labels.push(d.toLocaleDateString('ar-EG', { month: 'short', year: 'numeric' }));
                             lineData.datasets[0].data.push(movements.filter(m => { const md = new Date(m.timestamp); return md.getMonth() === d.getMonth() && md.getFullYear() === d.getFullYear(); }).reduce((sum, m) => sum + (Number(m.paidAmount) || 0), 0));
                             lineData.datasets[1].data.push(expenses.filter(e => { const ed = new Date(e.date); return ed.getMonth() === d.getMonth() && ed.getFullYear() === d.getFullYear(); }).reduce((sum, e) => sum + Number(e.amount), 0));
                        }
                        renderChart('revenueExpenseChart', 'line', lineData);
                    }
                },
                Subscribers: {
                    async render(filter = 'all') {
                        let subscribers = await App.DB.getAll('subscribers');
                        const searchTerm = document.getElementById('subscriber-search')?.value.toLowerCase() || '';
                        
                        if (filter !== 'all') subscribers = subscribers.filter(sub => (filter === 'has_debt') ? (Number(sub.debt) || 0) > 0 : this.getSubscriberStatus(sub).key === filter);
                        if (searchTerm) subscribers = subscribers.filter(s => s.name.toLowerCase().includes(searchTerm) || s.phone.toLowerCase().includes(searchTerm));

                        const listContainer = document.getElementById('subscriber-list');
                        const msgEl = document.getElementById('no-subs-message');
                        listContainer.innerHTML = '';
                        msgEl.style.display = subscribers.length === 0 ? 'block' : 'none';
                        
                        subscribers.forEach(sub => {
                            const statusInfo = this.getSubscriberStatus(sub);
                            const debt = Number(sub.debt) || 0;
                            const canActivateExternally = sub.username && (App.getSubscriberIsp(sub) != null);
                            const isExpiringSoon = statusInfo.key === 'expiring_soon';
                            
                            const item = document.createElement('div');
                            item.className = 'sub-list-item';
                            item.dataset.id = sub.id;
                            item.dataset.name = sub.name;
                            item.dataset.phone = sub.phone;
                            item.dataset.endDate = sub.lastActivation_endDate || '';

                            item.innerHTML = `
                                <input type="checkbox" class="sub-checkbox" data-phone="${sub.phone}" onclick="event.stopPropagation();">
                                <div class="info">
                                    <h4>${sub.name}</h4>
                                    <p>${sub.phone}</p>
                                    <p><span class="status-badge ${statusInfo.key}">${statusInfo.text}</span> ${debt > 0 ? `<span style="color:var(--danger-color); font-weight:bold;">دين: ${debt.toLocaleString()}</span>` : ''}</p>
                                    <p>ينتهي: ${App.UI.formatNumericDateTime(sub.lastActivation_endDate)}</p>
                                </div>
                                <div class="actions">
                                    ${isExpiringSoon ? `<button class="btn btn-sm btn-warning send-reminder-btn" title="إرسال تذكير"><i class="fab fa-whatsapp"></i></button>` : ''}
                                    ${canActivateExternally ? `<button class="btn btn-sm btn-info go-to-activation-table-btn" title="تفعيل خارجي"><i class="fas fa-external-link-alt"></i></button>` : ''}
                                    <button class="btn btn-sm btn-secondary view-sub-btn" title="عرض التفاصيل"><i class="fas fa-eye"></i></button>
                                </div>`;
                            listContainer.appendChild(item);
                        });
                        this.attachListeners();
                    },
                    getSubscriberStatus(sub) {
                        if (!sub.lastActivation_endDate) return { key: 'expired', text: 'منتهي' };
                        const endDate = new Date(sub.lastActivation_endDate);
                        const today = new Date();
                        const soonDate = new Date(); soonDate.setDate(today.getDate() + 3);
                        if (endDate < today) return { key: 'expired', text: 'منتهي' };
                        if (endDate < soonDate) return { key: 'expiring_soon', text: 'قرب الانتهاء' };
                        return { key: 'active', text: 'فعال' };
                    },
                    attachListeners() {
                        const page = document.getElementById('subscribers-page');
                        if (page.dataset.listenerAttached) return;
                        
                        document.getElementById('subscriber-search')?.addEventListener('input', () => this.render(document.querySelector('#subscriber-filters .filter-btn.active').dataset.filter));
                        document.getElementById('subscriber-filters')?.addEventListener('click', (e) => { if(e.target.classList.contains('filter-btn')) { document.querySelectorAll('#subscriber-filters .filter-btn').forEach(btn => btn.classList.remove('active')); e.target.classList.add('active'); this.render(e.target.dataset.filter); this.updateBulkActionsVisibility(); } });
                        
                        document.getElementById('subscriber-list')?.addEventListener('click', (e) => {
                            const subItem = e.target.closest('.sub-list-item');
                            if (!subItem) return;

                            const subId = parseInt(subItem.dataset.id);

                            if (e.target.closest('.send-reminder-btn')) {
                                e.stopPropagation();
                                this.handleReminder(subItem);
                                return;
                            }
                            if (e.target.closest('.go-to-activation-table-btn')) {
                                e.stopPropagation();
                                this.handleExternalActivation(subId);
                                return;
                            }
                            if (e.target.closest('.sub-checkbox')) {
                                e.stopPropagation();
                                return;
                            }
                            
                            this.openSubscriberModal(subId);
                        });

                        document.getElementById('bulk-actions-bar')?.addEventListener('click', (e) => {
                            if (e.target.closest('#bulk-delete-btn')) this.handleBulkDelete();
                            if (e.target.closest('#bulk-whatsapp-btn')) this.handleBulkWhatsapp();
                            if (e.target.closest('#bulk-reminder-btn')) this.handleBulkReminder();
                        });
                        document.getElementById('subscriber-list')?.addEventListener('change', (e) => { if(e.target.classList.contains('sub-checkbox')) this.updateBulkActionsVisibility(); });
                        document.getElementById('export-subs-xlsx')?.addEventListener('click', () => App.exportSubscribersTo('xlsx'));
                        document.getElementById('export-subs-csv')?.addEventListener('click', () => App.exportSubscribersTo('csv'));
                        
                        page.dataset.listenerAttached = 'true';
                    },
                    async openSubscriberModal(subId) {
                        const sub = subId ? await App.DB.get('subscribers', subId) : { id: null, name: '', phone: '', username: '', subId: '', debt: 0, ispId: null, notes: '' };
                        App.state.currentSubscriberId = subId;
                        const title = subId ? `تفاصيل: ${sub.name}` : 'إضافة مشترك جديد';

                        const modalHTML = `<div class="modal"><div class="modal-content"><div class="modal-header"><h2>${title}</h2><span class="close-btn">&times;</span></div><div class="modal-tabs" style="display:${subId ? 'flex' : 'none'};"><span class="tab-link active" data-tab="overview"><i class="fas fa-info-circle"></i> نظرة عامة</span><span class="tab-link" data-tab="actions"><i class="fas fa-bolt"></i> تفعيل</span><span class="tab-link" data-tab="history"><i class="fas fa-history"></i> سجل</span><span class="tab-link" data-tab="edit"><i class="fas fa-edit"></i> تعديل</span></div><div class="modal-body"><div id="overview-tab" class="tab-content active"></div><div id="actions-tab" class="tab-content"></div><div id="history-tab" class="tab-content"></div><div id="edit-tab" class="tab-content"></div></div></div></div>`;
                        App.UI.openModal(modalHTML, 'subscriber-modal');
                        
                        if (subId) {
                            this.populateSubscriberModal(sub);
                        } else {
                            document.querySelector('#subscriber-modal .modal-tabs').style.display = 'none';
                            document.querySelector('#overview-tab').classList.remove('active');
                            document.querySelector('#edit-tab').classList.add('active');
                            this.renderEditForm(sub);
                        }
                    },
                    async populateSubscriberModal(sub) {
                        // Overview Tab
                        const statusInfo = this.getSubscriberStatus(sub);
                        let remainingDays = 0, progress = 0;
                        if (statusInfo.key !== 'expired' && sub.lastActivation_startDate && sub.lastActivation_endDate) {
                            const startDate = new Date(sub.lastActivation_startDate);
                            const endDate = new Date(sub.lastActivation_endDate);
                            const totalDuration = (endDate - startDate);
                            const remainingTime = (endDate - new Date());
                            remainingDays = Math.ceil(remainingTime / (1000 * 60 * 60 * 24));
                            if (remainingDays < 0) remainingDays = 0;
                            progress = totalDuration > 0 ? Math.max(0, Math.min(100, ((totalDuration - remainingTime) / totalDuration) * 100)) : 0;
                        }
                        document.getElementById('overview-tab').innerHTML = `
                            <div class="sub-status-card">
                                <div class="sub-status-header"><h4>حالة الاشتراك</h4><span class="status-badge ${statusInfo.key}">${statusInfo.text}</span></div>
                                <div class="sub-status-body"><p>الباقة الحالية<strong>${sub.lastActivation_packageName || '-'}</strong></p><p>الدين الحالي<strong>${Number(sub.debt || 0).toLocaleString()}</strong></p></div>
                                <div style="margin-top: 15px;"><p style="margin:0 0 5px 0;">الأيام المتبقية: <strong>${remainingDays}</strong></p><div class="progress-bar"><div class="progress-bar-inner" style="width: ${progress}%;"></div></div></div>
                            </div>
                            <h4>معلومات التواصل</h4>
                            <p><strong><i class="fas fa-user"></i> اليوزر:</strong> ${sub.username || '-'}</p>
                            <p><strong><i class="fas fa-id-card"></i> معرف الاشتراك:</strong> ${sub.subId || '-'}</p>
                            <p><strong><i class="fas fa-phone"></i> الهاتف:</strong> ${sub.phone}</p>
                            <p><strong><i class="fas fa-sticky-note"></i> ملاحظات:</strong> ${sub.notes || '-'}</p>
                        `;
                        
                        // Actions Tab
                        const pkgOptions = App.state.packages.map(p => `<option value="${p.id}" data-price="${p.price}" data-duration-value="${p.durationValue}" data-duration-type="${p.durationType}">${p.name} - ${Number(p.price).toLocaleString()}</option>`).join('');
                        document.getElementById('actions-tab').innerHTML = `<form id="activation-form"><h4><i class="fas fa-rocket"></i> تفعيل اشتراك</h4><div class="form-group"><label>اختر باقة</label><select id="activation-package" class="form-control" required><option value="">-- اختر --</option>${pkgOptions}</select></div><div class="form-group"><label>تاريخ البدء</label><input type="datetime-local" id="activation-start-date" class="form-control"></div><div class="form-group"><label>تاريخ الانتهاء</label><input type="datetime-local" id="activation-end-date" class="form-control"></div><div class="form-group"><label>المبلغ المدفوع</label><input type="number" id="activation-amount-paid" class="form-control" placeholder="0" min="0"></div><div class="form-group"><label>ملاحظات</label><textarea id="activation-notes" class="form-control" rows="2"></textarea></div><div class="form-group"><p>صافي الدين: <strong id="net-debt-activation">0</strong></p></div><div style="display:flex; gap:10px;"><button type="submit" class="btn btn-primary" style="flex:1;">تفعيل وحفظ</button><button type="button" id="print-activation-receipt-btn" class="btn btn-secondary"><i class="fas fa-print"></i></button></div></form><hr style="margin: 20px 0;"><form id="payment-form"><h4><i class="fas fa-hand-holding-usd"></i> تسديد دين</h4><div class="form-group"><label>المبلغ المدفوع</label><input type="number" id="payment-amount" class="form-control" required min="1"></div><div class="form-group"><label>ملاحظات</label><textarea id="payment-notes" class="form-control" rows="2"></textarea></div><div style="display:flex; gap:10px;"><button type="submit" class="btn btn-secondary" style="flex:1;">تسديد وحفظ</button><button type="button" id="print-payment-receipt-btn" class="btn btn-secondary"><i class="fas fa-print"></i></button></div></form>`;
                        
                        const activationStartDateInput = document.getElementById('activation-start-date');
                        const endDateInput = document.getElementById('activation-end-date');
                        const endDateValue = sub.lastActivation_endDate ? new Date(sub.lastActivation_endDate) : null;
                        activationStartDateInput.value = App.UI.getISO_DateTimeLocal(endDateValue && endDateValue > new Date() ? endDateValue : new Date());
                        
                        const pkgSelect = document.getElementById('activation-package');
                        if(sub.lastActivation_packageName) {
                           const lastPkg = App.state.packages.find(p => p.name === sub.lastActivation_packageName);
                           if(lastPkg) pkgSelect.value = lastPkg.id;
                        }

                        const updateActivationDetails = () => {
                             const selectedPkg = pkgSelect.options[pkgSelect.selectedIndex];
                             if (!selectedPkg?.value) {
                                endDateInput.value = '';
                                return;
                             }
                             const pkgPrice = parseFloat(selectedPkg.dataset.price) || 0;
                             const paid = parseFloat(document.getElementById('activation-amount-paid').value) || 0;
                             document.getElementById('net-debt-activation').textContent = ((Number(sub.debt)||0) + pkgPrice - paid).toLocaleString();
                             
                             const startDate = new Date(activationStartDateInput.value);
                             const newEndDate = new Date(startDate);
                             const durationValue = parseInt(selectedPkg.dataset.durationValue);
                             const durationType = selectedPkg.dataset.durationType;
                             if (durationType === 'months') newEndDate.setMonth(startDate.getMonth() + durationValue);
                             else newEndDate.setDate(startDate.getDate() + durationValue);
                             endDateInput.value = App.UI.getISO_DateTimeLocal(newEndDate);
                        };

                        // Recalculate end date only if start date or package changes
                        pkgSelect.addEventListener('change', updateActivationDetails);
                        activationStartDateInput.addEventListener('change', updateActivationDetails);
                        document.getElementById('activation-amount-paid').addEventListener('input', updateActivationDetails);
                        
                        updateActivationDetails(); // Initial calculation

                        document.getElementById('activation-form').addEventListener('submit', (e) => this.handleActivationSubmit(e, sub));
                        document.getElementById('payment-form').addEventListener('submit', (e) => this.handlePaymentSubmit(e, sub));
                        document.getElementById('print-activation-receipt-btn').addEventListener('click', () => App.printReceipt('activation'));
                        document.getElementById('print-payment-receipt-btn').addEventListener('click', () => App.printReceipt('payment'));

                        // History Tab
                        const movements = await App.DB.getAll('movements', 'subscriberId', sub.id);
                        document.getElementById('history-tab').innerHTML = `<div class="table-responsive" style="max-height: 300px;"><table id="subscriber-movements-table"><tbody>${movements.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp)).map(m => `<tr><td>${m.type === 'activation' ? 'تفعيل' : 'تسديد'}</td><td>${m.type === 'activation' ? m.packageName : `دفعة: ${Number(m.amount).toLocaleString()}`}</td><td>${App.UI.formatDate(m.timestamp)}</td><td><button class="btn btn-sm btn-secondary print-movement-btn" data-movement-id="${m.id}"><i class="fas fa-print"></i></button></td></tr>`).join('')}</tbody></table></div>`;
                        document.getElementById('subscriber-movements-table').addEventListener('click', async e => {
                            if(e.target.closest('.print-movement-btn')) {
                                const movementId = parseInt(e.target.closest('.print-movement-btn').dataset.movementId);
                                const movement = await App.DB.get('movements', movementId);
                                App.printHistoricReceipt(movement, sub);
                            }
                        });
                        
                        // Edit Tab
                        this.renderEditForm(sub);

                        // Tab functionality
                        document.querySelector('#subscriber-modal .modal-tabs').addEventListener('click', (e) => {
                            if (e.target.classList.contains('tab-link')) {
                                const tabId = e.target.dataset.tab;
                                document.querySelectorAll('#subscriber-modal .tab-link').forEach(t => t.classList.remove('active'));
                                document.querySelectorAll('#subscriber-modal .tab-content').forEach(c => c.classList.remove('active'));
                                e.target.classList.add('active');
                                document.getElementById(`${tabId}-tab`).classList.add('active');
                            }
                        });
                    },
                    renderEditForm(sub) {
                        const ispOptions = App.state.settings.isps.map(isp => `<option value="${isp.id}" ${isp.id == sub.ispId ? 'selected' : ''}>${isp.name}</option>`).join('');
                        document.getElementById('edit-tab').innerHTML = `
                            <form id="subscriber-form">
                                <input type="hidden" id="subscriber-id" value="${sub.id || ''}">
                                <div class="form-group"><label>الاسم</label><input type="text" id="subscriber-name" class="form-control" required value="${sub.name || ''}"></div>
                                <div class="form-group"><label>اليوزر</label><input type="text" id="subscriber-username" class="form-control" value="${sub.username || ''}"></div>
                                <div class="form-group"><label>معرف الاشتراك (subId)</label><input type="text" id="subscriber-subid" class="form-control" value="${sub.subId || ''}"></div>
                                <div class="form-group"><label>الهاتف</label><input type="text" id="subscriber-phone" class="form-control" required value="${sub.phone || ''}"></div>
                                <div class="form-group"><label>شركة التزويد المخصصة</label><select id="subscriber-isp" class="form-control"><option value="">استخدام الافتراضي</option>${ispOptions}</select></div>
                                <div class="form-group"><label>ملاحظات</label><textarea id="subscriber-notes" class="form-control" rows="3">${sub.notes || ''}</textarea></div>
                                <button type="submit" class="btn btn-primary">حفظ المعلومات</button>
                            </form>
                            <hr style="margin: 20px 0;">
                            <div id="edit-dates-section" style="${sub.lastActivation_startDate ? 'display:block' : 'display:none'}">
                                <h4>تعديل تواريخ الاشتراك الحالي</h4>
                                <form id="edit-dates-form">
                                    <div class="form-group"><label>تاريخ البدء</label><input type="datetime-local" id="edit-start-date" class="form-control" value="${App.UI.getISO_DateTimeLocal(new Date(sub.lastActivation_startDate || new Date()))}"></div>
                                    <div class="form-group"><label>تاريخ الانتهاء</label><input type="datetime-local" id="edit-end-date" class="form-control" value="${App.UI.getISO_DateTimeLocal(new Date(sub.lastActivation_endDate || new Date()))}"></div>
                                    <button type="submit" class="btn btn-secondary">حفظ التواريخ</button>
                                </form>
                            </div>
                            ${sub.id ? '<button type="button" id="delete-sub-btn" class="btn btn-danger" style="margin-top:10px; width:100%;">حذف المشترك</button>' : ''}`;
                        document.getElementById('subscriber-form').addEventListener('submit', (e) => this.handleEditSubmit(e, sub));
                        document.getElementById('edit-dates-form')?.addEventListener('submit', (e) => this.handleEditDatesSubmit(e, sub));
                        document.getElementById('delete-sub-btn')?.addEventListener('click', () => this.handleDeleteSubmit(sub));
                    },
                    // Form Handlers
                    async handleActivationSubmit(e, sub) {
                        e.preventDefault();
                        const pkgId = parseInt(document.getElementById('activation-package').value);
                        if (!pkgId) { App.UI.showToast('الرجاء اختيار باقة', 'error'); return; }

                        const pkg = App.state.packages.find(p => p.id == pkgId);
                        const amountPaid = parseFloat(document.getElementById('activation-amount-paid').value) || 0;
                        const startDate = new Date(document.getElementById('activation-start-date').value);
                        const endDate = new Date(document.getElementById('activation-end-date').value);
                        const notes = document.getElementById('activation-notes').value;
                        
                        const newDebt = (Number(sub.debt) || 0) + Number(pkg.price) - amountPaid;

                        const movement = { id: Date.now(), subscriberId: sub.id, type: 'activation', packageName: pkg.name, amount: Number(pkg.price), paidAmount: amountPaid, notes, timestamp: new Date().toISOString(), startDate: startDate.toISOString(), endDate: endDate.toISOString() };
                        const updatedSub = { ...sub, debt: newDebt, lastActivation_packageName: pkg.name, lastActivation_startDate: startDate.toISOString(), lastActivation_endDate: endDate.toISOString(), lastActivation_movementId: movement.id };
                        
                        await App.DB.put('movements', movement);
                        await App.DB.put('subscribers', updatedSub);

                        App.UI.showToast('تم التفعيل بنجاح', 'success');

                        if (App.state.settings.automation.sendOnActivation) {
                            const templateData = { 'اسم_المشترك': updatedSub.name, 'اسم_الباقة': pkg.name, 'تاريخ_البدء': App.UI.formatNumericDateTime(startDate), 'تاريخ_الانتهاء': App.UI.formatNumericDateTime(endDate), 'الدين_السابق': (Number(sub.debt) || 0).toLocaleString(), 'سعر_الباقة': Number(pkg.price).toLocaleString(), 'المبلغ_الإجمالي': ((Number(sub.debt) || 0) + Number(pkg.price)).toLocaleString(), 'المبلغ_الواصل': amountPaid.toLocaleString(), 'الرصيد_المتبقي': newDebt.toLocaleString() };
                            const message = App.UI.parseTemplate(App.state.settings.whatsappTemplates.activation, templateData);
                            
                            App.UI.showWhatsappConfirmation(
                                'تم حفظ التفعيل. اضغط لإرسال الوصل عبر واتساب.',
                                updatedSub.phone,
                                message
                            );
                        }

                        document.getElementById('subscriber-modal')?.remove();
                        this.render();
                    },
                    async handlePaymentSubmit(e, sub) {
                        e.preventDefault();
                        const amount = parseFloat(document.getElementById('payment-amount').value);
                        if (!amount || amount <= 0) { App.UI.showToast('الرجاء إدخال مبلغ صحيح', 'error'); return; }
                        
                        const debt = Number(sub.debt) || 0;
                        const notes = document.getElementById('payment-notes').value;

                        const proceed = () => {
                            this.proceedWithPayment(sub, amount, notes);
                        };

                        if (amount > debt) {
                            App.UI.showConfirmation(
                                `المبلغ المدفوع (${amount.toLocaleString()}) أكبر من الدين الحالي (${debt.toLocaleString()}). سيصبح للمشترك رصيد. هل تريد المتابعة؟`,
                                proceed
                            );
                        } else {
                            proceed();
                        }
                    },
                    async proceedWithPayment(sub, amount, notes) {
                        const newDebt = (Number(sub.debt) || 0) - amount;

                        const movement = { id: Date.now(), subscriberId: sub.id, type: 'payment', amount, paidAmount: amount, notes, timestamp: new Date().toISOString() };
                        const updatedSub = { ...sub, debt: newDebt };

                        await App.DB.put('movements', movement);
                        await App.DB.put('subscribers', updatedSub);

                        App.UI.showToast('تم التسديد بنجاح', 'success');

                        if (App.state.settings.automation.sendOnPayment) {
                            const templateData = { 'اسم_المشترك': updatedSub.name, 'الدين_السابق': (Number(sub.debt) || 0).toLocaleString(), 'المبلغ_الواصل': amount.toLocaleString(), 'الرصيد_المتبقي': newDebt.toLocaleString() };
                            const message = App.UI.parseTemplate(App.state.settings.whatsappTemplates.payment, templateData);
                            
                            App.UI.showWhatsappConfirmation(
                                'تم حفظ الدفعة. اضغط لإرسال الوصل عبر واتساب.',
                                updatedSub.phone,
                                message
                            );
                        }

                        document.getElementById('subscriber-modal')?.remove();
                        this.render();
                    },
                    async handleEditSubmit(e, sub) {
                        e.preventDefault();
                        const id = parseInt(document.getElementById('subscriber-id').value) || Date.now();
                        const data = { 
                            name: document.getElementById('subscriber-name').value, 
                            username: document.getElementById('subscriber-username').value, 
                            phone: document.getElementById('subscriber-phone').value,
                            subId: document.getElementById('subscriber-subid').value,
                            ispId: parseInt(document.getElementById('subscriber-isp').value) || null,
                            notes: document.getElementById('subscriber-notes').value
                        };
                        
                        const existingSub = sub.id ? sub : { debt: 0 };
                        const finalSub = { ...existingSub, ...data, id: id };
                        
                        await App.DB.put('subscribers', finalSub);
                        App.UI.showToast('تم حفظ البيانات', 'success');
                        document.getElementById('subscriber-modal')?.remove();
                        this.render();
                    },
                    async handleEditDatesSubmit(e, sub) {
                        e.preventDefault();
                        if (!sub.lastActivation_movementId) { App.UI.showToast('لا يوجد اشتراك فعال لتعديله', 'error'); return; }
                        const movement = await App.DB.get('movements', sub.lastActivation_movementId);
                        const newStartDate = new Date(document.getElementById('edit-start-date').value);
                        const newEndDate = new Date(document.getElementById('edit-end-date').value);

                        await App.DB.put('movements', { ...movement, startDate: newStartDate.toISOString(), endDate: newEndDate.toISOString() });
                        await App.DB.put('subscribers', { ...sub, lastActivation_startDate: newStartDate.toISOString(), lastActivation_endDate: newEndDate.toISOString() });
                        
                        App.UI.showToast('تم تحديث التواريخ', 'success');
                        document.getElementById('subscriber-modal')?.remove();
                        this.render();
                    },
                    async handleDeleteSubmit(sub) {
                        if (confirm(`هل أنت متأكد من حذف ${sub.name}؟`)) {
                             await App.DB.delete('subscribers', sub.id);
                             const movements = await App.DB.getAll('movements', 'subscriberId', sub.id);
                             for (const m of movements) await App.DB.delete('movements', m.id);
                             App.UI.showToast('تم الحذف', 'success');
                             document.getElementById('subscriber-modal')?.remove();
                             this.render();
                        }
                    },
                    updateBulkActionsVisibility() {
                        const selectedCount = document.querySelectorAll('.sub-checkbox:checked').length;
                        const bar = document.getElementById('bulk-actions-bar');
                        const deleteBtn = document.getElementById('bulk-delete-btn');
                        const whatsappBtn = document.getElementById('bulk-whatsapp-btn');
                        const reminderBtn = document.getElementById('bulk-reminder-btn');
                        const currentFilter = document.querySelector('#subscriber-filters .filter-btn.active').dataset.filter;

                        if (bar) {
                            bar.style.display = selectedCount > 0 ? 'flex' : 'none';
                            document.getElementById('bulk-actions-count').textContent = `${selectedCount} محدد`;

                            if (currentFilter === 'expiring_soon') {
                                deleteBtn.style.display = 'none';
                                whatsappBtn.style.display = 'none';
                                reminderBtn.style.display = 'inline-flex';
                            } else {
                                deleteBtn.style.display = 'inline-flex';
                                whatsappBtn.style.display = 'inline-flex';
                                reminderBtn.style.display = 'none';
                            }
                        }
                    },
                    async handleBulkDelete() {
                        if (confirm(`هل أنت متأكد من حذف المشتركين المحددين؟`)) {
                            const selected = document.querySelectorAll('.sub-checkbox:checked');
                            if (selected.length === 0) return;
                            for (const box of selected) {
                                const subId = parseInt(box.closest('.sub-list-item').dataset.id);
                                await App.DB.delete('subscribers', subId);
                            }
                            App.UI.showToast('تم حذف المحددين', 'success');
                            this.render();
                        }
                    },
                    handleBulkWhatsapp() {
                        if (confirm(`سيتم فتح واتساب للأرقام المحددة. هل تود المتابعة؟`)) {
                            const selected = document.querySelectorAll('.sub-checkbox:checked');
                            if (selected.length === 0) return;
                            selected.forEach(box => App.openWhatsApp(box.dataset.phone, ''));
                        }
                    },
                    async handleBulkReminder() {
                        if (confirm(`سيتم إرسال رسالة تذكير للمشتركين المحددين. هل تود المتابعة؟\nملاحظة: قد يمنع المتصفح فتح نوافذ متعددة.`)) {
                            const selected = document.querySelectorAll('.sub-checkbox:checked');
                            if (selected.length === 0) return;
                            for (const box of selected) {
                                const subItem = box.closest('.sub-list-item');
                                this.handleReminder(subItem);
                            }
                        }
                    },
                    async handleExternalActivation(subId) {
                        const sub = await App.DB.get('subscribers', subId);
                        const isp = App.getSubscriberIsp(sub);
                        if (!isp) { App.UI.showToast('لم يتم تحديد شركة تزويد', 'error'); return; }
                        const url = isp.url.replace('{{USER}}', sub.username || '').replace('{{subId}}', sub.subId || '');
                        window.open(url, '_blank');
                    },
                    handleReminder(subItemElement) {
                        const name = subItemElement.dataset.name;
                        const phone = subItemElement.dataset.phone;
                        const endDate = subItemElement.dataset.endDate;

                        if (!phone || !endDate) {
                            App.UI.showToast('معلومات المشترك غير كاملة لإرسال تذكير.', 'error');
                            return;
                        }

                        const templateData = { 
                            'اسم_المشترك': name, 
                            'تاريخ_الانتهاء': App.UI.formatNumericDateTime(endDate) 
                        };
                        const message = App.UI.parseTemplate(App.state.settings.whatsappTemplates.reminder, templateData);
                        App.openWhatsApp(phone, message);
                        App.UI.showToast('تم تجهيز رسالة التذكير.', 'success');
                    }
                },
                Packages: {
                     async render() {
                        const packages = await App.DB.getAll('packages');
                        const tableBody = document.querySelector('#packages-table tbody');
                        tableBody.innerHTML = packages.map(p => `<tr data-id="${p.id}"><td>${p.name}</td><td>${Number(p.price).toLocaleString()}</td><td>${p.durationValue} ${p.durationType === 'months' ? 'شهر' : 'يوم'}</td><td><button class="btn btn-sm btn-secondary edit-pkg-btn"><i class="fas fa-edit"></i></button></td></tr>`).join('');
                        this.attachListeners();
                     },
                     attachListeners() {
                        const page = document.getElementById('packages-page');
                        if (page.dataset.listenerAttached) return;
                        page.querySelector('#packages-table').addEventListener('click', (e) => { if (e.target.closest('.edit-pkg-btn')) this.openFormModal(parseInt(e.target.closest('tr').dataset.id)); });
                        page.dataset.listenerAttached = 'true';
                     },
                     async openFormModal(pkgId = null) {
                        const pkg = pkgId ? await App.DB.get('packages', pkgId) : null;
                        const modalHTML = `<div class="modal"><div class="modal-content"><div class="modal-header"><h2>${pkg ? 'تعديل' : 'إضافة'} باقة</h2><span class="close-btn">&times;</span></div><div class="modal-body"><form id="package-form"><input type="hidden" id="package-id" value="${pkg?.id || ''}"><div class="form-group"><label>اسم الباقة</label><input type="text" id="package-name" class="form-control" value="${pkg?.name || ''}" required></div><div class="form-group"><label>السعر</label><input type="number" id="package-price" class="form-control" value="${pkg?.price || ''}" required></div><div class="form-group"><label>التكلفة</label><input type="number" id="package-cost" class="form-control" value="${pkg?.cost || 0}" required></div><div class="form-group"><label>المدة</label><div style="display:flex; gap:10px;"><input type="number" id="package-duration-value" class="form-control" value="${pkg?.durationValue || 30}" required><select id="package-duration-type" class="form-control"><option value="days" ${pkg?.durationType !== 'months' ? 'selected' : ''}>أيام</option><option value="months" ${pkg?.durationType === 'months' ? 'selected' : ''}>أشهر</option></select></div></div><div style="display:flex; gap: 10px;"><button type="submit" class="btn btn-primary" style="flex-grow:2;">حفظ</button>${pkg ? '<button type="button" id="delete-package-btn" class="btn btn-danger" style="flex-grow:1;">حذف</button>' : ''}</div></form></div></div></div>`;
                        const modal = App.UI.openModal(modalHTML, 'package-modal');
                        modal.querySelector('#package-form').addEventListener('submit', async (e) => {
                            e.preventDefault();
                            const id = parseInt(e.target.querySelector('#package-id').value) || Date.now();
                            const pkgData = { id, name: e.target.querySelector('#package-name').value, price: parseFloat(e.target.querySelector('#package-price').value), cost: parseFloat(e.target.querySelector('#package-cost').value), durationValue: parseInt(e.target.querySelector('#package-duration-value').value), durationType: e.target.querySelector('#package-duration-type').value };
                            await App.DB.put('packages', pkgData);
                            App.UI.showToast('تم حفظ الباقة', 'success');
                            modal.remove();
                            this.render();
                        });
                        modal.querySelector('#delete-package-btn')?.addEventListener('click', async () => { if (confirm('هل أنت متأكد؟')) { await App.DB.delete('packages', pkg.id); App.UI.showToast('تم الحذف', 'success'); modal.remove(); this.render(); } });
                     }
                 },
                Expenses: {
                    async render(){
                        const expenses = await App.DB.getAll('expenses');
                        const tableBody = document.querySelector('#expenses-table tbody');
                        tableBody.innerHTML = expenses.map(e => `<tr data-id="${e.id}"><td>${e.description}</td><td>${Number(e.amount).toLocaleString()}</td><td>${App.UI.formatDate(e.date)}</td><td><button class="btn btn-sm btn-secondary edit-exp-btn"><i class="fas fa-edit"></i></button></td></tr>`).join('');
                        this.attachListeners();
                    },
                    attachListeners() {
                        const page = document.getElementById('expenses-page');
                        if (page.dataset.listenerAttached) return;
                        page.querySelector('#expenses-table').addEventListener('click', (e) => { if (e.target.closest('.edit-exp-btn')) this.openFormModal(parseInt(e.target.closest('tr').dataset.id)); });
                        page.dataset.listenerAttached = 'true';
                    },
                    async openFormModal(expId = null) {
                        const exp = expId ? await App.DB.get('expenses', expId) : null;
                        const modalHTML = `<div class="modal"><div class="modal-content"><div class="modal-header"><h2>${exp ? 'تعديل' : 'إضافة'} مصروف</h2><span class="close-btn">&times;</span></div><div class="modal-body"><form id="expense-form"><input type="hidden" id="expense-id" value="${exp?.id || ''}"><div class="form-group"><label>الوصف</label><input type="text" id="expense-description" class="form-control" value="${exp?.description || ''}" required></div><div class="form-group"><label>المبلغ</label><input type="number" id="expense-amount" class="form-control" value="${exp?.amount || ''}" required></div><div class="form-group"><label>التاريخ</label><input type="date" id="expense-date" class="form-control" value="${exp?.date || App.UI.getISODate(new Date())}" required></div><div style="display:flex; gap: 10px;"><button type="submit" class="btn btn-primary" style="flex-grow:2;">حفظ</button>${exp ? '<button type="button" id="delete-expense-btn" class="btn btn-danger" style="flex-grow:1;">حذف</button>' : ''}</div></form></div></div></div>`;
                        const modal = App.UI.openModal(modalHTML, 'expense-modal');
                        modal.querySelector('#expense-form').addEventListener('submit', async (e) => {
                            e.preventDefault();
                            const id = parseInt(e.target.querySelector('#expense-id').value) || Date.now();
                            const expData = { id, description: e.target.querySelector('#expense-description').value, amount: parseFloat(e.target.querySelector('#expense-amount').value), date: e.target.querySelector('#expense-date').value };
                            await App.DB.put('expenses', expData);
                            App.UI.showToast('تم حفظ المصروف', 'success');
                            modal.remove();
                            this.render();
                        });
                        modal.querySelector('#delete-expense-btn')?.addEventListener('click', async () => { if (confirm('هل أنت متأكد؟')) { await App.DB.delete('expenses', exp.id); App.UI.showToast('تم الحذف', 'success'); modal.remove(); this.render(); } });
                    }
                },
                More: {
                     render() {
                        const container = document.getElementById('more-list-container');
                        if (!container) return;
                        
                        const userSession = JSON.parse(localStorage.getItem('userSession'));
                        const userName = userSession?.name || 'الملف الشخصي';
                        const userPhoto = userSession?.photoLink || 'https://placehold.co/40x40/eaf2fb/7f8c8d?text=U';

                        container.innerHTML = `
                            <div class="card">
                                <div class="list-item" data-page="profile">
                                    <div class="list-item-info profile-list-item">
                                        <img src="${userPhoto}" alt="User Avatar">
                                        <h4>${userName}</h4>
                                    </div>
                                    <i class="fas fa-chevron-left"></i>
                                </div>
                                <div class="list-item" data-page="reports"><div class="list-item-info"><h4><i class="fas fa-chart-pie fa-fw text-primary"></i> التقارير</h4></div><i class="fas fa-chevron-left"></i></div>
                                <div class="list-item" data-page="settings"><div class="list-item-info"><h4><i class="fas fa-cog fa-fw text-primary"></i> الإعدادات</h4></div><i class="fas fa-chevron-left"></i></div>
                                <div class="list-item" data-page="info"><div class="list-item-info"><h4><i class="fas fa-info-circle fa-fw text-primary"></i> حول التطبيق</h4></div><i class="fas fa-chevron-left"></i></div>
                                <div class="list-item" id="logout-btn" style="color: var(--danger-color);"><div class="list-item-info"><h4><i class="fas fa-sign-out-alt fa-fw"></i> تسجيل الخروج</h4></div><i class="fas fa-chevron-left"></i></div>
                            </div>
                        `;

                        container.querySelectorAll('.list-item').forEach(item => {
                            if(item.id === 'logout-btn') {
                                item.addEventListener('click', App.handleLogout);
                            } else {
                                item.addEventListener('click', () => { window.location.hash = item.dataset.page; });
                            }
                        });
                     }
                },
                Profile: {
                    async render() {
                        const userSession = JSON.parse(localStorage.getItem('userSession'));
                        if (!userSession) return;

                        document.getElementById('profile-avatar').src = userSession.photoLink || 'https://placehold.co/100x100/eaf2fb/7f8c8d?text=U';
                        document.getElementById('profile-name').textContent = userSession.name;
                        document.getElementById('profile-username').textContent = `@${userSession.username}`;
                        document.getElementById('profile-plan').textContent = userSession.plan;
                        document.getElementById('profile-end-date').textContent = App.UI.formatDate(userSession.endDate);

                        document.getElementById('update-name').value = userSession.name;
                        document.getElementById('update-email').value = userSession.email;
                        
                        this.attachListeners();
                    },
                    attachListeners() {
                        const page = document.getElementById('profile-page');
                        if (page.dataset.listenerAttached) return;

                        document.getElementById('profile-avatar').addEventListener('click', this.handleUpdatePhotoClick);
                        document.getElementById('update-profile-form').addEventListener('submit', this.handleUpdateProfileSubmit);
                        document.getElementById('change-password-form').addEventListener('submit', this.handleChangePasswordSubmit);

                        page.dataset.listenerAttached = 'true';
                    },
                    async handleUpdatePhotoClick() {
                        const newPhotoLink = prompt("الرجاء إدخال رابط الصورة الجديد:", document.getElementById('profile-avatar').src);
                        if (newPhotoLink && newPhotoLink.trim() !== '') {
                            App.Pages.Profile.handleUpdatePhotoSubmit(newPhotoLink.trim());
                        }
                    },
                    async handleUpdatePhotoSubmit(photoLink) {
                        const userSession = JSON.parse(localStorage.getItem('userSession'));
                        App.UI.showLoader();
                        try {
                            const payload = {
                                action: 'updatePhoto',
                                username: userSession.username,
                                photoLink: photoLink
                            };
                            const response = await fetch(App.loginScriptUrl, { method: 'POST', body: JSON.stringify(payload), mode: 'cors' });
                            const result = await response.json();

                            if (result.success) {
                                App.UI.showToast('تم تحديث الصورة بنجاح.', 'success');
                                userSession.photoLink = photoLink;
                                localStorage.setItem('userSession', JSON.stringify(userSession));
                                App.Pages.Profile.render();
                            } else {
                                throw new Error(result.message);
                            }
                        } catch (error) {
                            App.UI.showToast(`فشل تحديث الصورة: ${error.message}`, 'error');
                        } finally {
                            App.UI.hideLoader();
                        }
                    },
                    async handleUpdateProfileSubmit(e) {
                        e.preventDefault();
                        const userSession = JSON.parse(localStorage.getItem('userSession'));
                        const newName = document.getElementById('update-name').value;
                        const newEmail = document.getElementById('update-email').value;

                        App.UI.showLoader();
                        try {
                            const payload = {
                                action: 'updateProfile',
                                username: userSession.username,
                                name: newName,
                                email: newEmail
                            };
                            const response = await fetch(App.loginScriptUrl, { method: 'POST', body: JSON.stringify(payload), mode: 'cors' });
                            const result = await response.json();

                            if (result.success) {
                                App.UI.showToast('تم تحديث الملف الشخصي بنجاح.', 'success');
                                userSession.name = newName;
                                userSession.email = newEmail;
                                localStorage.setItem('userSession', JSON.stringify(userSession));
                                App.Pages.Profile.render();
                            } else {
                                throw new Error(result.message);
                            }
                        } catch (error) {
                            App.UI.showToast(`فشل التحديث: ${error.message}`, 'error');
                        } finally {
                            App.UI.hideLoader();
                        }
                    },
                    async handleChangePasswordSubmit(e) {
                        e.preventDefault();
                        const userSession = JSON.parse(localStorage.getItem('userSession'));
                        const currentPassword = document.getElementById('current-password').value;
                        const newPassword = document.getElementById('new-password').value;

                        if (!currentPassword || !newPassword) {
                            App.UI.showToast('الرجاء ملء جميع الحقول.', 'error');
                            return;
                        }

                        App.UI.showLoader();
                        try {
                             const payload = {
                                action: 'changePassword',
                                username: userSession.username,
                                currentPassword: currentPassword,
                                newPassword: newPassword
                            };
                            const response = await fetch(App.loginScriptUrl, { method: 'POST', body: JSON.stringify(payload), mode: 'cors' });
                            const result = await response.json();

                             if (result.success) {
                                App.UI.showToast('تم تغيير كلمة المرور بنجاح.', 'success');
                                e.target.reset(); // Clear form fields
                            } else {
                                throw new Error(result.message);
                            }
                        } catch (error) {
                            App.UI.showToast(`فشل التغيير: ${error.message}`, 'error');
                        } finally {
                            App.UI.hideLoader();
                        }
                    }
                },
                Reports: {
                     async render(){
                        const today = App.UI.getISODate(new Date());
                        document.getElementById('report-start-date').value = today;
                        document.getElementById('report-end-date').value = today;
                        this.attachListeners();
                     },
                     attachListeners() {
                        const page = document.getElementById('reports-page');
                        if (page.dataset.listenerAttached) return;
                        document.getElementById('generate-report-btn').addEventListener('click', () => this.generate());
                        document.getElementById('print-report-btn').addEventListener('click', () => this.print());
                        page.dataset.listenerAttached = 'true';
                     },
                     async generate() {
                        App.UI.showLoader();
                        const startDate = new Date(document.getElementById('report-start-date').value);
                        const endDate = new Date(document.getElementById('report-end-date').value);
                        endDate.setHours(23, 59, 59, 999);

                        const movements = (await App.DB.getAll('movements')).filter(m => { const d = new Date(m.timestamp); return d >= startDate && d <= endDate; });
                        const expenses = (await App.DB.getAll('expenses')).filter(e => { const d = new Date(e.date); return d >= startDate && d <= endDate; });

                        let totalRevenue = movements.reduce((sum, m) => sum + (Number(m.paidAmount) || 0), 0);
                        let totalCosts = movements.filter(m => m.type === 'activation').reduce((sum, m) => { const pkg = App.state.packages.find(p => p.name === m.packageName); return sum + (Number(pkg?.cost) || 0); }, 0);
                        let totalExpenses = expenses.reduce((sum, e) => sum + Number(e.amount), 0);
                        const netProfit = totalRevenue - totalCosts - totalExpenses;
                        
                        App.state.currentReportData = { totalRevenue, totalCosts, totalExpenses, netProfit, startDate, endDate };

                        document.getElementById('report-output').style.display = 'block';
                        document.getElementById('report-output').innerHTML = `<div class="card report-summary-list"><ul><li><span><i class="fas fa-arrow-up text-success"></i> إجمالي الإيرادات</span><span class="text-success">${totalRevenue.toLocaleString()}</span></li><li><span><i class="fas fa-arrow-down text-warning"></i> تكاليف الباقات</span><span class="text-warning">${totalCosts.toLocaleString()}</span></li><li><span><i class="fas fa-arrow-down text-danger"></i> المصاريف الأخرى</span><span class="text-danger">${totalExpenses.toLocaleString()}</span></li><li style="font-weight:bold; font-size:1.2rem;"><span><i class="fas fa-calculator text-primary"></i> صافي الربح</span><span class="text-primary">${netProfit.toLocaleString()}</span></li></ul></div>`;
                        App.UI.hideLoader();
                     },
                     print() {
                        if (!App.state.currentReportData) { App.UI.showToast('الرجاء توليد تقرير أولاً', 'warning'); return; }
                        const { totalRevenue, totalCosts, totalExpenses, netProfit, startDate, endDate } = App.state.currentReportData;
                        const profile = App.state.settings.companyProfile;
                        const printContent = `<div style="text-align:center; direction:rtl;"><img src="${profile.logo}" style="max-height:60px;"><h3 style="margin:5px 0;">${profile.name}</h3><p>تقرير مالي للفترة من ${App.UI.formatDate(startDate)} إلى ${App.UI.formatDate(endDate)}</p><hr><p>الإيرادات: ${totalRevenue.toLocaleString()}</p><p>التكاليف: ${totalCosts.toLocaleString()}</p><p>المصاريف: ${totalExpenses.toLocaleString()}</p><hr><p><b>صافي الربح: ${netProfit.toLocaleString()}</b></p></div>`;
                        App.printContent(printContent);
                     }
                },
                Settings: {
                    async render() {
                        const settings = App.state.settings;
                        const pageContainer = document.getElementById('settings-page');

                        pageContainer.innerHTML = `<div class="page-header"><h1>الإعدادات</h1></div>`;

                        const createSection = (title, icon, content) => {
                            const section = document.createElement('div');
                            section.className = 'card';
                            section.style.marginBottom = '20px';
                            section.innerHTML = `
                                <h3 style="font-size: 1.2rem; color: var(--primary-color); margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid var(--border-color);">
                                    <i class="fas ${icon} fa-fw"></i> ${title}
                                </h3>
                                ${content}
                            `;
                            pageContainer.appendChild(section);
                        };

                        // --- Company Profile Section ---
                        createSection('ملف الشركة', 'fa-building', `
                            <form id="company-profile-form">
                                <div class="form-group">
                                    <label for="company-name">اسم الشركة</label>
                                    <input type="text" id="company-name" class="form-control" value="${settings.companyProfile.name || ''}">
                                </div>
                                <div class="form-group">
                                    <label for="company-logo">رابط الشعار (URL)</label>
                                    <input type="text" id="company-logo" class="form-control" value="${settings.companyProfile.logo || ''}">
                                </div>
                                <div class="form-group">
                                    <label for="company-contact">معلومات التواصل</label>
                                    <input type="text" id="company-contact" class="form-control" value="${settings.companyProfile.contact || ''}">
                                </div>
                                <div class="form-group">
                                    <label for="whatsapp-code">كود الدولة للواتساب</label>
                                    <input type="text" id="whatsapp-code" class="form-control" value="${settings.companyProfile.whatsappCode || ''}">
                                </div>
                                <button type="submit" class="btn btn-primary">حفظ</button>
                            </form>
                        `);

                        // --- Appearance & Sound Section ---
                        const fontOptions = ['Cairo', 'Tajawal', 'Almarai', 'Noto Sans Arabic', 'El Messiri', 'Lalezar', 'Readex Pro']
                            .map(f => `<option value="'${f}', sans-serif" ${settings.appFont.includes(f) ? 'selected' : ''}>${f}</option>`).join('');
                        createSection('المظهر والأصوات', 'fa-paint-brush', `
                            <div class="form-group">
                                <label for="font-selector">خط التطبيق</label>
                                <select id="font-selector" class="form-control">${fontOptions}</select>
                            </div>
                            <div class="form-group">
                                <label for="primary-color-picker">اللون الأساسي</label>
                                <input type="color" id="primary-color-picker" class="form-control" value="${settings.primaryColor}">
                            </div>
                            <div class="form-group" style="display: flex; justify-content: space-between; align-items: center;">
                                <span>الوضع الليلي</span>
                                <label class="switch">
                                    <input type="checkbox" id="theme-toggle" ${document.body.classList.contains('dark-mode') ? 'checked' : ''}>
                                    <span class="slider round"></span>
                                </label>
                            </div>
                            <div class="form-group" style="display: flex; justify-content: space-between; align-items: center;">
                                <span>صوت اللمس</span>
                                <label class="switch">
                                    <input type="checkbox" id="touch-sound-toggle" ${settings.soundSettings.touchSound ? 'checked' : ''}>
                                    <span class="slider round"></span>
                                </label>
                            </div>
                        `);

                        // --- WhatsApp Automation Section ---
                        createSection('أتمتة الواتساب', 'fa-robot', `
                            <div class="form-group">
                                <label for="whatsapp-method-select">طريقة الإرسال</label>
                                <select id="whatsapp-method-select" class="form-control">
                                    <option value="api" ${settings.automation.whatsappMethod === 'api' ? 'selected' : ''}>API (wa.me) - الأفضل للجوال</option>
                                    <option value="web" ${settings.automation.whatsappMethod === 'web' ? 'selected' : ''}>Web (web.whatsapp.com) - الأفضل للكمبيوتر</option>
                                </select>
                            </div>
                            <div class="form-group" style="display: flex; justify-content: space-between; align-items: center;">
                                <span>إرسال رسالة عند التفعيل</span>
                                <label class="switch">
                                    <input type="checkbox" id="send-on-activation-toggle" ${settings.automation.sendOnActivation ? 'checked' : ''}>
                                    <span class="slider round"></span>
                                </label>
                            </div>
                            <div class="form-group" style="display: flex; justify-content: space-between; align-items: center;">
                                <span>إرسال رسالة عند التسديد</span>
                                <label class="switch">
                                    <input type="checkbox" id="send-on-payment-toggle" ${settings.automation.sendOnPayment ? 'checked' : ''}>
                                    <span class="slider round"></span>
                                </label>
                            </div>
                        `);

                        // --- WhatsApp Templates Section ---
                        createSection('قوالب رسائل واتساب', 'fa-whatsapp', `
                            <p style="font-size:0.8em; opacity:0.8; margin-bottom: 15px;">المتغيرات: {{اسم_المشترك}}, {{اسم_الباقة}}, {{تاريخ_البدء}}, {{تاريخ_الانتهاء}}, {{الدين_السابق}}, {{سعر_الباقة}}, {{المبلغ_الإجمالي}}, {{المبلغ_الواصل}}, {{الرصيد_المتبقي}}</p>
                            <form id="whatsapp-templates-form">
                                <div class="form-group"><label>قالب التفعيل</label><textarea id="activation-template" class="form-control" rows="5">${settings.whatsappTemplates.activation}</textarea></div>
                                <div class="form-group"><label>قالب التسديد</label><textarea id="payment-template" class="form-control" rows="4">${settings.whatsappTemplates.payment}</textarea></div>
                                <div class="form-group"><label>قالب رسالة التذكير</label><textarea id="reminder-template" class="form-control" rows="4">${settings.whatsappTemplates.reminder}</textarea></div>
                                <button type="submit" class="btn btn-primary">حفظ القوالب</button>
                            </form>
                        `);
                        
                        // --- ISP Management Section ---
                        const ispOptions = App.state.settings.isps.map(isp => `<option value="${isp.id}" ${isp.id == settings.activeIspId ? 'selected' : ''}>${isp.name}</option>`).join('');
                        createSection('إدارة شركات التزويد (ISP)', 'fa-network-wired', `
                            <div class="form-group">
                                <label>شركة التزويد الافتراضية</label>
                                <select id="active-isp-selector" class="form-control"><option value="">-- لا يوجد --</option>${ispOptions}</select>
                            </div>
                            <div class="table-responsive"><table id="isps-table"><tbody></tbody></table></div>
                            <button id="add-isp-btn" class="btn btn-secondary" style="margin-top:10px;">إضافة شركة</button>
                        `);

                        // --- Print Settings Section ---
                        const paperSize = settings.printSettings.paperSize;
                        createSection('إعدادات الطباعة', 'fa-print', `
                             <div class="form-group">
                                <label for="print-paper-size">حجم ورق الطباعة</label>
                                <select id="print-paper-size" class="form-control">
                                    <option value="A4" ${paperSize === 'A4' ? 'selected' : ''}>A4 (عادي)</option>
                                    <option value="80mm" ${paperSize === '80mm' ? 'selected' : ''}>80mm (حراري)</option>
                                    <option value="58mm" ${paperSize === '58mm' ? 'selected' : ''}>58mm (حراري)</option>
                                    <option value="custom" ${paperSize === 'custom' ? 'selected' : ''}>تخصيص...</option>
                                </select>
                            </div>
                            <div class="form-group" id="custom-paper-size-container" style="display: ${paperSize === 'custom' ? 'block' : 'none'};">
                                <label for="custom-paper-size">العرض المخصص (mm)</label>
                                <input type="number" id="custom-paper-size" class="form-control" value="${settings.printSettings.customPaperSize}" placeholder="مثال: 75">
                            </div>
                            <div class="form-group" style="display: flex; justify-content: space-between; align-items: center;">
                                <span>إظهار أزرار طباعة الوصلات</span>
                                <label class="switch">
                                    <input type="checkbox" id="show-print-buttons-toggle" ${settings.printSettings.showReceiptButtons ? 'checked' : ''}>
                                    <span class="slider round"></span>
                                </label>
                            </div>
                        `);
                        
                        // --- Data & Sync Section ---
                        createSection('البيانات والمزامنة', 'fa-sync-alt', `
                            <div class="form-group">
                                <label>رابط Google Sheet</label>
                                <input type="url" id="google-sheet-url" class="form-control" value="${App.gSheetApiUrl || ''}" placeholder="أدخل رابط Google Apps Script هنا">
                            </div>
                            <button id="save-gsheet-url-btn" class="btn btn-primary">حفظ الرابط</button>
                            <hr style="margin:20px 0;">
                            <div style="display:flex; gap:10px; margin-bottom: 20px;">
                                <button id="upload-to-sheet-btn" class="btn btn-success" style="flex:1;"><i class="fas fa-upload"></i> رفع</button>
                                <button id="download-from-sheet-btn" class="btn btn-danger" style="flex:1;"><i class="fas fa-download"></i> جلب</button>
                            </div>
                            <div class="form-group" style="display: flex; justify-content: space-between; align-items: center;">
                                <span>إظهار زر الرفع السريع</span>
                                <label class="switch">
                                    <input type="checkbox" id="show-fab-toggle" ${settings.syncSettings.showUploadFab ? 'checked' : ''}>
                                    <span class="slider round"></span>
                                </label>
                            </div>
                            <div class="form-group" style="display: flex; justify-content: space-between; align-items: center;">
                                <span>الرفع التلقائي عند الخمول</span>
                                <label class="switch">
                                    <input type="checkbox" id="auto-upload-toggle" ${settings.syncSettings.autoUploadOnIdle ? 'checked' : ''}>
                                    <span class="slider round"></span>
                                </label>
                            </div>
                            <hr style="margin:20px 0;">
                            <div style="display:flex; gap:10px;">
                                <button id="export-data-btn" class="btn btn-info"><i class="fas fa-file-export"></i> تصدير محلي</button>
                                <input type="file" id="import-file-input" style="display: none;" accept=".json">
                                <button id="import-data-btn" class="btn btn-warning"><i class="fas fa-file-import"></i> استيراد محلي</button>
                            </div>
                        `);

                        this.renderIspList();
                        this.attachListeners();
                    },
                    renderIspList() {
                        const tableBody = document.querySelector('#isps-table tbody');
                        if (!tableBody) return;
                        tableBody.innerHTML = App.state.settings.isps
                            .map(isp => `<tr data-id="${isp.id}"><td>${isp.name}</td><td><button class="btn btn-sm btn-secondary edit-isp-btn"><i class="fas fa-edit"></i></button></td></tr>`)
                            .join('');
                    },
                    attachListeners() {
                        const page = document.getElementById('settings-page');
                        if (page.dataset.listenerAttached) return;

                        // --- Event Listeners for each section ---
                        
                        // Company Profile
                        document.getElementById('company-profile-form')?.addEventListener('submit', async (e) => { 
                            e.preventDefault(); 
                            const p = { 
                                ...App.state.settings.companyProfile, 
                                name: document.getElementById('company-name').value, 
                                logo: document.getElementById('company-logo').value,
                                contact: document.getElementById('company-contact').value,
                                whatsappCode: document.getElementById('whatsapp-code').value
                            }; 
                            await App.saveSetting('companyProfile', p); 
                            App.UI.showToast('تم حفظ ملف الشركة', 'success'); 
                        });

                        // Appearance & Sound
                        document.getElementById('font-selector')?.addEventListener('change', async (e) => { App.UI.applyFont(e.target.value); await App.saveSetting('appFont', e.target.value); });
                        document.getElementById('primary-color-picker')?.addEventListener('input', async (e) => { App.UI.applyColor(e.target.value); await App.saveSetting('primaryColor', e.target.value); });
                        document.getElementById('theme-toggle')?.addEventListener('change', App.UI.toggleTheme);
                        document.getElementById('touch-sound-toggle')?.addEventListener('change', async (e) => { const soundSettings = { ...App.state.settings.soundSettings, touchSound: e.target.checked }; await App.saveSetting('soundSettings', soundSettings); });

                        // WhatsApp
                        document.getElementById('whatsapp-templates-form')?.addEventListener('submit', async (e) => { e.preventDefault(); const t = { ...App.state.settings.whatsappTemplates, activation: document.getElementById('activation-template').value, payment: document.getElementById('payment-template').value, reminder: document.getElementById('reminder-template').value }; await App.saveSetting('whatsappTemplates', t); App.UI.showToast('تم حفظ القوالب', 'success'); });
                        document.getElementById('whatsapp-method-select')?.addEventListener('change', async (e) => { const automation = { ...App.state.settings.automation, whatsappMethod: e.target.value }; await App.saveSetting('automation', automation); });
                        document.getElementById('send-on-activation-toggle')?.addEventListener('change', async (e) => { const automation = { ...App.state.settings.automation, sendOnActivation: e.target.checked }; await App.saveSetting('automation', automation); });
                        document.getElementById('send-on-payment-toggle')?.addEventListener('change', async (e) => { const automation = { ...App.state.settings.automation, sendOnPayment: e.target.checked }; await App.saveSetting('automation', automation); });

                        // ISP
                        document.getElementById('isps-table')?.addEventListener('click', (e) => { if(e.target.closest('.edit-isp-btn')) this.openIspModal(parseInt(e.target.closest('tr').dataset.id)); });
                        document.getElementById('add-isp-btn')?.addEventListener('click', () => this.openIspModal());
                        document.getElementById('active-isp-selector')?.addEventListener('change', async (e) => await App.saveSetting('activeIspId', parseInt(e.target.value) || null));

                        // Print
                        document.getElementById('print-paper-size')?.addEventListener('change', async (e) => {
                            const newSize = e.target.value;
                            const customContainer = document.getElementById('custom-paper-size-container');
                            const printSettings = { ...App.state.settings.printSettings, paperSize: newSize };
                            if (newSize === 'custom') { customContainer.style.display = 'block'; } else { customContainer.style.display = 'none'; }
                            await App.saveSetting('printSettings', printSettings);
                            App.UI.updatePrintStyles(newSize, printSettings.customPaperSize);
                        });
                        document.getElementById('custom-paper-size')?.addEventListener('input', async (e) => {
                            const customSize = parseInt(e.target.value) || 80;
                            const printSettings = { ...App.state.settings.printSettings, customPaperSize: customSize };
                            await App.saveSetting('printSettings', printSettings);
                            App.UI.updatePrintStyles('custom', customSize);
                        });
                        document.getElementById('show-print-buttons-toggle')?.addEventListener('change', async (e) => { const printSettings = { ...App.state.settings.printSettings, showReceiptButtons: e.target.checked }; await App.saveSetting('printSettings', printSettings); });

                        // Data & Sync
                        document.getElementById('show-fab-toggle')?.addEventListener('change', async (e) => { const syncSettings = { ...App.state.settings.syncSettings, showUploadFab: e.target.checked }; await App.saveSetting('syncSettings', syncSettings); document.getElementById('fab-upload-btn').style.display = e.target.checked ? 'flex' : 'none'; });
                        document.getElementById('auto-upload-toggle')?.addEventListener('change', async (e) => { const syncSettings = { ...App.state.settings.syncSettings, autoUploadOnIdle: e.target.checked }; await App.saveSetting('syncSettings', syncSettings); App.resetIdleTimer(); });
                        document.getElementById('save-gsheet-url-btn')?.addEventListener('click', () => { App.gSheetApiUrl = document.getElementById('google-sheet-url').value.trim(); localStorage.setItem('gSheetApiUrl', App.gSheetApiUrl); App.UI.showToast('تم حفظ الرابط', 'success'); });
                        document.getElementById('upload-to-sheet-btn')?.addEventListener('click', () => App.uploadAllDataToSheet());
                        document.getElementById('download-from-sheet-btn')?.addEventListener('click', () => App.downloadAllDataFromSheet());
                        document.getElementById('export-data-btn')?.addEventListener('click', () => App.exportData());
                        document.getElementById('import-data-btn')?.addEventListener('click', () => document.getElementById('import-file-input').click());
                        document.getElementById('import-file-input')?.addEventListener('change', (e) => App.importData(e));
                        
                        page.dataset.listenerAttached = 'true';
                    },
                    async openIspModal(ispId = null) {
                        const isp = ispId ? await App.DB.get('isps', ispId) : null;
                        const modalHTML = `<div class="modal"><div class="modal-content"><div class="modal-header"><h2>${isp ? 'تعديل' : 'إضافة'} شركة</h2><span class="close-btn">&times;</span></div><div class="modal-body"><form id="isp-form"><input type="hidden" id="isp-id" value="${isp?.id || ''}"><div class="form-group"><label>اسم الشركة</label><input type="text" id="isp-name" class="form-control" value="${isp?.name || ''}" required></div><div class="form-group"><label>رابط التفعيل</label><input type="text" id="isp-url" class="form-control" value="${isp?.url || ''}" placeholder="استخدم {{USER}} و {{subId}}"></div><div style="display:flex; gap: 10px;"><button type="submit" class="btn btn-primary" style="flex-grow:2;">حفظ</button>${isp ? '<button type="button" id="delete-isp-btn" class="btn btn-danger" style="flex-grow:1;">حذف</button>' : ''}</div></form></div></div></div>`;
                        const modal = App.UI.openModal(modalHTML, 'isp-modal');
                        modal.querySelector('#isp-form').addEventListener('submit', async (e) => {
                            e.preventDefault();
                            const id = parseInt(e.target.querySelector('#isp-id').value) || Date.now();
                            const ispData = { id, name: e.target.querySelector('#isp-name').value, url: e.target.querySelector('#isp-url').value };
                            await App.DB.put('isps', ispData);
                            App.state.settings.isps = await App.DB.getAll('isps'); // Refresh state
                            App.UI.showToast('تم الحفظ', 'success');
                            modal.remove();
                            App.loadPageData('settings'); // Reload settings page
                        });
                        modal.querySelector('#delete-isp-btn')?.addEventListener('click', async () => { 
                            if (confirm('هل أنت متأكد؟')) { 
                                await App.DB.delete('isps', isp.id); 
                                App.state.settings.isps = await App.DB.getAll('isps'); // Refresh state
                                App.UI.showToast('تم الحذف', 'success'); 
                                modal.remove(); 
                                App.loadPageData('settings'); // Reload settings page
                            } 
                        });
                    }
                },
                Info: {
                    render(){
                        const page = document.getElementById('info-page');
                        if(page) page.innerHTML = `<div class="page-header"><h1>حول التطبيق</h1></div><div class="card"><p>نظام إدارة اشتراكات الإنترنت، إصدار 2.1</p><p>تطبيق ويب تقدمي لإدارة شبكات ومكاتب الإنترنت بكفاءة.</p></div>`;
                    }
                }
            },
            
            // --- Global Listeners ---
            attachGlobalEventListeners() {
                document.body.addEventListener('click', (e) => {
                     // Play sound only on specific elements
                     if (e.target.closest('button, .nav-btn, .list-item, .sub-list-item .actions, .filter-btn')) {
                         this.playSound();
                     }
                });
                document.getElementById('fab-add-btn').addEventListener('click', (e) => {
                    const action = App.state.currentPage;
                    if (action === 'subscribers') App.Pages.Subscribers.openSubscriberModal();
                    else if (action === 'packages') App.Pages.Packages.openFormModal();
                    else if (action === 'expenses') App.Pages.Expenses.openFormModal();
                });
                document.getElementById('fab-upload-btn').addEventListener('click', () => this.uploadAllDataToSheet());
            },

            // --- Core Logic ---
            getSubscriberIsp(subscriber) {
                const ispId = subscriber.ispId || this.state.settings.activeIspId;
                if (!ispId) return null;
                return this.state.settings.isps.find(i => i.id == ispId);
            },
            openWhatsApp(phone, message) {
                if (!phone) {
                    this.UI.showToast('رقم الهاتف مفقود.', 'error');
                    return;
                }
                const cleanPhone = phone.toString().replace(/^0/, '');
                const fullPhone = `${this.state.settings.companyProfile.whatsappCode}${cleanPhone}`;
                const encodedMessage = encodeURIComponent(message);
                let url;
                if (this.state.settings.automation.whatsappMethod === 'web') {
                    url = `https://web.whatsapp.com/send?phone=${fullPhone}&text=${encodedMessage}`;
                } else { // 'api' is the default
                    url = `https://wa.me/${fullPhone}?text=${encodedMessage}`;
                }
                const newWindow = window.open(url, '_blank');
                if (!newWindow || newWindow.closed || typeof newWindow.closed == 'undefined') {
                    this.UI.showToast('تم حظر النافذة المنبثقة. الرجاء السماح بها.', 'error');
                }
            },
            playSound() {
                if (this.state.settings.soundSettings.touchSound) {
                    if (Tone.context.state !== 'running') {
                        Tone.context.resume();
                    }
                    if (!this.synth) {
                        this.synth = new Tone.Synth({
                            oscillator: { type: 'sine' },
                            envelope: { attack: 0.005, decay: 0.1, sustain: 0.1, release: 0.2 }
                        }).toDestination();
                        this.synth.volume.value = -18; // Make it quieter
                    }
                    this.synth.triggerAttackRelease("G5", "32n");
                }
            },
            resetIdleTimer() {
                clearTimeout(this.idleTimer);
                if (this.state.settings.syncSettings.autoUploadOnIdle) {
                    this.idleTimer = setTimeout(() => {
                        this.UI.showToast('يتم الرفع التلقائي...', 'info');
                        this.uploadAllDataToSheet(true);
                    }, 300000);
                }
            },
            saveSetting: async (key, value) => { App.state.settings[key] = value; await App.DB.put('settings', { key, value }); },
            
            handleLogout: async () => {
                const userSession = JSON.parse(localStorage.getItem('userSession'));
                const deviceId = localStorage.getItem('deviceId');
                
                if (userSession && deviceId) {
                    try {
                        const payload = {
                            action: 'logout',
                            username: userSession.username,
                            deviceId: deviceId
                        };
                        // Send request but don't wait for it to complete to speed up logout
                        fetch(App.loginScriptUrl, { method: 'POST', body: JSON.stringify(payload), mode: 'cors' });
                    } catch (error) {
                        console.error("Logout request failed, proceeding with local logout:", error);
                    }
                }
                localStorage.removeItem('userSession');
                window.location.replace('login.html');
            },

            // --- Data Management & Printing ---
            /**
             * NEW: Robust print function using an iframe to ensure isolation from app UI.
             * @param {string} contentHTML - The HTML string to be printed.
             */
            printContent(contentHTML) {
                const printFrame = document.createElement('iframe');
                printFrame.style.position = 'absolute';
                printFrame.style.width = '0';
                printFrame.style.height = '0';
                printFrame.style.border = '0';
                document.body.appendChild(printFrame);

                const frameDoc = printFrame.contentWindow.document;
                const printStyle = document.getElementById('print-style-sheet').innerHTML;
                const mainFontFamily = getComputedStyle(document.documentElement).getPropertyValue('--main-font');

                frameDoc.open();
                frameDoc.write(`
                    <!DOCTYPE html>
                    <html lang="ar" dir="rtl">
                    <head>
                        <title>طباعة</title>
                        <style>
                            body { 
                                font-family: ${mainFontFamily}, sans-serif; 
                                margin: 0;
                                -webkit-print-color-adjust: exact !important; /* Ensure colors print in Chrome/Safari */
                                color-adjust: exact !important; /* Standard */
                            }
                            ${printStyle}
                        </style>
                    </head>
                    <body>
                        ${contentHTML}
                    </body>
                    </html>
                `);
                frameDoc.close();

                setTimeout(() => {
                    try {
                        printFrame.contentWindow.focus();
                        printFrame.contentWindow.print();
                    } catch (e) {
                        console.error("Printing failed:", e);
                        App.UI.showToast('فشل الطباعة.', 'error');
                    } finally {
                        setTimeout(() => {
                            document.body.removeChild(printFrame);
                        }, 1000);
                    }
                }, 500);
            },

            async printReceipt(type) {
                const subId = this.state.currentSubscriberId;
                const sub = await this.DB.get('subscribers', subId);
                const profile = this.state.settings.companyProfile;
                let movementData, receiptTitle, newDebt;

                if (type === 'activation') {
                    const pkgId = parseInt(document.getElementById('activation-package').value);
                    const pkg = this.state.packages.find(p => p.id == pkgId);
                    if (!pkg) { this.UI.showToast('الرجاء اختيار باقة أولاً', 'error'); return; }
                    const amountPaid = parseFloat(document.getElementById('activation-amount-paid').value) || 0;
                    const startDate = new Date(document.getElementById('activation-start-date').value);
                    const endDate = new Date(document.getElementById('activation-end-date').value);
                    newDebt = (Number(sub.debt) || 0) + Number(pkg.price) - amountPaid;
                    receiptTitle = 'وصل تفعيل';
                    movementData = { details: `تفعيل باقة: ${pkg.name}`, subtotal: Number(pkg.price), paid: amountPaid, previousDebt: Number(sub.debt) || 0, total: (Number(sub.debt) || 0) + Number(pkg.price), remaining: newDebt, startDate, endDate };
                } else { // payment
                    const amount = parseFloat(document.getElementById('payment-amount').value);
                    if (!amount || amount <= 0) { this.UI.showToast('الرجاء إدخال مبلغ صحيح للطباعة', 'error'); return; }
                    newDebt = (Number(sub.debt) || 0) - amount;
                    receiptTitle = 'وصل تسديد';
                    movementData = { details: 'تسديد دفعة من الحساب', subtotal: amount, paid: amount, previousDebt: Number(sub.debt) || 0, total: Number(sub.debt) || 0, remaining: newDebt };
                }

                const receiptHTML = `<div style="font-family: var(--main-font); text-align: center; direction: rtl; color: #000; padding: 10px;"><img src="${profile.logo}" alt="شعار" style="max-height: 60px; margin-bottom: 15px;"><h3 style="margin: 0; font-size: 1.2em;">${profile.name}</h3><p style="margin: 2px 0; font-size: 0.9em;">${profile.contact}</p><hr style="border: none; border-top: 1px dashed #000; margin: 10px 0;"><h4 style="margin: 0 0 10px 0; font-size: 1.1em;">${receiptTitle}</h4><div style="text-align: right; font-size: 0.9em;"><p style="margin: 4px 0;"><strong>التاريخ:</strong> ${this.UI.formatNumericDateTime(new Date())}</p><p style="margin: 4px 0;"><strong>المشترك:</strong> ${sub.name}</p></div><hr style="border: none; border-top: 1px dashed #000; margin: 10px 0;"><table style="width: 100%; border-collapse: collapse; font-size: 0.9em;"><thead><tr><th style="text-align: right; padding: 5px;">الوصف</th><th style="text-align: left; padding: 5px;">المبلغ</th></tr></thead><tbody><tr><td style="text-align: right; padding: 5px;">${movementData.details}</td><td style="text-align: left; padding: 5px;">${movementData.subtotal.toLocaleString()}</td></tr></tbody></table><hr style="border: none; border-top: 1px dashed #000; margin: 10px 0;"><div style="text-align: right; font-size: 0.9em;"><p style="margin: 4px 0; display: flex; justify-content: space-between;"><span>الدين السابق:</span> <span>${movementData.previousDebt.toLocaleString()}</span></p><p style="margin: 4px 0; display: flex; justify-content: space-between;"><span>المبلغ الإجمالي:</span> <span>${movementData.total.toLocaleString()}</span></p><p style="margin: 4px 0; display: flex; justify-content: space-between;"><span>المبلغ الواصل:</span> <span>${movementData.paid.toLocaleString()}</span></p><p style="margin: 4px 0; display: flex; justify-content: space-between; font-weight: bold; font-size: 1.1em; border-top: 1px solid #000; padding-top: 5px; margin-top: 5px;"><span>الرصيد المتبقي:</span> <span>${movementData.remaining.toLocaleString()}</span></p></div>${type === 'activation' ? `<hr style="border: none; border-top: 1px dashed #000; margin: 10px 0;"><div style="font-size: 0.8em; text-align:right;"><p style="margin: 4px 0;"><strong>يبدأ من:</strong> ${this.UI.formatNumericDateTime(movementData.startDate)}</p><p style="margin: 4px 0;"><strong>ينتهي في:</strong> ${this.UI.formatNumericDateTime(movementData.endDate)}</p></div>` : ''}<div style="margin-top: 20px; font-size: 0.8em;">Powered by DashNET</div></div>`;
                
                this.printContent(receiptHTML);
            },
            async printHistoricReceipt(movement, subscriber) {
                 const profile = this.state.settings.companyProfile;
                 let receiptTitle = movement.type === 'activation' ? 'وصل تفعيل (نسخة)' : 'وصل تسديد (نسخة)';
                 let movementData = {};

                 if (movement.type === 'activation') {
                     movementData = {
                         details: `تفعيل باقة: ${movement.packageName}`,
                         subtotal: Number(movement.amount),
                         paid: Number(movement.paidAmount),
                         startDate: new Date(movement.startDate),
                         endDate: new Date(movement.endDate)
                     };
                 } else {
                     movementData = {
                         details: 'تسديد دفعة من الحساب',
                         subtotal: Number(movement.amount),
                         paid: Number(movement.amount),
                     };
                 }

                 const receiptHTML = `<div style="font-family: var(--main-font); text-align: center; direction: rtl; color: #000; padding: 10px;"><img src="${profile.logo}" alt="شعار" style="max-height: 60px; margin-bottom: 15px;"><h3 style="margin: 0; font-size: 1.2em;">${profile.name}</h3><p style="margin: 2px 0; font-size: 0.9em;">${profile.contact}</p><hr style="border: none; border-top: 1px dashed #000; margin: 10px 0;"><h4 style="margin: 0 0 10px 0; font-size: 1.1em;">${receiptTitle}</h4><div style="text-align: right; font-size: 0.9em;"><p style="margin: 4px 0;"><strong>تاريخ العملية:</strong> ${this.UI.formatNumericDateTime(movement.timestamp)}</p><p style="margin: 4px 0;"><strong>المشترك:</strong> ${subscriber.name}</p></div><hr style="border: none; border-top: 1px dashed #000; margin: 10px 0;"><table style="width: 100%; border-collapse: collapse; font-size: 0.9em;"><thead><tr><th style="text-align: right; padding: 5px;">الوصف</th><th style="text-align: left; padding: 5px;">المبلغ</th></tr></thead><tbody><tr><td style="text-align: right; padding: 5px;">${movementData.details}</td><td style="text-align: left; padding: 5px;">${movementData.paid.toLocaleString()}</td></tr></tbody></table>${movement.type === 'activation' ? `<hr style="border: none; border-top: 1px dashed #000; margin: 10px 0;"><div style="font-size: 0.8em; text-align:right;"><p style="margin: 4px 0;"><strong>يبدأ من:</strong> ${this.UI.formatNumericDateTime(movementData.startDate)}</p><p style="margin: 4px 0;"><strong>ينتهي في:</strong> ${this.UI.formatNumericDateTime(movementData.endDate)}</p></div>` : ''}<div style="margin-top: 20px; font-size: 0.8em;">Powered by DashNET</div></div>`;
                
                this.printContent(receiptHTML);
            },
            async uploadAllDataToSheet(silent = false) {
                if (!this.gSheetApiUrl) {
                    if (!silent) this.UI.showToast('الرجاء حفظ رابط Google Sheet أولاً.', 'error');
                    return;
                }
                if (!silent && !confirm('سيؤدي هذا لرفع البيانات المحلية واستبدال ما في الشيت. هل أنت متأكد؟')) return;

                if (!silent) this.UI.showLoader();
                try {
                    const storesToUpload = ['subscribers', 'packages', 'movements', 'expenses', 'isps', 'settings'];
                    
                    for (const storeName of storesToUpload) {
                        let localData = await this.DB.getAll(storeName);
                        
                        if (storeName === 'settings') {
                            localData = localData.filter(setting => setting.key !== 'appFont');
                        }
                        
                        for (const item of localData) {
                            await this.GSheetDB.put(storeName, item);
                        }
                    }
                    if (!silent) this.UI.showToast('اكتمل الرفع بنجاح!', 'success');
                } catch (error) {
                    if (!silent) this.UI.showToast(`فشل الرفع: ${error.message}`, 'error');
                } finally {
                    if (!silent) this.UI.hideLoader();
                    this.resetIdleTimer();
                }
            },
            async downloadAllDataFromSheet() {
                if (!this.gSheetApiUrl) {
                    this.UI.showToast('الرجاء حفظ رابط Google Sheet أولاً.', 'error');
                    return;
                }
                if (!confirm('تحذير! سيتم استبدال بياناتك المحلية الحالية بالبيانات من الشيت. هل أنت متأكد؟')) return;

                this.UI.showLoader();
                try {
                    const sheetData = await this.GSheetDB.getAllData();
                    const storesToSync = ['subscribers', 'packages', 'movements', 'expenses', 'isps', 'settings'];
                    const tx = this.db.transaction(storesToSync, 'readwrite');
                    for (const storeName of storesToSync) {
                        const store = tx.objectStore(storeName);
                        await new Promise(r => store.clear().onsuccess = r);
                        if (sheetData[storeName]) {
                            for(const record of sheetData[storeName]) {
                                if (storeName === 'settings' && record.key === 'appFont') {
                                    continue;
                                }
                                await new Promise(r => store.put(record).onsuccess = r);
                            }
                        }
                    }
                    this.UI.showToast('تم الجلب بنجاح! سيتم إعادة تحميل التطبيق.', 'success');
                    setTimeout(() => window.location.reload(), 2000);
                } catch (error) {
                    this.UI.showToast(`فشل الجلب: ${error.message}`, 'error');
                } finally {
                    this.UI.hideLoader();
                }
            },
            async exportData() {
                App.UI.showLoader();
                try {
                    const data = {};
                    const stores = App.db.objectStoreNames;
                    for (let i = 0; i < stores.length; i++) data[stores[i]] = await this.DB.getAll(stores[i]);
                    const a = document.createElement('a');
                    a.href = URL.createObjectURL(new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'}));
                    a.download = `backup-${new Date().toISOString().slice(0,10)}.json`;
                    a.click();
                    URL.revokeObjectURL(a.href);
                    App.UI.showToast('تم تصدير البيانات', 'success');
                } catch (e) { App.UI.showToast('فشل التصدير', 'error'); } 
                finally { App.UI.hideLoader(); }
            },
            importData(event) {
                const file = event.target.files[0];
                if (!file || !confirm('سيؤدي هذا للكتابة فوق البيانات الحالية. هل أنت متأكد؟')) return;
                const reader = new FileReader();
                reader.onload = async (e) => {
                    App.UI.showLoader();
                    try {
                        const data = JSON.parse(e.target.result);
                        const tx = App.db.transaction(App.db.objectStoreNames, 'readwrite');
                        for (const storeName in data) {
                            if (App.db.objectStoreNames.contains(storeName)) {
                                const store = tx.objectStore(storeName);
                                await new Promise(r => store.clear().onsuccess = r);
                                for(const record of data[storeName]) await new Promise(r => store.put(record).onsuccess = r);
                            }
                        }
                        App.UI.showToast('تم الاستيراد بنجاح. سيتم إعادة تحميل التطبيق.', 'success');
                        setTimeout(() => window.location.reload(), 2000);
                    } catch (err) { App.UI.showToast('فشل الاستيراد', 'error'); App.UI.hideLoader(); }
                };
                reader.readAsText(file);
            },
            async exportSubscribersTo(format) {
                App.UI.showLoader();
                try {
                    let subscribers = await App.DB.getAll('subscribers');
                    const searchTerm = document.getElementById('subscriber-search')?.value.toLowerCase() || '';
                    const filter = document.querySelector('#subscriber-filters .filter-btn.active').dataset.filter;

                    if (filter !== 'all') subscribers = subscribers.filter(sub => (filter === 'has_debt') ? (Number(sub.debt) || 0) > 0 : this.Pages.Subscribers.getSubscriberStatus(sub).key === filter);
                    if (searchTerm) subscribers = subscribers.filter(s => s.name.toLowerCase().includes(searchTerm) || s.phone.toLowerCase().includes(searchTerm));

                    const dataToExport = subscribers.map(sub => ({
                        'الاسم': sub.name,
                        'الهاتف': sub.phone,
                        'الحالة': this.Pages.Subscribers.getSubscriberStatus(sub).text,
                        'تاريخ الانتهاء': this.UI.formatNumericDateTime(sub.lastActivation_endDate),
                        'الدين': sub.debt || 0,
                        'اليوزر': sub.username || '',
                        'معرف الاشتراك': sub.subId || ''
                    }));

                    const ws = XLSX.utils.json_to_sheet(dataToExport);
                    const fileName = `subscribers-${new Date().toISOString().slice(0, 10)}.${format}`;
                    let blob;

                    if (format === 'xlsx') {
                        const wb = XLSX.utils.book_new();
                        XLSX.utils.book_append_sheet(wb, ws, "المشتركين");
                        const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
                        blob = new Blob([wbout], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                    } else { // csv
                        const csv = XLSX.utils.sheet_to_csv(ws);
                        blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
                    }
                    
                    const link = document.createElement("a");
                    const url = URL.createObjectURL(blob);
                    link.setAttribute("href", url);
                    link.setAttribute("download", fileName);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);

                    App.UI.showToast('تم التصدير بنجاح', 'success');
                } catch(e) {
                    App.UI.showToast('فشل التصدير', 'error');
                    console.error(e);
                } finally {
                    App.UI.hideLoader();
                }
            }
        };

        App.init();
    });
    </script>
</body>
</html>
