<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدارة الاشتراكات</title>
    <meta name="theme-color" content="#4a90e2">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="images/icon-192x192.png">

    <!-- CDN Libraries -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Almarai:wght@400;700&family=Cairo:wght@400;700&family=El+Messiri:wght@400;700&family=Lalezar&family=Noto+Sans+Arabic:wght@400;700&family=Readex+Pro:wght@400;700&family=Tajawal:wght@400;700&display=swap" rel="stylesheet">

    <style>
        /* General Styles & Theming */
        :root {
            --primary-color: #4a90e2;
            --primary-color-dark: #357ABD;
            --primary-color-light: #EAF2FB;
            --text-color: #333;
            --text-color-light: #e0e0e0;
            --bg-color: #f4f7fa;
            --sidebar-bg: #ffffff;
            --card-bg: #ffffff;
            --border-color: #e0e0e0;
            --danger-color: #e74c3c;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --selected-row-bg: #dbeafe;
            --main-font: 'Cairo', sans-serif;
        }

        .dark-mode {
            --text-color: var(--text-color-light);
            --bg-color: #121212;
            --sidebar-bg: #1a1a1a;
            --card-bg: #1e1e1e;
            --border-color: #2d2d2d;
            --primary-color-light: rgba(74, 144, 226, 0.1);
            --selected-row-bg: rgba(74, 144, 226, 0.15);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--main-font);
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
            font-size: 16px;
            line-height: 1.6;
            overflow: hidden; /* Prevent body scroll */
        }
        
        /* Layout */
        .app-container {
            display: flex;
            height: 100vh;
        }

        .sidebar {
            width: 260px;
            background-color: var(--sidebar-bg);
            border-left: 1px solid var(--border-color);
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            position: fixed;
            top: 0;
            right: 0;
            height: 100%;
            z-index: 1000;
        }
        
        .main-nav {
            flex-grow: 1;
            list-style: none;
            padding-top: 20px;
            overflow-y: auto; /* Scroll for nav items if they overflow */
        }

        .main-content {
            flex-grow: 1;
            margin-right: 260px;
            transition: margin-right 0.3s;
            height: 100vh;
            overflow-y: auto; /* THE MOST IMPORTANT CHANGE FOR SCROLLING */
            padding: 25px;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            height: 80px;
            flex-shrink: 0;
        }
        
        /* User Profile Section in Sidebar */
        .sidebar-footer {
            padding: 15px;
            border-top: 1px solid var(--border-color);
            flex-shrink: 0; /* Prevent footer from shrinking */
        }

        .user-profile-widget {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-bottom: 10px;
        }
        .user-profile-widget:hover {
            background-color: var(--primary-color-light);
        }
        #user-widget-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--primary-color);
        }
        .user-widget-info {
            line-height: 1.3;
            overflow: hidden;
        }
        #user-widget-name {
            font-weight: bold;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        #user-widget-email {
            font-size: 0.85rem;
            opacity: 0.7;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Other styles from original file... */
        .text-success { color: var(--success-color); }
        .text-danger { color: var(--danger-color); }
        .text-warning { color: var(--warning-color); }
        .text-primary { color: var(--primary-color); }
        .bg-success { background-color: var(--success-color); }
        .bg-danger { background-color: var(--danger-color); }
        .bg-warning { background-color: var(--warning-color); }
        .bg-primary { background-color: var(--primary-color); }

        .sidebar.collapsed {
            width: 80px;
        }
        
        .sidebar.collapsed .sidebar-header {
            justify-content: center;
        }
        
        .sidebar.collapsed #sidebar-company-name,
        .sidebar.collapsed .nav-link span,
        .sidebar.collapsed .user-widget-info,
        .sidebar.collapsed .theme-switcher span {
            display: none;
        }

        .sidebar-header {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        #sidebar-logo {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            object-fit: cover;
        }

        #sidebar-company-name {
            color: var(--primary-color);
            font-size: 1.5rem;
            font-weight: 700;
            white-space: nowrap;
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 15px 25px;
            color: var(--text-color);
            text-decoration: none;
            transition: background-color 0.3s;
            white-space: nowrap;
        }

        .nav-link:hover, .nav-link.active {
            background-color: var(--primary-color-light);
            color: var(--primary-color);
        }

        .nav-link i {
            width: 30px;
            text-align: center;
            font-size: 1.2rem;
            margin-left: 15px;
        }

        .sidebar.collapsed + .main-content {
            margin-right: 80px;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
            animation: fadeIn 0.5s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .page-header h1 {
            font-size: 2rem;
        }
        
        .header-actions {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .card {
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            box-shadow: var(--shadow);
            margin-bottom: 25px;
        }

        .stat-card {
            display: flex;
            align-items: center;
        }

        .stat-card .icon {
            font-size: 2rem;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            margin-left: 20px;
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .stat-card .info h3 {
            font-size: 1rem;
            color: var(--text-color);
            opacity: 0.8;
            margin: 0;
        }

        .stat-card .info p {
            font-size: 1.8rem;
            font-weight: bold;
            margin: 0;
        }

        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
        }
        
        .quick-list {
            list-style: none;
            padding: 0;
        }
        .quick-list li {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-color);
        }
        .quick-list li:last-child {
            border-bottom: none;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-family: inherit;
        }
        
        .btn-sm {
            padding: 5px 10px;
            font-size: 0.8rem;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: #fff;
        }

        .btn-primary:hover {
            background-color: var(--primary-color-dark);
        }
        
        .btn-secondary {
            background-color: var(--card-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: #fff;
        }
        
        .filter-btn {
            background-color: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-color);
        }
        .filter-btn.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background-color: var(--bg-color);
            color: var(--text-color);
            font-size: 1rem;
            font-family: inherit;
        }
        
        .dark-mode .form-control {
            background-color: #2d2d2d;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 25px;
        }
        .switch input { 
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 19px;
            width: 19px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
        }
        input:checked + .slider {
            background-color: var(--success-color);
        }
        input:checked + .slider:before {
            transform: translateX(25px);
        }
        .slider.round {
            border-radius: 25px;
        }
        .slider.round:before {
            border-radius: 50%;
        }

        .table-responsive {
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            text-align: right;
        }

        th, td {
            padding: 12px 15px;
            border-bottom: 1px solid var(--border-color);
            vertical-align: middle;
        }
        
        td .btn-sm {
            margin: 2px;
        }

        thead tr {
            background-color: var(--primary-color-light);
        }
        
        tbody tr:hover {
            background-color: var(--primary-color-light);
        }
        
        tbody tr.selected-row {
            background-color: var(--selected-row-bg);
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.5);
            -webkit-backdrop-filter: blur(4px);
            backdrop-filter: blur(4px);
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background-color: var(--card-bg);
            margin: auto;
            padding: 0;
            border-radius: 12px;
            width: 90%;
            max-width: 800px;
            animation: slideIn 0.3s;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }
        
        .dark-mode .modal-content {
            background-color: rgba(30, 30, 30, 0.9);
        }
        
        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 25px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .close-btn {
            cursor: pointer;
            font-size: 1.8rem;
            color: var(--text-color);
        }
        
        .modal-body {
            padding: 25px;
            max-height: 70vh;
            overflow-y: auto;
        }
        
        .modal-tabs {
            display: flex;
            background-color: var(--primary-color-light);
            padding: 0 25px;
        }
        .tab-link {
            padding: 15px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            font-weight: 500;
        }
        .tab-link:hover {
            color: var(--primary-color);
        }
        .tab-link.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
            animation: fadeIn 0.4s;
        }

        .sub-status-card {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-color-dark));
            color: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .sub-status-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .sub-status-header h4 {
            margin: 0;
            font-size: 1.2rem;
        }
        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.8em;
            color: white;
        }
        .status-badge.active { background-color: var(--success-color); }
        .status-badge.expired { background-color: var(--danger-color); }
        .status-badge.expiring_soon { background-color: var(--warning-color); }

        .sub-status-body {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        .sub-status-body p {
            margin: 0;
            font-size: 1rem;
        }
        .sub-status-body p strong {
            display: block;
            font-size: 1.3rem;
            margin-top: 4px;
        }
        .progress-bar {
            grid-column: 1 / -1;
            height: 8px;
            background-color: rgba(255,255,255,0.3);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 10px;
        }
        .progress-bar-inner {
            height: 100%;
            background-color: var(--success-color);
            border-radius: 4px;
            transition: width 0.5s;
        }
        
        .accordion-item {
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 10px;
            overflow: hidden;
        }
        .accordion-header {
            padding: 15px 20px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: var(--primary-color-light);
        }
        .accordion-header h4 {
            margin: 0;
            color: var(--primary-color);
        }
        .accordion-header .icon {
            transition: transform 0.3s;
        }
        .accordion-item.active .accordion-header .icon {
            transform: rotate(180deg);
        }
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out, padding 0.3s ease-out;
            padding: 0 20px;
        }
        .accordion-content p, .accordion-content ul {
            margin-top: 0;
            margin-bottom: 15px;
        }
        .accordion-content ul {
            padding-right: 20px;
        }

        #toast-container {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 9999;
        }

        .toast {
            padding: 15px 20px;
            margin-bottom: 10px;
            border-radius: 8px;
            color: #fff;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            opacity: 0;
            transform: translateY(100%);
            transition: all 0.5s ease;
        }

        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }

        .toast.success { background-color: var(--success-color); }
        .toast.error { background-color: var(--danger-color); }
        .toast.info { background-color: var(--primary-color); }

        #loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            display: none;
            justify-content: center;
            align-items: center;
        }
        
        .spinner {
            border: 8px solid var(--primary-color-light);
            border-top: 8px solid var(--primary-color);
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .fab-btn {
            position: fixed;
            bottom: 25px;
            left: 25px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
            border: none;
            cursor: pointer;
            z-index: 999;
            transition: transform 0.3s, background-color 0.3s;
        }
        .fab-btn:hover {
            background-color: var(--primary-color-dark);
            transform: scale(1.1);
        }

        .report-summary-list ul {
            list-style: none;
            padding: 0;
        }
        .report-summary-list li {
            display: flex;
            justify-content: space-between;
            font-size: 1.1rem;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
        }
        .report-summary-list li:last-child {
            border-bottom: none;
            font-weight: bold;
            font-size: 1.3rem;
            padding-top: 20px;
        }
        .report-summary-list li span:first-child {
            font-weight: 500;
        }
        
        .app-footer {
            text-align: center;
            padding: 20px 0 0 0;
            margin-top: 40px;
            color: #888;
            font-size: 0.9rem;
            border-top: 1px solid var(--border-color);
        }
        .app-footer a {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: bold;
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(100%);
                box-shadow: var(--shadow);
                background-color: rgba(255, 255, 255, 0.8);
                -webkit-backdrop-filter: blur(10px);
                backdrop-filter: blur(10px);
            }
            .dark-mode .sidebar {
                 background-color: rgba(26, 26, 26, 0.8);
            }
            .sidebar.open {
                transform: translateX(0);
            }
            .main-content {
                margin-right: 0;
                padding: 15px;
            }
            .mobile-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 15px;
                background-color: var(--card-bg);
                position: sticky;
                top: 0;
                z-index: 999;
                border-bottom: 1px solid var(--border-color);
            }
            .dark-mode .mobile-header {
                background-color: var(--sidebar-bg);
            }
            .mobile-header h2 { color: var(--primary-color); }
            .menu-toggle { font-size: 1.5rem; cursor: pointer; }
            .overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                z-index: 998;
                display: none;
            }
            .overlay.active { display: block; }
            .grid-container {
                grid-template-columns: 1fr;
            }
            .modal-content {
                width: 95%;
                height: 85%;
            }
            .modal-tabs {
                padding: 0 10px;
                flex-wrap: wrap;
            }
            .tab-link {
                padding: 12px 10px;
                font-size: 0.9rem;
            }
            .modal-body {
                padding: 15px;
            }
            .page-header h1 {
                font-size: 1.5rem;
            }
            .header-actions {
                gap: 5px;
            }
            .header-actions .btn {
                padding: 8px 10px;
                font-size: 0.8rem;
            }
            .toolbar {
                flex-direction: column;
                align-items: stretch;
                gap: 15px !important;
            }
            .toolbar .form-control {
                width: 100%;
            }
        }
        
        @media (min-width: 769px) {
            .mobile-header { display: none; }
        }
        
        @media print {
            body {
                overflow: visible; /* Allow content to flow in print */
            }
            .no-print {
                display: none !important;
            }
            .app-container, .sidebar, .main-content, .app-footer {
                display: block;
                margin: 0;
                padding: 0;
                position: static;
                height: auto;
                overflow: visible;
            }
            .page {
                display: none !important;
            }
            .page.active {
                display: block !important;
            }
            #report-output {
                display: block !important;
            }
            .card {
                box-shadow: none;
                border: 1px solid #ccc;
            }
            body {
                background-color: #fff;
            }
            .page-header {
                display: none;
            }
            #print-header {
                display: block !important;
                text-align: center;
                margin-bottom: 20px;
            }
            .app-footer {
                border-top: 1px solid #ccc;
                padding: 10px;
                font-size: 10pt;
            }
        }
    </style>
    <style id="print-style-sheet"></style>
</head>
<body>

    <div id="loader">
        <div class="spinner"></div>
    </div>

    <div id="toast-container"></div>
    
    <div class="overlay" id="overlay"></div>

    <div class="app-container">
        <aside class="sidebar no-print" id="sidebar">
            <div class="sidebar-header">
                <img src="" alt="شعار الشركة" id="sidebar-logo">
                <h2 id="sidebar-company-name"></h2>
            </div>
            <ul class="main-nav" id="main-nav">
                <li><a href="#dashboard" class="nav-link active"><i class="fas fa-tachometer-alt"></i><span>لوحة التحكم</span></a></li>
                <li><a href="#subscribers" class="nav-link"><i class="fas fa-users"></i><span>المشتركين</span></a></li>
                <li><a href="#movements" class="nav-link"><i class="fas fa-exchange-alt"></i><span>سجل الحركات</span></a></li>
                <li><a href="#packages" class="nav-link"><i class="fas fa-box-open"></i><span>الباقات</span></a></li>
                <li><a href="#expenses" class="nav-link"><i class="fas fa-wallet"></i><span>المصاريف</span></a></li>
                <li><a href="#reports" class="nav-link"><i class="fas fa-chart-pie"></i><span>التقارير</span></a></li>
                <li><a href="#settings" class="nav-link"><i class="fas fa-cog"></i><span>الإعدادات</span></a></li>
                <li><a href="#info" class="nav-link"><i class="fas fa-info-circle"></i><span>صفحات ثابتة</span></a></li>
            </ul>
            <div class="sidebar-footer">
                <!-- User Profile Widget -->
                <div class="user-profile-widget" id="user-profile-widget">
                    <img src="https://placehold.co/100x100/EAF2FB/333?text=U" alt="User Avatar" id="user-widget-avatar">
                    <div class="user-widget-info">
                        <div id="user-widget-name">اسم المستخدم</div>
                        <div id="user-widget-email">user@example.com</div>
                    </div>
                </div>
                <!-- Theme Switcher -->
                <div class="theme-switcher">
                    <button id="theme-toggle" class="btn btn-secondary" style="width: 100%;"><i class="fas fa-moon"></i><span>الوضع الليلي</span></button>
                </div>
            </div>
        </aside>

        <main class="main-content" id="main-content">
            <div class="mobile-header no-print">
                <i class="fas fa-bars menu-toggle" id="menu-toggle"></i>
                <h2>نظامي</h2>
                <i class="fas fa-bell"></i>
            </div>
            
            <section id="dashboard-page" class="page active">
                <div class="page-header"><h1>لوحة التحكم</h1></div>
                <div class="grid-container" id="stats-grid">
                    </div>
                <div class="grid-container" style="margin-top: 25px;">
                    <div class="card">
                        <h3>الاشتراكات الجديدة (آخر 6 أشهر)</h3>
                        <canvas id="newSubsChart"></canvas>
                    </div>
                    <div class="card">
                        <h3>توزيع المشتركين على الباقات</h3>
                        <canvas id="packagesPieChart"></canvas>
                    </div>
                </div>
                 <div class="card" style="margin-top: 25px;">
                    <h3>الإيرادات والمصاريف (آخر 6 أشهر)</h3>
                    <canvas id="revenueExpenseChart"></canvas>
                </div>
                <div class="grid-container" style="margin-top: 25px;">
                    <div class="card">
                        <h3><i class="fas fa-hourglass-end text-warning"></i> تنتهي اليوم</h3>
                        <ul id="expiring-today-list" class="quick-list"></ul>
                    </div>
                    <div class="card">
                        <h3><i class="fas fa-history"></i> آخر الحركات</h3>
                        <ul id="latest-movements-list" class="quick-list"></ul>
                    </div>
                </div>
            </section>

            <section id="subscribers-page" class="page">
                 <div class="page-header" style="display: flex; justify-content: space-between; align-items: center;">
                    <h1>قائمة المشتركين</h1>
                    <div class="header-actions">
                        <button id="export-subs-csv" class="btn btn-secondary"><i class="fas fa-file-csv"></i> CSV</button>
                        <button id="export-subs-xlsx" class="btn btn-success"><i class="fas fa-file-excel"></i> XLSX</button>
                        <button id="add-subscriber-btn" class="btn btn-primary"><i class="fas fa-plus"></i> إضافة مشترك</button>
                    </div>
                </div>
                <div class="card">
                    <div class="toolbar" style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; justify-content: space-between; align-items: center;">
                        <input type="text" id="subscriber-search" class="form-control" placeholder="بحث بالاسم أو الهاتف..." style="flex-grow: 1; min-width: 200px;">
                        <div id="subscriber-filters" class="btn-group" style="display: flex; gap: 5px; flex-wrap: wrap;">
                           <button class="btn btn-sm filter-btn active" data-filter="all">الكل</button>
                           <button class="btn btn-sm filter-btn" data-filter="active">فعال</button>
                           <button class="btn btn-sm filter-btn" data-filter="expiring_soon">سينتهي قريبا</button>
                           <button class="btn btn-sm filter-btn" data-filter="expired">منتهي</button>
                           <button class="btn btn-sm filter-btn" data-filter="has_debt">عليه دين</button>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table id="subscribers-table">
                            <thead>
                                <tr>
                                    <th><input type="checkbox" id="select-all-subs"></th>
                                    <th>الاسم</th>
                                    <th>الهاتف</th>
                                    <th>الحالة</th>
                                    <th>تاريخ الانتهاء</th>
                                    <th>الدين</th>
                                    <th>إجراءات</th>
                               </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                        <p id="no-subs-message" style="text-align: center; padding: 20px; display: none;">لا يوجد مشتركين لعرضهم.</p>
                    </div>
                     <div class="bulk-actions no-print" id="bulk-actions-bar" style="display: none; margin-top: 20px; gap: 10px; padding: 10px; background-color: var(--primary-color-light); border-radius: 8px;">
                        <span id="bulk-actions-count" style="font-weight: bold;">0 مشترك محدد</span>
                        <button id="bulk-delete-btn" class="btn btn-sm btn-danger"><i class="fas fa-trash"></i> حذف المحدد</button>
                        <button id="bulk-whatsapp-btn" class="btn btn-sm btn-success"><i class="fab fa-whatsapp"></i> إرسال واتساب جماعي</button>
                    </div>
                </div>
            </section>
            
             <section id="movements-page" class="page">
                <div class="page-header">
                    <h1>سجل الحركات</h1>
                    <div class="header-actions">
                        <button id="export-moves-csv" class="btn btn-secondary"><i class="fas fa-file-csv"></i> CSV</button>
                        <button id="export-moves-xlsx" class="btn btn-success"><i class="fas fa-file-excel"></i> XLSX</button>
                    </div>
                </div>
                 <div class="grid-container" id="movements-stats-grid">
                    </div>
                <div class="card">
                    <div class="toolbar" style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
                        <input type="text" id="movements-search" class="form-control" placeholder="بحث باسم المشترك..." style="flex-grow: 1;">
                        <input type="date" id="movements-start-date" class="form-control" style="width: auto;">
                        <input type="date" id="movements-end-date" class="form-control" style="width: auto;">
                        <select id="movements-type-filter" class="form-control" style="width: auto;">
                            <option value="all">كل الحركات</option>
                            <option value="activation">تفعيل</option>
                            <option value="payment">تسديد</option>
                        </select>
                    </div>
                    <div class="table-responsive">
                        <table id="movements-table">
                            <thead>
                                <tr>
                                    <th>المشترك</th>
                                    <th>النوع</th>
                                    <th>التفاصيل</th>
                                    <th>ملاحظات</th>
                                    <th>التاريخ والوقت</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                         <p id="no-movements-message" style="text-align: center; padding: 20px; display: none;">لا توجد حركات لعرضها.</p>
                    </div>
                </div>
            </section>

            <section id="packages-page" class="page">
                <div class="page-header" style="display: flex; justify-content: space-between; align-items: center;">
                    <h1>إدارة الباقات</h1>
                    <button id="add-package-btn" class="btn btn-primary"><i class="fas fa-plus"></i> إضافة باقة</button>
                </div>
                <div class="card">
                    <div class="table-responsive">
                        <table id="packages-table">
                             <thead>
                                <tr>
                                    <th>اسم الباقة</th>
                                    <th>السعر</th>
                                    <th>التكلفة</th>
                                    <th>المدة</th>
                                    <th>إجراءات</th>
                               </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="expenses-page" class="page">
                 <div class="page-header" style="display: flex; justify-content: space-between; align-items: center;">
                    <h1>إدارة المصاريف</h1>
                    <button id="add-expense-btn" class="btn btn-primary"><i class="fas fa-plus"></i> إضافة مصروف</button>
                </div>
                <div class="card">
                    <div class="table-responsive">
                        <table id="expenses-table">
                            <thead>
                                <tr>
                                    <th>الوصف</th>
                                    <th>المبلغ</th>
                                    <th>التاريخ</th>
                                    <th>إجراءات</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </section>
            
            <section id="reports-page" class="page">
                <div class="page-header no-print">
                    <h1>التقارير المتقدمة</h1>
                    <div class="header-actions">
                        <button id="export-report-csv" class="btn btn-secondary"><i class="fas fa-file-csv"></i> CSV</button>
                        <button id="export-report-xlsx" class="btn btn-success"><i class="fas fa-file-excel"></i> XLSX</button>
                        <button id="print-report-btn" class="btn btn-primary"><i class="fas fa-print"></i> طباعة التقرير</button>
                    </div>
                </div>
                <div class="card no-print">
                    <div class="form-group" style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                        <label for="report-start-date">من:</label>
                        <input type="date" id="report-start-date" class="form-control" style="width: auto; flex-grow: 1;">
                        <label for="report-end-date">إلى:</label>
                        <input type="date" id="report-end-date" class="form-control" style="width: auto; flex-grow: 1;">
                        <button id="generate-report-btn" class="btn btn-primary">عرض التقرير</button>
                    </div>
                </div>
                <div id="report-output" style="display: none;">
                    <div id="print-header" style="display: none;">
                        <img id="print-logo" src="https://placehold.co/150x80/4a90e2/ffffff?text=شعار" alt="Company Logo" style="max-height: 80px; margin-bottom: 15px;">
                        <h2 id="print-company-name">اسم الشركة</h2>
                        <h3 id="report-period" style="margin-top: 5px; font-weight: normal; color: #555;"></h3>
                        <hr style="margin: 15px 0;">
                    </div>
                    <div class="card">
                        <h3><i class="fas fa-chart-bar text-primary"></i> ملخص مالي</h3>
                        <div id="report-summary" class="report-summary-list"></div>
                    </div>
                    <div class="grid-container" style="grid-template-columns: 1fr 1fr; gap: 25px;">
                        <div class="card">
                            <h3><i class="fas fa-trophy text-warning"></i> الباقات الأكثر ربحاً</h3>
                            <ul id="top-packages-list" class="quick-list"></ul>
                        </div>
                        <div class="card">
                            <h3><i class="fas fa-crown text-primary"></i> المشتركون الأكثر دفعاً</h3>
                            <ul id="top-subscribers-list" class="quick-list"></ul>
                        </div>
                    </div>
                </div>
            </section>

            <section id="settings-page" class="page">
                <div class="page-header"><h1>الإعدادات</h1></div>
                <div class="card">
                    <h2>ملف تعريف الشركة</h2>
                    <form id="company-profile-form">
                        <div class="form-group">
                            <label for="company-name">اسم الشركة</label>
                            <input type="text" id="company-name" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="company-logo">رابط شعار الشركة</label>
                            <input type="text" id="company-logo" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="company-contact">معلومات التواصل</label>
                            <input type="text" id="company-contact" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="whatsapp-code">كود الدولة للواتساب (مثال: 964)</label>
                            <input type="text" id="whatsapp-code" class="form-control">
                        </div>
                        <button type="submit" class="btn btn-primary">حفظ</button>
                    </form>
                </div>
                 <div class="card">
                    <h2>قوالب رسائل واتساب</h2>
                    <p>المتغيرات: {{اسم_المشترك}}, {{اسم_الباقة}}, {{تاريخ_البدء}}, {{تاريخ_الانتهاء}}, {{الدين_السابق}}, {{سعر_الباقة}}, {{المبلغ_الإجمالي}}, {{المبلغ_الواصل}}, {{الرصيد_المتبقي}}</p>
                    <form id="whatsapp-templates-form">
                         <div class="form-group">
                            <label for="activation-template">قالب التفعيل</label>
                            <textarea id="activation-template" class="form-control" rows="4"></textarea>
                        </div>
                         <div class="form-group">
                            <label for="payment-template">قالب التسديد</label>
                            <textarea id="payment-template" class="form-control" rows="4"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="reminder-template">قالب رسالة التذكير</label>
                            <textarea id="reminder-template" class="form-control" rows="4"></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary">حفظ القوالب</button>
                    </form>
                </div>
                <div class="card">
                    <h2>أتمتة الواتساب</h2>
                    <div class="form-group">
                        <label for="whatsapp-method-select">طريقة إرسال الواتساب</label>
                        <select id="whatsapp-method-select" class="form-control">
                            <option value="api">API (wa.me) - الأفضل للجوال</option>
                            <option value="web">Web (web.whatsapp.com) - الأفضل للكمبيوتر</option>
                        </select>
                    </div>
                    <div class="form-group" style="display: flex; justify-content: space-between; align-items: center; border-top: 1px solid var(--border-color); padding-top: 15px;">
                        <span style="font-weight: 500;">إرسال رسالة عند التفعيل</span>
                        <label class="switch">
                            <input type="checkbox" id="send-on-activation-toggle">
                            <span class="slider round"></span>
                        </label>
                    </div>
                     <div class="form-group" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0;">
                        <span style="font-weight: 500;">إرسال رسالة عند التسديد</span>
                        <label class="switch">
                            <input type="checkbox" id="send-on-payment-toggle">
                            <span class="slider round"></span>
                        </label>
                    </div>
                </div>
                 <div class="card">
                    <h2>إعدادات التفعيل</h2>
                     <div class="form-group">
                        <label for="active-isp-selector">شركة التزويد الفعالة (الافتراضية)</label>
                        <select id="active-isp-selector" class="form-control"></select>
                    </div>
                </div>
                <div class="card">
                    <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h2>إدارة شركات التزويد (ISP)</h2>
                        <button id="add-isp-btn" class="btn btn-primary btn-sm"><i class="fas fa-plus"></i> إضافة شركة</button>
                    </div>
                    <div class="table-responsive">
                        <table id="isps-table">
                             <thead>
                                <tr>
                                    <th>اسم الشركة</th>
                                    <th>رابط التفعيل</th>
                                    <th>إجراءات</th>
                               </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
                <div class="card">
                    <h2>تخصيص المظهر</h2>
                    <div class="form-group">
                        <label for="font-selector">اختر الخط</label>
                        <select id="font-selector" class="form-control">
                            <option value="'Cairo', sans-serif">Cairo (Default)</option>
                            <option value="'Tajawal', sans-serif">Tajawal</option>
                            <option value="'Almarai', sans-serif">Almarai</option>
                            <option value="'Noto Sans Arabic', sans-serif">Noto Sans Arabic</option>
                            <option value="'El Messiri', sans-serif">El Messiri</option>
                            <option value="'Lalezar', cursive">Lalezar</option>
                            <option value="'Readex Pro', sans-serif">Readex Pro</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="primary-color-picker">اللون الأساسي للتطبيق</label>
                        <input type="color" id="primary-color-picker" class="form-control" style="padding: 5px; height: 50px;">
                    </div>
                </div>
                 <div class="card">
                    <h2>إعدادات الطباعة</h2>
                    <div class="form-group">
                        <label for="print-paper-size">حجم ورق الطباعة</label>
                        <select id="print-paper-size" class="form-control">
                            <option value="A4">A4 (عادي)</option>
                            <option value="80mm">80mm (حراري)</option>
                            <option value="58mm">58mm (حراري)</option>
                            <option value="custom">تخصيص...</option>
                        </select>
                    </div>
                    <div class="form-group" id="custom-paper-size-container" style="display: none;">
                        <label for="custom-paper-size">العرض المخصص (mm)</label>
                        <input type="number" id="custom-paper-size" class="form-control" placeholder="مثال: 75">
                    </div>
                    <div class="form-group" style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-weight: 500;">إظهار أزرار طباعة الوصلات</span>
                        <label class="switch">
                            <input type="checkbox" id="show-print-buttons-toggle">
                            <span class="slider round"></span>
                        </label>
                    </div>
                </div>
                <div class="card">
                    <h2>الربط مع Google Sheets</h2>
                    <p>استخدم Google Sheet كقاعدة بيانات أساسية لمزامنة بياناتك عبر الأجهزة. قم بحفظ رابط التطبيق ثم استخدم أزرار المزامنة.</p>
                    <form id="google-sheet-form">
                        <div class="form-group">
                            <label for="google-sheet-url">رابط تطبيق الويب (Apps Script URL)</label>
                            <input type="url" id="google-sheet-url" class="form-control" placeholder="الصق الرابط المنسوخ من Apps Script هنا">
                        </div>
                        <button type="submit" class="btn btn-primary">حفظ الرابط</button>
                    </form>
                    <div style="display: flex; gap: 10px; margin-top: 15px; border-top: 1px solid var(--border-color); padding-top: 15px;">
                        <button id="upload-to-sheet-btn" class="btn btn-success" style="flex-grow: 1;"><i class="fas fa-upload"></i> رفع البيانات إلى الشيت</button>
                        <button id="download-from-sheet-btn" class="btn btn-danger" style="flex-grow: 1;"><i class="fas fa-download"></i> جلب البيانات من الشيت</button>
                    </div>
                </div>
                <div class="card">
                    <h2>إعدادات المزامنة المتقدمة</h2>
                    <div class="form-group" style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 15px;">
                        <span style="font-weight: 500;">إظهار زر الرفع السريع</span>
                        <label class="switch">
                            <input type="checkbox" id="show-fab-toggle">
                            <span class="slider round"></span>
                        </label>
                    </div>
                     <div class="form-group" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0;">
                        <span style="font-weight: 500;">الرفع التلقائي عند الخمول (5 دقائق)</span>
                        <label class="switch">
                            <input type="checkbox" id="auto-upload-toggle">
                            <span class="slider round"></span>
                        </label>
                    </div>
                </div>
                <div class="card">
                    <h2>إدارة البيانات (محلي)</h2>
                    <div style="display: flex; gap: 10px;">
                        <button id="export-data-btn" class="btn btn-success"><i class="fas fa-file-export"></i> تصدير البيانات</button>
                        <input type="file" id="import-file-input" style="display: none;" accept=".json">
                        <button id="import-data-btn" class="btn btn-info"><i class="fas fa-file-import"></i> استيراد البيانات</button>
                    </div>
                </div>
            </section>
            
            <section id="info-page" class="page">
                <div class="page-header"><h1>معلومات التطبيق</h1></div>
                <div id="info-accordion">
                    <div class="accordion-item">
                        <div class="accordion-header">
                            <h4><i class="fas fa-question-circle text-primary"></i> كيفية الاستخدام</h4>
                            <i class="fas fa-chevron-down icon"></i>
                        </div>
                        <div class="accordion-content">
                            <p>هذا الدليل يساعدك على استخدام النظام بفعالية:</p>
                            <ul>
                                <li><strong>لوحة التحكم:</strong> توفر نظرة سريعة على أهم الإحصائيات مثل عدد المشتركين، الأرباح، والديون.</li>
                                <li><strong>المشتركين:</strong> من هنا يمكنك إضافة، تعديل، وحذف المشتركين. اضغط على زر العين لعرض التفاصيل الكاملة وإجراء عمليات التفعيل والتسديد.</li>
                                <li><strong>الباقات والمصاريف:</strong> قم بإدارة باقات الاشتراك والمصاريف التشغيلية من هذه الأقسام.</li>
                                <li><strong>التقارير:</strong> قم بتوليد تقارير مالية مفصلة لأي فترة زمنية.</li>
                                <li><strong>الإعدادات:</strong> خصص التطبيق حسب احتياجاتك، من معلومات الشركة، قوالب الرسائل، وحتى مظهر التطبيق والربط مع Google Sheets.</li>
                            </ul>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <div class="accordion-header">
                             <h4><i class="fas fa-headset text-primary"></i> الدعم الفني</h4>
                             <i class="fas fa-chevron-down icon"></i>
                        </div>
                        <div class="accordion-content">
                             <p>للمساعدة أو الإبلاغ عن مشكلة، يمكنك التواصل معنا عبر:</p>
                            <ul>
                                <li><strong>البريد الإلكتروني:</strong> support@example.com</li>
                                <li><strong>الهاتف:</strong> +964 123 456 7890</li>
                                <li><strong>واتساب:</strong> +964 123 456 7890</li>
                            </ul>
                        </div>
                    </div>
                     <div class="accordion-item">
                        <div class="accordion-header">
                             <h4><i class="fas fa-info text-primary"></i> حول التطبيق</h4>
                             <i class="fas fa-chevron-down icon"></i>
                        </div>
                        <div class="accordion-content">
                             <p>نظام إدارة اشتراكات الإنترنت هو تطبيق ويب تقدمي (PWA) متكامل، مصمم لمساعدتك على إدارة شبكتك بكفاءة وسهولة.</p>
                             <p>الإصدار الحالي: 2.0.0 (مع دعم تسجيل الدخول)</p>
                            <p>يعمل التطبيق دون الحاجة لاتصال دائم بالإنترنت (في الوضع المحلي) أو مع مزامنة كاملة عند تفعيل الربط مع Google Sheets.</p>
                        </div>
                    </div>
                </div>
            </section>

            <footer class="app-footer">
                <p>&copy; <span id="copyright-year"></span> جميع الحقوق محفوظة. تم التطوير بواسطة <a href="#">DashNET</a>.</p>
            </footer>
        </main>
        
        <button id="fab-upload-btn" class="fab-btn no-print" style="display: none;" title="رفع البيانات إلى الشيت">
            <i class="fas fa-cloud-upload-alt"></i>
        </button>
    </div>

    <!-- Modals -->
    <div id="subscriber-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="subscriber-modal-title">تفاصيل المشترك</h2>
                <span class="close-btn">&times;</span>
            </div>
            <div class="modal-tabs">
                <span class="tab-link active" data-tab="overview"><i class="fas fa-info-circle"></i> نظرة عامة</span>
                <span class="tab-link" data-tab="actions"><i class="fas fa-bolt"></i> تفعيل وتسديد</span>
                <span class="tab-link" data-tab="history"><i class="fas fa-history"></i> سجل الحركات</span>
                <span class="tab-link" data-tab="edit"><i class="fas fa-edit"></i> تعديل البيانات</span>
            </div>
            <div class="modal-body">
                <div id="overview-tab" class="tab-content active">
                    <div class="sub-status-card">
                        <div class="sub-status-header">
                            <h4>حالة الاشتراك</h4>
                            <span id="modal-status-badge" class="status-badge"></span>
                        </div>
                        <div class="sub-status-body">
                            <p>الباقة الحالية <strong id="modal-package-name">-</strong></p>
                            <p>الدين الحالي <strong id="modal-current-debt">-</strong></p>
                        </div>
                        <div class="sub-status-footer" style="margin-top: 15px;">
                            <p style="margin:0 0 5px 0;">الأيام المتبقية: <strong id="modal-remaining-days">-</strong></p>
                            <div class="progress-bar">
                                <div class="progress-bar-inner" id="modal-progress-bar"></div>
                            </div>
                        </div>
                    </div>
                    <h4>معلومات التواصل</h4>
                    <p><strong><i class="fas fa-user"></i> اليوزر:</strong> <span id="modal-username"></span></p>
                    <p><strong><i class="fas fa-id-card"></i> معرف الاشتراك:</strong> <span id="modal-subid"></span></p>
                    <p><strong><i class="fas fa-phone"></i> الهاتف:</strong> <span id="modal-phone"></span></p>
                    <p><strong><i class="fas fa-sticky-note"></i> ملاحظات:</strong> <span id="modal-notes"></span></p>
                </div>

                <div id="actions-tab" class="tab-content">
                     <form id="activation-form" novalidate>
                        <h4><i class="fas fa-rocket"></i> تفعيل اشتراك جديد</h4>
                        <div class="form-group">
                            <label for="activation-package">اختر باقة</label>
                            <select id="activation-package" class="form-control" required></select>
                        </div>
                         <div class="form-group">
                            <label for="activation-start-date">تاريخ ووقت البدء</label>
                            <input type="datetime-local" id="activation-start-date" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="activation-end-date">تاريخ ووقت الانتهاء</label>
                            <input type="datetime-local" id="activation-end-date" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="activation-amount-paid">المبلغ المدفوع (اختياري)</label>
                            <input type="number" id="activation-amount-paid" class="form-control" placeholder="0" min="0">
                        </div>
                         <div class="form-group">
                            <label for="activation-notes">ملاحظات</label>
                            <textarea id="activation-notes" class="form-control" rows="2"></textarea>
                        </div>
                        <div class="form-group">
                            <p>صافي الدين بعد العملية: <strong id="net-debt-activation">0</strong></p>
                        </div>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button type="submit" class="btn btn-success" style="flex-grow: 1;"><i class="fab fa-whatsapp"></i> تفعيل وحفظ</button>
                            <button type="button" id="go-to-activation-page-btn" class="btn btn-warning"><i class="fas fa-external-link-alt"></i> تفعيل خارجي</button>
                            <button type="button" id="print-activation-receipt-btn" class="btn btn-secondary print-receipt-btn"><i class="fas fa-print"></i> طباعة وصل</button>
                        </div>
                    </form>
                    <hr style="margin: 20px 0;">
                    <form id="payment-form" novalidate>
                        <h4><i class="fas fa-hand-holding-usd"></i> تسديد دين</h4>
                         <div class="form-group">
                            <label for="payment-amount">المبلغ المدفوع</label>
                            <input type="number" id="payment-amount" class="form-control" required min="1">
                        </div>
                        <div class="form-group">
                            <label for="payment-notes">ملاحظات</label>
                            <textarea id="payment-notes" class="form-control" rows="2"></textarea>
                        </div>
                        <div class="form-group">
                            <p>الدين المتبقي بعد الدفعة: <strong id="remaining-debt-payment">0</strong></p>
                        </div>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button type="submit" class="btn btn-info"><i class="fab fa-whatsapp"></i> تسديد وحفظ</button>
                             <button type="button" id="print-payment-receipt-btn" class="btn btn-secondary print-receipt-btn"><i class="fas fa-print"></i> طباعة وصل</button>
                        </div>
                    </form>
                </div>
                
                <div id="history-tab" class="tab-content">
                    <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                        <table id="subscriber-movements-table">
                            <thead>
                                <tr>
                                    <th>النوع</th>
                                    <th>التفاصيل</th>
                                    <th>تاريخ الحركة</th>
                                    <th>تاريخ البدء</th>
                                    <th>تاريخ الانتهاء</th>
                                    <th>إجراءات</th>
                                </tr>
                            </thead>
                            <tbody>
                                </tbody>
                        </table>
                    </div>
                </div>

                <div id="edit-tab" class="tab-content">
                    <h4>تعديل المعلومات الأساسية</h4>
                    <form id="subscriber-form">
                        <input type="hidden" id="subscriber-id">
                        <div class="form-group">
                            <label for="subscriber-name">الاسم</label>
                            <input type="text" id="subscriber-name" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="subscriber-username">اليوزر</label>
                            <input type="text" id="subscriber-username" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="subscriber-subid">معرف الاشتراك (subId)</label>
                            <input type="text" id="subscriber-subid" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="subscriber-phone">الهاتف</label>
                            <input type="text" id="subscriber-phone" class="form-control" required>
                        </div>
                         <div class="form-group">
                            <label for="subscriber-isp">شركة التزويد المخصصة</label>
                            <select id="subscriber-isp" class="form-control"></select>
                        </div>
                        <div class="form-group">
                            <label for="subscriber-notes">ملاحظات</label>
                            <textarea id="subscriber-notes" class="form-control"></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary">حفظ المعلومات</button>
                    </form>
                    <hr style="margin: 20px 0;">
                    <div id="edit-dates-section" style="display:none;">
                        <h4>تعديل تواريخ الاشتراك الحالي</h4>
                        <form id="edit-dates-form">
                            <div class="form-group">
                                <label for="edit-start-date">تاريخ البدء</label>
                                <input type="datetime-local" id="edit-start-date" class="form-control">
                            </div>
                            <div class="form-group">
                                <label for="edit-end-date">تاريخ الانتهاء</label>
                                <input type="datetime-local" id="edit-end-date" class="form-control">
                            </div>
                            <button type="submit" class="btn btn-secondary">حفظ التواريخ</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="package-modal" class="modal">
         <div class="modal-content">
            <div class="modal-header">
                <h2 id="package-modal-title">إضافة/تعديل باقة</h2>
                <span class="close-btn">&times;</span>
            </div>
            <div class="modal-body">
                <form id="package-form">
                    <input type="hidden" id="package-id">
                    <div class="form-group"><label for="package-name">اسم الباقة</label><input type="text" id="package-name" class="form-control" required></div>
                    <div class="form-group"><label for="package-price">السعر</label><input type="number" id="package-price" class="form-control" required></div>
                    <div class="form-group"><label for="package-cost">التكلفة</label><input type="number" id="package-cost" class="form-control" required></div>
                    <div class="form-group">
                        <label for="package-duration-type">نظام الاحتساب</label>
                        <select id="package-duration-type" class="form-control">
                            <option value="days">بالأيام</option>
                            <option value="months">بالأشهر</option>
                        </select>
                    </div>
                    <div class="form-group" id="duration-value-container">
                        <label for="package-duration-value" id="duration-value-label">عدد الأيام</label>
                        <input type="number" id="package-duration-value" class="form-control" required>
                    </div>
                    <button type="submit" class="btn btn-primary">حفظ الباقة</button>
                </form>
            </div>
        </div>
    </div>

    <div id="expense-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="expense-modal-title">إضافة/تعديل مصروف</h2>
                <span class="close-btn">&times;</span>
            </div>
            <div class="modal-body">
                <form id="expense-form">
                    <input type="hidden" id="expense-id">
                    <div class="form-group"><label for="expense-description">الوصف</label><input type="text" id="expense-description" class="form-control" required></div>
                    <div class="form-group"><label for="expense-amount">المبلغ</label><input type="number" id="expense-amount" class="form-control" required></div>
                    <div class="form-group"><label for="expense-date">التاريخ</label><input type="date" id="expense-date" class="form-control" required></div>
                    <button type="submit" class="btn btn-primary">حفظ المصروف</button>
                </form>
            </div>
        </div>
    </div>

    <div id="isp-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="isp-modal-title">إضافة/تعديل شركة تزويد</h2>
                <span class="close-btn">&times;</span>
            </div>
            <div class="modal-body">
                <form id="isp-form">
                    <input type="hidden" id="isp-id">
                    <div class="form-group"><label for="isp-name">اسم الشركة</label><input type="text" id="isp-name" class="form-control" required></div>
                    <div class="form-group">
                        <label for="isp-url">رابط التفعيل (استخدم {{USER}} لليوزر و {{subId}} لمعرف الاشتراك)</label>
                        <input type="text" id="isp-url" class="form-control" required placeholder="https://example.com/activate?user={{USER}}&subId={{subId}}">
                    </div>
                    <button type="submit" class="btn btn-primary">حفظ الشركة</button>
                </form>
            </div>
        </div>
    </div>

    <!-- User Profile Modal (New) -->
    <div id="user-profile-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="user-profile-modal-title">الملف الشخصي</h2>
                <span class="close-btn">&times;</span>
            </div>
            <div class="modal-tabs">
                <span class="tab-link active" data-tab="profile-edit"><i class="fas fa-user-edit"></i> تعديل الملف</span>
                <span class="tab-link" data-tab="profile-photo"><i class="fas fa-camera"></i> تغيير الصورة</span>
                <span class="tab-link" data-tab="profile-password"><i class="fas fa-key"></i> تغيير كلمة المرور</span>
            </div>
            <div class="modal-body">
                <div id="profile-edit-tab" class="tab-content active">
                    <h4>تعديل المعلومات</h4>
                    <form id="update-profile-form">
                        <div class="form-group">
                            <label for="profile-name">الاسم الكامل</label>
                            <input type="text" id="profile-name" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="profile-email">البريد الإلكتروني</label>
                            <input type="email" id="profile-email" class="form-control" required>
                        </div>
                        <button type="submit" class="btn btn-primary">حفظ التعديلات</button>
                    </form>
                </div>
                <div id="profile-photo-tab" class="tab-content">
                    <h4>تغيير الصورة الشخصية</h4>
                    <form id="update-photo-form">
                        <div class="form-group">
                            <label for="profile-photo-link">رابط الصورة الجديدة</label>
                            <input type="url" id="profile-photo-link" class="form-control" placeholder="https://example.com/image.png" required>
                        </div>
                        <button type="submit" class="btn btn-primary">تحديث الصورة</button>
                    </form>
                </div>
                <div id="profile-password-tab" class="tab-content">
                    <h4>تغيير كلمة المرور</h4>
                    <form id="change-password-form">
                        <div class="form-group">
                            <label for="current-password">كلمة المرور الحالية</label>
                            <input type="password" id="current-password" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="new-password">كلمة المرور الجديدة</label>
                            <input type="password" id="new-password" class="form-control" required>
                        </div>
                        <button type="submit" class="btn btn-primary">تغيير كلمة المرور</button>
                    </form>
                </div>
            </div>
            <div class="modal-footer" style="padding: 15px 25px; border-top: 1px solid var(--border-color); text-align: left;">
                 <button id="logout-btn" class="btn btn-danger"><i class="fas fa-sign-out-alt"></i> تسجيل الخروج</button>
            </div>
        </div>
    </div>


    <script>
    // --- Service Worker Registration ---
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('sw.js')
                .then(registration => console.log('Service Worker registered successfully:', registration))
                .catch(err => console.error('Service Worker registration failed:', err));
        });
    }

    // --- Main Application Logic ---
    document.addEventListener('DOMContentLoaded', () => {
        // --- LOGIN CHECK ---
        if (localStorage.getItem('isLoggedIn') !== 'true') {
            window.location.href = 'login.html';
            return; // Stop further execution
        }

        const App = {
            db: null,
            charts: {},
            gSheetApiUrl: null,
            idleTimer: null,
            allGSheetData: null,

            state: {
                currentPage: 'dashboard',
                currentSubscriberId: null,
                currentReportData: null,
                currentUser: JSON.parse(localStorage.getItem('loggedInUser')) || {},
                packages: [],
                settings: {
                    companyProfile: { name: 'DashNET', logo: 'https://placehold.co/150x80/4a90e2/ffffff?text=DashNET', contact: '07xxxxxxxx', whatsappCode: '964' },
                    whatsappTemplates: {
                        activation: 'مرحباً {{اسم_المشترك}}،\nتم تفعيل اشتراكك ({{اسم_الباقة}}).\n\nالدين السابق: {{الدين_السابق}}\nسعر الباقة: {{سعر_الباقة}}\nالمبلغ الإجمالي: {{المبلغ_الإجمالي}}\nالمبلغ الواصل: {{المبلغ_الواصل}}\nالرصيد المتبقي: {{الرصيد_المتبقي}}\n\nيبدأ من: {{تاريخ_البدء}}\nينتهي في: {{تاريخ_الانتهاء}}\n\nشكراً لاختياركم خدماتنا.',
                        payment: 'مرحباً {{اسم_المشترك}}،\nتم استلام دفعة.\n\nالدين السابق: {{الدين_السابق}}\nالمبلغ الواصل: {{المبلغ_الواصل}}\nالرصيد المتبقي: {{الرصيد_المتبقي}}\n\nشكراً لتعاونكم.',
                        reminder: 'مرحباً {{اسم_المشترك}}،\nنود تذكيركم بأن اشتراككم سينتهي قريباً بتاريخ {{تاريخ_الانتهاء}}.\n\nالرجاء تجديد الاشتراك لضمان استمرارية الخدمة.\nشكراً لتعاونكم.'
                    },
                    automation: { sendOnActivation: true, sendOnPayment: true, whatsappMethod: 'api' },
                    appFont: "'Cairo', sans-serif",
                    primaryColor: '#4a90e2',
                    isps: [],
                    activeIspId: null,
                    printSettings: { showReceiptButtons: true, paperSize: '80mm', customPaperSize: 80 },
                    syncSettings: { showUploadFab: false, autoUploadOnIdle: false }
                }
            },

            // --- Database Handler (IndexedDB) ---
            DB: {
                init() {
                    return new Promise((resolve, reject) => {
                        const request = indexedDB.open('ispManagerDB', 5);
                        request.onerror = (event) => {
                            console.error("Database error:", event.target.errorCode);
                            reject("Database error");
                        };
                        request.onupgradeneeded = (event) => {
                            const db = event.target.result;
                            if (!db.objectStoreNames.contains('subscribers')) {
                                const subStore = db.createObjectStore('subscribers', { keyPath: 'id' });
                                subStore.createIndex('name', 'name', { unique: false });
                                subStore.createIndex('phone', 'phone', { unique: false });
                            }
                            if (!db.objectStoreNames.contains('packages')) { db.createObjectStore('packages', { keyPath: 'id' }); }
                            if (!db.objectStoreNames.contains('movements')) {
                                const moveStore = db.createObjectStore('movements', { keyPath: 'id' });
                                moveStore.createIndex('subscriberId', 'subscriberId', { unique: false });
                                moveStore.createIndex('timestamp', 'timestamp', { unique: false });
                            }
                            if (!db.objectStoreNames.contains('expenses')) {
                                const expenseStore = db.createObjectStore('expenses', { keyPath: 'id' });
                                expenseStore.createIndex('date', 'date', { unique: false });
                            }
                            if (!db.objectStoreNames.contains('settings')) { db.createObjectStore('settings', { keyPath: 'key' }); }
                            if (event.oldVersion < 4) {
                                if (!db.objectStoreNames.contains('isps')) { db.createObjectStore('isps', { keyPath: 'id' }); }
                            }
                        };
                        request.onsuccess = (event) => {
                            App.db = event.target.result;
                            console.log("Database initialized successfully.");
                            resolve(App.db);
                        };
                    });
                },
                async add(storeName, data) { return new Promise((resolve, reject) => { const req = App.db.transaction([storeName], 'readwrite').objectStore(storeName).add(data); req.onsuccess = () => resolve(req.result); req.onerror = () => reject(req.error); }); },
                async get(storeName, key) { return new Promise((resolve, reject) => { const req = App.db.transaction([storeName], 'readonly').objectStore(storeName).get(key); req.onsuccess = () => resolve(req.result); req.onerror = () => reject(req.error); }); },
                async getAll(storeName, indexName, query) { return new Promise((resolve, reject) => { const store = App.db.transaction([storeName], 'readonly').objectStore(storeName); const index = indexName ? store.index(indexName) : store; const req = index.getAll(query); req.onsuccess = () => resolve(req.result); req.onerror = () => reject(req.error); }); },
                async put(storeName, data) { return new Promise((resolve, reject) => { const req = App.db.transaction([storeName], 'readwrite').objectStore(storeName).put(data); req.onsuccess = () => resolve(req.result); req.onerror = () => reject(req.error); }); },
                async delete(storeName, key) { return new Promise((resolve, reject) => { const req = App.db.transaction([storeName], 'readwrite').objectStore(storeName).delete(key); req.onsuccess = () => resolve(); req.onerror = () => reject(req.error); }); }
            },

            // --- Google Sheet API Handler ---
            GSheet: {
                async post(body) {
                    if (!App.gSheetApiUrl) throw new Error("Google Sheet API URL is not set.");
                    
                    const response = await fetch(App.gSheetApiUrl, {
                        method: 'POST',
                        mode: 'cors',
                        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                        body: JSON.stringify(body),
                    });

                    const resultText = await response.text();
                    const result = JSON.parse(resultText);

                    if (!result.success) {
                        console.error('Google Sheet API Error:', result.message);
                        throw new Error(result.message);
                    }
                    return result;
                },
                async getAllData() {
                    const url = `${App.gSheetApiUrl}?action=getAllData`;
                    const response = await fetch(url, { mode: 'cors' });
                    const result = await response.json();
                    if (result.status === 'error') {
                        console.error('Google Sheet API Error:', result.message);
                        throw new Error(result.message);
                    }
                    return {
                        subscribers: result.data.subscribers || [],
                        packages: result.data.packages || [],
                        movements: result.data.movements || [],
                        expenses: result.data.expenses || [],
                        isps: result.data.isps || [],
                        settings: result.data.settings || [],
                    };
                }
            },
            
            // --- DATA PERSISTENCE HELPER ---
            async saveData(action, storeName, data) {
                this.UI.showLoader();
                try {
                    return await this.DB[action](storeName, data);
                } catch (error) {
                    this.UI.showToast(`فشل حفظ البيانات المحلية: ${error.message}`, 'error');
                    throw error;
                } finally {
                    this.UI.hideLoader();
                }
            },

            // --- Initialization ---
            async init() {
                this.UI.showLoader();
                this.gSheetApiUrl = localStorage.getItem('gSheetApiUrl');
                if(document.getElementById('google-sheet-url')) {
                    document.getElementById('google-sheet-url').value = this.gSheetApiUrl || '';
                }

                await this.DB.init();
                await this.loadSettings();
                this.state.packages = await this.DB.getAll('packages');
                this.state.settings.isps = await this.DB.getAll('isps');

                this.UI.initTheme();
                this.UI.updateUIFromSettings();
                this.UI.displayUserProfile();
                this.Router.init();
                this.attachEventListeners();
                document.getElementById('copyright-year').textContent = new Date().getFullYear();
                
                const initialHash = window.location.hash.substring(1) || 'dashboard';
                this.Router.navigateTo(initialHash);
                
                this.UI.hideLoader();
            },
            // --- Settings Management ---
            async loadSettings() {
                const settingsToLoad = ['companyProfile', 'whatsappTemplates', 'automation', 'appFont', 'primaryColor', 'activeIspId', 'printSettings', 'syncSettings'];
                for (const key of settingsToLoad) {
                    const setting = await this.DB.get('settings', key);
                    if (setting && setting.value !== undefined) {
                        const defaultValue = this.state.settings[key];
                        const savedValue = setting.value;

                        if (typeof defaultValue === 'object' && defaultValue !== null && !Array.isArray(defaultValue) &&
                            typeof savedValue === 'object' && savedValue !== null && !Array.isArray(savedValue)) 
                        {
                             this.state.settings[key] = { ...defaultValue, ...savedValue };
                        } else {
                            this.state.settings[key] = savedValue;
                        }
                    } else {
                        // If setting doesn't exist in DB, save the default one.
                        await this.DB.put('settings', { key, value: this.state.settings[key] });
                    }
                }
            },

            // --- Router ---
            Router: {
                init() {
                    window.addEventListener('hashchange', () => {
                        const pageId = window.location.hash.substring(1) || 'dashboard';
                        this.navigateTo(pageId);
                    });
                },
                navigateTo(pageId) {
                    App.state.currentPage = pageId;
                    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                    document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));

                    const targetPage = document.getElementById(`${pageId}-page`);
                    const targetLink = document.querySelector(`.nav-link[href="#${pageId}"]`);

                    if (targetPage) targetPage.classList.add('active');
                    if (targetLink) targetLink.classList.add('active');
                    
                    // Close sidebar on navigation on mobile
                    if (window.innerWidth <= 768) {
                        document.getElementById('sidebar').classList.remove('open');
                        document.getElementById('overlay').classList.remove('active');
                    }

                    App.loadPageData(pageId);
                }
            },
            
            // --- Data Loading for Pages ---
            async loadPageData(pageId) {
                this.UI.showLoader();
                // Always get the latest data from the state or DB for rendering.
                if (pageId !== 'settings' && pageId !== 'info') {
                    this.state.packages = await this.DB.getAll('packages');
                    this.state.settings.isps = await this.DB.getAll('isps');
                }

                switch (pageId) {
                    case 'dashboard': await this.Pages.Dashboard.render(); break;
                    case 'subscribers': await this.Pages.Subscribers.render(); break;
                    case 'movements': await this.Pages.Movements.render(); break;
                    case 'packages': await this.Pages.Packages.render(); break;
                    case 'expenses': await this.Pages.Expenses.render(); break;
                    case 'reports': await this.Pages.Reports.init(); break;
                    case 'settings': await this.Pages.Settings.render(); break;
                    case 'info': this.Pages.Info.init(); break;
                }
                this.UI.hideLoader();
            },

            // --- UI Handler & Helpers ---
            UI: {
                showLoader() { document.getElementById('loader').style.display = 'flex'; },
                hideLoader() { document.getElementById('loader').style.display = 'none'; },
                
                showToast(message, type = 'info') {
                    const container = document.getElementById('toast-container');
                    const toast = document.createElement('div');
                    toast.className = `toast ${type}`;
                    toast.textContent = message;
                    container.appendChild(toast);
                    
                    setTimeout(() => toast.classList.add('show'), 10);
                    setTimeout(() => {
                        toast.classList.remove('show');
                        setTimeout(() => toast.remove(), 500);
                    }, 4000);
                },

                openModal(id) { document.getElementById(id).classList.add('active'); },
                closeModal(id) { document.getElementById(id).classList.remove('active'); },

                displayUserProfile() {
                    const user = App.state.currentUser;
                    if (!user || !user.name) {
                        console.warn("User data not found for profile widget.");
                        return;
                    }
                    const avatar = document.getElementById('user-widget-avatar');
                    avatar.src = user.photoLink || `https://placehold.co/100x100/EAF2FB/333?text=${user.name.charAt(0)}`;
                    avatar.onerror = function() { this.src = `https://placehold.co/100x100/EAF2FB/333?text=${user.name.charAt(0)}`; };
                    document.getElementById('user-widget-name').textContent = user.name;
                    document.getElementById('user-widget-email').textContent = user.email;
                },

                initTheme() {
                    const themeToggle = document.getElementById('theme-toggle');
                    const savedTheme = localStorage.getItem('theme') || 'light';
                    if (savedTheme === 'dark') {
                        document.body.classList.add('dark-mode');
                        themeToggle.querySelector('i').className = 'fas fa-sun';
                        if(themeToggle.querySelector('span')) themeToggle.querySelector('span').textContent = 'الوضع النهاري';
                    } else {
                        document.body.classList.remove('dark-mode');
                        themeToggle.querySelector('i').className = 'fas fa-moon';
                        if(themeToggle.querySelector('span')) themeToggle.querySelector('span').textContent = 'الوضع الليلي';
                    }
                },
                updateUIFromSettings() {
                    const profile = App.state.settings.companyProfile;
                    document.getElementById('sidebar-logo').src = profile.logo || 'https://placehold.co/40x40/4a90e2/ffffff?text=L';
                    document.getElementById('sidebar-company-name').textContent = profile.name || 'نظامي';
                    this.applyFont(App.state.settings.appFont);
                    this.applyColor(App.state.settings.primaryColor);
                    this.updatePrintStyles(App.state.settings.printSettings.paperSize, App.state.settings.printSettings.customPaperSize);
                    this.toggleFab(App.state.settings.syncSettings.showUploadFab);
                    App.resetIdleTimer();
                },
                applyFont(fontFamily) {
                    document.documentElement.style.setProperty('--main-font', fontFamily);
                },
                applyColor(color) {
                    document.documentElement.style.setProperty('--primary-color', color);
                    document.querySelector('meta[name="theme-color"]').setAttribute('content', color);
                },
                updatePrintStyles(paperSize, customSize = 80) {
                    const styleSheet = document.getElementById('print-style-sheet');
                    let styles = '';
                    let size;

                    if (paperSize === 'custom') {
                        size = `${customSize}mm`;
                    } else {
                        size = paperSize;
                    }

                    if (size === 'A4') {
                        styles = `@media print { @page { size: A4; margin: 20mm; } body { font-size: 14pt; -webkit-print-color-adjust: exact; } }`;
                    } else { // Thermal printers
                        styles = `@media print { @page { size: ${size} auto; margin: 3mm; } body { font-size: 12pt; -webkit-print-color-adjust: exact; } }`;
                    }
                    styleSheet.innerHTML = styles;
                },
                toggleFab(show) {
                    const fab = document.getElementById('fab-upload-btn');
                    if (fab) {
                        fab.style.display = show ? 'flex' : 'none';
                    }
                },
                formatDate(date) {
                    if (!date) return 'N/A';
                    return new Date(date).toLocaleDateString('ar-EG', { year: 'numeric', month: 'long', day: 'numeric' });
                },
                formatDateTime(date) {
                    if (!date) return 'N/A';
                    return new Date(date).toLocaleString('ar-EG', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                },
                formatNumericDateTime(date) {
                    if (!date) return 'N/A';
                    const d = new Date(date);
                    const pad = (num) => num.toString().padStart(2, '0');
                    const datePart = `${d.getFullYear()}/${pad(d.getMonth() + 1)}/${pad(d.getDate())}`;
                    const timePart = d.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
                    return `${datePart} ${timePart}`;
                },
                getISODate(date) {
                    if(!date) return '';
                    return new Date(date.getTime() - (date.getTimezoneOffset() * 60000)).toISOString().split('T')[0];
                },
                getISO_DateTimeLocal(date) {
                    if (!date) return '';
                    const d = new Date(date);
                    d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
                    return d.toISOString().slice(0, 16);
                },
                parseTemplate(template, data) {
                    return template.replace(/\{\{([^}]+)\}\}/g, (match, key) => {
                        const trimmedKey = key.trim();
                        return data[trimmedKey] !== undefined ? data[trimmedKey] : match;
                    });
                },
            },
            
            // --- Page Renderers ---
            Pages: {
                Dashboard: {
                    async render() {
                        const subscribers = await App.DB.getAll('subscribers');
                        const movements = await App.DB.getAll('movements');
                        const expenses = await App.DB.getAll('expenses');

                        // 1. Calculate Stats
                        let totalSubs = subscribers.length;
                        let activeSubs = 0;
                        let expiringSoonSubs = 0;
                        let expiredSubs = 0;
                        let totalDebt = 0;
                        const today = new Date();
                        const todayStart = new Date(new Date().setHours(0, 0, 0, 0));
                        const soonDate = new Date();
                        soonDate.setDate(today.getDate() + 3);

                        subscribers.forEach(sub => {
                            totalDebt += Number(sub.debt) || 0;
                            if (sub.lastActivation_endDate) {
                                const endDate = new Date(sub.lastActivation_endDate);
                                if (endDate >= today) {
                                    activeSubs++;
                                    if (endDate < soonDate) {
                                        expiringSoonSubs++;
                                    }
                                } else {
                                    expiredSubs++;
                                }
                            } else {
                                expiredSubs++;
                            }
                        });

                        const currentMonth = today.getMonth();
                        const currentYear = today.getFullYear();

                        let monthlyRevenue = 0;
                        let monthlyCosts = 0;
                        movements.filter(m => m.type === 'activation').forEach(m => {
                            const moveDate = new Date(m.timestamp);
                            if (moveDate.getMonth() === currentMonth && moveDate.getFullYear() === currentYear) {
                                monthlyRevenue += Number(m.amount);
                                const pkg = App.state.packages.find(p => p.name === m.packageName);
                                if(pkg) monthlyCosts += Number(pkg.cost);
                            }
                        });

                        let monthlyExpenses = 0;
                        expenses.forEach(e => {
                            const expenseDate = new Date(e.date);
                            if (expenseDate.getMonth() === currentMonth && expenseDate.getFullYear() === currentYear) {
                                monthlyExpenses += Number(e.amount);
                            }
                        });

                        const netProfit = monthlyRevenue - monthlyCosts - monthlyExpenses;

                        // 2. Render Stat Cards
                        const statsGrid = document.getElementById('stats-grid');
                        statsGrid.innerHTML = `
                            <div class="stat-card">
                                <div class="icon bg-primary"><i class="fas fa-users"></i></div>
                                <div class="info"><h3>إجمالي المشتركين</h3><p>${totalSubs}</p></div>
                            </div>
                            <div class="stat-card">
                                <div class="icon bg-success"><i class="fas fa-user-check"></i></div>
                                <div class="info"><h3>الفعّالون</h3><p>${activeSubs}</p></div>
                            </div>
                             <div class="stat-card">
                                <div class="icon bg-warning"><i class="fas fa-user-clock"></i></div>
                                <div class="info"><h3>سينتهي قريباً (3 أيام)</h3><p>${expiringSoonSubs}</p></div>
                            </div>
                            <div class="stat-card">
                                <div class="icon bg-danger"><i class="fas fa-user-times"></i></div>
                                <div class="info"><h3>منتهون</h3><p>${expiredSubs}</p></div>
                            </div>
                             <div class="stat-card">
                                <div class="icon bg-danger"><i class="fas fa-file-invoice-dollar"></i></div>
                                <div class="info"><h3>إجمالي الديون</h3><p>${totalDebt.toLocaleString()}</p></div>
                            </div>
                            <div class="stat-card">
                                <div class="icon bg-success"><i class="fas fa-piggy-bank"></i></div>
                                <div class="info"><h3>صافي الربح (الشهر الحالي)</h3><p>${netProfit.toLocaleString()}</p></div>
                            </div>
                        `;
                        
                        // 3. Render Charts
                        this.renderCharts(subscribers, movements, expenses);

                        // 4. Render Quick Lists
                        const expiringTodayList = document.getElementById('expiring-today-list');
                        expiringTodayList.innerHTML = '';
                        subscribers.filter(sub => {
                            if (!sub.lastActivation_endDate) return false;
                            const endDate = new Date(sub.lastActivation_endDate);
                            const todayDateOnly = new Date(today.getFullYear(), today.getMonth(), today.getDate());
                            const tomorrowDateOnly = new Date(today.getFullYear(), today.getMonth(), today.getDate() + 1);
                            return endDate >= todayDateOnly && endDate < tomorrowDateOnly;
                        }).forEach(sub => {
                            expiringTodayList.innerHTML += `<li><span>${sub.name}</span><span class="text-danger">${sub.phone}</span></li>`;
                        });
                         if(expiringTodayList.innerHTML === '') expiringTodayList.innerHTML = '<li>لا يوجد مشتركين تنتهي اشتراكاتهم اليوم.</li>';

                        const latestMovementsList = document.getElementById('latest-movements-list');
                        latestMovementsList.innerHTML = '';
                        movements.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp)).slice(0, 5).forEach(m => {
                            const sub = subscribers.find(s => s.id == m.subscriberId);
                            const typeText = m.type === 'activation' ? 'تفعيل' : 'تسديد';
                            const typeClass = m.type === 'activation' ? 'text-success' : 'text-primary';
                            latestMovementsList.innerHTML += `<li><span>${sub ? sub.name : 'مشترك محذوف'}</span><span class="${typeClass}">${typeText}: ${Number(m.amount).toLocaleString()}</span></li>`;
                        });
                        if(latestMovementsList.innerHTML === '') latestMovementsList.innerHTML = '<li>لا توجد حركات مسجلة.</li>';

                    },
                    renderCharts(subscribers, movements, expenses) {
                        const destroyChart = (chartId) => {
                            if (App.charts[chartId]) {
                                App.charts[chartId].destroy();
                            }
                        };
                        
                        // Chart 1: New Subs Bar Chart
                        destroyChart('newSubsChart');
                        const newSubsData = { labels: [], datasets: [{ label: 'اشتراكات جديدة', data: [], backgroundColor: 'rgba(74, 144, 226, 0.7)' }] };
                        for(let i = 5; i >= 0; i--) {
                            const d = new Date();
                            d.setMonth(d.getMonth() - i);
                            newSubsData.labels.push(d.toLocaleDateString('ar-EG', { month: 'long' }));
                            const count = movements.filter(m => {
                                const moveDate = new Date(m.timestamp);
                                return m.type === 'activation' && moveDate.getMonth() === d.getMonth() && moveDate.getFullYear() === d.getFullYear();
                            }).length;
                            newSubsData.datasets[0].data.push(count);
                        }
                        App.charts.newSubsChart = new Chart(document.getElementById('newSubsChart'), { type: 'bar', data: newSubsData });
                        
                        // Chart 2: Package Distribution Pie Chart
                        destroyChart('packagesPieChart');
                        const activeSubs = subscribers.filter(sub => sub.lastActivation_endDate && new Date(sub.lastActivation_endDate) > new Date());
                        const packageDist = activeSubs.reduce((acc, sub) => {
                            const pkgName = sub.lastActivation_packageName;
                            if (pkgName) acc[pkgName] = (acc[pkgName] || 0) + 1;
                            return acc;
                        }, {});
                        const pieData = {
                            labels: Object.keys(packageDist),
                            datasets: [{
                                data: Object.values(packageDist),
                                backgroundColor: ['#4a90e2', '#2ecc71', '#f39c12', '#e74c3c', '#9b59b6', '#34495e']
                            }]
                        };
                        App.charts.packagesPieChart = new Chart(document.getElementById('packagesPieChart'), { type: 'pie', data: pieData });

                        // Chart 3: Revenue vs Expenses Line Chart
                        destroyChart('revenueExpenseChart');
                        const lineData = {
                            labels: [],
                            datasets: [
                                { label: 'الإيرادات', data: [], borderColor: 'rgba(46, 204, 113, 1)', tension: 0.1 },
                                { label: 'المصاريف', data: [], borderColor: 'rgba(231, 76, 60, 1)', tension: 0.1 }
                            ]
                        };
                        for(let i = 5; i >= 0; i--) {
                             const d = new Date();
                             d.setMonth(d.getMonth() - i);
                             lineData.labels.push(d.toLocaleDateString('ar-EG', { month: 'short', year: 'numeric' }));
                             
                             let monthRevenue = 0;
                             movements.filter(m => m.type === 'activation' || m.type === 'payment').forEach(m => {
                                 const moveDate = new Date(m.timestamp);
                                 if (moveDate.getMonth() === d.getMonth() && moveDate.getFullYear() === d.getFullYear()) {
                                     monthRevenue += Number(m.paidAmount) || Number(m.amount);
                                 }
                             });
                             
                             let monthExpenses = 0;
                             expenses.forEach(e => {
                                 const expenseDate = new Date(e.date);
                                  if (expenseDate.getMonth() === d.getMonth() && expenseDate.getFullYear() === d.getFullYear()) {
                                     monthExpenses += Number(e.amount);
                                 }
                             });

                             lineData.datasets[0].data.push(monthRevenue);
                             lineData.datasets[1].data.push(monthExpenses);
                        }
                        App.charts.revenueExpenseChart = new Chart(document.getElementById('revenueExpenseChart'), { type: 'line', data: lineData });
                    }
                },
                Subscribers: {
                    async render(filter = 'all') {
                        let subscribers = await App.DB.getAll('subscribers');
                        
                        const noSubsMessage = document.getElementById('no-subs-message');

                        // Apply filter
                        if (filter !== 'all') {
                            subscribers = subscribers.filter(sub => {
                                const status = App.Pages.Subscribers.getSubscriberStatus(sub).key;
                                if (filter === 'active') return status === 'active';
                                if (filter === 'expired') return status === 'expired';
                                if (filter === 'expiring_soon') return status === 'expiring_soon';
                                if (filter === 'has_debt') return (Number(sub.debt) || 0) > 0;
                                return true;
                            });
                        }

                        const tableBody = document.querySelector('#subscribers-table tbody');
                        tableBody.innerHTML = '';

                        if (subscribers.length === 0) {
                            noSubsMessage.style.display = 'block';
                        } else {
                            noSubsMessage.style.display = 'none';
                            subscribers.forEach(sub => {
                                const statusInfo = App.Pages.Subscribers.getSubscriberStatus(sub);
                                const endDate = sub.lastActivation_endDate ? App.UI.formatNumericDateTime(sub.lastActivation_endDate) : 'N/A';
                                const debt = Number(sub.debt) || 0;
                                const canActivateExternally = sub.username && (sub.ispId || App.state.settings.activeIspId);
                                
                                const row = `
                                    <tr data-id="${sub.id}">
                                        <td><input type="checkbox" class="sub-checkbox" data-phone="${sub.phone}"></td>
                                        <td data-label="الاسم">${sub.name}</td>
                                        <td data-label="الهاتف">${sub.phone}</td>
                                        <td><span class="status-badge ${statusInfo.key}">${statusInfo.text}</span></td>
                                        <td>${endDate}</td>
                                        <td>${debt.toLocaleString()}</td>
                                        <td>
                                            <button class="btn btn-sm btn-secondary edit-sub-btn" title="عرض التفاصيل"><i class="fas fa-eye"></i></button>
                                            <button class="btn btn-sm btn-danger delete-sub-btn" title="حذف"><i class="fas fa-trash"></i></button>
                                            <button class="btn btn-sm btn-warning go-to-activation-table-btn" title="تفعيل خارجي" 
                                                style="display: ${canActivateExternally ? 'inline-flex' : 'none'};" 
                                                data-id="${sub.id}">
                                                <i class="fas fa-external-link-alt"></i>
                                            </button>
                                            <button class="btn btn-sm btn-info send-reminder-btn" title="إرسال تذكير"
                                                style="display: ${statusInfo.key === 'expiring_soon' ? 'inline-flex' : 'none'};"
                                                data-id="${sub.id}">
                                                <i class="fab fa-whatsapp"></i>
                                            </button>
                                        </td>
                                    </tr>`;
                                tableBody.insertAdjacentHTML('beforeend', row);
                            });
                        }
                        App.Pages.Subscribers.updateBulkActionsVisibility();
                    },
                    getSubscriberStatus(sub) {
                        if (!sub.lastActivation_endDate) {
                            return { key: 'expired', text: 'منتهي' };
                        }
                        const endDate = new Date(sub.lastActivation_endDate);
                        const today = new Date();
                        const soonDate = new Date();
                        soonDate.setDate(today.getDate() + 3);

                        if (endDate < today) {
                            return { key: 'expired', text: 'منتهي' };
                        }
                        if (endDate >= today && endDate < soonDate) {
                            return { key: 'expiring_soon', text: 'سينتهي قريبا' };
                        }
                        return { key: 'active', text: 'فعال' };
                    },
                    async openEditModal(subId) {
                        App.state.currentSubscriberId = subId;
                        const sub = await App.DB.get('subscribers', subId);

                        if (!sub) {
                            App.UI.showToast('لم يتم العثور على المشترك', 'error');
                            return;
                        }

                        // --- Populate Overview Tab & Status Card ---
                        const today = new Date();
                        const statusInfo = this.getSubscriberStatus(sub);
                        let remainingDays = 0;
                        let progress = 0;

                        if (statusInfo.key !== 'expired' && sub.lastActivation_startDate && sub.lastActivation_endDate) {
                            const startDate = new Date(sub.lastActivation_startDate);
                            const endDate = new Date(sub.lastActivation_endDate);
                            const totalDuration = (endDate - startDate);
                            const remainingTime = (endDate - today);
                            remainingDays = Math.ceil(remainingTime / (1000 * 60 * 60 * 24));
                            if (remainingDays < 0) remainingDays = 0;
                            progress = totalDuration > 0 ? ((totalDuration - remainingTime) / totalDuration) * 100 : 0;
                        }
                        
                        document.getElementById('subscriber-modal-title').textContent = `تفاصيل: ${sub.name}`;
                        document.getElementById('modal-status-badge').textContent = statusInfo.text;
                        document.getElementById('modal-status-badge').className = `status-badge ${statusInfo.key}`;
                        document.getElementById('modal-package-name').textContent = sub.lastActivation_packageName || '-';
                        document.getElementById('modal-current-debt').textContent = (Number(sub.debt) || 0).toLocaleString();
                        document.getElementById('modal-remaining-days').textContent = `${remainingDays} يوم`;
                        document.getElementById('modal-progress-bar').style.width = `${progress}%`;
                        document.getElementById('modal-username').textContent = sub.username || '-';
                        document.getElementById('modal-subid').textContent = sub.subId || '-';
                        document.getElementById('modal-phone').textContent = sub.phone;
                        document.getElementById('modal-notes').textContent = sub.notes || '-';

                        // --- Populate Actions Tab ---
                        const debt = Number(sub.debt) || 0;
                        const packageSelect = document.getElementById('activation-package');
                        packageSelect.innerHTML = '<option value="">-- اختر باقة --</option>';
                        App.state.packages.forEach(pkg => {
                            const option = `<option value="${pkg.id}" data-price="${pkg.price}">${pkg.name} - ${Number(pkg.price).toLocaleString()}</option>`;
                            packageSelect.insertAdjacentHTML('beforeend', option);
                        });
                        
                        const activationStartDateInput = document.getElementById('activation-start-date');
                        if (sub.lastActivation_endDate) {
                            const lastPkg = App.state.packages.find(p => p.name === sub.lastActivation_packageName);
                            if (lastPkg) { packageSelect.value = lastPkg.id; }
                            
                            const endDate = new Date(sub.lastActivation_endDate);
                            activationStartDateInput.value = App.UI.getISO_DateTimeLocal(endDate > new Date() ? endDate : new Date());
                        } else {
                            activationStartDateInput.value = App.UI.getISO_DateTimeLocal(new Date());
                        }
                        
                        this.updateActivationEndDate();
                        this.updateActivationDebt(debt);
                        this.updatePaymentDebt(debt);
                        
                        const activationBtn = document.getElementById('go-to-activation-page-btn');
                        activationBtn.style.display = (sub.username && (sub.ispId || App.state.settings.activeIspId)) ? 'inline-flex' : 'none';
                        
                        document.querySelectorAll('.print-receipt-btn').forEach(btn => {
                            btn.style.display = App.state.settings.printSettings.showReceiptButtons ? 'inline-flex' : 'none';
                        });

                        // --- Populate Edit Tab ---
                        document.getElementById('subscriber-id').value = sub.id;
                        document.getElementById('subscriber-name').value = sub.name;
                        document.getElementById('subscriber-username').value = sub.username || '';
                        document.getElementById('subscriber-subid').value = sub.subId || '';
                        document.getElementById('subscriber-phone').value = sub.phone;
                        document.getElementById('subscriber-notes').value = sub.notes || '';
                        
                        const ispSelect = document.getElementById('subscriber-isp');
                        ispSelect.innerHTML = '<option value="">استخدام الإعداد الافتراضي</option>';
                        App.state.settings.isps.forEach(isp => {
                           ispSelect.innerHTML += `<option value="${isp.id}">${isp.name}</option>`;
                        });
                        ispSelect.value = sub.ispId || "";

                        const editDatesSection = document.getElementById('edit-dates-section');
                        if (sub.lastActivation_startDate) {
                            document.getElementById('edit-start-date').value = App.UI.getISO_DateTimeLocal(new Date(sub.lastActivation_startDate));
                            document.getElementById('edit-end-date').value = App.UI.getISO_DateTimeLocal(new Date(sub.lastActivation_endDate));
                            editDatesSection.style.display = 'block';
                        } else {
                            editDatesSection.style.display = 'none';
                        }
                        
                        // --- Populate History Tab ---
                        const movements = await App.DB.getAll('movements', 'subscriberId', subId);
                        const movementsTableBody = document.querySelector('#subscriber-movements-table tbody');
                        movementsTableBody.innerHTML = '';
                        movements.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp)).forEach(m => {
                            let details = '';
                            if (m.type === 'activation') {
                                details = `${m.packageName} (+${Number(m.amount).toLocaleString()})`;
                                if(Number(m.paidAmount) > 0) details += ` | مدفوع: ${Number(m.paidAmount).toLocaleString()}`;
                            } else if (m.type === 'payment') {
                                details = `دفعة (-${Number(m.amount).toLocaleString()})`;
                            }
                            if (m.notes) { details += `<br><small style="opacity: 0.7;">${m.notes}</small>`; }
                            
                            const movementDate = App.UI.formatNumericDateTime(m.timestamp);
                            const startDate = m.type === 'activation' && m.startDate ? App.UI.formatNumericDateTime(m.startDate) : '-';
                            const endDate = m.type === 'activation' && m.endDate ? App.UI.formatNumericDateTime(m.endDate) : '-';

                            const row = `
                                <tr>
                                    <td>${m.type === 'activation' ? 'تفعيل' : 'تسديد'}</td>
                                    <td>${details}</td>
                                    <td>${movementDate}</td>
                                    <td>${startDate}</td>
                                    <td>${endDate}</td>
                                    <td><button class="btn btn-sm btn-secondary print-movement-btn" title="طباعة الوصل" data-movement-id="${m.id}"><i class="fas fa-print"></i></button></td>
                                </tr>`;
                            movementsTableBody.insertAdjacentHTML('beforeend', row);
                        });
                        
                        App.UI.openModal('subscriber-modal');
                    },
                    updateActivationDebt(currentDebt) {
                        const packageSelect = document.getElementById('activation-package');
                        const selectedOption = packageSelect.options[packageSelect.selectedIndex];
                        const pkgPrice = parseFloat(selectedOption.dataset.price) || 0;
                        const amountPaid = parseFloat(document.getElementById('activation-amount-paid').value) || 0;
                        const netDebt = (currentDebt + pkgPrice) - amountPaid;
                        document.getElementById('net-debt-activation').textContent = netDebt.toLocaleString();
                    },
                    updateActivationEndDate() {
                        const packageSelect = document.getElementById('activation-package');
                        const startDateInput = document.getElementById('activation-start-date');
                        const endDateInput = document.getElementById('activation-end-date');
                        const pkgId = parseInt(packageSelect.value);
                        const startDateValue = startDateInput.value;

                        if (pkgId && startDateValue) {
                            const startDate = new Date(startDateValue);
                            const pkg = App.state.packages.find(p => p.id == pkgId);
                            if (pkg) {
                                const endDate = new Date(startDate);
                                if (pkg.durationType === 'months') {
                                    endDate.setMonth(startDate.getMonth() + Number(pkg.durationValue));
                                } else {
                                    endDate.setDate(startDate.getDate() + Number(pkg.durationValue));
                                }
                                endDateInput.value = App.UI.getISO_DateTimeLocal(endDate);
                            } else { endDateInput.value = ''; }
                        } else { endDateInput.value = ''; }
                    },
                    updatePaymentDebt(currentDebt) {
                        const paymentAmount = parseFloat(document.getElementById('payment-amount').value) || 0;
                        const remainingDebt = currentDebt - paymentAmount;
                        document.getElementById('remaining-debt-payment').textContent = remainingDebt.toLocaleString();
                    },
                    filterTable() {
                        const searchTerm = document.getElementById('subscriber-search').value.toLowerCase();
                        const tableRows = document.querySelectorAll('#subscribers-table tbody tr');
                        tableRows.forEach(row => {
                            const name = row.cells[1].textContent.toLowerCase();
                            const phone = row.cells[2].textContent.toLowerCase();
                            row.style.display = (name.includes(searchTerm) || phone.includes(searchTerm)) ? '' : 'none';
                        });
                    },
                    updateBulkActionsVisibility() {
                        const selectedCheckboxes = document.querySelectorAll('.sub-checkbox:checked');
                        const bulkActionsBar = document.getElementById('bulk-actions-bar');
                        const countSpan = document.getElementById('bulk-actions-count');
                        
                        document.querySelectorAll('.sub-checkbox').forEach(box => {
                           box.closest('tr').classList.toggle('selected-row', box.checked);
                        });

                        if (selectedCheckboxes.length > 0) {
                            bulkActionsBar.style.display = 'flex';
                            countSpan.textContent = `${selectedCheckboxes.length} مشترك محدد`;
                        } else {
                            bulkActionsBar.style.display = 'none';
                        }
                    }
                },
                 Movements: {
                    async render() {
                        this.subscribers = await App.DB.getAll('subscribers');
                        this.movements = await App.DB.getAll('movements');
                        this.applyFilters();
                        this.attachListeners();
                    },
                    attachListeners() {
                        const page = document.getElementById('movements-page');
                        if (page.dataset.listenerAttached) return;
                        document.getElementById('movements-search').addEventListener('keyup', () => this.applyFilters());
                        document.getElementById('movements-start-date').addEventListener('change', () => this.applyFilters());
                        document.getElementById('movements-end-date').addEventListener('change', () => this.applyFilters());
                        document.getElementById('movements-type-filter').addEventListener('change', () => this.applyFilters());
                        page.dataset.listenerAttached = 'true';
                    },
                    applyFilters() {
                        const searchTerm = document.getElementById('movements-search').value.toLowerCase();
                        const startDate = document.getElementById('movements-start-date').value;
                        const endDate = document.getElementById('movements-end-date').value;
                        const typeFilter = document.getElementById('movements-type-filter').value;
                        
                        let filteredMovements = this.movements;

                        if (searchTerm) {
                            filteredMovements = filteredMovements.filter(m => {
                                const sub = this.subscribers.find(s => s.id == m.subscriberId);
                                return sub && sub.name.toLowerCase().includes(searchTerm);
                            });
                        }
                        if (startDate) { filteredMovements = filteredMovements.filter(m => new Date(m.timestamp) >= new Date(startDate)); }
                        if (endDate) {
                             const end = new Date(endDate);
                             end.setHours(23, 59, 59, 999);
                             filteredMovements = filteredMovements.filter(m => new Date(m.timestamp) <= end);
                        }
                        if (typeFilter !== 'all') { filteredMovements = filteredMovements.filter(m => m.type === typeFilter); }
                        
                        this.renderTable(filteredMovements);
                        this.renderStats(filteredMovements);
                    },
                    renderStats(movements) {
                        const statsGrid = document.getElementById('movements-stats-grid');
                        let totalActivationsAmount = 0;
                        let totalPaymentsAmount = 0;
                        
                        movements.forEach(m => {
                            if (m.type === 'activation') { totalActivationsAmount += Number(m.amount); }
                            else if (m.type === 'payment') { totalPaymentsAmount += Number(m.amount); }
                        });
                        
                        statsGrid.innerHTML = `
                            <div class="stat-card">
                                <div class="icon bg-success"><i class="fas fa-file-invoice-dollar"></i></div>
                                <div class="info"><h3>إجمالي إيرادات التفعيل</h3><p>${totalActivationsAmount.toLocaleString()}</p></div>
                            </div>
                            <div class="stat-card">
                                <div class="icon bg-primary"><i class="fas fa-hand-holding-usd"></i></div>
                                <div class="info"><h3>إجمالي التسديدات</h3><p>${totalPaymentsAmount.toLocaleString()}</p></div>
                            </div>`;
                    },
                    renderTable(movements) {
                        const tableBody = document.querySelector('#movements-table tbody');
                        const noMovementsMessage = document.getElementById('no-movements-message');
                        tableBody.innerHTML = '';
                        
                        if (movements.length === 0) {
                            noMovementsMessage.style.display = 'block';
                        } else {
                            noMovementsMessage.style.display = 'none';
                            movements.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp)).forEach(m => {
                                const sub = this.subscribers.find(s => s.id == m.subscriberId);
                                let details = '';
                                if (m.type === 'activation') {
                                    details = `${m.packageName} (+${Number(m.amount).toLocaleString()})`;
                                     if(Number(m.paidAmount) > 0) details += ` | مدفوع: ${Number(m.paidAmount).toLocaleString()}`;
                                } else if (m.type === 'payment') {
                                    details = `دفعة (-${Number(m.amount).toLocaleString()})`;
                                }
                                const row = `
                                    <tr>
                                        <td>${sub ? sub.name : 'مشترك محذوف'}</td>
                                        <td>${m.type === 'activation' ? 'تفعيل' : 'تسديد'}</td>
                                        <td>${details}</td>
                                        <td>${m.notes || '-'}</td>
                                        <td>${App.UI.formatDateTime(m.timestamp)}</td>
                                    </tr>`;
                                tableBody.insertAdjacentHTML('beforeend', row);
                            });
                        }
                    }
                },
                Packages: {
                     async render() {
                        const tableBody = document.querySelector('#packages-table tbody');
                        tableBody.innerHTML = '';
                        App.state.packages.forEach(pkg => {
                            const durationType = pkg.durationType === 'months' ? 'شهر' : 'يوم';
                            const row = `
                                <tr data-id="${pkg.id}">
                                    <td>${pkg.name}</td>
                                    <td>${Number(pkg.price).toLocaleString()}</td>
                                    <td>${Number(pkg.cost).toLocaleString()}</td>
                                    <td>${pkg.durationValue} ${durationType}</td>
                                    <td>
                                        <button class="btn btn-sm btn-secondary edit-pkg-btn"><i class="fas fa-edit"></i></button>
                                        <button class="btn btn-sm btn-danger delete-pkg-btn"><i class="fas fa-trash"></i></button>
                                    </td>
                                </tr>`;
                            tableBody.insertAdjacentHTML('beforeend', row);
                        });
                     }
                },
                Expenses: {
                     async render() {
                        const expenses = await App.DB.getAll('expenses');
                        const tableBody = document.querySelector('#expenses-table tbody');
                        tableBody.innerHTML = '';
                        expenses.sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(exp => {
                            const row = `
                                <tr data-id="${exp.id}">
                                    <td>${exp.description}</td>
                                    <td>${Number(exp.amount).toLocaleString()}</td>
                                    <td>${App.UI.formatDate(exp.date)}</td>
                                    <td>
                                        <button class="btn btn-sm btn-secondary edit-exp-btn"><i class="fas fa-edit"></i></button>
                                        <button class="btn btn-sm btn-danger delete-exp-btn"><i class="fas fa-trash"></i></button>
                                    </td>
                                </tr>`;
                            tableBody.insertAdjacentHTML('beforeend', row);
                        });
                     }
                },
                Reports: {
                     init() {
                        const page = document.getElementById('reports-page');
                        if (page.dataset.listenerAttached) return;
                        const today = App.UI.getISODate(new Date());
                        document.getElementById('report-start-date').value = today;
                        document.getElementById('report-end-date').value = today;
                        document.getElementById('report-output').style.display = 'none';
                        document.getElementById('generate-report-btn').addEventListener('click', () => this.generate());
                        document.getElementById('print-report-btn').addEventListener('click', () => this.print());
                        document.getElementById('export-report-csv').addEventListener('click', () => this.export('csv'));
                        document.getElementById('export-report-xlsx').addEventListener('click', () => this.export('xlsx'));
                        page.dataset.listenerAttached = 'true';
                     },
                     async generate() {
                        App.UI.showLoader();
                        const startDateStr = document.getElementById('report-start-date').value;
                        const endDateStr = document.getElementById('report-end-date').value;

                        if (!startDateStr || !endDateStr) {
                            App.UI.showToast('الرجاء تحديد تاريخ البدء والانتهاء', 'error');
                            App.UI.hideLoader();
                            return;
                        }

                        const startDate = new Date(startDateStr);
                        startDate.setHours(0, 0, 0, 0);
                        const endDate = new Date(endDateStr);
                        endDate.setHours(23, 59, 59, 999);

                        const allMovements = await App.DB.getAll('movements');
                        const allExpenses = await App.DB.getAll('expenses');
                        const allSubscribers = await App.DB.getAll('subscribers');

                        const movements = allMovements.filter(m => { const moveDate = new Date(m.timestamp); return moveDate >= startDate && moveDate <= endDate; });
                        const expenses = allExpenses.filter(e => { const expenseDate = new Date(e.date); return expenseDate >= startDate && expenseDate <= endDate; });

                        let totalRevenue = 0;
                        let totalCosts = 0;
                        const packageProfits = {};
                        const subscriberPayments = {};

                        movements.forEach(m => {
                            const amountPaid = Number(m.paidAmount) || (m.type === 'payment' ? Number(m.amount) : 0);
                            totalRevenue += amountPaid;
                            if (m.type === 'activation') {
                                const pkg = App.state.packages.find(p => p.name === m.packageName);
                                if (pkg) {
                                    totalCosts += Number(pkg.cost);
                                    const profit = Number(pkg.price) - Number(pkg.cost);
                                    packageProfits[pkg.name] = (packageProfits[pkg.name] || 0) + profit;
                                }
                            }
                            const sub = allSubscribers.find(s => s.id == m.subscriberId);
                            if (sub) { subscriberPayments[sub.name] = (subscriberPayments[sub.name] || 0) + amountPaid; }
                        });

                        let totalExpenses = expenses.reduce((sum, e) => sum + Number(e.amount), 0);
                        const netProfit = totalRevenue - totalCosts - totalExpenses;
                        
                        App.state.currentReportData = {
                            summary: [
                                { "البند": "إجمالي الإيرادات", "المبلغ": totalRevenue },
                                { "البند": "تكاليف الباقات", "المبلغ": totalCosts },
                                { "البند": "المصاريف الأخرى", "المبلغ": totalExpenses },
                                { "البند": "صافي الربح النهائي", "المبلغ": netProfit }
                            ],
                            topPackages: Object.entries(packageProfits).sort((a,b) => b[1] - a[1]).slice(0, 10),
                            topSubscribers: Object.entries(subscriberPayments).sort((a,b) => b[1] - a[1]).slice(0, 10)
                        };
                        
                        document.getElementById('report-summary').innerHTML = `
                            <ul>
                                <li><span><i class="fas fa-arrow-up text-success"></i> إجمالي الإيرادات</span><span class="text-success">${totalRevenue.toLocaleString()}</span></li>
                                <li><span><i class="fas fa-arrow-down text-warning"></i> تكاليف الباقات</span><span class="text-warning">${totalCosts.toLocaleString()}</span></li>
                                <li><span><i class="fas fa-arrow-down text-danger"></i> المصاريف الأخرى</span><span class="text-danger">${totalExpenses.toLocaleString()}</span></li>
                                <li><span><i class="fas fa-calculator text-primary"></i> صافي الربح النهائي</span><span class="text-primary">${netProfit.toLocaleString()}</span></li>
                            </ul>`;
                        
                        const topPackagesList = document.getElementById('top-packages-list');
                        topPackagesList.innerHTML = '';
                        App.state.currentReportData.topPackages.forEach(([name, profit]) => { topPackagesList.innerHTML += `<li><span>${name}</span> <span class="text-success">${profit.toLocaleString()}</span></li>`; });
                        if (topPackagesList.innerHTML === '') topPackagesList.innerHTML = '<li>لا توجد بيانات.</li>';

                        const topSubscribersList = document.getElementById('top-subscribers-list');
                        topSubscribersList.innerHTML = '';
                        App.state.currentReportData.topSubscribers.forEach(([name, payment]) => { topSubscribersList.innerHTML += `<li><span>${name}</span> <span class="text-success">${payment.toLocaleString()}</span></li>`; });
                        if (topSubscribersList.innerHTML === '') topSubscribersList.innerHTML = '<li>لا توجد بيانات.</li>';

                        document.getElementById('report-period').textContent = `للفترة من ${App.UI.formatDate(startDate)} إلى ${App.UI.formatDate(endDate)}`;
                        document.getElementById('report-output').style.display = 'block';
                        App.UI.hideLoader();
                     },
                     print() {
                        if (!App.state.currentReportData) { App.UI.showToast('الرجاء توليد تقرير أولاً', 'warning'); return; }
                        const profile = App.state.settings.companyProfile;
                        document.getElementById('print-company-name').textContent = profile.name;
                        document.getElementById('print-logo').src = profile.logo;
                        window.print();
                     },
                     export(format) {
                         if (!App.state.currentReportData) { App.UI.showToast('الرجاء توليد تقرير أولاً', 'warning'); return; }
                         const { summary, topPackages, topSubscribers } = App.state.currentReportData;
                         const summaryData = summary.map(item => ({ 'البند': item.البند, 'المبلغ': item.المبلغ }));
                         const packagesData = topPackages.map(([name, profit]) => ({ 'اسم الباقة': name, 'الربح': profit }));
                         const subscribersData = topSubscribers.map(([name, payment]) => ({ 'اسم المشترك': name, 'إجمالي الدفع': payment }));
                         const allData = [ { 'التقرير': 'الملخص المالي' }, ...summaryData, { '': '' }, { 'التقرير': 'الباقات الأكثر ربحاً' }, ...packagesData, { '': '' }, { 'التقرير': 'المشتركون الأكثر دفعاً' }, ...subscribersData ];
                         const filename = `Report-${document.getElementById('report-start-date').value}-to-${document.getElementById('report-end-date').value}`;
                         const ws = XLSX.utils.json_to_sheet(allData, { skipHeader: true });
                         const wb = XLSX.utils.book_new();
                         XLSX.utils.book_append_sheet(wb, ws, "التقرير");

                         if (format === 'xlsx') { XLSX.writeFile(wb, `${filename}.xlsx`); } 
                         else {
                            const csv = XLSX.utils.sheet_to_csv(ws);
                            const blob = new Blob([`\uFEFF${csv}`], { type: 'text/csv;charset=utf-8;' });
                            const link = document.createElement("a");
                            link.href = URL.createObjectURL(blob);
                            link.download = `${filename}.csv`;
                            document.body.appendChild(link);
                            link.click();
                            document.body.removeChild(link);
                         }
                     }
                },
                Settings: {
                     async render() {
                        const settings = App.state.settings;
                        document.getElementById('company-name').value = settings.companyProfile.name;
                        document.getElementById('company-logo').value = settings.companyProfile.logo;
                        document.getElementById('company-contact').value = settings.companyProfile.contact;
                        document.getElementById('whatsapp-code').value = settings.companyProfile.whatsappCode;
                        document.getElementById('activation-template').value = settings.whatsappTemplates.activation;
                        document.getElementById('payment-template').value = settings.whatsappTemplates.payment;
                        document.getElementById('reminder-template').value = settings.whatsappTemplates.reminder;
                        document.getElementById('whatsapp-method-select').value = settings.automation.whatsappMethod || 'api';
                        document.getElementById('send-on-activation-toggle').checked = settings.automation.sendOnActivation;
                        document.getElementById('send-on-payment-toggle').checked = settings.automation.sendOnPayment;
                        document.getElementById('font-selector').value = settings.appFont;
                        document.getElementById('primary-color-picker').value = settings.primaryColor;
                        document.getElementById('show-print-buttons-toggle').checked = settings.printSettings.showReceiptButtons;
                        document.getElementById('print-paper-size').value = settings.printSettings.paperSize;
                        document.getElementById('show-fab-toggle').checked = settings.syncSettings.showUploadFab;
                        document.getElementById('auto-upload-toggle').checked = settings.syncSettings.autoUploadOnIdle;
                        
                        const customContainer = document.getElementById('custom-paper-size-container');
                        if (settings.printSettings.paperSize === 'custom') {
                            customContainer.style.display = 'block';
                            document.getElementById('custom-paper-size').value = settings.printSettings.customPaperSize;
                        } else {
                             customContainer.style.display = 'none';
                        }

                        this.renderIspList();
                        this.renderActiveIspSelector();
                     },
                     async renderIspList() {
                        const tableBody = document.querySelector('#isps-table tbody');
                        tableBody.innerHTML = '';
                        App.state.settings.isps.forEach(isp => {
                            const row = `
                                <tr data-id="${isp.id}">
                                    <td>${isp.name}</td>
                                    <td>${isp.url}</td>
                                    <td>
                                        <button class="btn btn-sm btn-secondary edit-isp-btn"><i class="fas fa-edit"></i></button>
                                        <button class="btn btn-sm btn-danger delete-isp-btn"><i class="fas fa-trash"></i></button>
                                    </td>
                                </tr>`;
                            tableBody.insertAdjacentHTML('beforeend', row);
                        });
                     },
                     renderActiveIspSelector() {
                        const selector = document.getElementById('active-isp-selector');
                        selector.innerHTML = '<option value="">-- لا يوجد --</option>';
                        App.state.settings.isps.forEach(isp => {
                            const option = document.createElement('option');
                            option.value = isp.id;
                            option.textContent = isp.name;
                            if (isp.id == App.state.settings.activeIspId) {
                                option.selected = true;
                            }
                            selector.appendChild(option);
                        });
                     }
                },
                Info: {
                    init() {
                        const infoPage = document.getElementById('info-page');
                        if (!infoPage || infoPage.dataset.listenerAttached) return;

                        const accordionItems = infoPage.querySelectorAll('.accordion-item');
                        accordionItems.forEach(item => {
                            const header = item.querySelector('.accordion-header');
                            header.addEventListener('click', () => {
                                const content = item.querySelector('.accordion-content');
                                if (item.classList.contains('active')) {
                                    item.classList.remove('active');
                                    content.style.maxHeight = 0;
                                    content.style.padding = '0 20px';
                                } else {
                                    accordionItems.forEach(otherItem => {
                                        otherItem.classList.remove('active');
                                        otherItem.querySelector('.accordion-content').style.maxHeight = 0;
                                        otherItem.querySelector('.accordion-content').style.padding = '0 20px';
                                    });
                                    item.classList.add('active');
                                    content.style.padding = '15px 20px';
                                    content.style.maxHeight = content.scrollHeight + 'px';
                                }
                            });
                        });
                        infoPage.dataset.listenerAttached = 'true';
                    }
                }
            },
            
            resetIdleTimer() {
                clearTimeout(this.idleTimer);
                if (this.state.settings.syncSettings.autoUploadOnIdle) {
                    this.idleTimer = setTimeout(() => {
                        console.log("User idle for 5 minutes. Triggering auto-upload.");
                        this.UI.showToast('يتم الرفع التلقائي بسبب الخمول...', 'info');
                        this.uploadAllDataToSheet(true); // Pass true for silent mode
                    }, 300000); // 5 minutes in milliseconds
                }
            },

            // --- Event Listeners ---
            attachEventListeners() {
                // Sidebar toggle
                document.getElementById('menu-toggle').addEventListener('click', () => {
                    document.getElementById('sidebar').classList.toggle('open');
                    document.getElementById('overlay').classList.toggle('active');
                });
                document.getElementById('overlay').addEventListener('click', () => {
                    document.getElementById('sidebar').classList.remove('open');
                    document.getElementById('overlay').classList.remove('active');
                });

                // Modal close buttons
                document.querySelectorAll('.modal .close-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const modalId = e.target.closest('.modal').id;
                        this.UI.closeModal(modalId);
                    });
                });

                // Idle timer reset on user activity
                ['click', 'mousemove', 'keypress', 'scroll'].forEach(event => {
                    window.addEventListener(event, () => this.resetIdleTimer());
                });
                
                // --- SUBSCRIBERS ---
                document.getElementById('subscriber-search').addEventListener('keyup', this.Pages.Subscribers.filterTable);
                document.getElementById('subscriber-filters').addEventListener('click', (e) => {
                    if(e.target.classList.contains('filter-btn')) {
                        document.querySelectorAll('#subscriber-filters .filter-btn').forEach(btn => btn.classList.remove('active'));
                        e.target.classList.add('active');
                        this.Pages.Subscribers.render(e.target.dataset.filter);
                    }
                });
                document.getElementById('subscribers-table').addEventListener('change', (e) => {
                    if(e.target.classList.contains('sub-checkbox') || e.target.id === 'select-all-subs') {
                        this.Pages.Subscribers.updateBulkActionsVisibility();
                    }
                });
                document.getElementById('select-all-subs').addEventListener('change', (e) => {
                    document.querySelectorAll('.sub-checkbox').forEach(checkbox => checkbox.checked = e.target.checked);
                    this.Pages.Subscribers.updateBulkActionsVisibility();
                });

                document.getElementById('add-subscriber-btn').addEventListener('click', () => {
                    document.querySelector('#subscriber-modal .tab-link[data-tab="edit"]').click();
                    document.getElementById('subscriber-form').reset();
                    document.getElementById('subscriber-id').value = '';
                    document.getElementById('subscriber-modal-title').textContent = 'إضافة مشترك جديد';
                    
                    document.querySelector('#subscriber-modal .modal-tabs').style.display = 'none';
                    document.querySelectorAll('#subscriber-modal .tab-content').forEach(c => c.classList.remove('active'));
                    document.getElementById('edit-tab').classList.add('active');

                    this.UI.openModal('subscriber-modal');
                });

                document.getElementById('subscriber-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const id = parseInt(document.getElementById('subscriber-id').value);
                    let subscriberData = {
                        name: document.getElementById('subscriber-name').value,
                        username: document.getElementById('subscriber-username').value,
                        subId: document.getElementById('subscriber-subid').value,
                        phone: document.getElementById('subscriber-phone').value,
                        notes: document.getElementById('subscriber-notes').value,
                        ispId: parseInt(document.getElementById('subscriber-isp').value) || null
                    };
                    
                    if (id) {
                        const existingSub = await this.DB.get('subscribers', id);
                        subscriberData = {...existingSub, ...subscriberData};
                        subscriberData.id = id;
                        await this.saveData('put', 'subscribers', subscriberData);
                        this.UI.showToast('تم تحديث بيانات المشترك بنجاح', 'success');
                        this.UI.closeModal('subscriber-modal');
                        if(this.state.currentPage === 'subscribers') this.Pages.Subscribers.render();
                    } else {
                        subscriberData.debt = 0;
                        subscriberData.id = Date.now();
                        await this.saveData('add', 'subscribers', subscriberData);
                        this.UI.showToast('تمت إضافة المشترك بنجاح', 'success');
                        this.UI.closeModal('subscriber-modal');
                        this.Pages.Subscribers.render();
                    }
                });
                
                document.getElementById('subscribers-table').addEventListener('click', async (e) => {
                    const editBtn = e.target.closest('.edit-sub-btn');
                    const deleteBtn = e.target.closest('.delete-sub-btn');
                    const activateBtn = e.target.closest('.go-to-activation-table-btn');
                    const reminderBtn = e.target.closest('.send-reminder-btn');
                    
                    if (editBtn) {
                        document.querySelector('#subscriber-modal .modal-tabs').style.display = 'flex';
                        document.querySelector('#subscriber-modal .tab-link[data-tab="overview"]').click();
                        const subId = parseInt(editBtn.closest('tr').dataset.id);
                        this.Pages.Subscribers.openEditModal(subId);
                    }
                    
                    if (deleteBtn) {
                        if (confirm('هل أنت متأكد من حذف هذا المشترك؟ سيتم حذف جميع حركاته المالية أيضاً.')) {
                            const subId = parseInt(deleteBtn.closest('tr').dataset.id);
                            await this.saveData('delete', 'subscribers', subId);
                            const movementsToDelete = await this.DB.getAll('movements', 'subscriberId', subId);
                            for (const movement of movementsToDelete) {
                                await this.saveData('delete', 'movements', movement.id);
                            }
                            this.UI.showToast('تم حذف المشترك', 'success');
                            this.Pages.Subscribers.render();
                        }
                    }

                    if (activateBtn) {
                        const subId = parseInt(activateBtn.dataset.id);
                        const sub = await this.DB.get('subscribers', subId);
                        const isp = this.getSubscriberIsp(sub);
                        if (!isp) { this.UI.showToast('الرجاء تحديد شركة تزويد فعالة في الإعدادات أو للمشترك', 'error'); return; }
                        const url = isp.url.replace('{{USER}}', sub.username || '').replace('{{subId}}', sub.subId || '');
                        window.open(url, '_blank');
                    }
                    
                    if (reminderBtn) {
                        const subId = parseInt(reminderBtn.dataset.id);
                        const sub = await this.DB.get('subscribers', subId);
                        const templateData = {
                            'اسم_المشترك': sub.name,
                            'تاريخ_الانتهاء': this.UI.formatNumericDateTime(sub.lastActivation_endDate)
                        };
                        const message = this.UI.parseTemplate(this.state.settings.whatsappTemplates.reminder, templateData);
                        this.openWhatsApp(sub.phone, message);
                    }
                });

                // Subscriber Modal Tabs
                document.querySelector('#subscriber-modal .modal-tabs').addEventListener('click', (e) => {
                    if (e.target.classList.contains('tab-link')) {
                        const tabId = e.target.dataset.tab;
                        document.querySelectorAll('#subscriber-modal .tab-link').forEach(tab => tab.classList.remove('active'));
                        document.querySelectorAll('#subscriber-modal .tab-content').forEach(content => content.classList.remove('active'));
                        e.target.classList.add('active');
                        document.getElementById(`${tabId}-tab`).classList.add('active');
                    }
                });

                // Subscriber Modal - Live calculations
                const activationForm = document.getElementById('activation-form');
                activationForm.addEventListener('change', async (e) => {
                    if (e.target.id === 'activation-package' || e.target.id === 'activation-start-date') { this.Pages.Subscribers.updateActivationEndDate(); }
                    const sub = await this.DB.get('subscribers', this.state.currentSubscriberId);
                    this.Pages.Subscribers.updateActivationDebt(Number(sub.debt) || 0);
                });
                 activationForm.addEventListener('input', async (e) => {
                    if (e.target.id === 'activation-amount-paid') {
                        const sub = await this.DB.get('subscribers', this.state.currentSubscriberId);
                        this.Pages.Subscribers.updateActivationDebt(Number(sub.debt) || 0);
                    }
                });
                document.getElementById('payment-amount').addEventListener('input', async () => {
                     const sub = await this.DB.get('subscribers', this.state.currentSubscriberId);
                     this.Pages.Subscribers.updatePaymentDebt(Number(sub.debt) || 0);
                });

                // Subscriber Modal - Forms submission
                document.getElementById('activation-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const subId = this.state.currentSubscriberId;
                    const pkgId = parseInt(document.getElementById('activation-package').value);
                    if (!subId || !pkgId) { this.UI.showToast('الرجاء اختيار باقة صالحة', 'error'); return; }

                    const sub = await this.DB.get('subscribers', subId);
                    const pkg = this.state.packages.find(p => p.id == pkgId);
                    const amountPaid = parseFloat(document.getElementById('activation-amount-paid').value) || 0;
                    const notes = document.getElementById('activation-notes').value;
                    const startDate = new Date(document.getElementById('activation-start-date').value);
                    const endDate = new Date(document.getElementById('activation-end-date').value);
                    const newDebt = (Number(sub.debt) || 0) + Number(pkg.price) - amountPaid;

                    const movement = { id: Date.now(), subscriberId: sub.id, type: 'activation', packageName: pkg.name, amount: Number(pkg.price), paidAmount: amountPaid, notes: notes, timestamp: new Date().toISOString(), startDate: startDate.toISOString(), endDate: endDate.toISOString() };
                    const movementId = (await this.saveData('add', 'movements', movement));
                    const updatedSub = { ...sub, debt: newDebt, lastActivation_movementId: movementId, lastActivation_packageName: pkg.name, lastActivation_startDate: startDate.toISOString(), lastActivation_endDate: endDate.toISOString() };
                    await this.saveData('put', 'subscribers', updatedSub);

                    if (this.state.settings.automation.sendOnActivation) {
                        const templateData = { 'اسم_المشترك': sub.name, 'اسم_الباقة': pkg.name, 'تاريخ_البدء': this.UI.formatNumericDateTime(startDate), 'تاريخ_الانتهاء': this.UI.formatNumericDateTime(endDate), 'الدين_السابق': (Number(sub.debt) || 0).toLocaleString(), 'سعر_الباقة': Number(pkg.price).toLocaleString(), 'المبلغ_الإجمالي': ((Number(sub.debt) || 0) + Number(pkg.price)).toLocaleString(), 'المبلغ_الواصل': amountPaid.toLocaleString(), 'الرصيد_المتبقي': newDebt.toLocaleString() };
                        const message = this.UI.parseTemplate(this.state.settings.whatsappTemplates.activation, templateData);
                        this.openWhatsApp(sub.phone, message);
                    }

                    this.UI.showToast('تم التفعيل بنجاح', 'success');
                    this.UI.closeModal('subscriber-modal');
                    this.Pages.Subscribers.render();
                });

                document.getElementById('payment-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const subId = this.state.currentSubscriberId;
                    const amount = parseFloat(document.getElementById('payment-amount').value);
                    const notes = document.getElementById('payment-notes').value;
                    if (!subId || !amount || amount <= 0) { this.UI.showToast('الرجاء إدخال مبلغ صحيح', 'error'); return; }

                    const sub = await this.DB.get('subscribers', subId);
                    const newDebt = (Number(sub.debt) || 0) - amount;
                    const movement = { id: Date.now(), subscriberId: sub.id, type: 'payment', amount: amount, paidAmount: amount, notes: notes, timestamp: new Date().toISOString() };
                    const updatedSub = {...sub, debt: newDebt};
                    await this.saveData('put', 'subscribers', updatedSub);
                    await this.saveData('add', 'movements', movement);
                    
                    if (this.state.settings.automation.sendOnPayment) {
                       const templateData = { 'اسم_المشترك': sub.name, 'الدين_السابق': (Number(sub.debt) || 0).toLocaleString(), 'المبلغ_الواصل': amount.toLocaleString(), 'الرصيد_المتبقي': newDebt.toLocaleString() };
                        const message = this.UI.parseTemplate(this.state.settings.whatsappTemplates.payment, templateData);
                        this.openWhatsApp(sub.phone, message);
                    }
                    
                    this.UI.showToast('تم التسديد بنجاح', 'success');
                    this.UI.closeModal('subscriber-modal');
                    this.Pages.Subscribers.render();
                });

                document.getElementById('edit-dates-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const subId = this.state.currentSubscriberId;
                    if(!subId) return;
                    const sub = await this.DB.get('subscribers', subId);
                    if(!sub || !sub.lastActivation_movementId) { this.UI.showToast('لا يوجد اشتراك فعال لتعديل تواريخه', 'error'); return; }

                    const movementId = sub.lastActivation_movementId;
                    const movement = await this.DB.get('movements', movementId);
                    const newStartDate = new Date(document.getElementById('edit-start-date').value);
                    const newEndDate = new Date(document.getElementById('edit-end-date').value);
                    const updatedMovement = {...movement, startDate: newStartDate.toISOString(), endDate: newEndDate.toISOString()};
                    await this.saveData('put', 'movements', updatedMovement);
                    const updatedSub = {...sub, lastActivation_startDate: newStartDate.toISOString(), lastActivation_endDate: newEndDate.toISOString()};
                    await this.saveData('put', 'subscribers', updatedSub);

                    this.UI.showToast('تم تحديث التواريخ بنجاح', 'success');
                    this.UI.closeModal('subscriber-modal');
                    this.Pages.Subscribers.render();
                });
                
                document.getElementById('go-to-activation-page-btn').addEventListener('click', async () => {
                    const subId = this.state.currentSubscriberId;
                    const sub = await this.DB.get('subscribers', subId);
                    const isp = this.getSubscriberIsp(sub);
                    if (!isp) { this.UI.showToast('الرجاء تحديد شركة تزويد فعالة في الإعدادات أو للمشترك', 'error'); return; }
                    const url = isp.url.replace('{{USER}}', sub.username || '').replace('{{subId}}', sub.subId || '');
                    window.open(url, '_blank');
                });
                
                // Bulk Actions
                document.getElementById('bulk-delete-btn').addEventListener('click', async () => {
                    const selectedCheckboxes = document.querySelectorAll('.sub-checkbox:checked');
                    if (selectedCheckboxes.length === 0) { this.UI.showToast('الرجاء تحديد مشترك واحد على الأقل', 'warning'); return; }
                    if (confirm(`هل أنت متأكد من حذف ${selectedCheckboxes.length} مشترك؟`)) {
                        for (const checkbox of selectedCheckboxes) {
                            const subId = parseInt(checkbox.closest('tr').dataset.id);
                            await this.saveData('delete', 'subscribers', subId);
                            const movementsToDelete = await this.DB.getAll('movements', 'subscriberId', subId);
                            for (const movement of movementsToDelete) { await this.saveData('delete', 'movements', movement.id); }
                        }
                        this.UI.showToast('تم حذف المشتركين المحددين', 'success');
                        this.Pages.Subscribers.render();
                    }
                });
                
                document.getElementById('bulk-whatsapp-btn').addEventListener('click', () => {
                    const selectedCheckboxes = document.querySelectorAll('.sub-checkbox:checked');
                     if (selectedCheckboxes.length === 0) { this.UI.showToast('الرجاء تحديد مشترك واحد على الأقل', 'warning'); return; }
                    if (confirm(`سيتم فتح نافذة واتساب لـ ${selectedCheckboxes.length} مشترك. قد يمنع المتصفح بعض النوافذ.`)) {
                        selectedCheckboxes.forEach(checkbox => {
                            const phone = checkbox.dataset.phone;
                            this.openWhatsApp(phone, '');
                        });
                    }
                });

                // --- Print Buttons ---
                document.getElementById('print-activation-receipt-btn').addEventListener('click', () => this.printReceipt('activation'));
                document.getElementById('print-payment-receipt-btn').addEventListener('click', () => this.printReceipt('payment'));
                document.getElementById('subscriber-movements-table').addEventListener('click', async (e) => {
                    const printBtn = e.target.closest('.print-movement-btn');
                    if(printBtn) {
                        const movementId = parseInt(printBtn.dataset.movementId);
                        const movement = await this.DB.get('movements', movementId);
                        const subscriber = await this.DB.get('subscribers', movement.subscriberId);
                        this.printHistoricReceipt(movement, subscriber);
                    }
                });

                // --- PACKAGES ---
                document.getElementById('add-package-btn').addEventListener('click', () => {
                    document.getElementById('package-form').reset();
                    document.getElementById('package-id').value = '';
                    document.getElementById('package-modal-title').textContent = 'إضافة باقة جديدة';
                    document.getElementById('package-duration-type').dispatchEvent(new Event('change'));
                    this.UI.openModal('package-modal');
                });
                
                document.getElementById('package-duration-type').addEventListener('change', (e) => {
                    const durationValueLabel = document.getElementById('duration-value-label');
                    if (e.target.value === 'months') { durationValueLabel.textContent = 'عدد الأشهر'; } 
                    else { durationValueLabel.textContent = 'عدد الأيام'; }
                });

                document.getElementById('package-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const id = parseInt(document.getElementById('package-id').value);
                    const packageData = { name: document.getElementById('package-name').value, price: parseFloat(document.getElementById('package-price').value), cost: parseFloat(document.getElementById('package-cost').value), durationType: document.getElementById('package-duration-type').value, durationValue: parseInt(document.getElementById('package-duration-value').value), };
                    if (id) {
                        packageData.id = id;
                        await this.saveData('put', 'packages', packageData);
                        this.UI.showToast('تم تحديث الباقة بنجاح', 'success');
                    } else {
                        packageData.id = Date.now();
                        await this.saveData('add', 'packages', packageData);
                        this.UI.showToast('تمت إضافة الباقة بنجاح', 'success');
                    }
                    this.UI.closeModal('package-modal');
                    this.state.packages = await this.DB.getAll('packages');
                    this.Pages.Packages.render();
                });

                document.getElementById('packages-table').addEventListener('click', async (e) => {
                    const editBtn = e.target.closest('.edit-pkg-btn');
                    const deleteBtn = e.target.closest('.delete-pkg-btn');
                    if (editBtn) {
                        const pkgId = parseInt(editBtn.closest('tr').dataset.id);
                        const pkg = this.state.packages.find(p => p.id == pkgId);
                        document.getElementById('package-id').value = pkg.id;
                        document.getElementById('package-name').value = pkg.name;
                        document.getElementById('package-price').value = pkg.price;
                        document.getElementById('package-cost').value = pkg.cost;
                        document.getElementById('package-duration-type').value = pkg.durationType || 'days';
                        document.getElementById('package-duration-value').value = pkg.durationValue;
                        document.getElementById('package-modal-title').textContent = 'تعديل باقة';
                        document.getElementById('package-duration-type').dispatchEvent(new Event('change'));
                        this.UI.openModal('package-modal');
                    }
                    if (deleteBtn) {
                        if (confirm('هل أنت متأكد من حذف هذه الباقة؟')) {
                            const pkgId = parseInt(deleteBtn.closest('tr').dataset.id);
                            await this.saveData('delete', 'packages', pkgId);
                            this.UI.showToast('تم حذف الباقة', 'success');
                            this.state.packages = await this.DB.getAll('packages');
                            this.Pages.Packages.render();
                        }
                    }
                });
                
                // --- EXPENSES ---
                document.getElementById('add-expense-btn').addEventListener('click', () => {
                    document.getElementById('expense-form').reset();
                    document.getElementById('expense-id').value = '';
                    document.getElementById('expense-date').valueAsDate = new Date();
                    document.getElementById('expense-modal-title').textContent = 'إضافة مصروف جديد';
                    this.UI.openModal('expense-modal');
                });

                document.getElementById('expense-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const id = parseInt(document.getElementById('expense-id').value);
                    const expenseData = { description: document.getElementById('expense-description').value, amount: parseFloat(document.getElementById('expense-amount').value), date: document.getElementById('expense-date').value, };
                    if (id) {
                        expenseData.id = id;
                        await this.saveData('put', 'expenses', expenseData);
                        this.UI.showToast('تم تحديث المصروف بنجاح', 'success');
                    } else {
                        expenseData.id = Date.now();
                        await this.saveData('add', 'expenses', expenseData);
                        this.UI.showToast('تمت إضافة المصروف بنجاح', 'success');
                    }
                    this.UI.closeModal('expense-modal');
                    this.Pages.Expenses.render();
                });

                document.getElementById('expenses-table').addEventListener('click', async (e) => {
                    const editBtn = e.target.closest('.edit-exp-btn');
                    const deleteBtn = e.target.closest('.delete-exp-btn');
                    if (editBtn) {
                        const expId = parseInt(editBtn.closest('tr').dataset.id);
                        const exp = await this.DB.get('expenses', expId);
                        document.getElementById('expense-id').value = exp.id;
                        document.getElementById('expense-description').value = exp.description;
                        document.getElementById('expense-amount').value = exp.amount;
                        document.getElementById('expense-date').value = exp.date;
                        document.getElementById('expense-modal-title').textContent = 'تعديل مصروف';
                        this.UI.openModal('expense-modal');
                    }
                    if (deleteBtn) {
                        if (confirm('هل أنت متأكد من حذف هذا المصروف؟')) {
                            const expId = parseInt(deleteBtn.closest('tr').dataset.id);
                            await this.saveData('delete', 'expenses', expId);
                            this.UI.showToast('تم حذف المصروف', 'success');
                            this.Pages.Expenses.render();
                        }
                    }
                });

                // --- SETTINGS ---
                const saveSetting = async (key, value) => {
                    this.state.settings[key] = value;
                    await this.DB.put('settings', { key, value });
                };

                document.getElementById('company-profile-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const profile = { name: document.getElementById('company-name').value, logo: document.getElementById('company-logo').value, contact: document.getElementById('company-contact').value, whatsappCode: document.getElementById('whatsapp-code').value };
                    await saveSetting('companyProfile', profile);
                    this.UI.showToast('تم حفظ ملف الشركة', 'success');
                    this.UI.updateUIFromSettings();
                });

                document.getElementById('whatsapp-templates-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const templates = { activation: document.getElementById('activation-template').value, payment: document.getElementById('payment-template').value, reminder: document.getElementById('reminder-template').value, };
                    await saveSetting('whatsappTemplates', templates);
                    this.UI.showToast('تم حفظ قوالب واتساب', 'success');
                });
                
                document.getElementById('whatsapp-method-select').addEventListener('change', async (e) => {
                    const automation = { ...this.state.settings.automation, whatsappMethod: e.target.value };
                    await saveSetting('automation', automation);
                });
                document.getElementById('send-on-activation-toggle').addEventListener('change', async (e) => {
                    const automation = { ...this.state.settings.automation, sendOnActivation: e.target.checked };
                    await saveSetting('automation', automation);
                });
                document.getElementById('send-on-payment-toggle').addEventListener('change', async (e) => {
                    const automation = { ...this.state.settings.automation, sendOnPayment: e.target.checked };
                    await saveSetting('automation', automation);
                });

                document.getElementById('font-selector').addEventListener('change', async (e) => {
                    const newFont = e.target.value;
                    this.UI.applyFont(newFont);
                    await saveSetting('appFont', newFont);
                });
                
                document.getElementById('primary-color-picker').addEventListener('input', (e) => { this.UI.applyColor(e.target.value); });
                document.getElementById('primary-color-picker').addEventListener('change', async (e) => { await saveSetting('primaryColor', e.target.value); });
                
                document.getElementById('show-print-buttons-toggle').addEventListener('change', async (e) => {
                    const printSettings = { ...this.state.settings.printSettings, showReceiptButtons: e.target.checked };
                    await saveSetting('printSettings', printSettings);
                });
                
                document.getElementById('print-paper-size').addEventListener('change', async (e) => {
                    const newSize = e.target.value;
                    const customContainer = document.getElementById('custom-paper-size-container');
                    const printSettings = { ...this.state.settings.printSettings, paperSize: newSize };
                    if (newSize === 'custom') {
                        customContainer.style.display = 'block';
                        const customSize = parseInt(document.getElementById('custom-paper-size').value) || 80;
                        printSettings.customPaperSize = customSize;
                        this.UI.updatePrintStyles(newSize, customSize);
                    } else {
                        customContainer.style.display = 'none';
                        this.UI.updatePrintStyles(newSize);
                    }
                    await saveSetting('printSettings', printSettings);
                });
                
                document.getElementById('custom-paper-size').addEventListener('input', async (e) => {
                    const customSize = parseInt(e.target.value) || 80;
                    const printSettings = { ...this.state.settings.printSettings, customPaperSize: customSize };
                    this.UI.updatePrintStyles('custom', customSize);
                    await saveSetting('printSettings', printSettings);
                });

                // ISP Management
                document.getElementById('add-isp-btn').addEventListener('click', () => {
                    document.getElementById('isp-form').reset();
                    document.getElementById('isp-id').value = '';
                    document.getElementById('isp-modal-title').textContent = 'إضافة شركة تزويد';
                    this.UI.openModal('isp-modal');
                });

                document.getElementById('isps-table').addEventListener('click', async (e) => {
                    const editBtn = e.target.closest('.edit-isp-btn');
                    const deleteBtn = e.target.closest('.delete-isp-btn');
                    if (editBtn) {
                        const ispId = parseInt(editBtn.closest('tr').dataset.id);
                        const isp = this.state.settings.isps.find(i => i.id == ispId);
                        document.getElementById('isp-id').value = isp.id;
                        document.getElementById('isp-name').value = isp.name;
                        document.getElementById('isp-url').value = isp.url;
                        document.getElementById('isp-modal-title').textContent = 'تعديل شركة تزويد';
                        this.UI.openModal('isp-modal');
                    }
                    if (deleteBtn) {
                        if (confirm('هل أنت متأكد من حذف هذه الشركة؟')) {
                            const ispId = parseInt(deleteBtn.closest('tr').dataset.id);
                            this.state.settings.isps = this.state.settings.isps.filter(i => i.id != ispId);
                            await this.saveData('delete', 'isps', ispId);
                            this.UI.showToast('تم حذف الشركة', 'success');
                            this.Pages.Settings.renderIspList();
                            this.Pages.Settings.renderActiveIspSelector();
                        }
                    }
                });
                
                document.getElementById('isp-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const id = parseInt(document.getElementById('isp-id').value);
                    const ispData = { name: document.getElementById('isp-name').value, url: document.getElementById('isp-url').value };
                    if (id) {
                        ispData.id = id;
                        await this.saveData('put', 'isps', ispData);
                        this.UI.showToast('تم تحديث الشركة بنجاح', 'success');
                    } else {
                        ispData.id = Date.now();
                        await this.saveData('add', 'isps', ispData);
                        this.UI.showToast('تمت إضافة الشركة بنجاح', 'success');
                    }
                    this.UI.closeModal('isp-modal');
                    this.state.settings.isps = await this.DB.getAll('isps');
                    this.Pages.Settings.renderIspList();
                    this.Pages.Settings.renderActiveIspSelector();
                });
                
                document.getElementById('active-isp-selector').addEventListener('change', async (e) => {
                    const ispId = parseInt(e.target.value) || null;
                    await saveSetting('activeIspId', ispId);
                    this.UI.showToast('تم تحديد الشركة الفعالة', 'success');
                });

                // --- GOOGLE SHEET SETTINGS ---
                document.getElementById('google-sheet-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const url = document.getElementById('google-sheet-url').value.trim();
                    if (url) {
                        localStorage.setItem('gSheetApiUrl', url);
                        App.gSheetApiUrl = url;
                        this.UI.showToast('تم حفظ رابط Google Sheet بنجاح.', 'success');
                    } else {
                        this.UI.showToast('الرجاء إدخال رابط صحيح.', 'error');
                    }
                });

                document.getElementById('upload-to-sheet-btn').addEventListener('click', () => this.uploadAllDataToSheet());
                document.getElementById('download-from-sheet-btn').addEventListener('click', () => this.downloadAllDataFromSheet());

                // --- ADVANCED SYNC SETTINGS ---
                document.getElementById('show-fab-toggle').addEventListener('change', async (e) => {
                    const syncSettings = { ...this.state.settings.syncSettings, showUploadFab: e.target.checked };
                    await saveSetting('syncSettings', syncSettings);
                    this.UI.toggleFab(e.target.checked);
                });
                document.getElementById('auto-upload-toggle').addEventListener('change', async (e) => {
                    const syncSettings = { ...this.state.settings.syncSettings, autoUploadOnIdle: e.target.checked };
                    await saveSetting('syncSettings', syncSettings);
                    this.resetIdleTimer();
                });
                document.getElementById('fab-upload-btn').addEventListener('click', () => this.uploadAllDataToSheet());

                // Data Export/Import
                document.getElementById('export-data-btn').addEventListener('click', () => this.exportData());
                document.getElementById('import-data-btn').addEventListener('click', () => document.getElementById('import-file-input').click());
                document.getElementById('import-file-input').addEventListener('change', (e) => this.importData(e));
                
                // Table Export Buttons
                document.getElementById('export-subs-xlsx').addEventListener('click', () => this.exportTableToExcel('subscribers-table', 'subscribers'));
                document.getElementById('export-subs-csv').addEventListener('click', () => this.exportTableToCsv('subscribers-table', 'subscribers'));
                document.getElementById('export-moves-xlsx').addEventListener('click', () => this.exportTableToExcel('movements-table', 'movements'));
                document.getElementById('export-moves-csv').addEventListener('click', () => this.exportTableToCsv('movements-table', 'movements'));

                // --- User Profile Modal Listeners ---
                document.getElementById('user-profile-widget').addEventListener('click', () => {
                    const user = App.state.currentUser;
                    document.getElementById('profile-name').value = user.name;
                    document.getElementById('profile-email').value = user.email;
                    document.getElementById('profile-photo-link').value = user.photoLink || '';
                    document.getElementById('change-password-form').reset();
                    document.querySelector('#user-profile-modal .tab-link[data-tab="profile-edit"]').click();
                    App.UI.openModal('user-profile-modal');
                });

                document.querySelector('#user-profile-modal .modal-tabs').addEventListener('click', (e) => {
                    if (e.target.classList.contains('tab-link')) {
                        const tabId = e.target.dataset.tab;
                        document.querySelectorAll('#user-profile-modal .tab-link').forEach(tab => tab.classList.remove('active'));
                        document.querySelectorAll('#user-profile-modal .tab-content').forEach(content => content.classList.remove('active'));
                        e.target.classList.add('active');
                        document.getElementById(`${tabId}-tab`).classList.add('active');
                    }
                });

                document.getElementById('update-profile-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    App.UI.showLoader();
                    try {
                        const body = { action: 'updateProfile', username: App.state.currentUser.username, name: document.getElementById('profile-name').value, email: document.getElementById('profile-email').value };
                        const result = await App.GSheet.post(body);
                        App.state.currentUser.name = body.name;
                        App.state.currentUser.email = body.email;
                        localStorage.setItem('loggedInUser', JSON.stringify(App.state.currentUser));
                        App.UI.displayUserProfile();
                        App.UI.showToast(result.message, 'success');
                    } catch (error) {
                        App.UI.showToast(`فشل تحديث الملف: ${error.message}`, 'error');
                    } finally {
                        App.UI.hideLoader();
                    }
                });

                document.getElementById('update-photo-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    App.UI.showLoader();
                    try {
                        const body = { action: 'updatePhoto', username: App.state.currentUser.username, photoLink: document.getElementById('profile-photo-link').value };
                        const result = await App.GSheet.post(body);
                        App.state.currentUser.photoLink = body.photoLink;
                        localStorage.setItem('loggedInUser', JSON.stringify(App.state.currentUser));
                        App.UI.displayUserProfile();
                        App.UI.showToast(result.message, 'success');
                    } catch (error) {
                        App.UI.showToast(`فشل تحديث الصورة: ${error.message}`, 'error');
                    } finally {
                        App.UI.hideLoader();
                    }
                });

                document.getElementById('change-password-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    App.UI.showLoader();
                    try {
                        const body = { action: 'changePassword', username: App.state.currentUser.username, currentPassword: document.getElementById('current-password').value, newPassword: document.getElementById('new-password').value };
                        const result = await App.GSheet.post(body);
                        App.UI.showToast(result.message, 'success');
                        document.getElementById('change-password-form').reset();
                    } catch (error) {
                        App.UI.showToast(`فشل تغيير كلمة المرور: ${error.message}`, 'error');
                    } finally {
                        App.UI.hideLoader();
                    }
                });

                document.getElementById('logout-btn').addEventListener('click', async () => {
                    if (!confirm('هل أنت متأكد من رغبتك في تسجيل الخروج؟')) return;
                    App.UI.showLoader();
                    try {
                        const deviceId = localStorage.getItem('deviceId');
                        const body = { action: 'logout', username: App.state.currentUser.username, deviceId: deviceId };
                        await App.GSheet.post(body);
                    } catch (error) {
                        console.warn("Logout API call failed, but proceeding with local logout:", error.message);
                    } finally {
                        localStorage.removeItem('isLoggedIn');
                        localStorage.removeItem('loggedInUser');
                        localStorage.removeItem('deviceId');
                        App.UI.showToast('تم تسجيل الخروج بنجاح.', 'info');
                        window.location.href = 'login.html';
                    }
                });
            },
            
            openWhatsApp(phone, message) {
                const cleanPhone = phone.replace(/^0/, '');
                const fullPhone = `${this.state.settings.companyProfile.whatsappCode}${cleanPhone}`;
                const encodedMessage = encodeURIComponent(message);
                let url;
                if (this.state.settings.automation.whatsappMethod === 'web') {
                    url = `https://web.whatsapp.com/send?phone=${fullPhone}&text=${encodedMessage}`;
                } else {
                    url = `https://wa.me/${fullPhone}?text=${encodedMessage}`;
                }
                window.open(url, '_blank');
            },

            async uploadAllDataToSheet(silent = false) {
                if (!this.gSheetApiUrl) {
                    if (!silent) this.UI.showToast('الرجاء حفظ رابط Google Sheet أولاً في الإعدادات.', 'error');
                    return;
                }
                if (!silent && !confirm('سيؤدي هذا إلى رفع جميع البيانات المحلية إلى الشيت. قد يتم استبدال البيانات الموجودة هناك. هل أنت متأكد؟')) {
                    return;
                }

                if (!silent) this.UI.showLoader();
                try {
                    const storesToUpload = ['subscribers', 'packages', 'movements', 'expenses', 'isps', 'settings'];
                    let totalItems = 0;
                    let uploadedItems = 0;

                    for (const storeName of storesToUpload) {
                        let localData = await this.DB.getAll(storeName);
                        if (storeName === 'settings') { localData = localData.filter(setting => setting.key !== 'appFont'); }
                        totalItems += localData.length;
                        await Promise.all(localData.map(item => {
                            return this.GSheetDB.put(storeName, item).then(() => { uploadedItems++; });
                        }));
                    }
                    if (!silent) { this.UI.showToast(`اكتمل الرفع بنجاح! تم مزامنة ${uploadedItems} من أصل ${totalItems} عنصر.`, 'success'); } 
                    else { console.log(`Auto-sync complete: ${uploadedItems}/${totalItems} items.`); }
                } catch (error) {
                    if (!silent) this.UI.showToast(`فشل رفع البيانات: ${error.message}`, 'error');
                    else console.error("Auto-sync failed:", error.message);
                } finally {
                    if (!silent) this.UI.hideLoader();
                    this.resetIdleTimer();
                }
            },

            async downloadAllDataFromSheet() {
                if (!this.gSheetApiUrl) { this.UI.showToast('الرجاء حفظ رابط Google Sheet أولاً في الإعدادات.', 'error'); return; }
                if (!confirm('تحذير! سيتم استبدال جميع بياناتك المحلية الحالية بالبيانات الموجودة في الشيت. لا يمكن التراجع عن هذا الإجراء. هل أنت متأكد؟')) { return; }

                this.UI.showLoader();
                try {
                    const sheetData = await this.GSheet.getAllData();
                    const storesToSync = ['subscribers', 'packages', 'movements', 'expenses', 'isps', 'settings'];
                    const transaction = this.db.transaction(storesToSync, 'readwrite');

                    for (const storeName of storesToSync) {
                        const store = transaction.objectStore(storeName);
                        await new Promise((resolve, reject) => { const req = store.clear(); req.onsuccess = resolve; req.onerror = reject; });
                        if (sheetData[storeName]) {
                            for(const record of sheetData[storeName]) {
                                if (storeName === 'settings' && record.key === 'appFont') continue;
                                await new Promise((resolve, reject) => { const req = store.put(record); req.onsuccess = resolve; req.onerror = reject; });
                            }
                        }
                    }
                    this.UI.showToast('تم جلب البيانات بنجاح! سيتم إعادة تحميل التطبيق.', 'success');
                    setTimeout(() => window.location.reload(), 2000);
                } catch (error) {
                    this.UI.showToast(`فشل جلب البيانات: ${error.message}`, 'error');
                } finally {
                    this.UI.hideLoader();
                }
            },
            
            getSubscriberIsp(subscriber) {
                const ispId = subscriber.ispId || this.state.settings.activeIspId;
                if (!ispId) return null;
                return this.state.settings.isps.find(i => i.id == ispId);
            },

            async printHistoricReceipt(movement, subscriber) {
                 const profile = this.state.settings.companyProfile;
                 let receiptTitle = movement.type === 'activation' ? 'وصل تفعيل (نسخة)' : 'وصل تسديد (نسخة)';
                 let movementData = {};
                 if (movement.type === 'activation') {
                     movementData = { details: `تفعيل باقة: ${movement.packageName}`, subtotal: Number(movement.amount), paid: Number(movement.paidAmount), startDate: new Date(movement.startDate), endDate: new Date(movement.endDate) };
                 } else {
                     movementData = { details: 'تسديد دفعة من الحساب', subtotal: Number(movement.amount), paid: Number(movement.amount) };
                 }
                 const receiptHTML = `
                    <div class="receipt-container">
                        <img src="${profile.logo}" alt="شعار" style="max-width: 120px; max-height: 60px;"><h3>${profile.name}</h3><p class="contact-info">${profile.contact}</p><hr><h4>${receiptTitle}</h4>
                        <div class="details-section"><p><strong>تاريخ العملية:</strong> ${this.UI.formatNumericDateTime(movement.timestamp)}</p><p><strong>المشترك:</strong> ${subscriber.name}</p></div><hr>
                        <table class="items-table"><thead><tr><th style="text-align: right; padding: 5px;">الوصف</th><th style="text-align: left; padding: 5px;">المبلغ</th></tr></thead><tbody><tr><td style="text-align: right; padding: 5px;">${movementData.details}</td><td style="text-align: left; padding: 5px;">${movementData.paid.toLocaleString()}</td></tr></tbody></table>
                        ${movement.type === 'activation' ? `<hr><div class="details-section" style="font-size: 0.9em;"><p><strong>يبدأ من:</strong> ${this.UI.formatNumericDateTime(movementData.startDate)}</p><p><strong>ينتهي في:</strong> ${this.UI.formatNumericDateTime(movementData.endDate)}</p></div>` : ''}
                        <div class="footer-notes">شكراً لتعاملكم معنا</div><div class="copyright-footer">Powered by DashNET</div></div>`;
                this.printHTML(receiptHTML);
            },
            
            async printReceipt(type) {
                const subId = this.state.currentSubscriberId;
                const sub = await this.DB.get('subscribers', subId);
                const profile = this.state.settings.companyProfile;
                let movementData, receiptTitle, newDebt;

                if (type === 'activation') {
                    const pkgId = parseInt(document.getElementById('activation-package').value);
                    const pkg = this.state.packages.find(p => p.id == pkgId);
                    if (!pkg) { this.UI.showToast('الرجاء اختيار باقة أولاً', 'error'); return; }
                    const amountPaid = parseFloat(document.getElementById('activation-amount-paid').value) || 0;
                    const startDate = new Date(document.getElementById('activation-start-date').value);
                    const endDate = new Date(document.getElementById('activation-end-date').value);
                    newDebt = (Number(sub.debt) || 0) + Number(pkg.price) - amountPaid;
                    receiptTitle = 'وصل تفعيل';
                    movementData = { details: `تفعيل باقة: ${pkg.name}`, subtotal: Number(pkg.price), paid: amountPaid, previousDebt: Number(sub.debt) || 0, total: (Number(sub.debt) || 0) + Number(pkg.price), remaining: newDebt, startDate, endDate };
                } else {
                    const amount = parseFloat(document.getElementById('payment-amount').value);
                    if (!amount || amount <= 0) { this.UI.showToast('الرجاء إدخال مبلغ صحيح للطباعة', 'error'); return; }
                    newDebt = (Number(sub.debt) || 0) - amount;
                    receiptTitle = 'وصل تسديد';
                    movementData = { details: 'تسديد دفعة من الحساب', subtotal: amount, paid: amount, previousDebt: Number(sub.debt) || 0, total: Number(sub.debt) || 0, remaining: newDebt };
                }

                const receiptHTML = `
                    <div class="receipt-container">
                        <img src="${profile.logo}" alt="شعار" style="max-width: 120px; max-height: 60px;"><h3>${profile.name}</h3><p class="contact-info">${profile.contact}</p><hr><h4>${receiptTitle}</h4>
                        <div class="details-section"><p><strong>التاريخ:</strong> ${this.UI.formatNumericDateTime(new Date())}</p><p><strong>المشترك:</strong> ${sub.name}</p>${sub.username ? `<p><strong>اليوزر:</strong> ${sub.username}</p>` : ''}</div><hr>
                        <table class="items-table"><thead><tr><th>الوصف</th><th>المبلغ</th></tr></thead><tbody><tr><td>${movementData.details}</td><td>${movementData.subtotal.toLocaleString()}</td></tr></tbody></table><hr>
                        <div class="summary-section"><p><span>الدين السابق:</span> <span>${movementData.previousDebt.toLocaleString()}</span></p><p><span>المبلغ الإجمالي:</span> <span>${movementData.total.toLocaleString()}</span></p><p><span>المبلغ الواصل:</span> <span>${movementData.paid.toLocaleString()}</span></p><p class="total"><span>الرصيد المتبقي:</span> <span>${movementData.remaining.toLocaleString()}</span></p></div>
                        ${type === 'activation' ? `<hr><div class="details-section" style="font-size: 0.9em;"><p><strong>يبدأ من:</strong> ${this.UI.formatNumericDateTime(movementData.startDate)}</p><p><strong>ينتهي في:</strong> ${this.UI.formatNumericDateTime(movementData.endDate)}</p></div>` : ''}
                        <div class="footer-notes">شكراً لتعاملكم معنا</div><div class="copyright-footer">Powered by DashNET</div></div>`;
                this.printHTML(receiptHTML);
            },
            
            printHTML(htmlContent) {
                const receiptStyle = `<style>.receipt-container{font-family:'Cairo',sans-serif;text-align:center;direction:rtl;color:#000;padding:10px}.receipt-container img{max-width:120px;max-height:60px;margin-bottom:10px}.receipt-container h3{margin:0;font-size:1.4em;font-weight:700}.receipt-container .contact-info{margin:2px 0;font-size:1em}.receipt-container hr{border:none;border-top:1px dashed #000;margin:10px 0}.receipt-container h4{margin:0 0 10px;font-size:1.3em;font-weight:700}.receipt-container .details-section{text-align:right;font-size:1em}.receipt-container .details-section p{margin:4px 0}.receipt-container .items-table{width:100%;border-collapse:collapse;font-size:1em}.receipt-container .items-table th,.receipt-container .items-table td{text-align:right;padding:5px;border-bottom:1px solid #eee}.receipt-container .items-table th:last-child,.receipt-container .items-table td:last-child{text-align:left}.receipt-container .items-table thead tr{border-bottom:1px solid #000}.receipt-container .summary-section{text-align:right;font-size:1em}.receipt-container .summary-section p{margin:4px 0;display:flex;justify-content:space-between}.receipt-container .summary-section p.total{font-weight:700;font-size:1.1em;border-top:1px solid #000;padding-top:5px;margin-top:5px}.receipt-container .footer-notes{margin-top:20px;font-size:.9em}.copyright-footer{margin-top:15px;font-size:.8em;color:#555}</style>`;
                const printFrame = document.createElement('iframe');
                printFrame.style.position = 'absolute'; printFrame.style.width = '0'; printFrame.style.height = '0'; printFrame.style.border = '0';
                document.body.appendChild(printFrame);
                const frameDoc = printFrame.contentWindow.document;
                frameDoc.open();
                frameDoc.write(`<html><head><title>طباعة وصل</title>${receiptStyle}<style>@import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap');${document.getElementById('print-style-sheet').innerHTML}body{margin:0;font-family:'Cairo',sans-serif}</style></head><body>${htmlContent}</body></html>`);
                frameDoc.close();
                setTimeout(() => {
                    printFrame.contentWindow.focus();
                    printFrame.contentWindow.print();
                    document.body.removeChild(printFrame);
                }, 500);
            },

            // --- Data Management ---
            async exportData() {
                this.UI.showLoader();
                try {
                    const data = {};
                    const stores = this.db.objectStoreNames;
                    for (const storeName of stores) { data[storeName] = await this.DB.getAll(storeName); }
                    const jsonString = JSON.stringify(data, null, 2);
                    const blob = new Blob([jsonString], {type: 'application/json'});
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `isp-manager-backup-${new Date().toISOString().slice(0,10)}.json`;
                    a.click();
                    URL.revokeObjectURL(url);
                    this.UI.showToast('تم تصدير البيانات المحلية بنجاح', 'success');
                } catch (error) {
                    console.error('Export failed:', error);
                    this.UI.showToast('فشل تصدير البيانات', 'error');
                } finally { this.UI.hideLoader(); }
            },

            importData(event) {
                const file = event.target.files[0];
                if (!file) return;
                if (!confirm('سيؤدي هذا إلى الكتابة فوق جميع البيانات المحلية الحالية. هل أنت متأكد؟')) { event.target.value = ''; return; }
                const reader = new FileReader();
                reader.onload = async (e) => {
                    this.UI.showLoader();
                    try {
                        const data = JSON.parse(e.target.result);
                        const transaction = this.db.transaction(this.db.objectStoreNames, 'readwrite');
                        for (const storeName in data) {
                            if (this.db.objectStoreNames.contains(storeName)) {
                                const store = transaction.objectStore(storeName);
                                await new Promise((resolve, reject) => { const req = store.clear(); req.onsuccess = resolve; req.onerror = reject; });
                                for(const record of data[storeName]) { await new Promise((resolve, reject) => { const req = store.put(record); req.onsuccess = resolve; req.onerror = reject; }); }
                            }
                        }
                        this.UI.showToast('تم استيراد البيانات بنجاح. سيتم إعادة تحميل التطبيق.', 'success');
                        setTimeout(() => window.location.reload(), 2000);
                    } catch (error) {
                        console.error('Import failed:', error);
                        this.UI.showToast('فشل استيراد البيانات. تأكد من أن الملف صحيح.', 'error');
                        this.UI.hideLoader();
                    } finally { event.target.value = ''; }
                };
                reader.readAsText(file);
            },
            
            // --- EXPORT HELPERS ---
            exportTableToExcel(tableId, fileName) {
                const table = document.getElementById(tableId);
                if (!table) { this.UI.showToast('الجدول غير موجود', 'error'); return; }
                const wb = XLSX.utils.table_to_book(table, { sheet: "Sheet1" });
                XLSX.writeFile(wb, `${fileName}.xlsx`);
                this.UI.showToast('تم التصدير إلى Excel بنجاح', 'success');
            },
            exportTableToCsv(tableId, fileName) {
                const table = document.getElementById(tableId);
                if (!table) { this.UI.showToast('الجدول غير موجود', 'error'); return; }
                const ws = XLSX.utils.table_to_sheet(table);
                const csv = XLSX.utils.sheet_to_csv(ws);
                const blob = new Blob([`\uFEFF${csv}`], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = `${fileName}.csv`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                this.UI.showToast('تم التصدير إلى CSV بنجاح', 'success');
            }

        };

        App.init();
    });
    </script>
</body>
</html>
