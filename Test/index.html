<!DOCTYPE html>
<html>
<head>
    <title>دمج بيانات العملاء</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        table {
            border-collapse: collapse;
            width: 100%;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        .expired {
            background-color: #ffe0e0; /* أحمر فاتح */
        }
        .warning {
            background-color: #e0ffe0; /* أخضر فاتح */
        }
    </style>
</head>
<body>
    <h1>دمج بيانات العملاء</h1>
    <input type="file" id="xlsxFile" accept=".xlsx" style="display: none;">
    <input type="file" id="csvFile" accept=".csv" style="display: none;">
    <button onclick="تحميل_الملف()">تحميل الملف (XLSX)</button>
    <div id="result"></div>

    <script>
        let mergedData = []; // متغير لتخزين البيانات المدمجة

        async function دمج_البيانات(xlsxFile, csvFile) {
            if (!xlsxFile || !csvFile) {
                alert('الرجاء التأكد من وجود ملفي XLSX و CSV في نفس المجلد.');
                return;
            }

            const xlsxData = await readXlsx(xlsxFile);
            const csvData = await readCsv(csvFile);

            mergedData = mergeData(xlsxData, csvData); // تخزين البيانات المدمجة
            displayResult(mergedData);
        }

        async function readXlsx(file) {
            const data = await file.arrayBuffer();
            const workbook = XLSX.read(data, { type: 'array' });
            const sheetName = workbook.SheetNames[0];
            const sheet = workbook.Sheets[sheetName];
            return XLSX.utils.sheet_to_json(sheet);
        }

        async function readCsv(file) {
            const text = await file.text();
            return Papa.parse(text, { header: true }).data;
        }

        function mergeData(xlsxData, csvData) {
            const csvMap = {};
            csvData.forEach(row => {
                const customerId = row['Customer ID'];
                if (!csvMap[customerId] || isNewer(row, csvMap[customerId])) {
                    csvMap[customerId] = row;
                }
            });

            return xlsxData.map(xlsxRow => {
                const csvRow = csvMap[xlsxRow.id];
                if (csvRow) {
                    const date = new Date(csvRow.Date);
                    const hours = date.getHours() % 12 || 12;
                    const minutes = date.getMinutes();
                    const seconds = date.getSeconds();
                    const ampm = date.getHours() >= 12 ? 'مساءً' : 'صباحًا';

                    const endDate = new Date(csvRow['End Date'].split('/').reverse().join('-'));
                    const now = new Date();
                    const oneWeekFromNow = new Date();
                    oneWeekFromNow.setDate(oneWeekFromNow.getDate() + 7);

                    return {
                        ...xlsxRow,
                        'Start Date': csvRow['Start Date'],
                        'End Date': csvRow['End Date'],
                        'Date': `${hours}:${minutes}:${seconds} ${ampm}`,
                        'Plan Name': csvRow['Plan Name'],
                        'Status': endDate < now ? 'منتهي الصلاحية' : 'فعال',
                        'endDateObj': endDate,
                        'startDateObj': new Date(csvRow['Start Date'].split('/').reverse().join('-'))
                    };
                }
                return xlsxRow;
            });
        }

        function isNewer(row1, row2) {
            const date1 = new Date(row1['End Date'].split('/').reverse().join('-'));
            const date2 = new Date(row2['End Date'].split('/').reverse().join('-'));
            return date1 > date2;
        }

        function displayResult(data) {
            const resultDiv = document.getElementById('result');
            let tableHtml = '<table><tr><th>name</th><th>phone</th><th>id</th><th>email</th><th>createdAt</th><th>zone</th><th>address</th><th>contractor</th><th>deviceDetails</th><th>ontSerial</th><th>Start Date</th><th>End Date</th><th>Date</th><th>Plan Name</th><th>Status</th></tr>';

            data.forEach(row => {
                const isExpired = row.endDateObj < new Date();
                const startDate = row.startDateObj;
                const now = new Date();
                const oneWeekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000); // أسبوع مضى

                const isWarning = startDate >= oneWeekAgo && startDate <= now;

                let planName = row['Plan Name'];
                let status = row.Status;

                if(planName !== 'FIBER 35' && planName !== 'FIBER 50' && planName !== 'FIBER 75' && planName !== 'FIBER 150'){
                  planName = '';
                }

                if (isWarning) {
                  status = 'فعال هذا الأسبوع';
                }

                tableHtml += `<tr class="${isExpired ? 'expired' : isWarning ? 'warning' : ''}">`;
                tableHtml += `<td>${row.name || ''}</td><td>${row.phone || ''}</td><td>${row.id || ''}</td><td>${row.email || ''}</td><td>${row.createdAt || ''}</td><td>${row.zone || ''}</td><td>${row.address || ''}</td><td>${row.contractor || ''}</td><td>${row.deviceDetails || ''}</td><td>${row.ontSerial || ''}</td><td>${row['Start Date'] || ''}</td><td>${row['End Date'] || ''}</td><td>${row.Date || ''}</td><td>${planName || ''}</td><td>${status || ''}</td>`;
                tableHtml += '</tr>';
            });

            tableHtml += '</table>';
            resultDiv.innerHTML = tableHtml;
        }

        function تحميل_الملف() {
            if (mergedData.length === 0) {
                alert('الرجاء دمج البيانات أولاً.');
                return;
            }

            // حذف الأعمدة الزائدة
            const filteredData = mergedData.map(row => {
                const { endDateObj, startDateObj, ...rest } = row;
                return rest;
            });

            const ws = XLSX.utils.json_to_sheet(filteredData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Merged Data');

            // إضافة الألوان إلى ورقة العمل
            filteredData.forEach((row, index) => {
                const cellRef = XLSX.utils.encode_cell({ c: 0, r: index + 1 }); // +1 لتجنب تلوين الرأس
                const isExpired = mergedData[index].endDateObj < new Date();
                const startDate = mergedData[index].startDateObj;
                const now = new Date();
                const oneWeekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                const isWarning = startDate >= oneWeekAgo && startDate <= now;

                if (isExpired) {
                    ws[cellRef].s = { fill: { fgColor: { rgb: 'FFE0E0' } } }; // أحمر فاتح
                } else if (isWarning) {
                    ws[cellRef].s = { fill: { fgColor: { rgb: 'E0FFE0' } } }; // أخضر فاتح
                }
            });

            XLSX.writeFile(wb, 'merged_data.xlsx');
        }

        // تحديد الملفات ودمج البيانات تلقائيًا عند تحميل الصفحة
        window.onload = async function() {
            try {
                const xlsxResponse = await fetch('all_customers.xlsx');
                const xlsxBlob = await xlsxResponse.blob();
                const xlsxFile = new File([xlsxBlob], 'all_customers.xlsx');

                const csvResponse = await fetch('partner.csv');
                const csvBlob = await csvResponse.blob();
                const csvFile = new File([csvBlob], 'partner.csv');

                if (xlsxFile && csvFile) {
                    await دمج_البيانات(xlsxFile, csvFile);
                }
            } catch (error) {
                console.error('Error loading files:', error);
                alert('Error loading files. Please ensure the files are in the same directory and try again.');
            }
        };
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
</body>
</html>