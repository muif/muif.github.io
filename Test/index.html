<!DOCTYPE html>
<html>
<head>
    <title>دمج بيانات العملاء</title>
    <style>
        // ... (أنماط CSS)
    </style>
</head>
<body>
    // ... (HTML)

    <script>
        let mergedData = []; // متغير لتخزين البيانات المدمجة

        // تعريف دالة readXlsx قبل استدعائها
        async function readXlsx(file) {
            console.log('readXlsx file:', file);
            const data = await file.arrayBuffer();
            console.log('readXlsx data:', data);
            const workbook = XLSX.read(data, { type: 'array' });
            console.log('readXlsx workbook:', workbook);
            const sheetName = workbook.SheetNames[0];
            const sheet = workbook.Sheets[sheetName];
            console.log('readXlsx sheet:', sheet);
            return XLSX.utils.sheet_to_json(sheet);
        }

        // تعريف دالة mergeData قبل استدعائها
        function mergeData(xlsxData, csvData) {
            // ... (بقية الكود)
        }

        async function دمج_البيانات(xlsxFile, csvFile) {
            if (!xlsxFile || !csvFile) {
                alert('الرجاء التأكد من وجود ملفي XLSX و CSV في نفس المجلد.');
                return;
            }

            const xlsxData = await readXlsx(xlsxFile);
            const csvData = await readCsv(csvFile);

            mergedData = mergeData(xlsxData, csvData); // تخزين البيانات المدمجة
            displayResult(mergedData);
        }

        // ... (بقية الدوال)

        window.onload = async function() {
            try {
                const xlsxResponse = await fetch('all_customers.xlsx');
                const xlsxBlob = await xlsxResponse.blob();
                const xlsxFile = new File([xlsxBlob], 'all_customers.xlsx');

                const csvResponse = await fetch('partner.csv');
                const csvBlob = await csvResponse.blob();
                const csvFile = new File([csvBlob], 'partner.csv');

                console.log('xlsxFile:', xlsxFile);
                console.log('csvFile:', csvFile);

                if (xlsxFile && csvFile) {
                    await دمج_البيانات(xlsxFile, csvFile);
                }
            } catch (error) {
                console.error('Error loading files:', error);
                alert('Error loading files. Please ensure the files are in the same directory and try again.');
            }
        };
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
</body>
</html>
