<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„ØªØ§Ø¬Ø± - FastDelivery</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* Seller Specific Layout */
        .seller-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .grid-layout {
            display: grid;
            grid-template-columns: 1fr 2fr; /* 1/3 for form, 2/3 for table */
            gap: 20px;
        }

        @media (max-width: 768px) {
            .grid-layout { grid-template-columns: 1fr; }
        }

        .stat-box {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 20px;
            border-radius: var(--radius);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .stat-box.warning {
            background: linear-gradient(135deg, #f7971e, #ffd200);
        }
    </style>
</head>
<body>

    <nav class="topbar" style="margin: 20px; justify-content: space-between;">
        <div class="brand" style="margin: 0;">ğŸš€ FastDelivery <span style="font-size: 0.8rem; opacity: 0.7;">| Ø§Ù„ØªØ§Ø¬Ø±</span></div>
        <div style="display: flex; gap: 15px; align-items: center;">
            <span id="sellerName" style="font-weight: bold;">...</span>
            <button class="btn btn-sm btn-danger" onclick="Auth.logout()">Ø®Ø±ÙˆØ¬</button>
        </div>
    </nav>

    <div class="seller-container">
        
        <div class="grid-layout" style="margin-bottom: 0; grid-template-columns: 1fr 1fr; display: flex; gap: 20px;">
            <div class="stat-box" style="flex: 1;">
                <div>
                    <h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</h3>
                    <small>Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©</small>
                </div>
                <h2 id="totalSales">0 IQD</h2>
            </div>
            <div class="stat-box warning" style="flex: 1;">
                <div>
                    <h3>Ø·Ù„Ø¨Ø§Øª Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°</h3>
                    <small>Ø¬Ø¯ÙŠØ¯ / Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙˆØµÙŠÙ„</small>
                </div>
                <h2 id="pendingCount">0</h2>
            </div>
        </div>

        <div class="grid-layout" style="margin-top: 20px;">
            
            <div class="card" style="height: fit-content;">
                <div class="card-title">ğŸ“ Ø¥Ø¶Ø§ÙØ© Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</div>
                <form id="createOrderForm">
                    <div class="form-group">
                        <label>Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
                        <input type="text" name="customer_name" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
                        <input type="tel" name="customer_phone" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙƒØ§Ù…Ù„</label>
                        <input type="text" name="customer_address" class="form-control" placeholder="Ø§Ù„Ù…Ù†Ø·Ù‚Ø© - Ø£Ù‚Ø±Ø¨ Ù†Ù‚Ø·Ø© Ø¯Ø§Ù„Ø©" required>
                    </div>
                    <div class="form-group">
                        <label>Ù…Ø¨Ù„Øº Ø§Ù„Ø·Ù„Ø¨ (Ù…Ø¹ Ø§Ù„ØªÙˆØµÙŠÙ„)</label>
                        <input type="number" name="amount" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨</label>
                        <textarea name="order_details" class="form-control" rows="3" placeholder="Ù…Ø­ØªÙˆÙŠØ§Øª Ø§Ù„Ø·Ù„Ø¨..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù„Ù„Ù…Ù†Ø¯ÙˆØ¨</label>
                        <input type="text" name="notes" class="form-control">
                    </div>

                    <button type="submit" class="btn btn-primary" style="width: 100%;">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨</button>
                </form>
            </div>

            <div class="card">
                <div class="card-title">
                    ğŸ“¦ Ø·Ù„Ø¨Ø§ØªÙŠ Ø§Ù„Ø£Ø®ÙŠØ±Ø©
                    <button class="btn btn-sm btn-primary" onclick="loadSellerData()">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>
                </div>
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                <th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                                <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                                <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                            </tr>
                        </thead>
                        <tbody id="ordersTableBody">
                            <tr><td colspan="5" style="text-align:center;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

        </div>
    </div>

    <script src="app.js"></script>
    <script>
        // 1. Security Check & Init
        window.addEventListener('DOMContentLoaded', () => {
            if (!Auth.checkRole('seller')) return;
            
            const user = Auth.getUser();
            document.getElementById('sellerName').innerText = user.full_name;

            // Load Data
            loadSellerData();
        });

        // 2. Load Data Function
        async function loadSellerData() {
            try {
                const user = Auth.getUser();
                const orders = await Api.post('getOrders', {
                    role: 'seller',
                    username: user.username
                });

                renderStats(orders);
                renderTable(orders);

            } catch (error) {
                console.error(error);
            }
        }

        // 3. Render Stats
        function renderStats(orders) {
            // Calculate Total Sales (Only Delivered)
            const sales = orders
                .filter(o => o.status === 'Delivered')
                .reduce((sum, o) => sum + Number(o.amount), 0);
            
            document.getElementById('totalSales').innerText = sales.toLocaleString() + " IQD";

            // Calculate Pending (New + Assigned + PickedUp)
            const pending = orders.filter(o => ['New', 'Assigned', 'PickedUp'].includes(o.status)).length;
            document.getElementById('pendingCount').innerText = pending;
        }

        // 4. Render Table
        function renderTable(orders) {
            const tbody = document.getElementById('ordersTableBody');
            tbody.innerHTML = '';

            if (orders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†</td></tr>';
                return;
            }

            // Show only last 20 orders to keep it clean
            orders.slice(0, 20).forEach(o => {
                const tr = `
                    <tr>
                        <td><b>${o.order_id.split('-')[1]}</b></td>
                        <td>${new Date(o.date_time).toLocaleDateString()}</td>
                        <td>${o.customer_name}<br><small>${o.customer_phone}</small></td>
                        <td>${Number(o.amount).toLocaleString()}</td>
                        <td><span class="badge badge-${o.status}">${translateStatus(o.status)}</span></td>
                    </tr>
                `;
                tbody.innerHTML += tr;
            });
        }

        // 5. Handle Form Submit
        document.getElementById('createOrderForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const user = Auth.getUser();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());

            // Add seller identity
            data.seller_username = user.username;

            try {
                await Api.post('addOrder', data);
                UI.showToast("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­", "success");
                e.target.reset(); // Clear form
                loadSellerData(); // Refresh list
            } catch (err) {
                // Error handled by Api class
            }
        });
    </script>
</body>
</html>