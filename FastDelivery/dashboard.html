<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… - FastDelivery Admin V8.1</title>
    
    <link rel="stylesheet" href="style.css">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* ===========================================================
           1. ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø®Ø§ØµØ© Ø¨Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… (Dashboard Specific Styles)
           =========================================================== */
        
        /* Ø­Ø±ÙƒØ© Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª (Tabs Animation) */
        .tab-content { 
            display: none; 
            animation: fadeIn 0.4s ease-in-out; 
        }
        .tab-content.active { 
            display: block; 
        }
        
        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(5px); } 
            to { opacity: 1; transform: translateY(0); } 
        }
        
        /* Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ */
        .chart-container { 
            position: relative; 
            height: 350px; 
            width: 100%; 
        }

        /* Ø²Ø± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ */
        .menu-toggle { 
            display: none; 
            font-size: 1.8rem; 
            cursor: pointer; 
            color: var(--primary); 
            margin-left: 15px; 
        }
        
        /* ===========================================================
           2. Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª (KPI Cards Colors)
           =========================================================== */
        .kpi-card { 
            border-right: 5px solid var(--primary); 
        }
        .kpi-card.green { border-right-color: var(--success); }
        .kpi-card.orange { border-right-color: var(--warning); }
        .kpi-card.red { border-right-color: var(--accent); }

        /* ===========================================================
           3. Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØªØ­ÙƒÙ… ÙˆØ§Ù„ÙÙ„Ø§ØªØ± (Filters & Search)
           =========================================================== */
        .filter-bar { 
            display: flex; 
            gap: 15px; 
            margin-bottom: 1.5rem; 
            background: rgba(255,255,255,0.6); 
            padding: 15px; 
            border-radius: 12px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.02);
            flex-wrap: wrap; 
            align-items: center;
        }

        /* Ø´Ø¨ÙƒØ© Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© Ù„Ù„Ø£Ø³Ø·ÙˆÙ„ (Fleet Search Grid) */
        .search-grid {
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 15px; 
            margin-bottom: 15px;
        }

        /* ===========================================================
           4. Ø£Ù…Ø§Ù† ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ± (Password Security UI)
           =========================================================== */
        .password-wrapper {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(0,0,0,0.03);
            padding: 5px 10px;
            border-radius: 6px;
            width: fit-content;
        }
        .password-mask { 
            font-family: monospace; 
            letter-spacing: 2px; 
            color: #888; 
            font-size: 1.1rem;
        }
        .password-text {
            display: none;
            font-family: monospace;
            color: var(--primary);
            font-weight: bold;
        }
        .password-reveal { 
            cursor: pointer; 
            color: #666; 
            font-size: 0.9rem; 
            transition: color 0.2s;
        }
        .password-reveal:hover { color: var(--primary); }

        /* ===========================================================
           5. Ø§Ù„ØªØ¬Ø§ÙˆØ¨ Ù…Ø¹ Ø§Ù„Ø´Ø§Ø´Ø§Øª (Responsive)
           =========================================================== */
        @media (max-width: 900px) {
            .menu-toggle { display: block; }
            .filter-bar { flex-direction: column; align-items: stretch; }
            .stats-grid { grid-template-columns: 1fr 1fr; }
            .search-grid { grid-template-columns: 1fr; }
        }
        @media (max-width: 480px) {
            .stats-grid { grid-template-columns: 1fr; }
            .hide-mobile { display: none; }
        }
    </style>
</head>
<body>

    <div class="app-container">
        
        <nav class="sidebar" id="sidebar">
            <div class="brand">
                <span style="font-size: 2rem;">ğŸš€</span>
                <div>FastDelivery<br><small style="font-size: 0.8rem; opacity: 0.7;">Enterprise v8.1</small></div>
            </div>
            
            <a class="nav-link active" onclick="switchTab('overview', this)">
                <span>ğŸ“Š</span> Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø©
            </a>
            <a class="nav-link" onclick="switchTab('orders', this)">
                <span>ğŸ“¦</span> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª
            </a>
            <a class="nav-link" onclick="switchTab('fleet', this)">
                <span>ğŸ›µ</span> Ø§Ù„Ø£Ø³Ø·ÙˆÙ„ ÙˆØ§Ù„Ø´Ø±ÙƒØ§Ø¡
            </a>
            <a class="nav-link" onclick="switchTab('finance', this)">
                <span>ğŸ’°</span> Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠØ©
            </a>
            <a class="nav-link" onclick="switchTab('settings', this)">
                <span>âš™ï¸</span> Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
            </a>
            
            <div style="margin-top: auto;">
                <hr style="border-color: rgba(0,0,0,0.1); margin: 10px 0;">
                <a class="nav-link" onclick="Auth.logout()" style="color: var(--accent);">
                    <span>ğŸšª</span> ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬
                </a>
            </div>
        </nav>
<main class="main-content">
            
            <header class="topbar">
                <div style="display: flex; align-items: center;">
                    <div class="menu-toggle" onclick="toggleSidebar()">â˜°</div>
                    <div>
                        <h2 id="page-title" style="margin: 0;">Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø©</h2>
                        <small style="color: #666; font-size: 0.85rem;">Ù…Ø±ÙƒØ² Ø§Ù„Ù‚ÙŠØ§Ø¯Ø© ÙˆØ§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠ</small>
                    </div>
                </div>
                
                <div style="display: flex; gap: 15px; align-items: center;">
                    <button class="btn btn-warning btn-sm" onclick="openBroadcastModal()" title="Ø¥Ø±Ø³Ø§Ù„ ØªØ¹Ù…ÙŠÙ…">
                        <span>ğŸ“¢</span> <span class="hide-mobile">Ø¨Ø« Ø¥Ø´Ø¹Ø§Ø±</span>
                    </button>

                    <div class="notif-wrapper" onclick="Notifier.showDropdown()">
                        <span class="notif-icon">ğŸ””</span>
                        <span id="notif-badge" class="notif-badge">0</span>
                        
                        <div id="notif-dropdown" class="notif-dropdown" onclick="event.stopPropagation()">
                            <div class="notif-header">
                                <span>Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</span>
                                <span id="sound-icon" class="sound-toggle" onclick="Notifier.toggleSound()" title="ØªÙØ¹ÙŠÙ„/ÙƒØªÙ… Ø§Ù„ØµÙˆØª">ğŸ”Š</span>
                            </div>
                            <div id="notif-list" class="notif-list">
                                <div style="padding:20px; text-align:center; color:#999;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
                            </div>
                        </div>
                    </div>

                    <div style="display: flex; gap: 8px;">
                        <button class="btn btn-primary btn-sm" onclick="openAddUserModal()" title="Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯"><span>ğŸ‘¤</span></button>
                        <button class="btn btn-success btn-sm" onclick="openAddOrderModal()" title="Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯"><span>â•</span></button>
                    </div>
                    
                    <div id="user-info" class="badge" style="background: #333; color: #fff; display: none;">Admin</div>
                </div>
            </header>

            <div id="overview" class="tab-content active">
                <div class="stats-grid">
                    <div class="card kpi-card stat-card">
                        <p>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</p>
                        <h3 id="kpi-total">0</h3>
                        <small style="color: #888;">Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„ÙƒÙ„ÙŠ Ø§Ù„Ù…Ø³Ø¬Ù„</small>
                    </div>
                    <div class="card kpi-card green stat-card">
                        <p>Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„ØªÙˆØµÙŠÙ„ (Ø§Ù„Ù…Ø­Ù‚Ù‚Ø©)</p>
                        <h3 id="kpi-revenue">0</h3>
                        <small style="color: #888;">IQD (ØªÙ…Øª Ø§Ù„ØªØ³ÙˆÙŠØ©)</small>
                    </div>
                    <div class="card kpi-card orange stat-card">
                        <p>Ø·Ù„Ø¨Ø§Øª Ù†Ø´Ø·Ø©</p>
                        <h3 id="kpi-active">0</h3>
                        <small style="color: #888;">Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ° Ø­Ø§Ù„ÙŠØ§Ù‹</small>
                    </div>
                    <div class="card kpi-card red stat-card">
                        <p>Ø¯ÙŠÙˆÙ† ÙÙŠ Ø§Ù„Ø³ÙˆÙ‚</p>
                        <h3 id="kpi-debt">0</h3>
                        <small style="color: #888;">Ø¨Ø°Ù…Ø© Ø§Ù„Ù…Ù†Ø§Ø¯ÙŠØ¨ (Ù„Ù… ØªØµÙÙ‰)</small>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-title">ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ</div>
                    <div class="chart-container"><canvas id="ordersChart"></canvas></div>
                </div>
            </div>

            <div id="orders" class="tab-content">
                <div class="card">
                    <div class="card-title">
                        <span>Ø³Ø¬Ù„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø´Ø§Ù…Ù„</span>
                        <button class="btn btn-sm btn-primary" onclick="exportExcel()">ğŸ“¥ ØªØµØ¯ÙŠØ± Excel</button>
                    </div>
                    
                    <div class="filter-bar">
                        <div style="flex: 2; min-width: 250px;">
                            <label style="font-size: 0.8rem; margin-bottom: 5px;">Ø¨Ø­Ø« Ø°ÙƒÙŠ ÙˆØ´Ø§Ù…Ù„</label>
                            <input type="text" id="searchOrders" class="form-control" placeholder="Ø¨Ø­Ø« Ø¨Ù€: Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨ØŒ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ØŒ Ø§Ù„Ù‡Ø§ØªÙØŒ Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨..." onkeyup="renderOrdersTable()">
                        </div>
                        <div style="flex: 1; min-width: 180px;">
                            <label style="font-size: 0.8rem; margin-bottom: 5px;">ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø©</label>
                            <select id="filterStatus" class="form-control" onchange="renderOrdersTable()">
                                <option value="All">Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„</option>
                                <option value="New">Ø¬Ø¯ÙŠØ¯ (New)</option>
                                <option value="Assigned">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙˆØµÙŠÙ„ (Assigned)</option>
                                <option value="PickedUp">ØªÙ… Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… Ù…Ù† Ø§Ù„ØªØ§Ø¬Ø±</option>
                                <option value="Delivered">ØªÙ… Ø§Ù„ØªÙˆØµÙŠÙ„ (Delivered)</option>
                                <option value="Completed">Ù…ÙƒØªÙ…Ù„ ÙˆÙ…ØµÙÙ‰</option>
                                <option value="Cancelled">Ù…Ù„ØºÙŠ</option>
                            </select>
                        </div>
                    </div>

                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                    <th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                                    <th>Ø§Ù„ØªØ§Ø¬Ø±</th>
                                    <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                                    <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                    <th>Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨</th>
                                    <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</th>
                                </tr>
                            </thead>
                            <tbody id="orders-table-body">
                                <tr><td colspan="8" style="text-align:center; padding: 2rem;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</td></tr>
                            </tbody>
                        </table>
                        <div style="text-align:center; padding:15px;">
                            <button id="btnLoadMore" class="btn btn-sm btn-info" onclick="loadMoreOrders()" style="display:none; min-width: 200px;">â¬‡ï¸ Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„Ø·Ù„Ø¨Ø§Øª</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="fleet" class="tab-content">
                
                <div class="card">
                    <div class="card-title">ğŸ›µ Ø§Ù„Ù…Ù†Ø§Ø¯ÙŠØ¨ ÙˆØ§Ù„Ø°Ù…Ù… Ø§Ù„Ù…Ø§Ù„ÙŠØ©</div>
                    <div class="search-grid">
                        <input type="text" id="searchCouriers" class="form-control" placeholder="Ø¨Ø­Ø« Ù…Ù†Ø¯ÙˆØ¨ (Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„Ù‡Ø§ØªÙØŒ Ø§Ù„ÙŠÙˆØ²Ø±)..." onkeyup="renderFleetTable()">
                    </div>
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨</th>
                                    <th>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (User)</th>
                                    <th>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</th>
                                    <th>Ø§Ù„Ù‡Ø§ØªÙ</th>
                                    <th>Ø·Ù„Ø¨Ø§Øª Ù†Ø´Ø·Ø©</th>
                                    <th>Ø§Ù„Ø¹Ù‡Ø¯Ø© (Ø§Ù„Ø¯ÙŠÙˆÙ†)</th>
                                    <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                </tr>
                            </thead>
                            <tbody id="courier-table-body"></tbody>
                        </table>
                    </div>
                </div>

                <div class="card" style="margin-top: 20px;">
                    <div class="card-title">ğŸª Ø§Ù„ØªØ¬Ø§Ø± ÙˆØ§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</div>
                    <div class="search-grid">
                        <input type="text" id="searchSellers" class="form-control" placeholder="Ø¨Ø­Ø« ØªØ§Ø¬Ø± (Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„Ù‡Ø§ØªÙØŒ Ø§Ù„ÙŠÙˆØ²Ø±)..." onkeyup="renderFleetTable()">
                    </div>
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Ø§Ù„ØªØ§Ø¬Ø±</th>
                                    <th>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (User)</th>
                                    <th>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</th>
                                    <th>Ø§Ù„Ù‡Ø§ØªÙ</th>
                                    <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</th>
                                    <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                </tr>
                            </thead>
                            <tbody id="sellers-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="finance" class="tab-content">
                <div class="card">
                    <div class="card-title">ğŸ“Š Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ©</div>
                    
                    <div class="filter-bar" style="background: #e3f2fd;">
                        <div style="flex:1">
                            <label>Ù…Ù† ØªØ§Ø±ÙŠØ®:</label>
                            <input type="date" id="fin-start" class="form-control">
                        </div>
                        <div style="flex:1">
                            <label>Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®:</label>
                            <input type="date" id="fin-end" class="form-control">
                        </div>
                        <div style="display:flex; align-items:flex-end;">
                            <button class="btn btn-primary" onclick="loadFinancialReport()">ğŸ” Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
                        </div>
                    </div>

                    <div class="stats-grid" id="finance-summary-grid">
                        <div class="stat-card" style="text-align:center; padding:20px; color:#999; grid-column: 1 / -1;">
                            ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® ÙˆØ§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ "Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ±"
                        </div>
                    </div>

                    <div class="table-responsive">
                        <table class="table" id="finance-details-table">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                    <th>Ø§Ù„ØªØ§Ø¬Ø±</th>
                                    <th>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒÙ„ÙŠ</th>
                                    <th>Ø³Ø¹Ø± Ø§Ù„ØªÙˆØµÙŠÙ„ (Ø±Ø¨Ø­)</th>
                                    <th>ØµØ§ÙÙŠ Ø§Ù„ØªØ§Ø¬Ø±</th>
                                    <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                </tr>
                            </thead>
                            <tbody id="finance-report-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="settings" class="tab-content">
                <div class="card" style="max-width: 600px; margin: 0 auto;">
                    <div class="card-title">âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…</div>
                    <form id="configForm">
                        <div class="form-group">
                            <label>Ø³Ø¹Ø± Ø§Ù„ØªÙˆØµÙŠÙ„ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ (IQD)</label>
                            <small style="color:#666; display:block; margin-bottom:5px;">Ø³ÙŠØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¹Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©.</small>
                            <input type="number" id="conf_delivery_fee" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Ø§Ø³Ù… Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ (App Name)</label>
                            <input type="text" id="conf_app_name" class="form-control" required>
                        </div>
                        <button type="submit" class="btn btn-success">Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button>
                    </form>
                </div>
            </div>

        </main>
    </div>

    <div class="modal-overlay" id="broadcastModal">
        <div class="modal-content">
            <h3 style="color:var(--warning);">ğŸ“¢ Ø¥Ø±Ø³Ø§Ù„ ØªØ¹Ù…ÙŠÙ… (Broadcast)</h3>
            <p style="color:#666; font-size:0.9rem; margin-bottom:15px;">Ø³ÙŠØµÙ„ Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…Ø­Ø¯Ø¯ÙŠÙ† ÙÙˆØ±Ø§Ù‹.</p>
            
            <div class="form-group">
                <label>Ø§Ù„Ø¬Ù…Ù‡ÙˆØ± Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù:</label>
                <select id="bc-target" class="form-control">
                    <option value="all">Ø§Ù„ÙƒÙ„ (ØªØ¬Ø§Ø± ÙˆÙ…Ù†Ø¯ÙˆØ¨ÙŠÙ†)</option>
                    <option value="courier">Ø§Ù„Ù…Ù†Ø§Ø¯ÙŠØ¨ ÙÙ‚Ø·</option>
                    <option value="seller">Ø§Ù„ØªØ¬Ø§Ø± ÙÙ‚Ø·</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Ù†Øµ Ø§Ù„Ø±Ø³Ø§Ù„Ø©:</label>
                <textarea id="bc-message" class="form-control" rows="3" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§..."></textarea>
            </div>

            <button class="btn btn-warning btn-block" onclick="sendBroadcast()">ğŸš€ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¢Ù†</button>
            <button class="btn btn-block" onclick="UI.closeModal('broadcastModal')" style="margin-top:10px; background:#eee;">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>
    
    <div class="modal-overlay" id="assignModal">
        <div class="modal-content">
            <h3 id="assignModalTitle">Ø¥Ø³Ù†Ø§Ø¯ Ø§Ù„Ø·Ù„Ø¨</h3>
            <p id="assignOrderIdDisplay" style="margin-bottom: 1.5rem; color: #555; font-weight: bold;"></p>
            
            <div class="form-group">
                <label>Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨:</label>
                <select id="assignCourierSelect" class="form-control">
                    <option value="">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</option>
                </select>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 2rem;">
                <button class="btn btn-primary" onclick="confirmAssign()" style="flex: 1;">ØªØ£ÙƒÙŠØ¯</button>
                <button class="btn btn-danger" onclick="UI.closeModal('assignModal')" style="flex: 1;">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="addOrderModal">
        <div class="modal-content">
            <h3>ğŸ“ Ø¥Ø¶Ø§ÙØ© Ø·Ù„Ø¨ (ÙŠØ¯ÙˆÙŠ)</h3>
            <form id="addOrderForm">
                <div class="form-group"><label>Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</label><input type="text" name="customer_name" class="form-control" required></div>
                <div class="form-group"><label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label><input type="tel" name="customer_phone" class="form-control" required></div>
                <div class="form-group"><label>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label><input type="text" name="customer_address" class="form-control" required></div>
                <div class="form-group"><label>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒÙ„ÙŠ</label><input type="number" name="amount" class="form-control" required></div>
                <div class="form-group"><label>Ø§Ù„ØªÙØ§ØµÙŠÙ„</label><textarea name="order_details" class="form-control" rows="2" required></textarea></div>
                <div class="form-group"><label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label><input type="text" name="notes" class="form-control"></div>
                <button type="submit" class="btn btn-success btn-block">Ø¥Ø¶Ø§ÙØ©</button>
                <button type="button" class="btn btn-block" onclick="UI.closeModal('addOrderModal')" style="margin-top:10px; background:#eee;">Ø¥ØºÙ„Ø§Ù‚</button>
            </form>
        </div>
    </div>

    <div class="modal-overlay" id="addUserModal">
        <div class="modal-content">
            <h3>ğŸ‘¤ Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯</h3>
            <form id="addUserForm">
                <div class="form-group"><label>Ø§Ø³Ù… Ø§Ù„Ø¯Ø®ÙˆÙ„ (User)</label><input type="text" id="new_username" class="form-control" required></div>
                <div class="form-group"><label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label><input type="password" id="new_password" class="form-control" required></div>
                <div class="form-group"><label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label><input type="text" id="new_fullname" class="form-control" required></div>
                <div class="form-group"><label>Ø§Ù„Ù‡Ø§ØªÙ</label><input type="tel" id="new_phone" class="form-control" required></div>
                <div class="form-group">
                    <label>Ø§Ù„Ø¯ÙˆØ±</label>
                    <select id="new_role" class="form-control">
                        <option value="courier">Ù…Ù†Ø¯ÙˆØ¨</option>
                        <option value="seller">ØªØ§Ø¬Ø±</option>
                        <option value="admin">Ù…Ø¯ÙŠØ±</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary btn-block">ØªØ³Ø¬ÙŠÙ„</button>
                <button type="button" class="btn btn-block" onclick="UI.closeModal('addUserModal')" style="margin-top:10px; background:#eee;">Ø¥ØºÙ„Ø§Ù‚</button>
            </form>
        </div>
    </div>
<script src="app.js"></script>
    <script>
        /**
         * ------------------------------------------------------------------
         * DASHBOARD CONTROLLER (v8.1)
         * Includes: State Management, Data Rendering, and Admin Actions
         * ------------------------------------------------------------------
         */

        let DATA = { orders: [], users: [], config: {} };
        let chartInstance = null;
        let selectedOrderId = null;
        let isReassignMode = false;
        
        // Ù…ØªØºÙŠØ±Ø§Øª Ù„Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ø£Ø¯Ø§Ø¡ (Pagination)
        let displayLimit = 50; 
        let currentFilteredOrders = [];

        // 1. ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù… (Initialization)
        window.addEventListener('DOMContentLoaded', async () => {
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
            if (!Auth.checkRole('admin')) return;

            const user = Auth.getUser();
            if(user) {
                document.getElementById('user-info').innerText = user.full_name;
                document.getElementById('user-info').style.display = 'block';
            }
            
            // ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ø²Ù…Ù†ÙŠ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ (Ù…Ù† Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø´Ù‡Ø± Ø¥Ù„Ù‰ Ø§Ù„ÙŠÙˆÙ…)
            const date = new Date();
            const firstDay = new Date(date.getFullYear(), date.getMonth(), 1);
            document.getElementById('fin-start').valueAsDate = firstDay;
            document.getElementById('fin-end').valueAsDate = date;

            // Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ÙˆÙ„ÙŠ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            await loadAllData(false);
            
            // ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ©
            setInterval(() => loadAllData(true), 15000); 
        });

        // 2. Ù…Ø­Ø±Ùƒ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Data Sync Engine)
        async function loadAllData(isBackground = false) {
            try {
                // Ø§Ø³ØªØ®Ø¯Ø§Ù… Promise.all Ù„Ø·Ù„Ø¨ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¯ÙØ¹Ø© ÙˆØ§Ø­Ø¯Ø© (ØªÙˆØ§Ø²ÙŠ)
                const [ordersData, usersData, configData] = await Promise.all([
                    Api.post('getOrders', { role: 'admin', username: Auth.getUser().username }, isBackground),
                    Api.post('getUsers', { role: 'admin' }, isBackground),
                    Api.post('getConfig', {}, isBackground)
                ]);

                DATA.orders = ordersData || [];
                DATA.users = usersData || [];
                DATA.config = configData || {};

                // Ø¥Ø¹Ø§Ø¯Ø© Ø±Ø³Ù… Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
                refreshUI();
            } catch (err) { console.error("Sync Error:", err); }
        }

        function refreshUI() {
            renderKPI();
            renderChart();
            renderOrdersTable();
            renderFleetTable(); // ØªØ­Ø¯ÙŠØ« Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ø£Ø³Ø·ÙˆÙ„ ÙˆØ§Ù„Ø¨Ø­Ø«
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠ ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ù†Ø´Ø·Ø§Ù‹
            if(document.getElementById('finance').classList.contains('active')) {
                loadFinancialReport();
            }
            
            fillConfigForm();
        }

        // --- Ø¯ÙˆØ§Ù„ Ø§Ù„Ø¹Ø±Ø¶ ÙˆØ§Ù„ØªØ­Ù„ÙŠÙ„ (Render Functions) ---

        function renderKPI() {
            document.getElementById('kpi-total').innerText = DATA.orders.length;
            
            // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ (Ù„Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ØµÙØ§Ø© ÙÙ‚Ø·)
            const settledOrders = DATA.orders.filter(o => o.settled === true || o.settled === 'TRUE');
            const totalRevenue = settledOrders.reduce((sum, o) => sum + (Number(o.delivery_fee) || 0), 0);
            document.getElementById('kpi-revenue').innerText = totalRevenue.toLocaleString();

            const active = DATA.orders.filter(o => ['New', 'Assigned', 'PickedUp'].includes(o.status)).length;
            document.getElementById('kpi-active').innerText = active;

            // Ø§Ù„Ø¯ÙŠÙˆÙ† (Ø·Ù„Ø¨Ø§Øª Ù…ÙˆØµÙ„Ø© Ù„Ù… ÙŠØªÙ… ØªØ³ÙˆÙŠØªÙ‡Ø§)
            const debtOrders = DATA.orders.filter(o => o.status === 'Delivered' && (!o.settled || o.settled === 'FALSE'));
            const debt = debtOrders.reduce((sum, o) => sum + Number(o.amount), 0);
            document.getElementById('kpi-debt').innerText = debt.toLocaleString();
        }

        function renderOrdersTable() {
            const filterStatus = document.getElementById('filterStatus').value;
            const search = document.getElementById('searchOrders').value.toLowerCase();
            const tbody = document.getElementById('orders-table-body');
            
            tbody.innerHTML = '';

            // Ø§Ù„ÙÙ„ØªØ±Ø© ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø© (Client-side filtering)
            currentFilteredOrders = DATA.orders.filter(o => {
                const matchStatus = filterStatus === 'All' || o.status === filterStatus;
                const matchSearch = 
                    o.order_id.toLowerCase().includes(search) || 
                    o.customer_name.toLowerCase().includes(search) ||
                    o.customer_phone.includes(search) ||
                    (o.courier_username && o.courier_username.toLowerCase().includes(search)) ||
                    (o.seller_username && o.seller_username.toLowerCase().includes(search));
                
                return matchStatus && matchSearch;
            });

            if(currentFilteredOrders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding: 2rem; color: #999;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª ØªØ·Ø§Ø¨Ù‚ Ø§Ù„Ø¨Ø­Ø«</td></tr>';
                document.getElementById('btnLoadMore').style.display = 'none';
                return;
            }

            // Ø¹Ø±Ø¶ Ø¬Ø²Ø¡ Ù…Ù† Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ù„Ù„Ø£Ø¯Ø§Ø¡ (Pagination)
            const ordersToShow = currentFilteredOrders.slice(0, displayLimit);
            
            ordersToShow.forEach(o => {
                const shortId = o.order_id.split('-')[1];
                let actions = '';

                // Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø°ÙƒÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø©
                if (o.status === 'New') {
                    actions = `<button class="btn btn-sm btn-primary" onclick="event.stopPropagation(); openAssignModal('${o.order_id}', false)">ğŸš€ Ø¥Ø³Ù†Ø§Ø¯</button>`;
                } 
                else if (o.status === 'Assigned') {
                    actions = `
                        <div style="display:flex; gap:5px; flex-wrap:wrap;">
                            <button class="btn btn-sm btn-success" onclick="event.stopPropagation(); confirmHandover('${o.order_id}')" title="ØªØ³Ù„ÙŠÙ… Ù‚Ø³Ø±ÙŠ Ù„Ù„Ù…Ù†Ø¯ÙˆØ¨">ğŸ’° ØªØ³Ù„ÙŠÙ…</button>
                            <button class="btn btn-sm btn-warning" onclick="event.stopPropagation(); openAssignModal('${o.order_id}', true)" title="Ù†Ù‚Ù„ Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨">â™»ï¸</button>
                            <button class="btn btn-sm btn-danger" onclick="event.stopPropagation(); forceCancel('${o.order_id}')" title="Ø¥Ù„ØºØ§Ø¡">âŒ</button>
                        </div>`;
                }
                else if (o.status === 'PickedUp') {
                    actions = `
                        <div style="display:flex; gap:5px;">
                            <button class="btn btn-sm btn-danger btn-pulse" onclick="event.stopPropagation(); nudgeUser('${o.order_id}', '${o.courier_username}', 'courier')" title="Ø§Ø³ØªØ¹Ø¬Ø§Ù„">ğŸ””</button>
                            <button class="btn btn-sm btn-danger" onclick="event.stopPropagation(); forceCancel('${o.order_id}')" title="Ø¥Ù„ØºØ§Ø¡">âŒ</button>
                        </div>`;
                }
                else if (o.status === 'Delivered') {
                    if (!o.settled || o.settled === 'FALSE') {
                        actions = `<button class="btn btn-sm btn-success" onclick="event.stopPropagation(); settleOrder('${o.order_id}')">ğŸ’° ØªØ³ÙˆÙŠØ©</button>`;
                    } else {
                        actions = `<span class="badge badge-Completed">âœ” Ù…ØµÙÙ‰</span>`;
                    }
                }
                else if (o.status === 'Cancelled') {
                    actions = `<span class="badge badge-Cancelled">Ù…Ù„ØºÙŠ</span>`;
                }

                // Ø§Ù„ØµÙ Ù…Ø¹ Ø¯Ø¹Ù… Ø§Ù„Ù†Ù‚Ø± Ù„ÙØªØ­ Ø§Ù„ØªÙØ§ØµÙŠÙ„
                const tr = `
                    <tr style="cursor:pointer;" onclick="UI.openOrderPage(DATA.orders.find(x => x.order_id === '${o.order_id}'))">
                        <td data-label="#"><b>${shortId}</b></td>
                        <td data-label="Ø§Ù„ØªØ§Ø±ÙŠØ®">${new Date(o.date_time).toLocaleDateString()}</td>
                        <td data-label="Ø§Ù„Ø¹Ù…ÙŠÙ„">${o.customer_name}<br><small>${o.customer_phone}</small></td>
                        <td data-label="Ø§Ù„ØªØ§Ø¬Ø±">${o.seller_username}</td>
                        <td data-label="Ø§Ù„Ù…Ø¨Ù„Øº"><b>${Number(o.amount).toLocaleString()}</b></td>
                        <td data-label="Ø§Ù„Ø­Ø§Ù„Ø©"><span class="badge badge-${o.status}">${translateStatus(o.status)}</span></td>
                        <td data-label="Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨">${o.courier_username || '-'}</td>
                        <td data-label="Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª" onclick="event.stopPropagation()">${actions}</td>
                    </tr>`;
                tbody.innerHTML += tr;
            });

            // Ø²Ø± Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø²ÙŠØ¯
            const btnMore = document.getElementById('btnLoadMore');
            if (currentFilteredOrders.length > displayLimit) {
                btnMore.style.display = 'inline-block';
                btnMore.innerText = `â¬‡ï¸ Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø²ÙŠØ¯ (${currentFilteredOrders.length - displayLimit} Ù…ØªØ¨Ù‚ÙŠ)`;
            } else {
                btnMore.style.display = 'none';
            }
        }

        function loadMoreOrders() {
            displayLimit += 50;
            renderOrdersTable();
        }

        // âœ… Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø³Ø·ÙˆÙ„ Ø§Ù„Ù…Ø­Ø¯Ø«Ø© (ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ± + Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù…Ù†ÙØµÙ„)
        function renderFleetTable() {
            // 1. Ù‚Ø³Ù… Ø§Ù„Ù…Ù†Ø§Ø¯ÙŠØ¨
            const searchC = document.getElementById('searchCouriers').value.toLowerCase();
            const couriers = DATA.users.filter(u => u.role === 'courier' && (
                u.username.toLowerCase().includes(searchC) || 
                u.full_name.toLowerCase().includes(searchC) ||
                u.phone.includes(searchC)
            ));
            
            const cBody = document.getElementById('courier-table-body');
            cBody.innerHTML = '';
            
            couriers.forEach(c => {
                const active = DATA.orders.filter(o => o.courier_username === c.username && ['Assigned', 'PickedUp'].includes(o.status)).length;
                const cash = Finance.calculateCourierDebt(DATA.orders, c.username);
                
                // ÙÙƒ ØªØ´ÙÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù„Ù„Ø¹Ø±Ø¶
                let realPass = "";
                try { realPass = c.password ? atob(c.password) : "-"; } catch(e) { realPass = "Error"; }

                const passHtml = `
                    <div class="password-wrapper">
                        <span class="password-mask" id="pass-mask-${c.username}">******</span>
                        <span class="password-text" id="pass-txt-${c.username}">${realPass}</span>
                        <span class="password-reveal" onclick="togglePassword('${c.username}')" title="Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡">ğŸ‘ï¸</span>
                    </div>
                `;

                cBody.innerHTML += `
                    <tr>
                        <td data-label="Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨"><b>${c.full_name}</b></td>
                        <td data-label="Ø§Ù„ÙŠÙˆØ²Ø±" style="font-family:monospace; color:#555;">${c.username}</td>
                        <td data-label="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">${passHtml}</td>
                        <td data-label="Ø§Ù„Ù‡Ø§ØªÙ">${c.phone}</td>
                        <td data-label="Ù†Ø´Ø·Ø©">${active}</td>
                        <td data-label="Ø§Ù„Ø¹Ù‡Ø¯Ø©" style="color:${cash > 0 ? 'var(--accent)' : 'green'}"><b>${cash.toLocaleString()}</b></td>
                        <td data-label="Ø§Ù„Ø­Ø§Ù„Ø©"><span class="badge badge-Active">${c.status}</span></td>
                    </tr>`;
            });

            // 2. Ù‚Ø³Ù… Ø§Ù„ØªØ¬Ø§Ø±
            const searchS = document.getElementById('searchSellers').value.toLowerCase();
            const sellers = DATA.users.filter(u => u.role === 'seller' && (
                u.username.toLowerCase().includes(searchS) || 
                u.full_name.toLowerCase().includes(searchS) ||
                u.phone.includes(searchS)
            ));
            
            const sBody = document.getElementById('sellers-table-body');
            sBody.innerHTML = '';
            
            sellers.forEach(s => {
                 const totalSales = DATA.orders.filter(o => o.seller_username === s.username).reduce((sum,o) => sum + Number(o.amount), 0);
                 
                 let realPass = "";
                 try { realPass = s.password ? atob(s.password) : "-"; } catch(e) { realPass = "Error"; }
                 const passHtml = `
                    <div class="password-wrapper">
                        <span class="password-mask" id="pass-mask-${s.username}">******</span>
                        <span class="password-text" id="pass-txt-${s.username}">${realPass}</span>
                        <span class="password-reveal" onclick="togglePassword('${s.username}')" title="Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡">ğŸ‘ï¸</span>
                    </div>
                `;

                 sBody.innerHTML += `
                    <tr>
                        <td data-label="Ø§Ù„ØªØ§Ø¬Ø±"><b>${s.full_name}</b></td>
                        <td data-label="Ø§Ù„ÙŠÙˆØ²Ø±" style="font-family:monospace; color:#555;">${s.username}</td>
                        <td data-label="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">${passHtml}</td>
                        <td data-label="Ø§Ù„Ù‡Ø§ØªÙ">${s.phone}</td>
                        <td data-label="Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª">${totalSales.toLocaleString()}</td>
                        <td data-label="Ø§Ù„Ø­Ø§Ù„Ø©"><span class="badge badge-Active">${s.status}</span></td>
                    </tr>`;
            });
        }

        // ØªØ¨Ø¯ÙŠÙ„ Ø¹Ø±Ø¶ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
        function togglePassword(username) {
            const mask = document.getElementById(`pass-mask-${username}`);
            const txt = document.getElementById(`pass-txt-${username}`);
            if (mask.style.display === 'none') {
                mask.style.display = 'inline';
                txt.style.display = 'none';
            } else {
                mask.style.display = 'none';
                txt.style.display = 'inline';
            }
        }

        function renderChart() {
            const ctx = document.getElementById('ordersChart').getContext('2d');
            const stats = { 'New': 0, 'Active': 0, 'Completed': 0, 'Cancelled': 0 };
            DATA.orders.forEach(o => {
                if (o.status === 'New') stats.New++;
                else if (['Assigned', 'PickedUp'].includes(o.status)) stats.Active++;
                else if (['Delivered', 'Completed'].includes(o.status)) stats.Completed++;
                else if (o.status === 'Cancelled') stats.Cancelled++;
            });

            if (chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, {
                type: 'bar', 
                data: {
                    labels: ['Ø¬Ø¯ÙŠØ¯', 'Ù†Ø´Ø·', 'Ù…ÙƒØªÙ…Ù„', 'Ù…Ù„ØºÙŠ'],
                    datasets: [{
                        label: 'Ø§Ù„Ø·Ù„Ø¨Ø§Øª',
                        data: [stats.New, stats.Active, stats.Completed, stats.Cancelled],
                        backgroundColor: ['#2196f3', '#ff9800', '#00b09b', '#f44336'],
                        borderRadius: 5
                    }]
                },
                options: { maintainAspectRatio: false, responsive: true, scales: { y: { beginAtZero: true } } }
            });
        }

        function loadFinancialReport() {
            const start = document.getElementById('fin-start').value;
            const end = document.getElementById('fin-end').value;
            const filtered = Finance.filterOrdersByDate(DATA.orders, start, end);
            const stats = Finance.calculateStats(filtered);
            
            document.getElementById('finance-summary-grid').innerHTML = `
                <div class="stat-card" style="background:#e8f5e9;">
                    <p>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</p>
                    <h3 style="color:var(--success)">${stats.totalSales.toLocaleString()} IQD</h3>
                </div>
                <div class="stat-card" style="background:#e3f2fd;">
                    <p>ØµØ§ÙÙŠ Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„ØªÙˆØµÙŠÙ„</p>
                    <h3 style="color:var(--primary)">${stats.totalFees.toLocaleString()} IQD</h3>
                </div>
                <div class="stat-card" style="background:#fff3e0;">
                    <p>Ù…Ø³ØªØ­Ù‚Ø§Øª Ø§Ù„ØªØ¬Ø§Ø±</p>
                    <h3 style="color:var(--warning)">${stats.totalNet.toLocaleString()} IQD</h3>
                </div>`;
            
            const tbody = document.getElementById('finance-report-body');
            tbody.innerHTML = '';
            filtered.forEach(o => {
                if(o.status !== 'Delivered' && o.status !== 'Completed') return;
                tbody.innerHTML += `
                    <tr>
                        <td>${o.order_id.split('-')[1]}</td>
                        <td>${new Date(o.date_time).toLocaleDateString()}</td>
                        <td>${o.seller_username}</td>
                        <td><b>${Number(o.amount).toLocaleString()}</b></td>
                        <td style="color:var(--success)">+${Number(o.delivery_fee || 0).toLocaleString()}</td>
                        <td style="color:var(--warning)">${Number(o.net_seller || 0).toLocaleString()}</td>
                        <td>${o.settled === true || o.settled === 'TRUE' ? 'âœ… Ù…ØµÙÙ‰' : 'âŒ Ø°Ù…Ø©'}</td>
                    </tr>`;
            });
            if(tbody.innerHTML === '') tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:20px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>';
        }

        function fillConfigForm() {
            if(document.activeElement.tagName === 'INPUT') return;
            document.getElementById('conf_delivery_fee').value = DATA.config.delivery_fee || 0;
            document.getElementById('conf_app_name').value = DATA.config.app_name || '';
        }

        // --- Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ© (Admin Actions) ---

        function openAssignModal(orderId, reassignMode) {
            selectedOrderId = orderId;
            isReassignMode = reassignMode;
            document.getElementById('assignModalTitle').innerText = reassignMode ? "ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨" : "Ø¥Ø³Ù†Ø§Ø¯ Ø·Ù„Ø¨";
            document.getElementById('assignOrderIdDisplay').innerText = "#" + orderId.split('-')[1];
            
            const select = document.getElementById('assignCourierSelect');
            select.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ --</option>';
            DATA.users.filter(u => u.role === 'courier').forEach(c => {
                const opt = document.createElement('option');
                opt.value = c.username;
                opt.text = c.full_name;
                select.appendChild(opt);
            });
            UI.openModal('assignModal');
        }

        async function confirmAssign() {
            const courier = document.getElementById('assignCourierSelect').value;
            if (!courier) return UI.showToast("Ø§Ø®ØªØ± Ù…Ù†Ø¯ÙˆØ¨Ø§Ù‹", "error");
            const action = isReassignMode ? 'reassignOrder' : 'updateStatus';
            const payload = isReassignMode ? { order_id: selectedOrderId, new_courier_username: courier } : { order_id: selectedOrderId, status: 'Assigned', courier_username: courier };
            try { await Api.post(action, payload, false); UI.closeModal('assignModal'); UI.showToast("ØªÙ…Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­"); loadAllData(false); } catch (e) { }
        }
        
        // âœ… Ù…ÙŠØ²Ø© Ø§Ù„ØªØ³Ù„ÙŠÙ… Ø§Ù„Ù‚Ø³Ø±ÙŠ (Force Handover)
        async function confirmHandover(orderId) {
            if(!confirm("âš ï¸ ØªØ£ÙƒÙŠØ¯ Ø¥Ø¯Ø§Ø±ÙŠ:\nÙ‡Ù„ ØªØ±ÙŠØ¯ Ù†Ù‚Ù„ Ø§Ù„Ø¹Ù‡Ø¯Ø© Ù„Ù„Ù…Ù†Ø¯ÙˆØ¨ ÙˆØªØ¬Ø§ÙˆØ² Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªØ§Ø¬Ø±ØŸ\nØ³ÙŠØµØ¨Ø­ Ø§Ù„Ø·Ù„Ø¨ 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙˆØµÙŠÙ„'.")) return;
            try {
                await Api.post('updateStatus', { order_id: orderId, status: 'PickedUp' }, false);
                UI.showToast("âœ… ØªÙ… ØªØ³Ù„ÙŠÙ… Ø§Ù„Ø¹Ù‡Ø¯Ø© Ù„Ù„Ù…Ù†Ø¯ÙˆØ¨ Ø¨Ù†Ø¬Ø§Ø­");
                loadAllData(false);
            } catch(e) {}
        }

        function openBroadcastModal() { UI.openModal('broadcastModal'); }
        async function sendBroadcast() {
            const target = document.getElementById('bc-target').value;
            const msg = document.getElementById('bc-message').value;
            if(!msg) return UI.showToast("Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©", "error");
            try { await Api.post('broadcastNotification', { role: 'admin', target_group: target, message: msg }); UI.closeModal('broadcastModal'); UI.showToast("ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ ğŸ“¢"); document.getElementById('bc-message').value = ""; } catch(e) {}
        }
        
        async function nudgeUser(orderId, targetUser, role) {
            if(!confirm("Ø¥Ø±Ø³Ø§Ù„ ØªÙ†Ø¨ÙŠÙ‡ Ø§Ø³ØªØ¹Ø¬Ø§Ù„ØŸ")) return;
            try { await Api.post('nudgeUser', { order_id: orderId, target_user: targetUser, target_role: role, username: 'admin' }, false); UI.showToast("ØªÙ… Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ ğŸ””"); } catch(e) {}
        }
        
        async function forceCancel(orderId) {
            if(!confirm("âš ï¸ Ø¥Ù„ØºØ§Ø¡ Ù‚Ø³Ø±ÙŠØŸ Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ Ø±Ø¬Ø¹Ø© ÙÙŠÙ‡.")) return;
            try { await Api.post('forceCancel', { order_id: orderId, role: 'admin' }, false); UI.showToast("ØªÙ… Ø§Ù„Ø¥Ù„ØºØ§Ø¡", "warning"); loadAllData(false); } catch(e) {}
        }
        
        async function settleOrder(orderId) {
            if(!confirm("ØªØµÙÙŠØ© Ø§Ù„Ø­Ø³Ø§Ø¨ ÙˆØªØ£ÙƒÙŠØ¯ Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„ÙƒØ§Ø´ØŸ")) return;
            try { await Api.post('settleOrder', { order_id: orderId }, false); UI.showToast("ØªÙ…Øª Ø§Ù„ØªØµÙÙŠØ© ğŸ’°"); loadAllData(false); } catch (e) {}
        }
        
        // --- Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ ÙˆØ§Ù„Ø­ÙØ¸ (Forms Handling) ---
        document.getElementById('addOrderForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = Object.fromEntries(new FormData(e.target).entries());
            data.seller_username = Auth.getUser().username; 
            data.request_username = 'admin'; 
            await Api.post('addOrder', data, false);
            UI.closeModal('addOrderModal'); e.target.reset(); loadAllData(false);
        });

        document.getElementById('addUserForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = {
                new_username: document.getElementById('new_username').value,
                new_password: document.getElementById('new_password').value,
                full_name: document.getElementById('new_fullname').value,
                phone: document.getElementById('new_phone').value,
                new_role: document.getElementById('new_role').value
            };
            await Api.post('registerUser', data, false);
            UI.closeModal('addUserModal'); document.getElementById('addUserForm').reset(); loadAllData(false);
        });

        document.getElementById('configForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const updates = { delivery_fee: document.getElementById('conf_delivery_fee').value, app_name: document.getElementById('conf_app_name').value };
            await Api.post('saveConfig', { updates: updates }, false);
            UI.showToast("ØªÙ… Ø§Ù„Ø­ÙØ¸");
        });

        // --- Ø£Ø¯ÙˆØ§Øª Ø¹Ø§Ù…Ø© (Utilities) ---
        function openAddOrderModal() { UI.openModal('addOrderModal'); }
        function openAddUserModal() { UI.openModal('addUserModal'); }
        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); }
        
        function switchTab(tabId, navElement) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            if(navElement) navElement.classList.add('active');
            if(navElement) document.getElementById('page-title').innerText = navElement.innerText.trim().substring(2);
            document.getElementById('sidebar').classList.remove('open');
        }
        
        function exportExcel() {
            let csv = "\uFEFFOrder ID,Date,Customer,Phone,Amount,Status,Courier,Seller,Settled\n";
            DATA.orders.forEach(o => {
                const cleanName = o.customer_name.replace(/,/g, " ");
                const isSettled = (o.settled === true || o.settled === 'TRUE') ? "Yes" : "No";
                csv += `${o.order_id},${o.date_time},${cleanName},${o.customer_phone},${o.amount},${o.status},${o.courier_username},${o.seller_username},${isSettled}\n`;
            });
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = `Orders_${new Date().toISOString().slice(0,10)}.csv`;
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
        }
    </script>
</body>
</html>
