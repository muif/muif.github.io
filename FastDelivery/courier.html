<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ - FastDelivery V9.4</title>
    
    <link rel="stylesheet" href="style.css">
    
    <style>
        /* --- ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø®Ø§ØµØ© Ø¨Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ (V9.4) --- */
        body { 
            padding-bottom: 90px; 
            background: #f0f2f5; 
            overscroll-behavior-y: none;
        }

        /* Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…Ø­ÙØ¸Ø© */
        .wallet-card {
            background: linear-gradient(135deg, #4e54c8, #8f94fb);
            color: white; 
            padding: 30px; 
            border-radius: 25px;
            text-align: center; 
            margin-bottom: 25px;
            box-shadow: 0 10px 30px rgba(78, 84, 200, 0.3);
        }

        /* Ø²Ø± Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø¹Ø±ÙŠØ¶ */
        .map-btn {
            background: #f1f3f4; 
            color: #1a73e8; 
            width: 100%; 
            display: flex; align-items: center; justify-content: center; gap: 8px; 
            padding: 12px; border-radius: 12px; text-decoration: none; 
            font-weight: 600; margin: 10px 0; border: 1px solid #e0e0e0;
            transition: background 0.2s;
        }
        .map-btn:active { background: #e0e0e0; }
        
        /* ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª */
        .notes-box {
            background: #fff9c4; color: #5f5200;
            padding: 10px; border-radius: 8px;
            margin: 10px 0; font-size: 0.9rem;
            border-right: 4px solid #fbc02d;
        }

        /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„Ø³Ø±ÙŠØ¹ */
        .contact-actions {
            display: flex; gap: 10px; margin-top: 5px;
        }

        /* --- âœ… ØªØ­Ø¯ÙŠØ« 1: Ø¥ØµÙ„Ø§Ø­ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ --- */
        @media (max-width: 600px) {
            .notif-dropdown {
                position: fixed !important;
                top: 70px !important;
                left: 10px !important;
                right: 10px !important;
                width: auto !important;
                max-height: 80vh !important;
                overflow-y: auto !important;
                box-shadow: 0 100vh 0 100vh rgba(0,0,0,0.5) !important; /* ØªØ¹ØªÙŠÙ… Ø§Ù„Ø®Ù„ÙÙŠØ© */
                z-index: 9999;
                border: 1px solid rgba(0,0,0,0.1);
            }
        }

        /* --- âœ… ØªØ­Ø¯ÙŠØ« 2: Ø¯Ø¹Ù… Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ø¹ØµØ±ÙŠØ© (Modern Modals CSS) --- */
        .modal-content {
            border-radius: 20px !important;
            padding: 0 !important;
            border: none !important;
            overflow: hidden;
        }
        .modal-header-modern {
            background: linear-gradient(135deg, var(--primary), #1e3a8a);
            color: white;
            padding: 20px;
            text-align: center;
        }
        .modal-body-modern { padding: 20px; background: #fff; }
        
        /* Ø´Ø¨ÙƒØ© Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù†Ø§ÙØ°Ø© */
        .detail-grid {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 10px 15px;
            font-size: 0.95rem;
            align-items: baseline;
        }
        .detail-label { color: #666; font-weight: bold; min-width: 80px; }
        .detail-value { color: #333; }
        .detail-divider { grid-column: 1 / -1; height: 1px; background: #eee; margin: 8px 0; }
    </style>
</head>
<body>

    <div class="app-header">
        <div>
            <h3 style="margin: 0; font-size: 1.2rem;">ğŸ‘‹ Ø£Ù‡Ù„Ø§Ù‹ ÙƒØ§Ø¨ØªÙ†</h3>
            <span id="courierName" style="color: var(--primary); font-weight: bold;">...</span>
        </div>
        
        <div style="display: flex; gap: 15px; align-items: center;">
            <div class="notif-wrapper" onclick="Notifier.showDropdown()">
                <span class="notif-icon">ğŸ””</span>
                <span id="notif-badge" class="notif-badge">0</span>
                
                <div id="notif-dropdown" class="notif-dropdown" onclick="event.stopPropagation()">
                    <div class="notif-header">
                        <span>Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</span>
                        <span id="sound-icon" class="sound-toggle" onclick="Notifier.toggleSound()" title="ØµÙˆØª Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª">ğŸ”Š</span>
                    </div>
                    <div id="notif-list" class="notif-list">
                        <div style="padding:20px; text-align:center; color:#999;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
                    </div>
                </div>
            </div>
            
            <button class="btn btn-sm btn-danger" onclick="Auth.logout()">
                <span>ğŸšª</span>
            </button>
        </div>
    </div>
<div id="tab-available" class="tab-view active">
        <h4 style="margin-bottom: 15px; color: #666; font-size: 0.9rem;">Ø§Ù„ÙØ±Øµ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ø§Ù„Ù…ØªØ§Ø­Ø©</h4>
        <div id="list-available">
            <div style="text-align: center; margin-top: 60px; color: #aaa;">
                <div class="spinner" style="margin: 0 auto 20px; border-width: 3px; border-top-color: #ccc;"></div>
                Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø·Ù„Ø¨Ø§Øª...
            </div>
        </div>
    </div>

    <div id="tab-active" class="tab-view">
        <h4 style="margin-bottom: 15px; color: #666; font-size: 0.9rem;">Ù…Ù‡Ø§Ù…Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠØ©</h4>
        <div id="list-active">
            <div style="text-align: center; margin-top: 60px; color: #aaa;">
                <span style="font-size: 3rem; display: block; margin-bottom: 10px;">âœ…</span>
                Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‡Ø§Ù… Ù†Ø´Ø·Ø© Ø­Ø§Ù„ÙŠØ§Ù‹
            </div>
        </div>
    </div>

    <div id="tab-wallet" class="tab-view">
        <div class="wallet-card">
            <p style="opacity: 0.9;">Ø§Ù„Ø¹Ù‡Ø¯Ø© Ø§Ù„Ù…Ø§Ù„ÙŠØ© (Ø§Ù„ÙƒØ§Ø´)</p>
            <h1 id="wallet-amount" style="font-size: 3.5rem; margin: 10px 0;">0</h1>
            <p style="opacity: 0.8;">Ø¯ÙŠÙ†Ø§Ø± Ø¹Ø±Ø§Ù‚ÙŠ</p>
        </div>
        
        <div class="card" style="padding: 0;">
            <div class="card-title" style="padding: 15px; border-bottom: 1px solid #eee; margin: 0;">
                Ø³Ø¬Ù„ Ø§Ù„ØªÙˆØµÙŠÙ„Ø§Øª Ø§Ù„ÙŠÙˆÙ…
            </div>
            <ul id="wallet-history" style="list-style: none; padding: 0; margin: 0;">
                <li style="padding: 20px; text-align: center; color: #999;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ø§Ù„ÙŠÙˆÙ…</li>
            </ul>
        </div>
    </div>

    <div class="bottom-nav">
        <div class="nav-item active" onclick="switchTab('available', this)">
            <span class="icon">ğŸ“‹</span> <span>Ù…ØªØ§Ø­</span>
        </div>
        <div class="nav-item" onclick="switchTab('active', this)">
            <span class="icon">ğŸ›µ</span> <span>Ù…Ù‡Ø§Ù…ÙŠ</span>
        </div>
        <div class="nav-item" onclick="switchTab('wallet', this)">
            <span class="icon">ğŸ’°</span> <span>Ù…Ø­ÙØ¸ØªÙŠ</span>
        </div>
    </div>

    <div class="modal-overlay" id="cancelModal">
        <div class="modal-content">
            <div class="modal-header-modern" style="background: var(--danger);">
                <h3 style="margin:0;">â›” Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨</h3>
            </div>
            <div class="modal-body-modern">
                <p style="color:#666; margin-bottom:15px;">Ù‡Ù„ Ø£Ù†Øª Ù…Ø¶Ø·Ø± Ù„Ø¥Ù„ØºØ§Ø¡ Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ØŸ ÙŠØ±Ø¬Ù‰ Ø°ÙƒØ± Ø§Ù„Ø³Ø¨Ø¨ Ø¨ÙˆØ¶ÙˆØ­.</p>
                <form id="cancelForm">
                    <input type="hidden" id="cancelOrderId">
                    <div class="form-group">
                        <label>Ø§Ù„Ø³Ø¨Ø¨ (Ù…Ø·Ù„ÙˆØ¨)</label>
                        <textarea id="cancelReason" class="form-control" rows="3" required placeholder="Ù…Ø«Ø§Ù„: ØªØ¹Ø·Ù„ Ø§Ù„Ø¯Ø±Ø§Ø¬Ø©ØŒ Ø§Ù„Ø²Ø¨ÙˆÙ† Ù„Ø§ ÙŠØ±Ø¯..."></textarea>
                    </div>
                    <button type="submit" class="btn btn-danger btn-block">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ù„ØºØ§Ø¡</button>
                    <button type="button" class="btn btn-block" onclick="UI.closeModal('cancelModal')" style="margin-top: 10px; background: #eee; color: #333;">ØªØ±Ø§Ø¬Ø¹</button>
                </form>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="transferModal">
        <div class="modal-content">
            <div class="modal-header-modern" style="background: var(--primary);">
                <h3 style="margin:0;">â™»ï¸ ØªØ­ÙˆÙŠÙ„ Ù„Ø²Ù…ÙŠÙ„</h3>
            </div>
            <div class="modal-body-modern">
                <p style="color:#666; font-size:0.9rem; margin-bottom:15px;">Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Username) Ù„Ù„Ù…Ù†Ø¯ÙˆØ¨ Ø§Ù„Ø²Ù…ÙŠÙ„ Ù„Ù†Ù‚Ù„ Ø§Ù„Ø¹Ù‡Ø¯Ø© Ø¥Ù„ÙŠÙ‡.</p>
                
                <input type="hidden" id="transferOrderId">
                <div class="form-group">
                    <label>Ø§Ø³Ù… Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø²Ù…ÙŠÙ„:</label>
                    <input type="text" id="transferTargetUser" class="form-control" placeholder="username" required>
                </div>
                
                <button class="btn btn-primary btn-block" onclick="confirmTransfer()">ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨</button>
                <button class="btn btn-block" onclick="UI.closeModal('transferModal')" style="margin-top:10px; background:#eee; color: #333;">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="detailsModal"></div>
    <div class="modal-overlay" id="unifiedOrderModal"></div>
<script src="app.js"></script>
    
    <script>
        /**
         * ------------------------------------------------------------------
         * COURIER APP LOGIC (v9.4 - Smart WhatsApp & Modern Cards)
         * ------------------------------------------------------------------
         */
        
        // âœ… ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ù‚Ø¯ÙŠÙ… (Ø§Ø®ØªÙŠØ§Ø±ÙŠØŒ Ù„Ø¶Ù…Ø§Ù† Ø§Ù„ØªÙˆØ§ÙÙ‚)
        // if(window.Api) window.API_URL = "Ø¶Ø¹_Ø±Ø§Ø¨Ø·_Ø§Ù„Ù†Ø´Ø±_Ø§Ù„Ø¬Ø¯ÙŠØ¯_Ù‡Ù†Ø§";

        let currentOrders = [];

        // 1. Ø§Ù„ØªÙ‡ÙŠØ¦Ø© (Initialization)
        window.addEventListener('DOMContentLoaded', () => {
            if (!Auth.checkRole('courier')) return;
            
            const user = Auth.getUser();
            if(user) document.getElementById('courierName').innerText = user.full_name.split(' ')[0];
            
            loadCourierData(false);
            
            // ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙƒÙ„ 15 Ø«Ø§Ù†ÙŠØ©
            setInterval(() => loadCourierData(true), 15000);
        });

        // 2. Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        async function loadCourierData(isBackground = false) {
            try {
                const user = Auth.getUser();
                if(!user) return;

                const newOrders = await Api.post('getOrders', {
                    role: 'courier',
                    username: user.username
                }, isBackground);

                currentOrders = newOrders;

                renderAvailable(newOrders);
                renderActive(newOrders);
                renderWallet(newOrders);

            } catch (err) { console.error("Sync Error:", err); }
        }

        // --- Ø¯ÙˆØ§Ù„ Ø§Ù„Ø¹Ø±Ø¶ (Render Functions) ---

        // Ø£. Ø§Ù„ÙØ±Øµ Ø§Ù„Ù…ØªØ§Ø­Ø© (Available Orders)
        function renderAvailable(orders) {
            const container = document.getElementById('list-available');
            const list = orders.filter(o => o.status === 'New');

            if (list.length === 0) {
                container.innerHTML = `
                <div style="text-align: center; margin-top: 60px; color: #999;">
                    <span style="font-size: 4rem; display: block; margin-bottom: 10px; opacity: 0.5;">ğŸ˜´</span>
                    Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© Ø­Ø§Ù„ÙŠØ§Ù‹
                </div>`;
                return;
            }

            let html = '';
            list.forEach(o => {
                const shortId = o.order_id.split('-')[1] || o.order_id;
                
                let notesHtml = o.notes ? `<div class="notes-box">ğŸ“ <b>Ù…Ù„Ø§Ø­Ø¸Ø©:</b> ${o.notes}</div>` : '';

                // Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯
                html += `
                <div class="mobile-card new" onclick="UI.openOrderPage(currentOrders.find(x => x.order_id === '${o.order_id}'))">
                    <div class="card-header">
                        <span>#${shortId}</span>
                        <span style="color:var(--success); background:#e8f5e9; padding:2px 10px; border-radius:8px;">${Number(o.amount).toLocaleString()}</span>
                    </div>
                    <div class="info-row"><span>ğŸª</span> <b>Ø§Ù„ØªØ§Ø¬Ø±:</b> ${o.seller_username}</div>
                    <div class="info-row"><span>ğŸ“</span> <b>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</b> ${o.customer_address}</div>
                    
                    <div class="info-row" style="color: #666; font-size: 0.9rem; background: #f9f9f9; padding: 10px; border-radius: 8px; margin-top:10px;">
                        ${o.order_details}
                    </div>
                    ${notesHtml}
                    
                    <div class="action-grid" style="margin-top:15px;">
                        <button class="btn btn-primary btn-block" onclick="event.stopPropagation(); acceptOrder('${o.order_id}')">âœ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨</button>
                    </div>
                </div>`;
            });
            container.innerHTML = html;
        }

        // Ø¨. Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù†Ø´Ø·Ø© (Active Tasks) - Ù…Ø¹ Ø¥ØµÙ„Ø§Ø­ Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨
        function renderActive(orders) {
            const container = document.getElementById('list-active');
            const user = Auth.getUser().username;
            
            const list = orders.filter(o => 
                (o.status === 'Assigned' || o.status === 'PickedUp') && 
                o.courier_username === user
            );

            if (list.length === 0) {
                container.innerHTML = `
                <div style="text-align: center; margin-top: 60px; color: #999;">
                    <span style="font-size: 3rem; display: block; margin-bottom: 10px;">ğŸ™Œ</span>
                    Ø£Ù†Øª Ø¬Ø§Ù‡Ø² Ù„Ø§Ø³ØªÙ„Ø§Ù… Ù…Ù‡Ø§Ù… Ø¬Ø¯ÙŠØ¯Ø©
                </div>`;
                return;
            }

            let html = '';
            list.forEach(o => {
                let mainButton = '';
                let extraButtons = '';
                let statusBadge = '';
                let notesHtml = o.notes ? `<div class="notes-box">ğŸ“ <b>Ù…Ù„Ø§Ø­Ø¸Ø©:</b> ${o.notes}</div>` : '';

                // âœ… Ø¥ØµÙ„Ø§Ø­ Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ (964)
                const shortId = o.order_id.split('-')[1];
                const waButton = WhatsAppHelper.getButton(o.customer_phone, `Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ Ø£Ù†Ø§ Ù…Ù†Ø¯ÙˆØ¨ Ø§Ù„ØªÙˆØµÙŠÙ„ Ø¨Ø®ØµÙˆØµ Ø·Ù„Ø¨Ùƒ #${shortId}`, "ÙˆØ§ØªØ³Ø§Ø¨");
                const phoneButton = `<a href="tel:${o.customer_phone}" class="btn btn-sm" style="background:#eee; color:#333; border:1px solid #ccc; text-decoration:none; display:inline-flex; align-items:center; gap:5px;" onclick="event.stopPropagation()">ğŸ“ Ø§ØªØµØ§Ù„</a>`;

                // Ø§Ù„Ù…Ù†Ø·Ù‚ Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø©
                if (o.status === 'Assigned') {
                    statusBadge = `<span class="badge badge-Assigned">ÙÙŠ Ø§Ù„Ø·Ø±ÙŠÙ‚ Ù„Ù„ØªØ§Ø¬Ø±</span>`;
                    const isPaid = (o.seller_paid === true || o.seller_paid === 'TRUE');
                    
                    if (isPaid) {
                        mainButton = `<button class="btn btn-warning btn-block" onclick="event.stopPropagation(); updateStatus('${o.order_id}', 'PickedUp')">ğŸ“¦ ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø·Ù„Ø¨ Ù…Ù† Ø§Ù„ØªØ§Ø¬Ø±</button>`;
                    } else {
                        mainButton = `<button class="btn btn-block" style="background:#f3f4f6; color:#888; cursor:not-allowed;" onclick="event.stopPropagation()">â³ Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø¯ÙØ¹ Ø§Ù„ØªØ§Ø¬Ø±</button>`;
                        
                        extraButtons += `<button class="btn btn-danger btn-pulse btn-block" onclick="event.stopPropagation(); nudgeSeller('${o.order_id}', '${o.seller_username}')">ğŸ”” Ø§Ø³ØªØ¹Ø¬Ø§Ù„ Ø§Ù„ØªØ§Ø¬Ø± Ù„Ù„Ø¯ÙØ¹</button>`;
                        extraButtons += `<button class="btn btn-transfer btn-block" style="background:#e0f2fe; color:#0284c7;" onclick="event.stopPropagation(); openTransferModal('${o.order_id}')">â™»ï¸ ØªØ­ÙˆÙŠÙ„ Ù„Ø²Ù…ÙŠÙ„</button>`;
                        extraButtons += `<button class="btn btn-danger btn-block" onclick="event.stopPropagation(); openCancelModal('${o.order_id}')">âŒ Ø¥Ù„ØºØ§Ø¡</button>`;
                    }

                } else if (o.status === 'PickedUp') {
                    statusBadge = `<span class="badge badge-PickedUp">ÙÙŠ Ø§Ù„Ø·Ø±ÙŠÙ‚ Ù„Ù„Ø¹Ù…ÙŠÙ„</span>`;
                    mainButton = `<button class="btn btn-success btn-block" onclick="event.stopPropagation(); updateStatus('${o.order_id}', 'Delivered')">ğŸ ØªÙ… ØªØ³Ù„ÙŠÙ… Ø§Ù„Ø·Ù„Ø¨ Ù„Ù„Ø¹Ù…ÙŠÙ„</button>`;
                }

                // Ø±Ø§Ø¨Ø· Ø§Ù„Ø®Ø±ÙŠØ·Ø©
                const mapQuery = encodeURIComponent(o.customer_address);
                const mapLink = `https://www.google.com/maps/search/?api=1&query=${mapQuery}`;

                html += `
                <div class="mobile-card active" onclick="UI.openOrderPage(currentOrders.find(x => x.order_id === '${o.order_id}'))">
                    <div class="card-header">
                        <span>#${shortId}</span>
                        ${statusBadge}
                    </div>
                    
                    <div style="margin-bottom: 15px; background: #fff; padding: 15px; border-radius: 12px; border: 1px solid #eee; box-shadow: 0 2px 5px rgba(0,0,0,0.02);">
                        <div style="font-weight: bold; font-size: 1.1rem; margin-bottom:8px; color:var(--text-main);">ğŸ‘¤ ${o.customer_name}</div>
                        <div class="contact-actions">
                            ${phoneButton}
                            ${waButton}
                        </div>
                        <div style="color: var(--primary); font-weight: 800; font-size:1.1rem; margin-top: 12px; border-top:1px dashed #eee; padding-top:8px;">
                            ğŸ’° Ø§Ù„ØªØ­ØµÙŠÙ„: ${Number(o.amount).toLocaleString()}
                        </div>
                    </div>
                    
                    ${notesHtml}

                    <a href="${mapLink}" target="_blank" class="map-btn" onclick="event.stopPropagation()"><span>ğŸ“</span> ÙØªØ­ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ÙÙŠ Ø§Ù„Ø®Ø±ÙŠØ·Ø©</a>
                    
                    <div class="action-grid" style="margin-top:15px;">
                        ${mainButton}
                    </div>
                    ${extraButtons ? `<div class="action-grid" style="margin-top:10px; gap:8px;">${extraButtons}</div>` : ''}
                </div>`;
            });
            container.innerHTML = html;
        }

        // Ø¬. Ø§Ù„Ù…Ø­ÙØ¸Ø© (Wallet)
        function renderWallet(orders) {
            const user = Auth.getUser().username;
            const delivered = orders.filter(o => o.status === 'Delivered' && o.courier_username === user);
            
            // Ø­Ø³Ø§Ø¨ Ø§Ù„ÙƒØ§Ø´ Ø§Ù„Ø°ÙŠ Ù„Ù… ÙŠØªÙ… ØªØ³ÙˆÙŠØªÙ‡ Ø¨Ø¹Ø¯
            const totalCash = delivered
                .filter(o => !o.settled || o.settled === 'FALSE')
                .reduce((sum, o) => sum + Number(o.amount), 0);
            
            document.getElementById('wallet-amount').innerText = totalCash.toLocaleString();

            const historyContainer = document.getElementById('wallet-history');
            let historyHtml = '';
            
            if (delivered.length === 0) {
                historyContainer.innerHTML = '<li style="padding: 20px; text-align: center; color: #999;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù…ÙƒØªÙ…Ù„Ø© Ø§Ù„ÙŠÙˆÙ…</li>';
                return;
            }

            delivered.slice().reverse().slice(0, 15).forEach(o => { 
                const isSettled = (o.settled === true || o.settled === 'TRUE');
                const icon = isSettled ? 'âœ…' : 'â³';
                const statusText = isSettled ? 'ØªÙ…Øª Ø§Ù„ØªØµÙÙŠØ©' : 'Ø¨Ø°Ù…ØªÙƒ';
                const color = isSettled ? '#999' : 'var(--danger)';

                historyHtml += `
                    <li style="padding: 15px; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items:center;">
                        <div>
                            <div style="font-weight: bold; color:#333;">Ø·Ù„Ø¨ #${o.order_id.split('-')[1]}</div>
                            <small style="color: ${color};">${icon} ${statusText}</small>
                        </div>
                        <span style="font-weight: bold; color: var(--primary); direction:ltr;">+${Number(o.amount).toLocaleString()}</span>
                    </li>`;
            });
            historyContainer.innerHTML = historyHtml;
        }

        // --- 3. Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª (Actions) ---

        async function acceptOrder(orderId) {
            if(!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù‚Ø¨ÙˆÙ„ Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ØŸ")) return;
            const user = Auth.getUser().username;
            try {
                await Api.post('updateStatus', { order_id: orderId, status: 'Assigned', courier_username: user }, false);
                UI.showToast("ğŸš€ ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨! Ø§Ù†ØªÙ‚Ù„ Ù„ØªØ¨ÙˆÙŠØ¨ 'Ù…Ù‡Ø§Ù…ÙŠ'");
                switchTab('active', document.querySelectorAll('.nav-item')[1]);
                loadCourierData(false);
            } catch (err) { }
        }

        async function updateStatus(orderId, newStatus) {
            const msg = newStatus === 'PickedUp' ? "ØªØ£ÙƒÙŠØ¯ Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø·Ù„Ø¨ Ù…Ù† Ø§Ù„ØªØ§Ø¬Ø±ØŸ" : "ØªØ£ÙƒÙŠØ¯ ØªØ³Ù„ÙŠÙ… Ø§Ù„Ø·Ù„Ø¨ Ù„Ù„Ø¹Ù…ÙŠÙ„ ÙˆØ§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ù…Ø¨Ù„ØºØŸ";
            if(!confirm(msg)) return;
            try {
                await Api.post('updateStatus', { order_id: orderId, status: newStatus }, false);
                UI.showToast(newStatus === 'PickedUp' ? "ğŸ“¦ ØªÙ… Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…" : "ğŸ’° ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ… ÙˆØ§Ù„ØªØ­ØµÙŠÙ„");
                loadCourierData(false);
            } catch (err) { }
        }

        async function nudgeSeller(orderId, sellerUsername) {
            if(!confirm("Ø¥Ø±Ø³Ø§Ù„ ØªÙ†Ø¨ÙŠÙ‡ Ù„Ù„ØªØ§Ø¬Ø± Ø¨Ø£Ù†Ùƒ ØªÙ†ØªØ¸Ø± Ø§Ù„Ø¯ÙØ¹ØŸ")) return;
            try {
                const user = Auth.getUser().username;
                await Api.post('nudgeUser', { 
                    order_id: orderId, target_user: sellerUsername, target_role: 'seller', 
                    username: user, message: "Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ Ù…ÙˆØ¬ÙˆØ¯ ÙˆÙŠÙ†ØªØ¸Ø± ØªØ£ÙƒÙŠØ¯ Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ù…Ø¨Ù„Øº!"
                }, false);
                UI.showToast("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ù„Ù„ØªØ§Ø¬Ø± ğŸ””");
            } catch(e) {}
        }

        function openTransferModal(orderId) {
            document.getElementById('transferOrderId').value = orderId;
            document.getElementById('transferTargetUser').value = "";
            UI.openModal('transferModal');
        }

        async function confirmTransfer() {
            const orderId = document.getElementById('transferOrderId').value;
            const targetUser = document.getElementById('transferTargetUser').value;
            if(!targetUser) return UI.showToast("Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù„Ø²Ù…ÙŠÙ„", "error");

            try {
                const currentUser = Auth.getUser().username;
                await Api.post('transferOrder', { 
                    order_id: orderId, new_courier_username: targetUser, username: currentUser
                }, false);
                
                UI.closeModal('transferModal');
                UI.showToast("ØªÙ… ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­ â™»ï¸");
                loadCourierData(false);
            } catch(e) {}
        }

        function openCancelModal(orderId) {
            document.getElementById('cancelOrderId').value = orderId;
            document.getElementById('cancelReason').value = "";
            UI.openModal('cancelModal');
        }

        document.getElementById('cancelForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const orderId = document.getElementById('cancelOrderId').value;
            const reason = document.getElementById('cancelReason').value;

            try {
                await Api.post('cancelOrderWithReason', {
                    order_id: orderId, reason: reason, role: 'courier'
                }, false);
                
                UI.closeModal('cancelModal');
                UI.showToast("ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨", "warning");
                loadCourierData(false);
            } catch (err) { }
        });

        function switchTab(tabName, btnElement) {
            document.querySelectorAll('.tab-view').forEach(el => el.classList.remove('active'));
            document.getElementById('tab-' + tabName).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            if(btnElement) btnElement.classList.add('active');
            window.scrollTo(0,0);
        }
    </script>
</body>
</html>
